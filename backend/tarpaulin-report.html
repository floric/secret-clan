<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
}

.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","bin.rs"],"content":"use secret_clan::run_app;\n\nfn main() {\n    run_app();\n}\n","traces":[{"line":3,"address":[4211120],"length":1,"stats":{"Line":0},"fn_name":"main"},{"line":4,"address":[4211121],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":2},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","client.rs"],"content":"use super::{Command, CommandData, Persist, QueryError};\nuse log::debug;\nuse nanoid::nanoid;\nuse std::{\n    collections::HashSet,\n    fmt::{self, Debug},\n};\nuse tokio::sync::{mpsc, oneshot};\n\npub struct Client\u003cT: Persist\u003e {\n    sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Persist\u003e Client\u003cT\u003e {\n    pub fn new(sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e) -\u003e Self {\n        Client { sender }\n    }\n\n    async fn run_query\u003cR: Debug\u003e(\n        \u0026self,\n        cmd_provider: impl FnOnce(CommandData\u003cR\u003e) -\u003e Command\u003cT\u003e,\n    ) -\u003e Result\u003cR, QueryError\u003e {\n        let (responder, receiver): (oneshot::Sender\u003cR\u003e, oneshot::Receiver\u003cR\u003e) = oneshot::channel();\n        let id = nanoid!();\n        let data = CommandData {\n            responder,\n            id: String::from(\u0026id),\n        };\n        let cmd = cmd_provider(data);\n        let res = self.sender.clone().send(cmd).await;\n        debug!(\"Sent query \\\"{}\\\"\", \u0026id);\n\n        match res {\n            Ok(_) =\u003e match receiver.await {\n                Ok(res) =\u003e {\n                    debug!(\"Received answer for query \\\"{}\\\": {:?}\", \u0026id, res);\n                    Ok(res)\n                }\n                Err(error) =\u003e Err(QueryError::new(\u0026fmt::format(format_args!(\n                    \"Retrieving result for query \\\"{}\\\" has failed: {}\",\n                    id,\n                    error.to_string(),\n                )))),\n            },\n            Err(error) =\u003e Err(QueryError::new(\u0026fmt::format(format_args!(\n                \"Sending query for query \\\"{}\\\" has failed: {}\",\n                id,\n                error.to_string(),\n            )))),\n        }\n    }\n\n    fn map_result\u003cR\u003e(res: Result\u003cR, sled::Error\u003e) -\u003e Result\u003cR, QueryError\u003e {\n        res.map_err(QueryError::from_sled)\n    }\n\n    pub async fn get(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cT\u003e, QueryError\u003e {\n        let key = String::from(id);\n        self.run_query(|data| Command::Get { key, data })\n            .await\n            .and_then(Self::map_result)\n    }\n\n    pub async fn scan(\n        \u0026self,\n        scan_function: Box\u003cdyn Fn(\u0026T) -\u003e bool + Send + Sync\u003e,\n    ) -\u003e Result\u003cHashSet\u003cString\u003e, QueryError\u003e {\n        self.run_query(|data| Command::Scan {\n            scan_function,\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn persist(\u0026self, elem: \u0026T) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Persist {\n            value: elem.clone(),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn remove(\u0026self, key: \u0026str) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Remove {\n            key: String::from(key),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn remove_batch(\u0026self, keys: \u0026HashSet\u003cString\u003e) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::RemoveBatch {\n            keys: keys.clone(),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn purge(\u0026self) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Purge { data })\n            .await\n            .and_then(Self::map_result)\n    }\n\n    pub async fn total_count(\u0026self) -\u003e Result\u003cusize, QueryError\u003e {\n        self.run_query(|data| Command::Count { data }).await\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::Client;\n    use crate::{\n        db::{Database, Persist},\n        model::Game,\n    };\n    use nanoid::nanoid;\n    use std::collections::HashSet;\n\n    fn init_client() -\u003e Client\u003cGame\u003e {\n        let mut repo = Database::init(\"games\");\n\n        let sender = repo.sender();\n        tokio::task::spawn(async move {\n            repo.start_listening().await;\n        });\n\n        let client = Client::new(sender);\n\n        client\n    }\n\n    #[tokio::test]\n    async fn should_get_game() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"token\");\n        let game_id = String::from(game.id());\n\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n\n        let res = client.get(\u0026game_id).await.expect(\"Reading game has failed\");\n\n        assert!(res.is_some());\n        assert_eq!(res.unwrap().id(), game_id);\n    }\n\n    #[tokio::test]\n    async fn should_persist_game() {\n        let client = init_client();\n\n        client\n            .persist(\u0026Game::new(\"admin\", \"token\"))\n            .await\n            .expect(\"Game persist failed\");\n    }\n\n    #[tokio::test]\n    async fn should_purge_games() {\n        let client = init_client();\n\n        client\n            .persist(\u0026Game::new(\"admin\", \"token\"))\n            .await\n            .expect(\"Game persist failed\");\n        client\n            .persist(\u0026Game::new(\"admin\", \"token2\"))\n            .await\n            .expect(\"Game persist failed\");\n\n        assert_eq!(client.total_count().await.unwrap(), 2);\n\n        client.purge().await.expect(\"Perging has failed\");\n\n        assert_eq!(client.total_count().await.unwrap(), 0);\n    }\n\n    #[tokio::test]\n    async fn should_remove_game() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"token\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n\n        let persisted_game = client\n            .get(\u0026game.id())\n            .await\n            .expect(\"Reading game has failed\");\n        assert!(persisted_game.is_some());\n\n        let res = client\n            .remove(game.id())\n            .await\n            .expect(\"Removing game failed\");\n        assert!(res);\n\n        let removed_game = client\n            .get(\u0026game.id())\n            .await\n            .expect(\"Reading game has failed\");\n        assert!(removed_game.is_none());\n    }\n\n    #[tokio::test]\n    async fn should_remove_games() {\n        let client = init_client();\n        let mut ids = HashSet::new();\n        for x in \u0026[\"A\", \"B\", \"C\"] {\n            let g = Game::new(\"admin\", *x);\n            client.persist(\u0026g).await.expect(\"Game persist failed\");\n            ids.insert(String::from(*x));\n        }\n\n        let game_count = client\n            .total_count()\n            .await\n            .expect(\"Reading count has failed\");\n        assert_eq!(game_count, 3);\n\n        let res = client\n            .remove_batch(\u0026ids)\n            .await\n            .expect(\"Removing games failed\");\n        assert!(res);\n\n        let game_count = client\n            .total_count()\n            .await\n            .expect(\"Reading count has failed\");\n        assert_eq!(game_count, 0);\n    }\n\n    #[tokio::test]\n    async fn should_not_get_game() {\n        let client = init_client();\n        let res = client\n            .get(\"unknown\")\n            .await\n            .expect(\"Reading game has failed\");\n\n        assert!(res.is_none());\n    }\n\n    #[tokio::test]\n    async fn should_create_entities_concurrently() {\n        let client = init_client();\n\n        let mut threads = vec![];\n\n        for _ in 0..1000 {\n            threads.push(async {\n                let _ = client.persist(\u0026Game::new(\"admin\", \u0026nanoid!())).await;\n            });\n        }\n\n        futures::future::join_all(threads).await;\n\n        assert_eq!(\n            client\n                .total_count()\n                .await\n                .expect(\"Reading count has failed\"),\n            1000\n        );\n    }\n}\n","traces":[{"line":15,"address":[5551744,5551808],"length":1,"stats":{"Line":9},"fn_name":"new\u003csecret_clan::model::game::Game\u003e"},{"line":19,"address":[5552032,5552448,5552288,5552208,5552112,5551872,5551952,5552352,5552544],"length":1,"stats":{"Line":17},"fn_name":"run_query\u003csecret_clan::model::player::Player,core::result::Result\u003cbool, sled::result::Error\u003e,closure-0\u003e"},{"line":23,"address":[5558413,5564201,5575801,5599161,5570013,5581805,5593369,5552817,5587581],"length":1,"stats":{"Line":17},"fn_name":null},{"line":24,"address":[5581898,5552902,5593454,5558506,5587674,5564286,5575886,5570106,5599246],"length":1,"stats":{"Line":18},"fn_name":null},{"line":27,"address":[5587899,5582123,5558731,5564511,5570331,5576111,5553127,5593679,5599471],"length":1,"stats":{"Line":18},"fn_name":null},{"line":29,"address":[5582363,5553359,5558811,5588139,5593759,5570411,5570571,5587979,5582203,5564591,5576383,5593951,5553207,5558971,5564779,5576191,5599551,5599739],"length":1,"stats":{"Line":37},"fn_name":null},{"line":30,"address":[4516897,4526417,4546673,4557409,4545313,4539889,4574033,4575713,4558849],"length":1,"stats":{"Line":96},"fn_name":null},{"line":31,"address":[5583312,5571480,5589135,5594860,5589048,5600515,5565688,5600922,5554355,5571754,5589322,5554542,5565728,5554268,5559747,5554308,5571347,5554135,5600688,5577379,5577332,5595134,5600648,5559920,5565775,5577159,5560154,5577566,5583359,5594947,5559880,5559967,5571520,5594900,5600735,5577292,5571567,5565555,5583272,5588915,5565962,5583546,5589088,5583139,5594727],"length":1,"stats":{"Line":76},"fn_name":null},{"line":33,"address":[5583748,5574220,5586322,5586012,5592098,5603394,5580554,5595336,5603718,5580230,5554744,5556835,5560356,5574530,5571956,5597572,5562620,5566164,5568758,5601124,5577768,5597896,5557160,5589524,5568434,5562930,5591788],"length":1,"stats":{"Line":20},"fn_name":null},{"line":34,"address":[4545528,4540104,4559064,4575928,4546888,4557624,4517112,4526632,4574248],"length":1,"stats":{"Line":99},"fn_name":null},{"line":35,"address":[5560749,5589990,5595724,5601520,5584214,5566636,5572422,5578368,5589917,5555170,5560822,5601596,5584141,5572349,5566560,5578292,5555103,5595828],"length":1,"stats":{"Line":42},"fn_name":null},{"line":36,"address":[5555363,5555745,5578496,5584278,5601851,5573059,5601898,5561124,5572619,5595971,5561077,5555186,5567176,5595830,5572486,5584851,5572724,5578629,5555410,5567273,5578734,5560886,5561459,5572962,5578972,5584754,5584516,5590187,5555319,5590530,5584411,5590292,5590627,5596076,5566700,5601793,5602136,5602233,5566833,5561362,5555648,5578687,5561019,5590054,5596314,5601660,5566891,5572677,5566938,5584469,5590245,5579069,5596411,5596029],"length":1,"stats":{"Line":84},"fn_name":null},{"line":37,"address":[5555786,5579110,5561500,5596452,5567314,5573100,5584892,5602274,5590668],"length":1,"stats":{"Line":21},"fn_name":null},{"line":39,"address":[5555827,5556050,5562027,5567651,5573525,5591195,5602801,5561925,5590788,5585419,5591005,5579447,5579535,5585012,5596789,5602611,5585229,5602394,5596712,5596979,5573627,5585152,5561620,5591093,5556240,5596877,5590928,5596572,5567841,5556138,5567739,5602534,5573220,5579637,5585317,5561837,5573437,5579230,5579370,5561760,5602699,5573360,5555967,5567434,5567574],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[5601552,5589946,5560778,5578324,5584170,5595756,5572378,5555126,5566592],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[5566596,5560782,5584174,5601556,5578328,5555130,5572382,5595760,5589950],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[5597471,5591587,5560235,5567936,5579941,5601003,5579867,5574019,5574119,5556470,5568071,5577647,5579732,5583627,5573722,5585514,5585649,5585723,5585911,5589403,5556632,5603193,5554623,5573857,5591290,5562419,5591499,5580129,5603105,5597074,5556544,5556335,5603293,5597283,5595215,5556734,5568145,5571835,5568333,5597371,5602896,5568233,5580029,5591687,5566043,5562331,5562257,5585811,5562122,5573931,5591425,5597209,5562519,5603031],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[5583698,5589474,5566114,5577718,5601074,5554694,5571906,5560306,5595286],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[5601078,5577722,5554698,5595290,5583702,5566118,5560310,5589478,5571910],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[5604784,5604944,5605184,5605024,5605104,5604864],"length":1,"stats":{"Line":15},"fn_name":"map_result\u003csecret_clan::model::game::Game,std::collections::hash::set::HashSet\u003calloc::string::String, std::collections::hash::map::RandomState\u003e\u003e"},{"line":54,"address":[5605194,5605031,5604791,5604871,5604951,5605114],"length":1,"stats":{"Line":15},"fn_name":null},{"line":57,"address":[5605360,5606656,5605394,5605978,5606890,5605770,5605264,5606445,5607357,5605298,5606682,5605744],"length":1,"stats":{"Line":14},"fn_name":"get\u003csecret_clan::model::game::Game\u003e"},{"line":58,"address":[5606801,5605889],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[4522246,4563478],"length":1,"stats":{"Line":18},"fn_name":null},{"line":60,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[5607664,5607568],"length":1,"stats":{"Line":2},"fn_name":"scan\u003csecret_clan::model::player::Player\u003e"},{"line":68,"address":[4563958,4570310],"length":1,"stats":{"Line":15},"fn_name":null},{"line":69,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[5607889,5607777],"length":1,"stats":{"Line":2},"fn_name":null},{"line":72,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[5610704,5609802,5611386,5611360,5609856,5610480,5609776,5610506,5611584,5609882,5612051,5611171],"length":1,"stats":{"Line":35},"fn_name":"persist\u003csecret_clan::model::player::Player\u003e"},{"line":77,"address":[5609987,5610608,5611727,5609936,5610208,5611659,5611488,5610779,5611613,5610059,5610258,5610733,5610330,5611156,5612036,5610847],"length":1,"stats":{"Line":41},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":78,"address":[5609954,5610226],"length":1,"stats":{"Line":7},"fn_name":null},{"line":79,"address":[5610007,5610278],"length":1,"stats":{"Line":7},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":86,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[4516575,4516560,4568288,4568376,4568303,4516648],"length":1,"stats":{"Line":12},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":95,"address":[4516630,4568358],"length":1,"stats":{"Line":12},"fn_name":null},{"line":96,"address":[5612415,5612655],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[5612709,5612469],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":104,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":105,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[4551896,4551808,4551823],"length":1,"stats":{"Line":10},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":110,"address":[4551878],"length":1,"stats":{"Line":12},"fn_name":null},{"line":124,"address":[5022560,5022634],"length":1,"stats":{"Line":2},"fn_name":"init_client"},{"line":125,"address":[5022577],"length":1,"stats":{"Line":3},"fn_name":null},{"line":127,"address":[5022662],"length":1,"stats":{"Line":7},"fn_name":null},{"line":128,"address":[5022677],"length":1,"stats":{"Line":12},"fn_name":null},{"line":129,"address":[5843222],"length":1,"stats":{"Line":6},"fn_name":null},{"line":132,"address":[5022862],"length":1,"stats":{"Line":7},"fn_name":null},{"line":137,"address":[5023079,5023072],"length":1,"stats":{"Line":9},"fn_name":"should_get_game"},{"line":139,"address":[7072368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[7072399],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[7072517,7072456],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[5795887],"length":1,"stats":{"Line":4},"fn_name":null},{"line":145,"address":[5795986],"length":1,"stats":{"Line":5},"fn_name":null},{"line":147,"address":[7073571,7073620,7073802],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[7073636,7073848,7074040,7073897,7074259,7074349,7073875],"length":1,"stats":{"Line":4},"fn_name":null},{"line":151,"address":[5023383,5023376],"length":1,"stats":{"Line":9},"fn_name":"should_persist_game"},{"line":153,"address":[7075334],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[5781573],"length":1,"stats":{"Line":5},"fn_name":null},{"line":156,"address":[7075351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[5023687,5023680],"length":1,"stats":{"Line":9},"fn_name":"should_purge_games"},{"line":163,"address":[7076318],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[5818727],"length":1,"stats":{"Line":5},"fn_name":null},{"line":166,"address":[7076341],"length":1,"stats":{"Line":1},"fn_name":null},{"line":169,"address":[5818819],"length":1,"stats":{"Line":5},"fn_name":null},{"line":170,"address":[7076927],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[5818866],"length":1,"stats":{"Line":4},"fn_name":null},{"line":176,"address":[5818894],"length":1,"stats":{"Line":5},"fn_name":null},{"line":178,"address":[5818925],"length":1,"stats":{"Line":5},"fn_name":null},{"line":181,"address":[5023991,5023984],"length":1,"stats":{"Line":9},"fn_name":"should_remove_game"},{"line":183,"address":[7080750],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[7080765],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[5856983],"length":1,"stats":{"Line":5},"fn_name":null},{"line":187,"address":[5857052],"length":1,"stats":{"Line":4},"fn_name":null},{"line":188,"address":[7081282,7081364],"length":1,"stats":{"Line":2},"fn_name":null},{"line":191,"address":[7081881,7081943,7082009],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[5857100],"length":1,"stats":{"Line":4},"fn_name":null},{"line":194,"address":[7081971],"length":1,"stats":{"Line":1},"fn_name":null},{"line":197,"address":[7082542,7082464],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[5857151],"length":1,"stats":{"Line":4},"fn_name":null},{"line":200,"address":[7082493,7082590],"length":1,"stats":{"Line":2},"fn_name":null},{"line":203,"address":[7083117,7083077,7083052],"length":1,"stats":{"Line":2},"fn_name":null},{"line":206,"address":[5024288,5024295],"length":1,"stats":{"Line":9},"fn_name":"should_remove_games"},{"line":208,"address":[7084261],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[7084276],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[7084357,7084290,7084508,7085137,7084411],"length":1,"stats":{"Line":4},"fn_name":null},{"line":211,"address":[7084546],"length":1,"stats":{"Line":1},"fn_name":null},{"line":212,"address":[5825467],"length":1,"stats":{"Line":5},"fn_name":null},{"line":213,"address":[7085099,7085032],"length":1,"stats":{"Line":2},"fn_name":null},{"line":216,"address":[5825557],"length":1,"stats":{"Line":5},"fn_name":null},{"line":220,"address":[7085575,7086067,7085968,7085722],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[5825584],"length":1,"stats":{"Line":5},"fn_name":null},{"line":223,"address":[7085681],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[7086478,7086514],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[5825609],"length":1,"stats":{"Line":5},"fn_name":null},{"line":232,"address":[7087352,7086935,7087262,7087058],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[5024592,5024599],"length":1,"stats":{"Line":9},"fn_name":"should_not_get_game"},{"line":237,"address":[7088502],"length":1,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[5847093],"length":1,"stats":{"Line":4},"fn_name":null},{"line":243,"address":[7088959,7088993,7088934],"length":1,"stats":{"Line":2},"fn_name":null},{"line":246,"address":[5024903,5024896],"length":1,"stats":{"Line":9},"fn_name":"should_create_entities_concurrently"},{"line":248,"address":[7090517],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[7090539],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[7090729,7091001,7090668,7090879,7090561],"length":1,"stats":{"Line":4},"fn_name":null},{"line":253,"address":[5760509,5760320,5760534,5760335],"length":1,"stats":{"Line":5},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":254,"address":[5760404],"length":1,"stats":{"Line":6},"fn_name":null},{"line":258,"address":[5800258],"length":1,"stats":{"Line":5},"fn_name":null},{"line":260,"address":[7091867,7091744,7092161,7092071],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[5800310],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":104,"coverable":125},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","database.rs"],"content":"use super::{Command, Persist, ScanFunction};\nuse log::{debug, error, info, warn};\nuse nanoid::nanoid;\nuse rayon::prelude::*;\nuse sled::Db;\nuse std::collections::HashSet;\nuse tokio::sync::{\n    mpsc::{self},\n    oneshot::{self},\n};\n\npub struct Database\u003cT: Persist\u003e {\n    path: String,\n    db: Db,\n    receiver: mpsc::Receiver\u003cCommand\u003cT\u003e\u003e,\n    sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Persist\u003e Database\u003cT\u003e {\n    pub fn init(path: \u0026str) -\u003e Database\u003cT\u003e {\n        let db = sled::open(if cfg!(test) {\n            format!(\".sled/{}/{}\", nanoid!(), \u0026path)\n        } else {\n            format!(\".sled/{}\", \u0026path)\n        })\n        .expect(\"opening database has failed\");\n\n        let (sender, receiver): (mpsc::Sender\u003cCommand\u003cT\u003e\u003e, mpsc::Receiver\u003cCommand\u003cT\u003e\u003e) =\n            mpsc::channel(256);\n\n        let repo = Database {\n            db,\n            path: String::from(path),\n            receiver,\n            sender,\n        };\n\n        repo.purge()\n            .expect(\"Cleanup of existing database has failed\");\n\n        repo\n    }\n\n    pub fn sender(\u0026self) -\u003e mpsc::Sender\u003cCommand\u003cT\u003e\u003e {\n        self.sender.clone()\n    }\n\n    /// A database connection is etablished by creating a database instance, which should should then be started in a separate thread.\n    /// The communication between resources and the database is established with channels. Simply use a client to send messages to the database thread in an easy accesible way.\n    /// Of course it's also possible to send messages through the channel directly without using the client.\n    ///\n    /// Example:\n    /// ```\n    /// use secret_clan::{model::Game, db::{Database, Client}};\n    /// let mut repo: Database\u003cGame\u003e = Database::init(\"test\");\n    /// let sender = repo.sender();\n    /// std::thread::spawn(move || {\n    ///     repo.start_listening();\n    /// });\n    /// let client = Client::new(sender);\n    /// ```\n    pub async fn start_listening(\u0026mut self) {\n        info!(\"Database for \\\"{}\\\" ready\", self.path);\n\n        while let Some(cmd) = self.receiver.recv().await {\n            debug!(\"Received query: {:?}\", cmd);\n\n            match cmd {\n                Command::Get { key, data } =\u003e {\n                    self.send_result(self.get(\u0026key), data.responder);\n                }\n                Command::Persist { value, data } =\u003e {\n                    self.send_result(self.persist(\u0026value), data.responder);\n                }\n                Command::Remove { key, data } =\u003e {\n                    self.send_result(self.remove(\u0026key), data.responder);\n                }\n                Command::RemoveBatch { keys, data } =\u003e {\n                    self.send_result(self.remove_batch(\u0026keys), data.responder);\n                }\n                Command::Count { data } =\u003e {\n                    self.send_result(self.total_count(), data.responder);\n                }\n                Command::Scan {\n                    scan_function,\n                    data,\n                } =\u003e {\n                    self.send_result(Ok(self.scan(scan_function)), data.responder);\n                }\n                Command::Purge { data } =\u003e {\n                    self.send_result(self.purge(), data.responder);\n                }\n            }\n        }\n    }\n\n    fn persist(\u0026self, elem: \u0026T) -\u003e Result\u003cbool, sled::Error\u003e {\n        self.db\n            .insert(elem.id(), elem.clone())\n            .expect(\"Persisting item failed\");\n        self.flush()\n    }\n\n    fn remove(\u0026self, key: \u0026str) -\u003e Result\u003cbool, sled::Error\u003e {\n        match self.db.remove(key).expect(\"Removing item failed\") {\n            Some(_) =\u003e self.flush(),\n            None =\u003e {\n                warn!(\"No item with key \\\"{}\\\" found for removal\", key);\n                Ok(false)\n            }\n        }\n    }\n\n    fn remove_batch(\u0026self, keys: \u0026HashSet\u003cString\u003e) -\u003e Result\u003cbool, sled::Error\u003e {\n        let batch = sled::Batch::default();\n        for key in keys {\n            match self.db.remove(key).expect(\"Removing item failed\") {\n                Some(_) =\u003e {}\n                None =\u003e {\n                    warn!(\"No item with key \\\"{}\\\" found for removal\", key);\n                }\n            }\n        }\n        self.db.apply_batch(batch)?;\n        self.flush()\n    }\n\n    fn get(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cT\u003e, sled::Error\u003e {\n        let success = self.db.get(id);\n        match success {\n            Ok(res) =\u003e Ok(res.and_then(|g| T::try_from(g).ok())),\n            Err(err) =\u003e Err(err),\n        }\n    }\n\n    fn scan(\u0026self, scan_function: ScanFunction\u003cT\u003e) -\u003e HashSet\u003cString\u003e {\n        self.db\n            .iter()\n            .par_bridge()\n            .filter_map(|x| x.ok())\n            .filter_map(|(_, x)| T::try_from(x).ok())\n            .filter_map(|y| {\n                if scan_function(\u0026y) {\n                    Some(String::from(y.id()))\n                } else {\n                    None\n                }\n            })\n            .collect::\u003cHashSet\u003cString\u003e\u003e()\n    }\n\n    fn total_count(\u0026self) -\u003e usize {\n        self.db.len()\n    }\n\n    fn flush(\u0026self) -\u003e Result\u003cbool, sled::Error\u003e {\n        self.db.flush().map(|_| true)\n    }\n\n    fn send_result\u003cR\u003e(\u0026self, data: R, sender: oneshot::Sender\u003cR\u003e) {\n        if sender.send(data).is_err() {\n            error!(\"Sending result to client has failed\");\n        }\n    }\n\n    fn purge(\u0026self) -\u003e Result\u003cbool, sled::Error\u003e {\n        let res = self.db.clear().and_then(|()| self.db.flush()).map(|_| true);\n        info!(\"Purged database \\\"{}\\\"\", self.path);\n\n        res\n    }\n}\n","traces":[{"line":20,"address":[5712256,5712386,5713248,5713378],"length":1,"stats":{"Line":5},"fn_name":"init\u003csecret_clan::model::game::Game\u003e"},{"line":21,"address":[5712549,5713541,5712283,5713275],"length":1,"stats":{"Line":8},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":24,"address":[5712413,5713299,5713405,5712307],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[5712649,5713641],"length":1,"stats":{"Line":5},"fn_name":null},{"line":33,"address":[5713752,5712760],"length":1,"stats":{"Line":5},"fn_name":null},{"line":38,"address":[5714001,5713009,5713960,5712968],"length":1,"stats":{"Line":14},"fn_name":null},{"line":41,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[5714288,5714240],"length":1,"stats":{"Line":9},"fn_name":"sender\u003csecret_clan::model::game::Game\u003e"},{"line":45,"address":[5714300,5714252],"length":1,"stats":{"Line":9},"fn_name":null},{"line":62,"address":[4529071,4554720,4529056,4554735],"length":1,"stats":{"Line":13},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":63,"address":[5720968,5714825,5714889,5720724,5720857,5714692,5715107,5714936,5720921,5721139],"length":1,"stats":{"Line":23},"fn_name":null},{"line":65,"address":[5721180,5715304,5715259,5721336,5715594,5715148,5715366,5721291,5721398,5719531,5725563,5721626],"length":1,"stats":{"Line":40},"fn_name":null},{"line":66,"address":[5722037,5715958,5716005,5716182,5721752,5721893,5721990,5722214,5715720,5715861],"length":1,"stats":{"Line":32},"fn_name":null},{"line":68,"address":[5716667,5717044,5717637,5723669,5722388,5717340,5716356,5722699,5725347,5723076,5723372,5719315],"length":1,"stats":{"Line":15},"fn_name":null},{"line":69,"address":[5716358,5716223,5722390,5722255],"length":1,"stats":{"Line":11},"fn_name":null},{"line":70,"address":[5716454,5722486,5716600,5722632],"length":1,"stats":{"Line":6},"fn_name":null},{"line":72,"address":[5722704,5716672],"length":1,"stats":{"Line":7},"fn_name":null},{"line":73,"address":[5716864,5722896],"length":1,"stats":{"Line":7},"fn_name":null},{"line":75,"address":[5723081,5717049],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[5723308,5717145,5717276,5723177],"length":1,"stats":{"Line":2},"fn_name":null},{"line":78,"address":[5723377,5717345],"length":1,"stats":{"Line":2},"fn_name":null},{"line":79,"address":[5717457,5723489],"length":1,"stats":{"Line":2},"fn_name":null},{"line":81,"address":[5717642,5723674],"length":1,"stats":{"Line":2},"fn_name":null},{"line":82,"address":[5723730,5717698],"length":1,"stats":{"Line":2},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[5717824,5723856],"length":1,"stats":{"Line":2},"fn_name":null},{"line":86,"address":[5723896,5717864],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[5717920,5724033,5718001,5723952],"length":1,"stats":{"Line":4},"fn_name":null},{"line":90,"address":[5722295,5716263],"length":1,"stats":{"Line":1},"fn_name":null},{"line":91,"address":[5722351,5718128,5724160,5716319],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[5726736,5726496],"length":1,"stats":{"Line":7},"fn_name":"persist\u003csecret_clan::model::player::Player\u003e"},{"line":98,"address":[5726762,5726605,5726845,5726522],"length":1,"stats":{"Line":14},"fn_name":null},{"line":99,"address":[5726571,5726811],"length":1,"stats":{"Line":7},"fn_name":null},{"line":101,"address":[5726951,5726709],"length":1,"stats":{"Line":7},"fn_name":null},{"line":104,"address":[5727632,5727701,5726976,5727045],"length":1,"stats":{"Line":1},"fn_name":"remove\u003csecret_clan::model::player::Player\u003e"},{"line":105,"address":[5727217,5727873,5727660,5727240,5727060,5727004,5727896,5727716],"length":1,"stats":{"Line":3},"fn_name":null},{"line":106,"address":[5727219,5727143,5727875,5727799],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[5727245,5727984,5727179,5727328,5727901,5727835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[5728288,5728365,5729645,5729568],"length":1,"stats":{"Line":2},"fn_name":"remove_batch\u003csecret_clan::model::game::Game\u003e"},{"line":115,"address":[5729594,5728314],"length":1,"stats":{"Line":2},"fn_name":null},{"line":116,"address":[5728380,5728529,5729809,5729660,5730390,5729110],"length":1,"stats":{"Line":4},"fn_name":null},{"line":117,"address":[5728568,5729848,5730029,5728749,5730369,5729089],"length":1,"stats":{"Line":2},"fn_name":null},{"line":118,"address":[5728669,5729949],"length":1,"stats":{"Line":2},"fn_name":null},{"line":119,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[5728711,5729991,5730036,5728839,5730119,5728756],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[5729452,5729282,5729420,5728503,5730700,5729783,5730732,5730562,5730395,5729115],"length":1,"stats":{"Line":4},"fn_name":null},{"line":125,"address":[5729258,5730538],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[5731742,5730848,5731278,5731312],"length":1,"stats":{"Line":3},"fn_name":"get\u003csecret_clan::model::player::Player\u003e"},{"line":129,"address":[5730882,5731346],"length":1,"stats":{"Line":3},"fn_name":null},{"line":130,"address":[5731561,5731097],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[5731104,5731872,5731786,5731776,5731568,5731882,5730949,5731413],"length":1,"stats":{"Line":14},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":132,"address":[5731429,5730965],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[5732272,5731968,5732332,5732028],"length":1,"stats":{"Line":2},"fn_name":"scan\u003csecret_clan::model::game::Game\u003e"},{"line":137,"address":[5732173,5732383,5732477,5732347,5732043,5731996,5732079,5732300],"length":1,"stats":{"Line":8},"fn_name":null},{"line":140,"address":[5732656,5732668,5732588,5732576],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":141,"address":[5732736,5732994,5732754,5732976],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":142,"address":[5733216,5732165,5733499,5733275,5732469,5733440],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":143,"address":[5733228,5733546,5733322,5733452,5733291,5733515],"length":1,"stats":{"Line":6},"fn_name":null},{"line":144,"address":[5733324,5733548],"length":1,"stats":{"Line":2},"fn_name":null},{"line":146,"address":[5733315,5733539],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[5733664,5733728],"length":1,"stats":{"Line":2},"fn_name":"total_count\u003csecret_clan::model::player::Player\u003e"},{"line":153,"address":[5733673,5733737],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[5733888,5733792],"length":1,"stats":{"Line":7},"fn_name":"flush\u003csecret_clan::model::player::Player\u003e"},{"line":157,"address":[5733900,5733984,5734037,5733804,5733993,5734005,5734025,5734016],"length":1,"stats":{"Line":21},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":160,"address":[5734944,5734576,5734048,5735840,5736656,5737104,5736736,5735392,5736288,5734131,5734496,5735441,5735027,5735760,5736208,5737153],"length":1,"stats":{"Line":14},"fn_name":"send_result\u003csecret_clan::model::player::Player,core::result::Result\u003ccore::option::Option\u003csecret_clan::model::player::Player\u003e, sled::result::Error\u003e\u003e"},{"line":161,"address":[5735456,5734519,5736170,5736618,5736679,5735855,5737129,5737168,5734906,5736303,5735417,5736751,5734461,5734146,5735357,5735717,5734591,5737066,5735042,5737429,5736231,5735783,5734071,5734967],"length":1,"stats":{"Line":32},"fn_name":null},{"line":162,"address":[5735108,5736369,5734212,5735588,5735206,5734755,5735921,5736915,5734657,5736467,5734310,5735502,5736019,5737300,5736817,5737214],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[5737525,5738032,5738085,5737472],"length":1,"stats":{"Line":5},"fn_name":"purge\u003csecret_clan::model::game::Game\u003e"},{"line":167,"address":[5737540,5738784,5738793,5738684,5738752,5738592,5738100,5738672,5738047,5738773,5738805,5738761,5737487,5738604],"length":1,"stats":{"Line":38},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":168,"address":[5737615,5737779,5737736,5738175,5738296,5738339],"length":1,"stats":{"Line":27},"fn_name":null},{"line":170,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":62,"coverable":74},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","mod.rs"],"content":"mod client;\nmod database;\n\nuse sled::IVec;\nuse std::{\n    clone::Clone,\n    collections::HashSet,\n    convert::TryFrom,\n    fmt::{self, Debug},\n};\nuse tokio::sync::oneshot;\n\npub use self::client::Client;\npub use self::database::Database;\n\npub trait Persist: Into\u003cIVec\u003e + TryFrom\u003cIVec\u003e + Clone + Debug + Send {\n    fn id(\u0026self) -\u003e \u0026str;\n}\n#[derive(Debug, Clone)]\npub struct QueryError {\n    message: String,\n}\n\nimpl QueryError {\n    pub fn new(message: \u0026str) -\u003e Self {\n        QueryError {\n            message: String::from(message),\n        }\n    }\n\n    pub fn from_sled(error: sled::Error) -\u003e Self {\n        QueryError {\n            message: error.to_string(),\n        }\n    }\n}\n\nimpl fmt::Display for QueryError {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter) -\u003e fmt::Result {\n        write!(f, \"invalid first item to double\")\n    }\n}\n\n#[derive(Derivative)]\n#[derivative(Debug)]\npub struct CommandData\u003cR: Debug\u003e {\n    id: String,\n    #[derivative(Debug = \"ignore\")]\n    responder: oneshot::Sender\u003cR\u003e,\n}\n\npub type ScanFunction\u003cT\u003e = Box\u003cdyn Fn(\u0026T) -\u003e bool + Send + Sync\u003e;\n\n#[derive(Derivative)]\n#[derivative(Debug)]\npub enum Command\u003cT: Persist\u003e {\n    Get {\n        key: String,\n        data: CommandData\u003cResult\u003cOption\u003cT\u003e, sled::Error\u003e\u003e,\n    },\n    Scan {\n        #[derivative(Debug = \"ignore\")]\n        scan_function: ScanFunction\u003cT\u003e,\n        data: CommandData\u003cResult\u003cHashSet\u003cString\u003e, sled::Error\u003e\u003e,\n    },\n    Persist {\n        value: T,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Remove {\n        key: String,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Purge {\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    RemoveBatch {\n        keys: HashSet\u003cString\u003e,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Count {\n        data: CommandData\u003cusize\u003e,\n    },\n}\n","traces":[{"line":25,"address":[5840720],"length":1,"stats":{"Line":0},"fn_name":"new"},{"line":27,"address":[5840737],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[5840800,5840841],"length":1,"stats":{"Line":0},"fn_name":"from_sled"},{"line":33,"address":[5840807],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[5840944],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":40,"address":[5840977],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","cleanup_games.rs"],"content":"use crate::{db::Client, model::Game, server::app_context::AppContext};\nuse chrono::{Duration, Utc};\nuse log::{debug, info, warn};\n\npub fn cleanup_games(ctx: \u0026'static AppContext) -\u003e impl Fn() {\n    move || {\n        tokio::task::spawn(async move {\n            execute_cleanup_games(ctx.db().games(), Duration::minutes(5)).await;\n        });\n    }\n}\n\nasync fn execute_cleanup_games(client: \u0026Client\u003cGame\u003e, duration: Duration) -\u003e bool {\n    let inactive_games = client\n        .scan(Box::new(is_inactive_game(duration)))\n        .await\n        .expect(\"Scanning games has failed\");\n\n    let inactive_count = inactive_games.len();\n    if inactive_count == 0 {\n        debug!(\"Removed no inactive games\");\n        false\n    } else {\n        match client.remove_batch(\u0026inactive_games).await {\n            Ok(_) =\u003e {\n                info!(\"Removed {} inactive games\", inactive_count);\n                true\n            }\n            Err(e) =\u003e {\n                warn!(\n                    \"Removing {} inactive games has failed: {:?}\",\n                    inactive_count, e\n                );\n                false\n            }\n        }\n    }\n}\n\n// Game is inactive if no admin is present and last activity happened five minutes ago\nfn is_inactive_game(duration: Duration) -\u003e impl Fn(\u0026Game) -\u003e bool {\n    let threshold = Utc::now().checked_sub_signed(duration).unwrap();\n    move |game: \u0026Game| match game.admin_id() {\n        Some(_) =\u003e false,\n        None =\u003e game.last_action_time().lt(\u0026threshold),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::execute_cleanup_games;\n    use crate::{\n        db::{Client, Database},\n        model::Game,\n    };\n    use chrono::Duration;\n\n    fn init_client() -\u003e Client\u003cGame\u003e {\n        let mut repo = Database::init(\"games\");\n\n        let sender = repo.sender();\n        tokio::task::spawn(async move {\n            repo.start_listening().await;\n        });\n\n        let client = Client::new(sender);\n\n        client\n    }\n\n    #[tokio::test]\n    async fn should_cleanup_games() {\n        let client = init_client();\n        let mut game = Game::new(\"admin\", \"TOKEN\");\n        game.remove_player(\"admin\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_none());\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n\n        let res = execute_cleanup_games(\u0026client, Duration::nanoseconds(1)).await;\n        assert!(res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_none());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_games_with_admin() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"TOKEN\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_some());\n\n        let res = execute_cleanup_games(\u0026client, Duration::nanoseconds(1)).await;\n        assert!(!res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_games_with_recent_action() {\n        let client = init_client();\n        let mut game = Game::new(\"admin\", \"TOKEN\");\n        game.remove_player(\"admin\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_none());\n\n        let res = execute_cleanup_games(\u0026client, Duration::minutes(5)).await;\n        assert!(!res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n    }\n}\n","traces":[{"line":5,"address":[6977360],"length":1,"stats":{"Line":0},"fn_name":"cleanup_games"},{"line":6,"address":[6977369],"length":1,"stats":{"Line":0},"fn_name":null},{"line":7,"address":[5766710,5766732,5766639,5766624],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":8,"address":[5766694],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[5926304,5926337],"length":1,"stats":{"Line":8},"fn_name":"execute_cleanup_games"},{"line":14,"address":[5769327],"length":1,"stats":{"Line":8},"fn_name":null},{"line":15,"address":[6042782],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[6043460,6043523],"length":1,"stats":{"Line":6},"fn_name":null},{"line":20,"address":[6045386,6043534,6043965],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[6043607,6043853,6043950,6043806,6043740],"length":1,"stats":{"Line":8},"fn_name":null},{"line":22,"address":[6043957],"length":1,"stats":{"Line":2},"fn_name":null},{"line":24,"address":[4522645],"length":1,"stats":{"Line":6},"fn_name":null},{"line":25,"address":[4841347],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4841805,4841566,4841605,4841442,4841646],"length":1,"stats":{"Line":4},"fn_name":null},{"line":27,"address":[4841846],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4841364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[4841859,4841942,4842313,4842225,4841995,4842066,4841396,4842036],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[4842062],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[4842354],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[5926384],"length":1,"stats":{"Line":1},"fn_name":"is_inactive_game"},{"line":42,"address":[5926400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[4843168,4843255,4843248,4843187,4843281],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}"},{"line":44,"address":[4843250,4843211],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4843236,4843266],"length":1,"stats":{"Line":2},"fn_name":null},{"line":58,"address":[6238688,6238762],"length":1,"stats":{"Line":1},"fn_name":"init_client"},{"line":59,"address":[6238705],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[6238790],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[6238805],"length":1,"stats":{"Line":9},"fn_name":null},{"line":63,"address":[5808102],"length":1,"stats":{"Line":7},"fn_name":null},{"line":66,"address":[6238990],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[5785722,5785783,5785536,5785813,5785557,5785840,5785689,5785758],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":73,"address":[6256590],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[6256605],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[6256662],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[5785673],"length":1,"stats":{"Line":5},"fn_name":null},{"line":77,"address":[5785742],"length":1,"stats":{"Line":7},"fn_name":null},{"line":84,"address":[5785767],"length":1,"stats":{"Line":5},"fn_name":null},{"line":86,"address":[5785797],"length":1,"stats":{"Line":5},"fn_name":null},{"line":87,"address":[6258776,6258735],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[5785824],"length":1,"stats":{"Line":5},"fn_name":null},{"line":92,"address":[5826096,5826280,5826340,5826247,5826313,5826117,5826367],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":94,"address":[6260574],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[6260589],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5826231],"length":1,"stats":{"Line":5},"fn_name":null},{"line":97,"address":[5826297],"length":1,"stats":{"Line":7},"fn_name":null},{"line":105,"address":[5826324],"length":1,"stats":{"Line":5},"fn_name":null},{"line":106,"address":[6262089,6262132],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5826351],"length":1,"stats":{"Line":5},"fn_name":null},{"line":111,"address":[5854504,5854320,5854341,5854564,5854537,5854591,5854471],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":113,"address":[6263726],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[6263741],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[6263798],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[5854455],"length":1,"stats":{"Line":5},"fn_name":null},{"line":117,"address":[5854521],"length":1,"stats":{"Line":7},"fn_name":null},{"line":125,"address":[5854548],"length":1,"stats":{"Line":5},"fn_name":null},{"line":126,"address":[6265277,6265320],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[5854575],"length":1,"stats":{"Line":5},"fn_name":null}],"covered":49,"coverable":57},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","cleanup_players.rs"],"content":"use crate::{model::Player, server::app_context::AppContext};\nuse chrono::{Duration, Utc};\nuse log::{debug, info, warn};\n\npub fn cleanup_players(ctx: \u0026'static AppContext) -\u003e impl Fn() {\n    move || {\n        tokio::spawn(async move {\n            execute_cleanup_players(ctx, Duration::minutes(1)).await;\n        });\n    }\n}\n\n// Player is active after one minute without an active connection\nfn is_inactive_player(duration: Duration) -\u003e impl Fn(\u0026Player) -\u003e bool {\n    let threshold = Utc::now().checked_sub_signed(duration).unwrap();\n\n    move |player: \u0026Player| player.last_action_time().lt(\u0026threshold)\n}\n\nasync fn execute_cleanup_players(ctx: \u0026AppContext, duration: Duration) -\u003e bool {\n    let inactive_players = ctx\n        .db()\n        .players()\n        .scan(Box::new(is_inactive_player(duration)))\n        .await\n        .expect(\"Scanning players has failed\");\n    let inactive_count = inactive_players.len();\n\n    // remove players from maybe existing game\n    for id in inactive_players.clone() {\n        let player = ctx.db().players().get(\u0026id).await;\n        if let Some(player) = player.expect(\"Reading player has failed\") {\n            let game = ctx.db().games().get(player.game_token()).await;\n            if let Some(mut game) = game.expect(\"Reading game has failed\") {\n                game.remove_player(\u0026id);\n                if ctx.db().games().persist(\u0026game).await.is_err() {\n                    warn!(\"Removing player has failed\");\n                }\n            }\n        }\n    }\n\n    // remove players\n    if inactive_count \u003e 0 {\n        match ctx.db().players().remove_batch(\u0026inactive_players).await {\n            Ok(_) =\u003e {\n                info!(\"Removed {} inactive players\", inactive_count);\n                true\n            }\n            Err(e) =\u003e {\n                warn!(\n                    \"Removing {} inactive players has failed: {:?}\",\n                    inactive_count, e\n                );\n                false\n            }\n        }\n    } else {\n        debug!(\"Removed no inactive players\");\n        false\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::execute_cleanup_players;\n    use crate::{\n        model::{Game, GameState, Player},\n        server::app_context::AppContext,\n    };\n    use chrono::Duration;\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_cleanup_player() {\n        let ctx = init_ctx();\n        let player = Player::new(\"GAME\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Persisting player failed\");\n        let game = Game::new(player.id(), \"GAME\");\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Persisting game failed\");\n\n        let res = execute_cleanup_players(\u0026ctx, Duration::nanoseconds(1)).await;\n        assert!(res);\n\n        assert!(ctx.db().players().get(player.id()).await.unwrap().is_none());\n        assert!(ctx\n            .db()\n            .games()\n            .get(player.game_token())\n            .await\n            .unwrap()\n            .expect(\"Game should still exist\")\n            .admin_id()\n            .is_none());\n        assert_eq!(\n            ctx.db()\n                .games()\n                .get(player.game_token())\n                .await\n                .unwrap()\n                .expect(\"Game should still exist\")\n                .state(),\n            \u0026GameState::Abandoned\n        );\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_player() {\n        let ctx = init_ctx();\n        let player = Player::new(\"GAME\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Persisting player failed\");\n\n        let res = execute_cleanup_players(\u0026ctx, Duration::minutes(1)).await;\n        assert!(!res);\n\n        assert!(ctx.db().players().get(player.id()).await.unwrap().is_some());\n    }\n}\n","traces":[{"line":5,"address":[5704576],"length":1,"stats":{"Line":0},"fn_name":"cleanup_players"},{"line":6,"address":[6128697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":7,"address":[5771312,5771420,5771327,5771398],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":8,"address":[5771382],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[6128720],"length":1,"stats":{"Line":1},"fn_name":"is_inactive_player"},{"line":15,"address":[5704624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[5704788],"length":1,"stats":{"Line":3},"fn_name":null},{"line":20,"address":[4508661,4508958,4509267,4509068,4508640,4509029,4508761,4508878,4509171],"length":1,"stats":{"Line":6},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":21,"address":[4508741],"length":1,"stats":{"Line":7},"fn_name":null},{"line":24,"address":[6445206],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[6445938,6446005],"length":1,"stats":{"Line":4},"fn_name":null},{"line":30,"address":[6446129,6446317,6449643,6446088,6446171,6446199,6446016],"length":1,"stats":{"Line":11},"fn_name":null},{"line":31,"address":[4508858],"length":1,"stats":{"Line":5},"fn_name":null},{"line":32,"address":[6447467,6447164],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4509009],"length":1,"stats":{"Line":5},"fn_name":null},{"line":34,"address":[6448398,6448194],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[6448544],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[4509114],"length":1,"stats":{"Line":5},"fn_name":null},{"line":37,"address":[6449312,6449352,6449179,6449496,6449399],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[6449656,6451786],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4509216],"length":1,"stats":{"Line":6},"fn_name":null},{"line":46,"address":[6450176],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[6450446,6450487,6450271,6450404,6450646],"length":1,"stats":{"Line":4},"fn_name":null},{"line":48,"address":[6450687],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[6450193],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[6450836,6450225,6451066,6451154,6450907,6450700,6450783,6450877],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[6450903],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[6451195],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[6451227,6451310,6451347,6449663,6451388,6451485],"length":1,"stats":{"Line":4},"fn_name":null},{"line":60,"address":[6451492],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6068976],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":74,"address":[6068984],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[5566309,5566304,5566365,5570779,5570983,5566336],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":79,"address":[5566446],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[5566461],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[5862871],"length":1,"stats":{"Line":6},"fn_name":null},{"line":83,"address":[5566592],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[5567000,5567043],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[5567129,5567205,5567101,5567320,5567265,5570884,5567394],"length":1,"stats":{"Line":6},"fn_name":null},{"line":89,"address":[5567183],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[5863013],"length":1,"stats":{"Line":5},"fn_name":null},{"line":94,"address":[5567991,5568020],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5568179,5568348,5570926,5568066,5568274,5568005,5568098,5568842,5568757],"length":1,"stats":{"Line":6},"fn_name":null},{"line":97,"address":[5569096,5568827,5568888,5568982,5569471,5569170,5569496,5569521,5569602,5569001,5570947],"length":1,"stats":{"Line":8},"fn_name":null},{"line":100,"address":[5568920],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[5570280,5570599,5570689,5570242,5570389],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[5570220,5569740,5569762,5569857,5569648,5569931,5569587,5570968,5570264],"length":1,"stats":{"Line":8},"fn_name":null},{"line":109,"address":[5569678],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[5574400,5572373,5572400,5574259,5572368,5572423],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":120,"address":[5572504],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[5572519],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[5572553,5572730,5572599,5572670,5572782,5574343,5572847],"length":1,"stats":{"Line":6},"fn_name":null},{"line":124,"address":[5572650],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[5574364,5573056,5573271,5573099,5573206,5573121],"length":1,"stats":{"Line":5},"fn_name":null},{"line":129,"address":[5573402,5573430],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[5574385,5573473,5574131,5573660,5573725,5573418,5573502,5574206,5573568],"length":1,"stats":{"Line":6},"fn_name":null}],"covered":47,"coverable":56},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","mod.rs"],"content":"mod cleanup_games;\nmod cleanup_players;\n\nuse self::cleanup_games::cleanup_games;\nuse self::cleanup_players::cleanup_players;\nuse crate::server::app_context::AppContext;\nuse clokwerk::{Scheduler, TimeUnits};\nuse std::{thread, time::Duration};\n\nconst JOB_INTERVAL: u32 = 60;\n\npub fn init_jobs(ctx: \u0026'static AppContext) {\n    tokio::task::spawn(async move {\n        let mut scheduler = Scheduler::new();\n\n        scheduler\n            .every(JOB_INTERVAL.seconds())\n            .run(cleanup_games(ctx));\n        scheduler\n            .every(JOB_INTERVAL.seconds())\n            .run(cleanup_players(ctx));\n\n        loop {\n            scheduler.run_pending();\n            thread::sleep(Duration::from_millis(100));\n        }\n    });\n}\n","traces":[{"line":12,"address":[6499184],"length":1,"stats":{"Line":0},"fn_name":"init_jobs"},{"line":13,"address":[4895598,4895232,4895249],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":14,"address":[4895287],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[4895327,4895396],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[4895303],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[4895381],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[4895498,4895445],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[4895419],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[4895483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[4895521,4895591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[4895525],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[4895551,4895569],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":12},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","lib.rs"],"content":"use jobs::init_jobs;\nuse server::{app_context::AppContext, run_server};\nuse tokio::runtime::Builder;\n\nmod config;\npub mod db;\npub mod jobs;\npub mod model;\npub mod server;\n\nextern crate chrono;\nextern crate envconfig;\nextern crate log;\n\n#[macro_use]\nextern crate derivative;\n\npub fn run_app() {\n    let mut rt = Builder::new()\n        .threaded_scheduler()\n        .enable_all()\n        .thread_name(\"sc\")\n        .build()\n        .expect(\"Creating runtime failed\");\n\n    rt.block_on(async {\n        let ctx: \u0026'static AppContext = Box::leak(Box::new(AppContext::init()));\n\n        init_jobs(ctx);\n\n        run_server(\u0026ctx).await;\n    });\n}\n","traces":[{"line":18,"address":[4498103,4498080],"length":1,"stats":{"Line":0},"fn_name":"run_app"},{"line":19,"address":[4498087,4498179,4498118],"length":1,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[4498312],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[4805041,4805182,4805147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[4805185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[4560038],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","model","game.rs"],"content":"use crate::db::Persist;\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sled::IVec;\nuse std::{collections::HashSet, convert::TryFrom};\n\n#[derive(Serialize, Deserialize, Clone, PartialEq, Eq, Debug)]\npub enum GameState {\n    Initialized,\n    Abandoned,\n    Started,\n}\n\n/// This struct defines a game session. Each valid game needs to have an admin who is responsible for defining game settings.\n/// The admin is also a player but currently not added redundantly to player_ids as well as admin_id.\n///\n/// Please note that each method here only mutates the struct state but still needs to be persisted to the database separately.\n///\n/// Example:\n/// ```no_run\n/// use secret_clan::{model::Game, db::{Database, Client}};\n/// let mut repo: Database\u003cGame\u003e = Database::init(\"test\");\n/// let sender = repo.sender();\n/// std::thread::spawn(move || {\n///     repo.start_listening();\n/// });\n/// std::thread::spawn(move || {\n///     async move {\n///         let client = Client::new(sender.clone());\n///         let mut game = Game::new(\"admin\", \"GAME\");\n///         game.start();\n///         let _ = client.persist(\u0026game).await;\n///     }\n/// });\n/// ```\n#[derive(Serialize, Deserialize, Clone, PartialEq, Eq, Debug)]\npub struct Game {\n    token: String,\n    creation_time: DateTime\u003cUtc\u003e,\n    last_action_time: DateTime\u003cUtc\u003e,\n    admin_id: Option\u003cString\u003e,\n    player_ids: HashSet\u003cString\u003e,\n    state: GameState,\n}\n\nimpl Game {\n    pub fn new(admin_id: \u0026str, token: \u0026str) -\u003e Self {\n        Game {\n            token: String::from(token).to_uppercase(),\n            creation_time: Utc::now(),\n            last_action_time: Utc::now(),\n            admin_id: Some(String::from(admin_id)),\n            player_ids: HashSet::new(),\n            state: GameState::Initialized,\n        }\n    }\n\n    pub fn token(\u0026self) -\u003e \u0026str {\n        \u0026self.token\n    }\n\n    pub fn player_ids(\u0026self) -\u003e \u0026HashSet\u003cString\u003e {\n        \u0026self.player_ids\n    }\n\n    pub fn admin_id(\u0026self) -\u003e \u0026Option\u003cString\u003e {\n        \u0026self.admin_id\n    }\n\n    pub fn last_action_time(\u0026self) -\u003e \u0026DateTime\u003cUtc\u003e {\n        \u0026self.last_action_time\n    }\n\n    pub fn state(\u0026self) -\u003e \u0026GameState {\n        \u0026self.state\n    }\n\n    pub fn add_player(\u0026mut self, player_id: \u0026str) {\n        match self.admin_id {\n            Some(_) =\u003e {\n                self.player_ids.insert(String::from(player_id));\n            }\n            None =\u003e self.admin_id = Some(String::from(player_id)),\n        }\n    }\n\n    pub fn remove_player(\u0026mut self, player_id: \u0026str) {\n        if self.player_ids.contains(player_id) {\n            self.player_ids.remove(player_id);\n        } else if self\n            .admin_id\n            .to_owned()\n            .filter(|id| id == player_id)\n            .is_some()\n        {\n            if let Some(next_player_id) = self.player_ids.iter().next().map(String::from) {\n                self.admin_id = Some(String::from(\u0026next_player_id));\n                self.player_ids.remove(\u0026next_player_id);\n            } else {\n                self.admin_id = None;\n                self.state = GameState::Abandoned\n            }\n        } else {\n            // game is already abandoned or requesting user is no admin or player\n        }\n    }\n\n    pub fn start(\u0026mut self) {\n        self.state = GameState::Started;\n    }\n}\n\nimpl Persist for Game {\n    fn id(\u0026self) -\u003e \u0026str {\n        self.token()\n    }\n}\n\nimpl Into\u003cIVec\u003e for Game {\n    fn into(self) -\u003e IVec {\n        IVec::from(bincode::serialize(\u0026self).unwrap())\n    }\n}\n\nimpl TryFrom\u003cIVec\u003e for Game {\n    type Error = bincode::Error;\n    fn try_from(bytes: IVec) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let vec: Vec\u003cu8\u003e = bytes.to_vec();\n\n        bincode::deserialize(\u0026vec)\n    }\n}\n","traces":[{"line":47,"address":[5524371,5524288],"length":1,"stats":{"Line":5},"fn_name":"new"},{"line":49,"address":[5524330,5524391],"length":1,"stats":{"Line":10},"fn_name":null},{"line":50,"address":[5524447],"length":1,"stats":{"Line":5},"fn_name":null},{"line":51,"address":[5524562,5524525],"length":1,"stats":{"Line":12},"fn_name":null},{"line":52,"address":[5524632],"length":1,"stats":{"Line":6},"fn_name":null},{"line":53,"address":[5524671],"length":1,"stats":{"Line":6},"fn_name":null},{"line":58,"address":[5524960],"length":1,"stats":{"Line":1},"fn_name":"token"},{"line":59,"address":[5524969],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[5525008],"length":1,"stats":{"Line":1},"fn_name":"player_ids"},{"line":63,"address":[5525013],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[5525040],"length":1,"stats":{"Line":1},"fn_name":"admin_id"},{"line":67,"address":[5525045],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[5525072],"length":1,"stats":{"Line":1},"fn_name":"last_action_time"},{"line":71,"address":[5525077],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[5525104],"length":1,"stats":{"Line":1},"fn_name":"state"},{"line":75,"address":[5525109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":78,"address":[5525349,5525136],"length":1,"stats":{"Line":1},"fn_name":"add_player"},{"line":79,"address":[5525396,5525221,5525273],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[5525161],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[5525228],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[5525275,5525199,5525326,5525364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[5525424,5525496],"length":1,"stats":{"Line":1},"fn_name":"remove_player"},{"line":88,"address":[5525578,5526002,5525515,5525449],"length":1,"stats":{"Line":4},"fn_name":null},{"line":89,"address":[5525553],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[5525593,5526272,5525665,5525526],"length":1,"stats":{"Line":4},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[5525583],"length":1,"stats":{"Line":3},"fn_name":null},{"line":96,"address":[5525997,5525681,5525810],"length":1,"stats":{"Line":3},"fn_name":null},{"line":97,"address":[5526160,5525863],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[5526235],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[5525772,5526012],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[5526096],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5526448],"length":1,"stats":{"Line":1},"fn_name":"start"},{"line":109,"address":[5526457],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[5526480],"length":1,"stats":{"Line":1},"fn_name":"id"},{"line":115,"address":[5526489],"length":1,"stats":{"Line":1},"fn_name":null},{"line":120,"address":[5526528,5526569],"length":1,"stats":{"Line":6},"fn_name":"into"},{"line":121,"address":[5526581,5526622,5526535],"length":1,"stats":{"Line":18},"fn_name":null},{"line":127,"address":[5526756,5526688],"length":1,"stats":{"Line":3},"fn_name":"try_from"},{"line":128,"address":[5526700],"length":1,"stats":{"Line":2},"fn_name":null},{"line":130,"address":[5526781],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":39,"coverable":41},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","model","player.rs"],"content":"use crate::db::Persist;\nuse chrono::{DateTime, Utc};\nuse names::Generator;\nuse nanoid::nanoid;\nuse serde::{Deserialize, Serialize};\nuse sled::IVec;\nuse std::hash::Hash;\n\nfn generate_random_name() -\u003e String {\n    Generator::default().next().unwrap()\n}\n\n#[derive(Serialize, Deserialize, Clone, Hash, PartialEq, Eq, Derivative)]\n#[derivative(Debug)]\npub struct Player {\n    id: String,\n    name: String,\n    game_token: String,\n    #[derivative(Debug = \"ignore\")]\n    user_token: String,\n    creation_time: DateTime\u003cUtc\u003e,\n    last_action_time: DateTime\u003cUtc\u003e,\n}\n\nimpl Player {\n    pub fn new(game_token: \u0026str) -\u003e Self {\n        Player {\n            id: nanoid!(),\n            name: generate_random_name(),\n            game_token: String::from(game_token),\n            user_token: String::from(\"\"),\n            creation_time: Utc::now(),\n            last_action_time: Utc::now(),\n        }\n    }\n\n    pub fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    pub fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    pub fn set_name(\u0026mut self, name: \u0026str) {\n        if !name.is_empty() {\n            self.name = String::from(name);\n        }\n    }\n\n    pub fn game_token(\u0026self) -\u003e \u0026str {\n        \u0026self.game_token\n    }\n\n    pub fn update_token(\u0026mut self, new_token: \u0026str) {\n        self.user_token = String::from(new_token);\n    }\n\n    pub fn heartbeat(\u0026mut self) {\n        self.last_action_time = Utc::now();\n    }\n\n    pub fn last_action_time(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.last_action_time\n    }\n}\n\nimpl Persist for Player {\n    fn id(\u0026self) -\u003e \u0026str {\n        self.id()\n    }\n}\n\nimpl Into\u003cIVec\u003e for Player {\n    fn into(self) -\u003e IVec {\n        IVec::from(bincode::serialize(\u0026self).unwrap())\n    }\n}\n\nimpl From\u003cIVec\u003e for Player {\n    fn from(bytes: IVec) -\u003e Player {\n        let vec: Vec\u003cu8\u003e = bytes.to_vec();\n        bincode::deserialize(\u0026vec).unwrap()\n    }\n}\n","traces":[{"line":9,"address":[5926768],"length":1,"stats":{"Line":1},"fn_name":"generate_random_name"},{"line":10,"address":[5190183],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[5190365,5190272],"length":1,"stats":{"Line":1},"fn_name":"new"},{"line":28,"address":[5190312],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[5190385],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[5190407],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[5190427],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[5190466,5190505],"length":1,"stats":{"Line":2},"fn_name":null},{"line":33,"address":[5927149,5927191],"length":1,"stats":{"Line":2},"fn_name":null},{"line":37,"address":[5927520],"length":1,"stats":{"Line":1},"fn_name":"id"},{"line":38,"address":[5927529],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[5190976],"length":1,"stats":{"Line":1},"fn_name":"name"},{"line":42,"address":[5190985],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[5191024,5191156],"length":1,"stats":{"Line":1},"fn_name":"set_name"},{"line":46,"address":[5191200,5191048],"length":1,"stats":{"Line":2},"fn_name":null},{"line":47,"address":[5191168,5191133,5191085],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[5191216],"length":1,"stats":{"Line":1},"fn_name":"game_token"},{"line":52,"address":[5191225],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[5927856,5927936],"length":1,"stats":{"Line":2},"fn_name":"update_token"},{"line":56,"address":[5927875,5927948],"length":1,"stats":{"Line":4},"fn_name":null},{"line":59,"address":[5928000],"length":1,"stats":{"Line":1},"fn_name":"heartbeat"},{"line":60,"address":[5928009],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[5928080],"length":1,"stats":{"Line":1},"fn_name":"last_action_time"},{"line":64,"address":[5928089],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[5928128],"length":1,"stats":{"Line":1},"fn_name":"id"},{"line":70,"address":[5928137],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[5928176,5928217],"length":1,"stats":{"Line":1},"fn_name":"into"},{"line":76,"address":[5928270,5928229,5928183],"length":1,"stats":{"Line":3},"fn_name":null},{"line":81,"address":[5928336,5928407],"length":1,"stats":{"Line":1},"fn_name":"from"},{"line":82,"address":[5928351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[5928500,5928435],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":31,"coverable":31},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","app_context.rs"],"content":"use super::logger::init_logger;\nuse crate::{\n    config::AppConfig,\n    db::{Client, Database},\n    model::{Game, Player},\n};\nuse envconfig::Envconfig;\n\npub struct DbClients {\n    games: Client\u003cGame\u003e,\n    players: Client\u003cPlayer\u003e,\n}\n\nimpl DbClients {\n    pub fn init() -\u003e DbClients {\n        let mut games_repo = Database::init(\"games\");\n        let games_sender = games_repo.sender();\n        tokio::task::spawn(async move {\n            games_repo.start_listening().await;\n        });\n        let mut players_repo = Database::init(\"players\");\n        let players_sender = players_repo.sender();\n        tokio::task::spawn(async move {\n            players_repo.start_listening().await;\n        });\n\n        DbClients {\n            games: Client::new(games_sender),\n            players: Client::new(players_sender),\n        }\n    }\n\n    pub fn games(\u0026self) -\u003e \u0026Client\u003cGame\u003e {\n        \u0026self.games\n    }\n\n    pub fn players(\u0026self) -\u003e \u0026Client\u003cPlayer\u003e {\n        \u0026self.players\n    }\n}\n\npub struct AppContext {\n    db: DbClients,\n    config: AppConfig,\n}\n\nimpl AppContext {\n    pub fn init() -\u003e AppContext {\n        let config = AppConfig::init_from_env().expect(\"Loading server config failed\");\n\n        init_logger(\u0026config);\n\n        let db = DbClients::init();\n\n        AppContext { db, config }\n    }\n\n    pub fn db(\u0026self) -\u003e \u0026DbClients {\n        \u0026self.db\n    }\n\n    pub fn config(\u0026self) -\u003e \u0026AppConfig {\n        \u0026self.config\n    }\n\n    pub fn is_dev(\u0026self) -\u003e bool {\n        cfg!(debug_assertions)\n    }\n}\n","traces":[{"line":15,"address":[6830832,6830923],"length":1,"stats":{"Line":1},"fn_name":"init"},{"line":16,"address":[6978449],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[6830938],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[6978565],"length":1,"stats":{"Line":7},"fn_name":null},{"line":19,"address":[4548566],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[6978750],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[6831202],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[6129767,6130101,6129687,6129664],"length":1,"stats":{"Line":10},"fn_name":"{{closure}}"},{"line":24,"address":[6129889,6129845,6129954,6129755,6130086,6129794],"length":1,"stats":{"Line":6},"fn_name":null},{"line":28,"address":[6979017],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[6831513],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[6979520],"length":1,"stats":{"Line":1},"fn_name":"games"},{"line":34,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[6831984],"length":1,"stats":{"Line":1},"fn_name":"players"},{"line":38,"address":[6831989],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[6832052,6832016],"length":1,"stats":{"Line":1},"fn_name":"init"},{"line":49,"address":[6832026,6832081],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[6832123],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[6832130],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[6832352],"length":1,"stats":{"Line":1},"fn_name":"db"},{"line":59,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[6832368],"length":1,"stats":{"Line":1},"fn_name":"config"},{"line":63,"address":[6832373],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[6832400],"length":1,"stats":{"Line":0},"fn_name":"is_dev"}],"covered":21,"coverable":24},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","auth.rs"],"content":"use super::app_context::AppContext;\nuse crate::model::Player;\nuse hmac::{Hmac, NewMac};\nuse jwt::{AlgorithmType, Error, Header, SignWithKey, Token, VerifyWithKey};\nuse sha2::Sha256;\nuse std::collections::BTreeMap;\nuse std::result::Result;\n\npub fn generate_jwt_token(player: \u0026Player, secret: \u0026str) -\u003e String {\n    let key = init_key(secret);\n    let header = Header {\n        algorithm: AlgorithmType::Hs256,\n        ..Default::default()\n    };\n    let mut claims = BTreeMap::new();\n    claims.insert(String::from(\"sub\"), String::from(player.id()));\n    claims.insert(String::from(\"name\"), String::from(player.name()));\n    claims.insert(String::from(\"game\"), String::from(player.game_token()));\n\n    let jwt_token = Token::new(header, claims).sign_with_key(\u0026key).unwrap();\n\n    String::from(jwt_token.as_str())\n}\n\npub fn extract_verified_token(\n    token_str: \u0026str,\n    secret: \u0026str,\n) -\u003e Result\u003cToken\u003cHeader, BTreeMap\u003cString, String\u003e, jwt::token::Verified\u003e, Error\u003e {\n    let key = init_key(secret);\n    let raw_token: \u0026str = \u0026token_str.replace(\"Bearer \", \"\");\n    let token: Result\u003cToken\u003cHeader, BTreeMap\u003cString, String\u003e, jwt::token::Verified\u003e, Error\u003e =\n        VerifyWithKey::verify_with_key(raw_token, \u0026key);\n\n    token\n}\n\npub fn extract_verified_id(authorization: \u0026str, ctx: \u0026AppContext) -\u003e Option\u003cString\u003e {\n    extract_verified_token(\u0026authorization, \u0026ctx.config().auth_secret)\n        .ok()\n        .and_then(|token| token.claims().get(\"sub\").map(String::from))\n}\n\nfn init_key(secret: \u0026str) -\u003e Hmac\u003cSha256\u003e {\n    Hmac::new_varkey(secret.as_bytes()).unwrap()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{extract_verified_id, extract_verified_token, generate_jwt_token};\n    use crate::{model::Player, server::app_context::AppContext};\n\n    const SECRET: \u0026str = \"super-secret\";\n\n    #[test]\n    fn should_create_token() {\n        let player = Player::new(\"game\");\n        let token = generate_jwt_token(\u0026player, SECRET);\n\n        // payload contains dynamic ID of user, so we can't check the payload for equalness\n        assert!(token.starts_with(\"eyJhbGciOiJIUzI1NiJ9\"));\n    }\n\n    #[test]\n    fn should_verify_token() {\n        let token = extract_verified_token(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX4\", \"super-secret\");\n\n        assert_eq!(token.unwrap().claims().get(\"name\").unwrap(), \"Random Dude\");\n    }\n\n    #[tokio::test]\n    async fn should_extract_verified_id() {\n        let ctx = AppContext::init();\n        let id = extract_verified_id(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX4\", \u0026ctx);\n\n        assert_eq!(id.unwrap(), \"MllJ7oeCY4RGw2M6tIHBZ\");\n    }\n\n    #[tokio::test]\n    async fn should_not_extract_unverified_id() {\n        let ctx = AppContext::init();\n        let id = extract_verified_id(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX3\", \u0026ctx);\n\n        assert!(id.is_none());\n    }\n\n    #[test]\n    fn should_create_and_verify_token() {\n        let player = Player::new(\"game\");\n        let token_str = generate_jwt_token(\u0026player, SECRET);\n        let token = extract_verified_token(\u0026token_str, SECRET);\n        assert!(!token.unwrap().claims().get(\"name\").unwrap().is_empty());\n    }\n\n    #[test]\n    fn should_fail_to_verify_token() {\n        let token = extract_verified_token(\"eyJhbGciOiJIUzI1NiJ9.XYZ.ABC\", \"super-secret\");\n\n        assert!(token.is_err());\n    }\n}\n","traces":[{"line":9,"address":[6077664,6077774],"length":1,"stats":{"Line":1},"fn_name":"generate_jwt_token"},{"line":10,"address":[6077698],"length":1,"stats":{"Line":1},"fn_name":null},{"line":15,"address":[6077892],"length":1,"stats":{"Line":1},"fn_name":null},{"line":16,"address":[4399289,4398470],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[4399325,4398634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[6078266,6078867],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[6078430],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[6078611],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[6079024,6079107],"length":1,"stats":{"Line":1},"fn_name":"extract_verified_token"},{"line":29,"address":[6079066],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[6079133],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[6079240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[6079360],"length":1,"stats":{"Line":1},"fn_name":"extract_verified_id"},{"line":38,"address":[6079388],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[5926615,5926608],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":43,"address":[6079552],"length":1,"stats":{"Line":1},"fn_name":"init_key"},{"line":44,"address":[6079645],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[6131858,6131824],"length":1,"stats":{"Line":3},"fn_name":"should_create_token"},{"line":56,"address":[6131838],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[6131873],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[6132024,6131913,6131942,6131999],"length":1,"stats":{"Line":3},"fn_name":null},{"line":64,"address":[6132128,6132178],"length":1,"stats":{"Line":3},"fn_name":"should_verify_token"},{"line":65,"address":[6132149],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[6132200],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[6132848,6132855],"length":1,"stats":{"Line":7},"fn_name":"should_extract_verified_id"},{"line":72,"address":[6843780],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6843787],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[6844254,6843998,6844343,6843906,6843819,6844024],"length":1,"stats":{"Line":4},"fn_name":null},{"line":78,"address":[6133168,6133175],"length":1,"stats":{"Line":7},"fn_name":"should_not_extract_unverified_id"},{"line":80,"address":[6844820],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[6844827],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[6844890,6844861,6844931],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[6133488,6133522],"length":1,"stats":{"Line":3},"fn_name":"should_create_and_verify_token"},{"line":88,"address":[6133502],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[6133537],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[6133606,6133577],"length":1,"stats":{"Line":2},"fn_name":null},{"line":91,"address":[6133660,6133913],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[6134032,6134076],"length":1,"stats":{"Line":3},"fn_name":"should_fail_to_verify_token"},{"line":96,"address":[6134050],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[6134140,6134093],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":40,"coverable":40},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","endpoints","games.rs"],"content":"use crate::{\n    model::{Game, Player},\n    server::{\n        app_context::AppContext,\n        auth::extract_verified_id,\n        auth::generate_jwt_token,\n        reply::{reply_error, reply_error_with_details, reply_success},\n    },\n};\nuse log::debug;\nuse rand::{distributions::Alphanumeric, thread_rng, Rng};\nuse serde::Serialize;\nuse std::{convert::Infallible, iter};\nuse warp::hyper::StatusCode;\n\n// this value determines the findability of a game and is a tradeoff between security and user friendliness\n// 5 tokens mean a chance of finding a random game of 1:60466176.\nconst TOKEN_CHARS_COUNT: usize = 5;\n\npub async fn get_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match extract_verified_id(authorization, ctx) {\n        Some(token) =\u003e match ctx\n            .db()\n            .games()\n            .get(game_token)\n            .await\n            .expect(\"Reading game has failed\")\n        {\n            Some(game) =\u003e {\n                match ctx\n                    .db()\n                    .players()\n                    .get(\u0026token)\n                    .await\n                    .expect(\"Reading player has failed\")\n                    .filter(|player| {\n                        game.player_ids().contains(player.id())\n                            || game.admin_id().is_some()\n                                \u0026\u0026 game.admin_id().as_ref().unwrap() == player.id()\n                    }) {\n                    Some(mut player) =\u003e {\n                        player.heartbeat();\n                        ctx.db()\n                            .players()\n                            .persist(\u0026player)\n                            .await\n                            .expect(\"Persisting heartbeat has failed\");\n                        Ok(warp::reply::with_status(\n                            warp::reply::json(\u0026game),\n                            StatusCode::OK,\n                        ))\n                    }\n                    None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n                }\n            }\n            None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n        },\n        None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n    }\n}\n\npub async fn get_games_count_filter(ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    #[derive(Serialize)]\n    struct GetGamesResponse {\n        total: usize,\n    };\n\n    let total = ctx\n        .db()\n        .games()\n        .total_count()\n        .await\n        .expect(\"Reading games count has failed\");\n\n    Ok(warp::reply::with_status(\n        warp::reply::json(\u0026GetGamesResponse { total }),\n        StatusCode::OK,\n    ))\n}\n\npub async fn create_game_filter(ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    fn generate_game_token() -\u003e String {\n        let mut rng = thread_rng();\n\n        String::from_utf8(\n            iter::repeat(())\n                .map(|()| rng.sample(Alphanumeric).to_ascii_uppercase())\n                .take(TOKEN_CHARS_COUNT)\n                .collect(),\n        )\n        .unwrap()\n    }\n\n    let game_token = generate_game_token();\n    let player = create_new_player(\u0026game_token, ctx).await;\n    let new_game = create_new_game(player.id(), \u0026game_token, ctx).await;\n\n    #[derive(Serialize)]\n    struct CreateGameReponse {\n        game: Game,\n        admin: Player,\n    };\n\n    Ok(warp::reply::with_status(\n        warp::reply::json(\u0026CreateGameReponse {\n            game: new_game,\n            admin: player,\n        }),\n        StatusCode::CREATED,\n    ))\n}\n\npub async fn attend_game_filter(\n    game_token: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e {\n            let player = create_new_player(\u0026game_token, ctx).await;\n\n            game.add_player(player.id());\n            match ctx.db().games().persist(\u0026game).await {\n                Ok(_) =\u003e Ok(warp::reply::with_status(\n                    warp::reply::json(\u0026player),\n                    StatusCode::OK,\n                )),\n                Err(_) =\u003e Ok(reply_error(StatusCode::INTERNAL_SERVER_ERROR)),\n            }\n        }\n        None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n    }\n}\n\npub async fn leave_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e match extract_verified_id(authorization, ctx) {\n            Some(player_id) =\u003e {\n                game.remove_player(\u0026player_id);\n                match ctx.db().games().persist(\u0026game).await {\n                    Ok(_) =\u003e Ok(reply_success(StatusCode::OK)),\n                    Err(_) =\u003e Ok(reply_error_with_details(\n                        StatusCode::INTERNAL_SERVER_ERROR,\n                        \"Writing player has failed\",\n                    )),\n                }\n            }\n            None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n    }\n}\n\npub async fn start_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e match extract_verified_id(authorization, ctx)\n            .filter(|_| game.admin_id().is_some())\n            .filter(|id| id == game.admin_id().as_ref().unwrap())\n        {\n            Some(_) =\u003e {\n                game.start();\n                match ctx.db().games().persist(\u0026game).await {\n                    Ok(_) =\u003e Ok(reply_error(StatusCode::OK)),\n                    Err(_) =\u003e Ok(reply_error(StatusCode::INTERNAL_SERVER_ERROR)),\n                }\n            }\n            None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n    }\n}\n\nasync fn create_new_game(admin_id: \u0026str, token: \u0026str, ctx: \u0026AppContext) -\u003e Game {\n    let new_game = Game::new(admin_id, token);\n    let new_token = new_game.token();\n    ctx.db()\n        .games()\n        .persist(\u0026new_game)\n        .await\n        .expect(\"Creating game failed\");\n    debug!(\"Created game with token {}\", new_token);\n\n    new_game\n}\n\nasync fn create_new_player(game_token: \u0026str, ctx: \u0026AppContext) -\u003e Player {\n    let mut player = Player::new(game_token);\n    let user_token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n    player.update_token(\u0026user_token);\n\n    ctx.db()\n        .players()\n        .persist(\u0026player)\n        .await\n        .expect(\"Creating player failed\");\n    debug!(\"Created player with token {}\", player.id());\n\n    player\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{\n        attend_game_filter, create_game_filter, get_game_filter, leave_game_filter,\n        start_game_filter,\n    };\n    use crate::{\n        model::{Game, GameState, Player},\n        server::{app_context::AppContext, auth::generate_jwt_token},\n    };\n    use warp::{hyper::StatusCode, Reply};\n\n    const GAME_TOKEN: \u0026str = \"ACDEF\";\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_not_get_game_unauthorized() {\n        let ctx = init_ctx();\n\n        let reply = get_game_filter(\"invalid\", \"auth\", \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n    }\n\n    #[tokio::test]\n    async fn should_not_get_unknown_game() {\n        let ctx = init_ctx();\n\n        let token = generate_jwt_token(\u0026Player::new(\"game\"), \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(\"game\", \u0026token, \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_get_game_for_admin() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        ctx.db()\n            .players()\n            .persist(\u0026admin)\n            .await\n            .expect(\"Writing player failed\");\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(admin.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_get_game_for_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(GAME_TOKEN);\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let mut game = Game::new(\"admin\", GAME_TOKEN);\n        game.add_player(player.id());\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_get_game_and_send_heartbeat() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n        let first_time = admin.last_action_time();\n        ctx.db()\n            .players()\n            .persist(\u0026admin)\n            .await\n            .expect(\"Writing admin failed\");\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(admin.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_admin = ctx\n            .db()\n            .players()\n            .get(admin.id())\n            .await\n            .expect(\"Reading admin failed\");\n        assert!(updated_admin.unwrap().last_action_time().gt(\u0026first_time));\n    }\n\n    #[tokio::test]\n    async fn should_create_new_game() {\n        let ctx = init_ctx();\n\n        let reply = create_game_filter(\u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::CREATED);\n    }\n\n    #[tokio::test]\n    async fn should_not_attend_unknown_game() {\n        let ctx = init_ctx();\n\n        let reply = attend_game_filter(\"test\", \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_attend_game() {\n        let ctx = init_ctx();\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(\"admin\", GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = attend_game_filter(GAME_TOKEN, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_leave_game() {\n        let ctx = init_ctx();\n\n        let mut game = Game::new(\"admin\", GAME_TOKEN);\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n        game.add_player(player.id());\n\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n        assert!(game.player_ids().contains(player.id()));\n\n        let reply = leave_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\");\n        assert!(!updated_game.unwrap().player_ids().contains(player.id()));\n    }\n\n    #[tokio::test]\n    async fn should_leave_game_and_select_new_admin() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        let mut game = Game::new(admin.id(), GAME_TOKEN);\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n        game.add_player(player.id());\n\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n        assert_eq!(game.admin_id().as_ref().unwrap(), admin.id());\n\n        let reply = leave_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\")\n            .unwrap();\n        assert!(updated_game.player_ids().is_empty());\n        assert_eq!(updated_game.admin_id().as_ref().unwrap(), player.id());\n    }\n\n    #[tokio::test]\n    async fn should_start_game() {\n        let ctx = init_ctx();\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(player.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = start_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\");\n        assert_eq!(updated_game.unwrap().state(), \u0026GameState::Started);\n    }\n\n    #[tokio::test]\n    async fn should_not_start_game() {\n        let ctx = init_ctx();\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(\"admin\", GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = start_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\");\n        assert_eq!(updated_game.unwrap().state(), \u0026GameState::Initialized);\n    }\n\n    #[tokio::test]\n    async fn should_not_start_unknown_game() {\n        let ctx = init_ctx();\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = start_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n}\n","traces":[{"line":20,"address":[4834672],"length":1,"stats":{"Line":1},"fn_name":"get_game_filter"},{"line":25,"address":[4807507,4807664],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4808355,4810478,4807869,4807776,4807924,4808003,4807584,4807674],"length":1,"stats":{"Line":6},"fn_name":null},{"line":33,"address":[4808295,4808365],"length":1,"stats":{"Line":2},"fn_name":null},{"line":34,"address":[4808471,4810499,4808712,4809213,4808576,4808782,4809322,4808622],"length":1,"stats":{"Line":6},"fn_name":null},{"line":37,"address":[4808552],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[4809191,4806992],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":41,"address":[4807098,4807184,4807012],"length":1,"stats":{"Line":3},"fn_name":null},{"line":42,"address":[4807328,4807060,4807315,4807205,4807149],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":43,"address":[4807168,4807230],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4809332,4809264],"length":1,"stats":{"Line":2},"fn_name":null},{"line":46,"address":[4809458],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4809480,4810520,4809771,4809649,4809569,4809701,4809530],"length":1,"stats":{"Line":6},"fn_name":null},{"line":49,"address":[4809563],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4810049,4810010],"length":1,"stats":{"Line":2},"fn_name":null},{"line":53,"address":[4809977],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4810114,4809295],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[4810188,4808328],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[4807637,4810259],"length":1,"stats":{"Line":2},"fn_name":null},{"line":66,"address":[4586192,4586207,4586280],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":72,"address":[4586262],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[4811874,4811913],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[4811834],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[4814629,4814563,4812362,4812336],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}"},{"line":86,"address":[4834912,4834945],"length":1,"stats":{"Line":1},"fn_name":"generate_game_token"},{"line":87,"address":[4834932],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[4834960,4834984,4835021],"length":1,"stats":{"Line":3},"fn_name":null},{"line":91,"address":[4815040,4815049],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":98,"address":[4812458],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[4812762,4812645,4812603,4814593,4812692,4812484],"length":1,"stats":{"Line":5},"fn_name":null},{"line":100,"address":[4547589],"length":1,"stats":{"Line":6},"fn_name":null},{"line":108,"address":[4814361],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[4814030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[4813792],"length":1,"stats":{"Line":1},"fn_name":null},{"line":111,"address":[4813928],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[4835168],"length":1,"stats":{"Line":1},"fn_name":"attend_game_filter"},{"line":121,"address":[4567133],"length":1,"stats":{"Line":5},"fn_name":null},{"line":124,"address":[4815327],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[4815861,4815931],"length":1,"stats":{"Line":2},"fn_name":null},{"line":129,"address":[4567205],"length":1,"stats":{"Line":4},"fn_name":null},{"line":131,"address":[4816623],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[4567291],"length":1,"stats":{"Line":6},"fn_name":null},{"line":133,"address":[4817316,4817234,4817396],"length":1,"stats":{"Line":3},"fn_name":null},{"line":134,"address":[4817288],"length":1,"stats":{"Line":1},"fn_name":null},{"line":137,"address":[4817251,4817464],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[4815894,4817610],"length":1,"stats":{"Line":2},"fn_name":null},{"line":144,"address":[4835264],"length":1,"stats":{"Line":1},"fn_name":"leave_game_filter"},{"line":149,"address":[4565530],"length":1,"stats":{"Line":5},"fn_name":null},{"line":152,"address":[4818681],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[4819258,4819492,4819188],"length":1,"stats":{"Line":2},"fn_name":null},{"line":157,"address":[4819411,4819502],"length":1,"stats":{"Line":2},"fn_name":null},{"line":158,"address":[4819544],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[4565628],"length":1,"stats":{"Line":7},"fn_name":null},{"line":160,"address":[4820058,4820113],"length":1,"stats":{"Line":4},"fn_name":null},{"line":161,"address":[4820224,4820075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[4820342,4819465],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[4820413,4819221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[4835376],"length":1,"stats":{"Line":1},"fn_name":"start_game_filter"},{"line":178,"address":[4579066],"length":1,"stats":{"Line":5},"fn_name":null},{"line":181,"address":[4821609],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[4822104,4822441,4822571,4823271,4822344,4822174,4823337],"length":1,"stats":{"Line":6},"fn_name":null},{"line":186,"address":[4821198,4822330,4821184],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":187,"address":[4821262,4822419,4821248],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":189,"address":[4822487],"length":1,"stats":{"Line":1},"fn_name":null},{"line":190,"address":[4822581],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[4579156],"length":1,"stats":{"Line":7},"fn_name":null},{"line":192,"address":[4823030,4823073],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[4823184,4823047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[4823273,4822544],"length":1,"stats":{"Line":2},"fn_name":null},{"line":198,"address":[4823400,4822137],"length":1,"stats":{"Line":2},"fn_name":null},{"line":202,"address":[4577543,4577408,4577423],"length":1,"stats":{"Line":6},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":203,"address":[4824343],"length":1,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[4824413,4824503],"length":1,"stats":{"Line":2},"fn_name":null},{"line":205,"address":[4577500],"length":1,"stats":{"Line":6},"fn_name":null},{"line":207,"address":[4824599],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[4825161,4825202,4825127,4825044,4825367,4825001],"length":1,"stats":{"Line":4},"fn_name":null},{"line":212,"address":[4825416],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[4519920,4519935,4520154,4520006],"length":1,"stats":{"Line":8},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":216,"address":[4826070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":217,"address":[4826131,4826225,4826309],"length":1,"stats":{"Line":5},"fn_name":null},{"line":218,"address":[4826381],"length":1,"stats":{"Line":2},"fn_name":null},{"line":220,"address":[4520067],"length":1,"stats":{"Line":9},"fn_name":null},{"line":222,"address":[4826552],"length":1,"stats":{"Line":2},"fn_name":null},{"line":225,"address":[4827117,4827158,4827325,4827000,4826957,4827393,4827083],"length":1,"stats":{"Line":7},"fn_name":null},{"line":227,"address":[4827442],"length":1,"stats":{"Line":2},"fn_name":null},{"line":244,"address":[7170400],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":245,"address":[7170408],"length":1,"stats":{"Line":1},"fn_name":null},{"line":248,"address":[5695248,5696353,5695216,5695271,5696449,5695221],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":250,"address":[5695340],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[5695515,5695580,5695347,5695468,5696434],"length":1,"stats":{"Line":3},"fn_name":null},{"line":253,"address":[5695898,5695859,5695999,5696220,5696309],"length":1,"stats":{"Line":2},"fn_name":null},{"line":254,"address":[5695833,5695737,5695820,5695882],"length":1,"stats":{"Line":4},"fn_name":null},{"line":259,"address":[5698323,5696848,5696821,5696816,5698224,5696871],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":261,"address":[5696952],"length":1,"stats":{"Line":1},"fn_name":null},{"line":263,"address":[5697040,5697072,5696959,5697099],"length":1,"stats":{"Line":3},"fn_name":null},{"line":265,"address":[5697313,5697425,5697271,5698308,5697360,5697190],"length":1,"stats":{"Line":5},"fn_name":null},{"line":266,"address":[5698154,5698065,5697743,5697704,5697844],"length":1,"stats":{"Line":2},"fn_name":null},{"line":267,"address":[5697582,5697678,5697727,5697665],"length":1,"stats":{"Line":4},"fn_name":null},{"line":272,"address":[5698837,5698864,5698887,5701372,5698832,5701513],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":274,"address":[5698968],"length":1,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[5698983],"length":1,"stats":{"Line":1},"fn_name":null},{"line":277,"address":[5701456,5699134,5699249,5699063,5699323,5699017,5699194],"length":1,"stats":{"Line":6},"fn_name":null},{"line":279,"address":[5699114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[5699698,5699721,5699916,5699522,5699842,5699792,5699550,5701477],"length":1,"stats":{"Line":7},"fn_name":null},{"line":284,"address":[5699580,5699676],"length":1,"stats":{"Line":2},"fn_name":null},{"line":288,"address":[5700234,5700144],"length":1,"stats":{"Line":2},"fn_name":null},{"line":290,"address":[5700482,5700282,5700547,5701498,5700435,5700393],"length":1,"stats":{"Line":5},"fn_name":null},{"line":291,"address":[5700828,5701189,5700706,5700802,5700789,5700968,5700851,5701278],"length":1,"stats":{"Line":5},"fn_name":null},{"line":294,"address":[5702336,5704937,5702368,5705078,5702341,5702391],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":296,"address":[5702472],"length":1,"stats":{"Line":1},"fn_name":null},{"line":298,"address":[5702487],"length":1,"stats":{"Line":1},"fn_name":null},{"line":299,"address":[5705021,5702567,5702698,5702753,5702827,5702638,5702521],"length":1,"stats":{"Line":6},"fn_name":null},{"line":301,"address":[5702618],"length":1,"stats":{"Line":1},"fn_name":null},{"line":304,"address":[5703026],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[5703090,5703171],"length":1,"stats":{"Line":2},"fn_name":null},{"line":306,"address":[5703217,5705042,5703407,5703352,5703481,5703289],"length":1,"stats":{"Line":5},"fn_name":null},{"line":308,"address":[5703267],"length":1,"stats":{"Line":1},"fn_name":null},{"line":312,"address":[5703680,5703728,5703775],"length":1,"stats":{"Line":3},"fn_name":null},{"line":314,"address":[5704023,5703823,5703934,5704088,5705063,5703976],"length":1,"stats":{"Line":5},"fn_name":null},{"line":315,"address":[5704330,5704730,5704392,5704247,5704509,5704343,5704369,5704819],"length":1,"stats":{"Line":5},"fn_name":null},{"line":318,"address":[5705997,5705941,5709718,5709880,5705936,5705968],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":320,"address":[5706078],"length":1,"stats":{"Line":1},"fn_name":null},{"line":322,"address":[5706093],"length":1,"stats":{"Line":1},"fn_name":null},{"line":323,"address":[5706127,5706193,5706261],"length":1,"stats":{"Line":3},"fn_name":null},{"line":324,"address":[5706309],"length":1,"stats":{"Line":1},"fn_name":null},{"line":325,"address":[5706724,5706485,5706532,5706432,5706595,5709802,5706650],"length":1,"stats":{"Line":6},"fn_name":null},{"line":327,"address":[5706512],"length":1,"stats":{"Line":1},"fn_name":null},{"line":331,"address":[5707099,5709823,5706923,5706951,5707317,5707193,5707243,5707122],"length":1,"stats":{"Line":7},"fn_name":null},{"line":333,"address":[5706981,5707077],"length":1,"stats":{"Line":2},"fn_name":null},{"line":337,"address":[5709844,5707809,5707685,5707643,5707545,5707735],"length":1,"stats":{"Line":5},"fn_name":null},{"line":338,"address":[5708119,5708064,5708572,5708248,5708093,5708051,5708482,5707968],"length":1,"stats":{"Line":5},"fn_name":null},{"line":340,"address":[5708721,5708702,5708876,5708609,5709865,5708811],"length":1,"stats":{"Line":5},"fn_name":null},{"line":343,"address":[5708655],"length":1,"stats":{"Line":1},"fn_name":null},{"line":346,"address":[5709643,5709489,5709270,5709441,5709467,5709609],"length":1,"stats":{"Line":4},"fn_name":null},{"line":349,"address":[5711013,5711040,5712120,5711063,5711008,5712216],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":351,"address":[5711132],"length":1,"stats":{"Line":1},"fn_name":null},{"line":353,"address":[5711235,5711282,5711155,5711347,5712201],"length":1,"stats":{"Line":4},"fn_name":null},{"line":354,"address":[5711987,5711649,5711600,5711766,5711504,5711587,5712076,5711626],"length":1,"stats":{"Line":5},"fn_name":null},{"line":357,"address":[5712581,5712608,5712576,5712631,5713796,5713700],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":359,"address":[5712700],"length":1,"stats":{"Line":1},"fn_name":null},{"line":361,"address":[5713781,5712707,5712862,5712815,5712927],"length":1,"stats":{"Line":4},"fn_name":null},{"line":362,"address":[5713656,5713567,5713206,5713346,5713245],"length":1,"stats":{"Line":2},"fn_name":null},{"line":363,"address":[5713180,5713167,5713229,5713084],"length":1,"stats":{"Line":4},"fn_name":null},{"line":368,"address":[5714165,5715854,5715968,5714215,5714160,5714192],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":370,"address":[5714293],"length":1,"stats":{"Line":1},"fn_name":null},{"line":372,"address":[5714665,5714476,5714456,5714308,5714547,5714597,5715932],"length":1,"stats":{"Line":6},"fn_name":null},{"line":374,"address":[5714379],"length":1,"stats":{"Line":1},"fn_name":null},{"line":378,"address":[5714880,5715082,5715953,5714970,5715017],"length":1,"stats":{"Line":4},"fn_name":null},{"line":379,"address":[5715498,5715319,5715358,5715381,5715236,5715332,5715720,5715810],"length":1,"stats":{"Line":5},"fn_name":null},{"line":382,"address":[5716544,5716573,5719868,5716512,5719727,5716517],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":384,"address":[5716654],"length":1,"stats":{"Line":1},"fn_name":null},{"line":386,"address":[5716669],"length":1,"stats":{"Line":1},"fn_name":null},{"line":387,"address":[5716726],"length":1,"stats":{"Line":1},"fn_name":null},{"line":388,"address":[5716924,5716785,5716856],"length":1,"stats":{"Line":3},"fn_name":null},{"line":389,"address":[5716972],"length":1,"stats":{"Line":1},"fn_name":null},{"line":391,"address":[5717358,5717229,5717284,5719811,5717096,5717166],"length":1,"stats":{"Line":5},"fn_name":null},{"line":393,"address":[5717146],"length":1,"stats":{"Line":1},"fn_name":null},{"line":396,"address":[5717726,5717592,5717557,5717680,5717655],"length":1,"stats":{"Line":4},"fn_name":null},{"line":398,"address":[5717996,5719832,5717922,5717830,5717694,5717764,5717872],"length":1,"stats":{"Line":6},"fn_name":null},{"line":399,"address":[5718280,5718251,5718435,5718306,5718238,5718696,5718789,5718155],"length":1,"stats":{"Line":5},"fn_name":null},{"line":401,"address":[5718826,5718946,5719853,5718864,5718998,5719063],"length":1,"stats":{"Line":5},"fn_name":null},{"line":407,"address":[5719583,5719511,5719628,5719465,5719486,5719294],"length":1,"stats":{"Line":4},"fn_name":null},{"line":410,"address":[5720989,5720933,5725443,5725302,5720960,5720928],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":412,"address":[5721070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":414,"address":[5721085],"length":1,"stats":{"Line":1},"fn_name":null},{"line":415,"address":[5721119,5721180],"length":1,"stats":{"Line":2},"fn_name":null},{"line":416,"address":[5721259],"length":1,"stats":{"Line":1},"fn_name":null},{"line":417,"address":[5721369,5721437,5721297],"length":1,"stats":{"Line":3},"fn_name":null},{"line":418,"address":[5721485],"length":1,"stats":{"Line":1},"fn_name":null},{"line":420,"address":[5725386,5721875,5721611,5721683,5721746,5721801],"length":1,"stats":{"Line":5},"fn_name":null},{"line":422,"address":[5721661],"length":1,"stats":{"Line":1},"fn_name":null},{"line":425,"address":[5722691,5722450,5722074,5722103,5722139,5722387,5722790],"length":1,"stats":{"Line":4},"fn_name":null},{"line":427,"address":[5722927,5722977,5722407,5725407,5723051,5722885,5722819],"length":1,"stats":{"Line":6},"fn_name":null},{"line":428,"address":[5723306,5723210,5723293,5723856,5723335,5723490,5723757,5723361],"length":1,"stats":{"Line":5},"fn_name":null},{"line":430,"address":[5724025,5725428,5723940,5723893,5724080,5724154],"length":1,"stats":{"Line":5},"fn_name":null},{"line":437,"address":[5724502,5724558,5724459,5724529],"length":1,"stats":{"Line":3},"fn_name":null},{"line":438,"address":[5725160,5724593,5724838,5724626,5725071,5724543,5724873],"length":1,"stats":{"Line":4},"fn_name":null},{"line":441,"address":[5726832,5726893,5726837,5730190,5726864,5730331],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":443,"address":[5726974],"length":1,"stats":{"Line":1},"fn_name":null},{"line":444,"address":[5726989],"length":1,"stats":{"Line":1},"fn_name":null},{"line":445,"address":[5727089,5727157,5727023],"length":1,"stats":{"Line":3},"fn_name":null},{"line":447,"address":[5727616,5730274,5727205,5727492,5727542,5727421,5727398],"length":1,"stats":{"Line":6},"fn_name":null},{"line":449,"address":[5727283,5727376],"length":1,"stats":{"Line":2},"fn_name":null},{"line":453,"address":[5727844,5728034,5728108,5727942,5730295,5727984],"length":1,"stats":{"Line":5},"fn_name":null},{"line":454,"address":[5728913,5728392,5728814,5728267,5728547,5728418,5728350,5728363],"length":1,"stats":{"Line":5},"fn_name":null},{"line":456,"address":[5729137,5729082,5730316,5729211,5728950,5728997],"length":1,"stats":{"Line":5},"fn_name":null},{"line":462,"address":[5729649,5729796,5729671,5730006,5729633,5730096,5729457],"length":1,"stats":{"Line":4},"fn_name":null},{"line":465,"address":[5731376,5731344,5731405,5734801,5734660,5731349],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":467,"address":[5731486],"length":1,"stats":{"Line":1},"fn_name":null},{"line":468,"address":[5731501],"length":1,"stats":{"Line":1},"fn_name":null},{"line":469,"address":[5731535,5731669,5731601],"length":1,"stats":{"Line":3},"fn_name":null},{"line":471,"address":[5731717,5732020,5734744,5731970,5731876,5731899,5732094],"length":1,"stats":{"Line":6},"fn_name":null},{"line":473,"address":[5731795],"length":1,"stats":{"Line":1},"fn_name":null},{"line":477,"address":[5732512,5732322,5732586,5734765,5732462,5732420],"length":1,"stats":{"Line":5},"fn_name":null},{"line":478,"address":[5732870,5733292,5733391,5733025,5732912],"length":1,"stats":{"Line":2},"fn_name":null},{"line":479,"address":[5732828,5732841,5732745,5732896],"length":1,"stats":{"Line":4},"fn_name":null},{"line":483,"address":[5733615,5733560,5733428,5734786,5733689,5733475],"length":1,"stats":{"Line":5},"fn_name":null},{"line":489,"address":[5734143,5734566,5734121,5734105,5734268,5734477,5733929],"length":1,"stats":{"Line":4},"fn_name":null},{"line":492,"address":[5735824,5735847,5735792,5737348,5735797,5737249],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":494,"address":[5735928],"length":1,"stats":{"Line":1},"fn_name":null},{"line":495,"address":[5735943],"length":1,"stats":{"Line":1},"fn_name":null},{"line":496,"address":[5736043,5736111,5735977],"length":1,"stats":{"Line":3},"fn_name":null},{"line":498,"address":[5736424,5736312,5736159,5736270,5736359,5737333],"length":1,"stats":{"Line":5},"fn_name":null},{"line":499,"address":[5736705,5736744,5737155,5736845,5737066],"length":1,"stats":{"Line":2},"fn_name":null},{"line":500,"address":[5736728,5736666,5736679,5736583],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":195,"coverable":205},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","endpoints","players.rs"],"content":"use crate::server::{app_context::AppContext, auth::extract_verified_id, reply::reply_error};\nuse serde::{Deserialize, Serialize};\nuse std::convert::Infallible;\nuse warp::hyper::StatusCode;\n\npub async fn get_player_filter(id: \u0026str, ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    #[derive(Serialize)]\n    struct GetPlayerResponse {\n        id: String,\n        name: String,\n    }\n\n    match ctx\n        .db()\n        .players()\n        .get(\u0026id)\n        .await\n        .expect(\"Reading player has failed\")\n    {\n        Some(player) =\u003e Ok(warp::reply::with_status(\n            warp::reply::json(\u0026GetPlayerResponse {\n                id: String::from(player.id()),\n                name: String::from(player.name()),\n            }),\n            StatusCode::OK,\n        )),\n        None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n    }\n}\n\n#[derive(Deserialize)]\npub struct EditPlayerInput {\n    name: String,\n}\n\npub async fn edit_player_filter(\n    id: \u0026str,\n    input: \u0026EditPlayerInput,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match extract_verified_id(authorization, ctx).filter(|token_id| token_id == id) {\n        Some(player_id) =\u003e match ctx\n            .db()\n            .players()\n            .get(\u0026player_id)\n            .await\n            .expect(\"Reading player has failed\")\n        {\n            Some(mut player) =\u003e {\n                player.set_name(\u0026input.name);\n                ctx.db()\n                    .players()\n                    .persist(\u0026player)\n                    .await\n                    .expect(\"editing player failed\");\n                Ok(warp::reply::with_status(\n                    warp::reply::json(\u0026player),\n                    StatusCode::OK,\n                ))\n            }\n            None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{edit_player_filter, get_player_filter, EditPlayerInput};\n    use crate::{\n        model::Player,\n        server::{app_context::AppContext, auth::generate_jwt_token},\n    };\n    use warp::{hyper::StatusCode, Reply};\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_not_get_unknown_player() {\n        let ctx = init_ctx();\n\n        let reply = get_player_filter(\"unknown\", \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_get_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        let player_id = String::from(player.id());\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n\n        let reply = get_player_filter(\u0026player_id, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_edit_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        let player_id = String::from(player.id());\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = edit_player_filter(\n            \u0026player_id,\n            \u0026EditPlayerInput {\n                name: String::from(\"new name\"),\n            },\n            \u0026token,\n            \u0026ctx,\n        )\n        .await;\n\n        let updated_player = ctx\n            .db()\n            .players()\n            .get(player.id())\n            .await\n            .expect(\"Reading player failed\");\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n        assert_eq!(updated_player.unwrap().name(), \"new name\");\n    }\n\n    #[tokio::test]\n    async fn should_not_edit_other_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = edit_player_filter(\n            \"other\",\n            \u0026EditPlayerInput {\n                name: String::from(\"new name\"),\n            },\n            \u0026token,\n            \u0026ctx,\n        )\n        .await;\n\n        let updated_player = ctx\n            .db()\n            .players()\n            .get(player.id())\n            .await\n            .expect(\"Reading player failed\");\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n        assert_eq!(updated_player.unwrap().name(), player.name());\n    }\n}\n","traces":[{"line":6,"address":[6696288,6696452,6697739,6696314],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}"},{"line":13,"address":[6697569,6696555,6697100,6696415,6696604,6696669,6696504,6697724],"length":1,"stats":{"Line":6},"fn_name":null},{"line":16,"address":[6696483],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[6697102,6697498,6697045],"length":1,"stats":{"Line":3},"fn_name":null},{"line":21,"address":[6697368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[4897014],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4897095],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4897389,4896860],"length":1,"stats":{"Line":2},"fn_name":null},{"line":36,"address":[5908512],"length":1,"stats":{"Line":1},"fn_name":"edit_player_filter"},{"line":42,"address":[4897968,4897982,4898423,4898211],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":43,"address":[4898433,4900352,4898597,4898371,4898551,4898757,4899260,4898687],"length":1,"stats":{"Line":6},"fn_name":null},{"line":46,"address":[4898527],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[6699355,6699288],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[4899396],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4899547,4899747,4900373,4899488,4899679,4899627],"length":1,"stats":{"Line":5},"fn_name":null},{"line":54,"address":[4899541],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4899986,4900025],"length":1,"stats":{"Line":2},"fn_name":null},{"line":58,"address":[4899953],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[4899233,4900090],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[4898396,4900161],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[6026992],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":78,"address":[6027000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[6073412,6073508,6072320,6072288,6072293,6072343],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":83,"address":[6072412],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[6072419,6072527,6072639,6073493,6072574],"length":1,"stats":{"Line":4},"fn_name":null},{"line":87,"address":[6072957,6073058,6073368,6073279,6072918],"length":1,"stats":{"Line":2},"fn_name":null},{"line":88,"address":[6072796,6072879,6072892,6072941],"length":1,"stats":{"Line":4},"fn_name":null},{"line":93,"address":[5762880,5763055,5762895,5763113,5763146],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":95,"address":[6074008],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[6074023],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[6074057,6074118],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[5763039],"length":1,"stats":{"Line":5},"fn_name":null},{"line":101,"address":[6074261],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[5763130],"length":1,"stats":{"Line":6},"fn_name":null},{"line":107,"address":[6075144,6075061,6075323,6075183,6075544,6075206,6075633,6075157],"length":1,"stats":{"Line":5},"fn_name":null},{"line":110,"address":[5864245,5864735,5864608,5864399,5864224,5864457],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":112,"address":[6076614],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[6076655],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[6076689,6076750],"length":1,"stats":{"Line":2},"fn_name":null},{"line":116,"address":[6077028,6077102,6076818,6080579,6076973,6076913],"length":1,"stats":{"Line":5},"fn_name":null},{"line":118,"address":[6076893],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[6077349,6077396,6077301],"length":1,"stats":{"Line":3},"fn_name":null},{"line":123,"address":[5864534],"length":1,"stats":{"Line":5},"fn_name":null},{"line":124,"address":[6077444],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[6077590],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[6077492],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[6077634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[5864555,5864513],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[5864671],"length":1,"stats":{"Line":5},"fn_name":null},{"line":136,"address":[6078255],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[6078913,6079072,6079043,6079098,6079227,6079030,6079587,6079491],"length":1,"stats":{"Line":5},"fn_name":null},{"line":141,"address":[6079989,6079839,6079616,6080208,6080298,6079817],"length":1,"stats":{"Line":3},"fn_name":null},{"line":144,"address":[5858608,5858792,5858943,5858629,5859070,5858759],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":146,"address":[6081830],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[6081871],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[5858743],"length":1,"stats":{"Line":6},"fn_name":null},{"line":151,"address":[6082002],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[6082505,6082458,6082410],"length":1,"stats":{"Line":3},"fn_name":null},{"line":156,"address":[5858869],"length":1,"stats":{"Line":4},"fn_name":null},{"line":158,"address":[6082580],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[6082545],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[6082624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[5858890,5858848],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[5859006],"length":1,"stats":{"Line":5},"fn_name":null},{"line":169,"address":[6083286],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[6084145,6084103,6084525,6084258,6084624],"length":1,"stats":{"Line":2},"fn_name":null},{"line":174,"address":[6084129,6084074,6084061,6083944],"length":1,"stats":{"Line":4},"fn_name":null},{"line":177,"address":[6084857,6085095,6085404,6085314,6084653,6084879,6085075],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":67,"coverable":68},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","logger.rs"],"content":"use crate::config::AppConfig;\nuse flexi_logger::{style, DeferredNow, Level, Logger, Record};\nuse log::info;\nuse std::thread;\n\npub fn custom_format(\n    w: \u0026mut dyn std::io::Write,\n    now: \u0026mut DeferredNow,\n    record: \u0026Record,\n) -\u003e Result\u003c(), std::io::Error\u003e {\n    let level = record.level();\n    write!(\n        w,\n        \"[{}] {} ({})[{}] {}\",\n        now.now().format(\"%Y-%m-%d %H:%M:%S%.3f %:z\"),\n        style(level, level),\n        thread::current().name().unwrap_or(\"-\"),\n        style(level, record.module_path().unwrap_or(\"-\")),\n        style(level, \u0026record.args())\n    )\n}\n\npub fn init_logger(config: \u0026AppConfig) {\n    let log_level = if cfg!(test) {\n        Level::Warn.to_string()\n    } else {\n        config.log_level.to_string()\n    };\n    Logger::with_env_or_str(\u0026log_level)\n        .format(custom_format)\n        .start()\n        .ok();\n\n    info!(\"Initialized logger with level {}\", \u0026log_level);\n}\n","traces":[{"line":6,"address":[7152692,7152592],"length":1,"stats":{"Line":0},"fn_name":"custom_format"},{"line":11,"address":[7152642],"length":1,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[7153207],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[7152715],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[7152766],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[7152972,7152847,7152801],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[7153004],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[7153133],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[7154032,7154073],"length":1,"stats":{"Line":1},"fn_name":"init_logger"},{"line":25,"address":[6997398],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[7154047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[7154159,7154088],"length":1,"stats":{"Line":2},"fn_name":null},{"line":34,"address":[7154226,7154347],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":4,"coverable":13},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","mod.rs"],"content":"pub mod app_context;\nmod auth;\nmod endpoints;\nmod logger;\nmod reply;\n\nuse self::{\n    app_context::AppContext,\n    endpoints::{\n        games::{\n            attend_game_filter, create_game_filter, get_game_filter, get_games_count_filter,\n            leave_game_filter, start_game_filter,\n        },\n        players::{edit_player_filter, get_player_filter, EditPlayerInput},\n    },\n    reply::handle_rejection,\n};\nuse log::warn;\nuse std::fs;\nuse warp::Filter;\n\nconst PUBLIC_PATH: \u0026str = \"/var/www/public\";\nconst AUTHORIZATION: \u0026str = \"Authorization\";\n\npub async fn run_server(ctx: \u0026'static AppContext) {\n    let frontend_path = fs::canonicalize(\"../frontend\")\n        .map(|p| {\n            p.into_os_string()\n                .into_string()\n                .unwrap_or_else(|_| \"-\".to_string())\n        })\n        .unwrap_or_else(|_| \"-\".to_string());\n\n    let index_path: String;\n    let static_path: String;\n    if ctx.is_dev() {\n        warn!(\"Delivering development assets from {}\", frontend_path);\n        index_path = format!(\"{}/public/index.html\", frontend_path);\n        static_path = format!(\"{}/dist/\", frontend_path);\n    } else {\n        index_path = format!(\"{}/index.html\", PUBLIC_PATH);\n        static_path = format!(\"{}/static/\", PUBLIC_PATH);\n    }\n\n    let game_route =\n        warp::path(\"games\").and(\n            // GET /api/games\n            warp::get()\n                .and(warp::path::end())\n                .and_then(move || async move { get_games_count_filter(ctx).await })\n                .or(\n                    // PUT /api/games\n                    warp::put().and_then(move || async move { create_game_filter(ctx).await }),\n                )\n                .or(\n                    // POST /api/games/:token/attend\n                    warp::post().and(warp::path!(String / \"attend\")).and_then(\n                        move |game_token: String| async move {\n                            attend_game_filter(\u0026game_token, ctx).await\n                        },\n                    ),\n                )\n                .or(\n                    // POST /api/games/:token/leave\n                    warp::post()\n                        .and(warp::path!(String / \"leave\"))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(\n                            move |game_token: String, authorization: String| async move {\n                                leave_game_filter(\u0026game_token, \u0026authorization, ctx).await\n                            },\n                        ),\n                )\n                .or(\n                    // POST /api/games/:token/start\n                    warp::post()\n                        .and(warp::path!(String / \"start\"))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(\n                            move |game_token: String, authorization: String| async move {\n                                start_game_filter(\u0026game_token, \u0026authorization, ctx).await\n                            },\n                        ),\n                )\n                .or(\n                    // GET /api/games/:token\n                    warp::get()\n                        .and(warp::path!(String))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(move |token: String, authorization: String| async move {\n                            get_game_filter(\u0026token, \u0026authorization, ctx).await\n                        }),\n                ),\n        );\n\n    let player_route = warp::path(\"players\").and(\n        // GET /api/players/:id\n        warp::get()\n            .and(warp::path!(String))\n            .and_then(move |id: String| async move { get_player_filter(\u0026id, ctx).await })\n            .or(\n                // POST /api/players/:id\n                warp::post()\n                    .and(warp::path!(String))\n                    .and(warp::body::json())\n                    .and(warp::header(AUTHORIZATION))\n                    .and_then(\n                        move |id: String, input: EditPlayerInput, authorization: String| async move {\n                            edit_player_filter(\u0026id, \u0026input, \u0026authorization, ctx).await\n                        },\n                    )),\n    );\n    let api_route = warp::path(\"api\").and(game_route.or(player_route));\n\n    let static_route = warp::path(\"static\").and(warp::fs::dir(static_path));\n    let index_route = warp::get().and(warp::path::end().and(warp::fs::file(index_path)));\n\n    let routes = index_route\n        .or(static_route)\n        .or(api_route)\n        .recover(handle_rejection)\n        .with(warp::log(\"server\"));\n\n    warp::serve(routes)\n        .run(([0, 0, 0, 0], ctx.config().port))\n        .await;\n}\n","traces":[{"line":25,"address":[4517488,4517509,4517683],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":27,"address":[4907104],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":28,"address":[4907111],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[4907008,4907015],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":32,"address":[4907216,4907223],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":36,"address":[4915726,4915761,4916922],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[4916067,4916154,4916107,4915934,4916335],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[4916384,4916531],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[4916637,4916784],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[4916935,4917009,4915863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[4917115,4917265],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[4918855,4917519,4917548,4917635,4917879,4917458,4918219,4918551],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[4917492],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[4530432,4530447],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":53,"address":[4572656,4572671],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":57,"address":[4917852,4917775,4917825,4917762,4917696,4917801,4917743],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[4538018,4537872,4537962,4537887],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":59,"address":[4537942],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[4918156,4918042,4917927,4918092],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[4917938,4918018,4917992,4917979,4917960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[4918053],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[4514735,4514943,4514720,4514817],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":70,"address":[4514797],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[4918424,4918488,4918259,4918374],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[4918350,4918311,4918292,4918270,4918324],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[4918385],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[4531087,4530961,4530864,4530879],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":81,"address":[4530941],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[4918728,4918678,4918792,4918591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[4918654,4918641,4918602,4918624],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[4918689],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[4543711,4543585,4543503,4543488],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":91,"address":[4543565],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[4919446,4918993,4919100,4919127],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[4919046,4919027,4919063,4919076],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[4585375,4585360],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":103,"address":[4919383,4919245,4919267,4919319,4919154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[4919208,4919221,4919167,4919191],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[4919256],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[4919280],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[4580335,4580420,4580616,4580320],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":109,"address":[4580397],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[4919822,4919529],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[4920091,4919869,4920036],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[4920098,4920245,4920310,4920276,4920175],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[4920457,4920515,4920597,4920365],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[4920326],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[4920447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[4920546],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[4920554,4920501,4921431,4920642],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[4517621],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[4920741,4920962,4920802,4920931,4920944,4921458,4920817],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":52},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","reply.rs"],"content":"use serde::Serialize;\nuse std::convert::Infallible;\nuse warp::{\n    hyper::StatusCode,\n    reply::{Json, WithStatus},\n    Rejection, Reply,\n};\n\n#[derive(Serialize)]\nstruct ErrorMessage {\n    code: u16,\n    message: String,\n    details: String,\n}\n\n#[derive(Serialize)]\nstruct SuccessMessage {\n    code: u16,\n    message: String,\n}\n\npub fn reply_success(status: StatusCode) -\u003e WithStatus\u003cJson\u003e {\n    warp::reply::with_status(warp::reply::json(\u0026build_success_content(\u0026status)), status)\n}\n\npub fn reply_error(status: StatusCode) -\u003e WithStatus\u003cJson\u003e {\n    warp::reply::with_status(warp::reply::json(\u0026build_error_content(\u0026status, \"\")), status)\n}\n\npub fn reply_error_with_details(status: StatusCode, details: \u0026str) -\u003e WithStatus\u003cJson\u003e {\n    warp::reply::with_status(\n        warp::reply::json(\u0026build_error_content(\u0026status, details)),\n        status,\n    )\n}\n\npub async fn handle_rejection(err: Rejection) -\u003e Result\u003cimpl Reply, Infallible\u003e {\n    if err.is_not_found() {\n        return Ok(reply_error_with_details(\n            StatusCode::NOT_FOUND,\n            \"Path unsupported\",\n        ));\n    } else if err.find::\u003cwarp::reject::MethodNotAllowed\u003e().is_some() {\n        return Ok(reply_error_with_details(\n            StatusCode::METHOD_NOT_ALLOWED,\n            \"Request not supported, check path and sent headers\",\n        ));\n    }\n\n    return Ok(reply_error_with_details(\n        StatusCode::INTERNAL_SERVER_ERROR,\n        \"An internal error has happend, please contact the developers\",\n    ));\n}\n\nfn build_error_content(status: \u0026StatusCode, details: \u0026str) -\u003e ErrorMessage {\n    ErrorMessage {\n        code: status.as_u16(),\n        message: String::from(status.canonical_reason().unwrap_or(\"unknown\")),\n        details: String::from(details),\n    }\n}\n\nfn build_success_content(status: \u0026StatusCode) -\u003e SuccessMessage {\n    SuccessMessage {\n        code: status.as_u16(),\n        message: String::from(status.canonical_reason().unwrap_or(\"unknown\")),\n    }\n}\n","traces":[{"line":22,"address":[4775392,4775434],"length":1,"stats":{"Line":2},"fn_name":"reply_success"},{"line":23,"address":[4907516,4907568],"length":1,"stats":{"Line":4},"fn_name":null},{"line":26,"address":[4907648,4907698],"length":1,"stats":{"Line":1},"fn_name":"reply_error"},{"line":27,"address":[4907662,4907720],"length":1,"stats":{"Line":2},"fn_name":null},{"line":30,"address":[4775766,4775712],"length":1,"stats":{"Line":0},"fn_name":"reply_error_with_details"},{"line":32,"address":[4775737,4775778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[4775897,4775888],"length":1,"stats":{"Line":0},"fn_name":"handle_rejection"},{"line":38,"address":[6173642],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[6173737,6173826],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[6173923,6173713,6173961],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[6174003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[6173967,6174104],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[4775968,4776042],"length":1,"stats":{"Line":1},"fn_name":"build_error_content"},{"line":58,"address":[4776007],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[4776062],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[4776152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4776272],"length":1,"stats":{"Line":2},"fn_name":"build_success_content"},{"line":66,"address":[4776289],"length":1,"stats":{"Line":2},"fn_name":null},{"line":67,"address":[4776317],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":11,"coverable":19}]};
        var previousData = {"files":[{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","bin.rs"],"content":"use secret_clan::run_app;\n\nfn main() {\n    run_app();\n}\n","traces":[{"line":3,"address":[4211120],"length":1,"stats":{"Line":0},"fn_name":"main"},{"line":4,"address":[4211121],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":2},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","client.rs"],"content":"use super::{Command, CommandData, Persist, QueryError};\nuse log::debug;\nuse nanoid::nanoid;\nuse std::{\n    collections::HashSet,\n    fmt::{self, Debug},\n};\nuse tokio::sync::{mpsc, oneshot};\n\npub struct Client\u003cT: Persist\u003e {\n    sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Persist\u003e Client\u003cT\u003e {\n    pub fn new(sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e) -\u003e Self {\n        Client { sender }\n    }\n\n    async fn run_query\u003cR: Debug\u003e(\n        \u0026self,\n        cmd_provider: impl FnOnce(CommandData\u003cR\u003e) -\u003e Command\u003cT\u003e,\n    ) -\u003e Result\u003cR, QueryError\u003e {\n        let (responder, receiver): (oneshot::Sender\u003cR\u003e, oneshot::Receiver\u003cR\u003e) = oneshot::channel();\n        let id = nanoid!();\n        let data = CommandData {\n            responder,\n            id: String::from(\u0026id),\n        };\n        let cmd = cmd_provider(data);\n        let res = self.sender.clone().send(cmd).await;\n        debug!(\"Sent query \\\"{}\\\"\", \u0026id);\n\n        match res {\n            Ok(_) =\u003e match receiver.await {\n                Ok(res) =\u003e {\n                    debug!(\"Received answer for query \\\"{}\\\": {:?}\", \u0026id, res);\n                    Ok(res)\n                }\n                Err(error) =\u003e Err(QueryError::new(\u0026fmt::format(format_args!(\n                    \"Retrieving result for query \\\"{}\\\" has failed: {}\",\n                    id,\n                    error.to_string(),\n                )))),\n            },\n            Err(error) =\u003e Err(QueryError::new(\u0026fmt::format(format_args!(\n                \"Sending query for query \\\"{}\\\" has failed: {}\",\n                id,\n                error.to_string(),\n            )))),\n        }\n    }\n\n    fn map_result\u003cR\u003e(res: Result\u003cR, sled::Error\u003e) -\u003e Result\u003cR, QueryError\u003e {\n        res.map_err(QueryError::from_sled)\n    }\n\n    pub async fn get(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cT\u003e, QueryError\u003e {\n        let key = String::from(id);\n        self.run_query(|data| Command::Get { key, data })\n            .await\n            .and_then(Self::map_result)\n    }\n\n    pub async fn scan(\n        \u0026self,\n        scan_function: Box\u003cdyn Fn(\u0026T) -\u003e bool + Send + Sync\u003e,\n    ) -\u003e Result\u003cHashSet\u003cString\u003e, QueryError\u003e {\n        self.run_query(|data| Command::Scan {\n            scan_function,\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn persist(\u0026self, elem: \u0026T) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Persist {\n            value: elem.clone(),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn remove(\u0026self, key: \u0026str) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Remove {\n            key: String::from(key),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn remove_batch(\u0026self, keys: \u0026HashSet\u003cString\u003e) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::RemoveBatch {\n            keys: keys.clone(),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn purge(\u0026self) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Purge { data })\n            .await\n            .and_then(Self::map_result)\n    }\n\n    pub async fn total_count(\u0026self) -\u003e Result\u003cusize, QueryError\u003e {\n        self.run_query(|data| Command::Count { data }).await\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::Client;\n    use crate::{\n        db::{Database, Persist},\n        model::Game,\n    };\n    use nanoid::nanoid;\n    use std::collections::HashSet;\n\n    fn init_client() -\u003e Client\u003cGame\u003e {\n        let mut repo = Database::init(\"games\");\n\n        let sender = repo.sender();\n        tokio::task::spawn(async move {\n            repo.start_listening().await;\n        });\n\n        let client = Client::new(sender);\n\n        client\n    }\n\n    #[tokio::test]\n    async fn should_get_game() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"token\");\n        let game_id = String::from(game.id());\n\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n\n        let res = client.get(\u0026game_id).await.expect(\"Reading game has failed\");\n\n        assert!(res.is_some());\n        assert_eq!(res.unwrap().id(), game_id);\n    }\n\n    #[tokio::test]\n    async fn should_persist_game() {\n        let client = init_client();\n\n        client\n            .persist(\u0026Game::new(\"admin\", \"token\"))\n            .await\n            .expect(\"Game persist failed\");\n    }\n\n    #[tokio::test]\n    async fn should_purge_games() {\n        let client = init_client();\n\n        client\n            .persist(\u0026Game::new(\"admin\", \"token\"))\n            .await\n            .expect(\"Game persist failed\");\n        client\n            .persist(\u0026Game::new(\"admin\", \"token2\"))\n            .await\n            .expect(\"Game persist failed\");\n\n        assert_eq!(client.total_count().await.unwrap(), 2);\n\n        client.purge().await.expect(\"Perging has failed\");\n\n        assert_eq!(client.total_count().await.unwrap(), 0);\n    }\n\n    #[tokio::test]\n    async fn should_remove_game() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"token\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n\n        let persisted_game = client\n            .get(\u0026game.id())\n            .await\n            .expect(\"Reading game has failed\");\n        assert!(persisted_game.is_some());\n\n        let res = client\n            .remove(game.id())\n            .await\n            .expect(\"Removing game failed\");\n        assert!(res);\n\n        let removed_game = client\n            .get(\u0026game.id())\n            .await\n            .expect(\"Reading game has failed\");\n        assert!(removed_game.is_none());\n    }\n\n    #[tokio::test]\n    async fn should_remove_games() {\n        let client = init_client();\n        let mut ids = HashSet::new();\n        for x in \u0026[\"A\", \"B\", \"C\"] {\n            let g = Game::new(\"admin\", *x);\n            client.persist(\u0026g).await.expect(\"Game persist failed\");\n            ids.insert(String::from(*x));\n        }\n\n        let game_count = client\n            .total_count()\n            .await\n            .expect(\"Reading count has failed\");\n        assert_eq!(game_count, 3);\n\n        let res = client\n            .remove_batch(\u0026ids)\n            .await\n            .expect(\"Removing games failed\");\n        assert!(res);\n\n        let game_count = client\n            .total_count()\n            .await\n            .expect(\"Reading count has failed\");\n        assert_eq!(game_count, 0);\n    }\n\n    #[tokio::test]\n    async fn should_not_get_game() {\n        let client = init_client();\n        let res = client\n            .get(\"unknown\")\n            .await\n            .expect(\"Reading game has failed\");\n\n        assert!(res.is_none());\n    }\n\n    #[tokio::test]\n    async fn should_create_entities_concurrently() {\n        let client = init_client();\n\n        let mut threads = vec![];\n\n        for _ in 0..1000 {\n            threads.push(async {\n                let _ = client.persist(\u0026Game::new(\"admin\", \u0026nanoid!())).await;\n            });\n        }\n\n        futures::future::join_all(threads).await;\n\n        assert_eq!(\n            client\n                .total_count()\n                .await\n                .expect(\"Reading count has failed\"),\n            1000\n        );\n    }\n}\n","traces":[{"line":15,"address":[5551744,5551808],"length":1,"stats":{"Line":7},"fn_name":"new\u003csecret_clan::model::game::Game\u003e"},{"line":19,"address":[5552208,5552032,5551952,5552544,5551872,5552112,5552288,5552352,5552448],"length":1,"stats":{"Line":17},"fn_name":"run_query\u003csecret_clan::model::player::Player,core::result::Result\u003cbool, sled::result::Error\u003e,closure-0\u003e"},{"line":23,"address":[5558413,5599161,5570013,5564201,5581805,5575801,5593369,5587581,5552817],"length":1,"stats":{"Line":17},"fn_name":null},{"line":24,"address":[5558506,5593454,5570106,5587674,5564286,5575886,5552902,5581898,5599246],"length":1,"stats":{"Line":18},"fn_name":null},{"line":27,"address":[5553127,5576111,5599471,5582123,5558731,5570331,5587899,5593679,5564511],"length":1,"stats":{"Line":18},"fn_name":null},{"line":29,"address":[5593759,5564591,5553207,5588139,5570411,5564779,5558971,5582363,5582203,5576383,5553359,5570571,5587979,5593951,5599739,5576191,5558811,5599551],"length":1,"stats":{"Line":36},"fn_name":null},{"line":30,"address":[4526417,4557409,4575713,4539889,4516897,4545313,4574033,4558849,4546673],"length":1,"stats":{"Line":91},"fn_name":null},{"line":31,"address":[5589048,5554268,5571480,5577159,5583272,5577292,5554355,5571567,5583359,5583312,5594727,5588915,5600515,5583139,5594947,5559880,5571754,5559920,5565688,5577566,5594900,5571520,5559967,5577379,5565728,5595134,5565555,5583546,5600648,5565962,5589088,5554308,5571347,5589322,5565775,5600688,5577332,5554542,5560154,5594860,5554135,5600735,5559747,5600922,5589135],"length":1,"stats":{"Line":72},"fn_name":null},{"line":33,"address":[5601124,5586012,5603394,5589524,5554744,5595336,5592098,5591788,5580554,5566164,5568434,5560356,5571956,5597896,5583748,5556835,5562930,5557160,5568758,5603718,5574530,5586322,5597572,5580230,5577768,5574220,5562620],"length":1,"stats":{"Line":17},"fn_name":null},{"line":34,"address":[4557624,4545528,4574248,4559064,4540104,4546888,4575928,4526632,4517112],"length":1,"stats":{"Line":95},"fn_name":null},{"line":35,"address":[5572422,5560822,5566560,5584141,5578292,5566636,5595828,5589990,5584214,5595724,5572349,5560749,5589917,5555103,5555170,5601520,5601596,5578368],"length":1,"stats":{"Line":38},"fn_name":null},{"line":36,"address":[5572677,5590530,5595830,5561019,5584411,5572962,5578972,5566700,5566833,5567273,5555186,5572486,5578687,5590245,5555319,5584754,5579069,5595971,5590187,5555648,5584278,5590292,5566891,5561459,5590054,5601793,5596314,5561124,5590627,5573059,5572724,5584516,5555363,5596411,5566938,5561362,5601898,5601851,5596029,5561077,5584469,5602233,5584851,5596076,5572619,5601660,5555745,5567176,5578629,5602136,5578734,5578496,5560886,5555410],"length":1,"stats":{"Line":76},"fn_name":null},{"line":37,"address":[5590668,5579110,5561500,5602274,5596452,5584892,5555786,5567314,5573100],"length":1,"stats":{"Line":17},"fn_name":null},{"line":39,"address":[5596877,5567651,5596572,5562027,5585317,5602611,5585152,5602394,5556050,5561760,5596789,5561925,5590788,5579370,5567841,5591005,5596712,5573437,5561837,5573627,5579535,5555827,5573360,5590928,5602534,5567574,5585229,5579230,5573220,5555967,5602699,5585419,5579447,5573525,5596979,5585012,5591195,5567434,5567739,5556138,5556240,5561620,5579637,5602801,5591093],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[5560778,5584170,5578324,5595756,5589946,5555126,5566592,5601552,5572378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[5566596,5595760,5589950,5572382,5601556,5555130,5560782,5578328,5584174],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[5583627,5580129,5579941,5568145,5556470,5579732,5556632,5568333,5573857,5603193,5601003,5571835,5556544,5562519,5554623,5580029,5556335,5562257,5597283,5585514,5562331,5585723,5602896,5603031,5591687,5573722,5566043,5591587,5591499,5567936,5603105,5574019,5589403,5560235,5568233,5573931,5591290,5597074,5585811,5603293,5568071,5597371,5591425,5585911,5579867,5556734,5597471,5585649,5597209,5595215,5562419,5574119,5562122,5577647],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[5595286,5560306,5566114,5601074,5577718,5589474,5554694,5583698,5571906],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[5595290,5589478,5601078,5554698,5560310,5577722,5583702,5566118,5571910],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[5604784,5605104,5604944,5605024,5605184,5604864],"length":1,"stats":{"Line":16},"fn_name":"map_result\u003csecret_clan::model::game::Game,std::collections::hash::set::HashSet\u003calloc::string::String, std::collections::hash::map::RandomState\u003e\u003e"},{"line":54,"address":[5604871,5605031,5604951,5605114,5605194,5604791],"length":1,"stats":{"Line":12},"fn_name":null},{"line":57,"address":[5605264,5606890,5605744,5605394,5605978,5607357,5605360,5605770,5606445,5606682,5606656,5605298],"length":1,"stats":{"Line":16},"fn_name":"get\u003csecret_clan::model::game::Game\u003e"},{"line":58,"address":[5606801,5605889],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[4563478,4522246],"length":1,"stats":{"Line":19},"fn_name":null},{"line":60,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[5607568,5607664],"length":1,"stats":{"Line":2},"fn_name":"scan\u003csecret_clan::model::player::Player\u003e"},{"line":68,"address":[4570310,4563958],"length":1,"stats":{"Line":20},"fn_name":null},{"line":69,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[5607889,5607777],"length":1,"stats":{"Line":3},"fn_name":null},{"line":72,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[5611584,5610506,5609882,5609776,5611386,5611171,5610704,5609856,5612051,5611360,5609802,5610480],"length":1,"stats":{"Line":31},"fn_name":"persist\u003csecret_clan::model::player::Player\u003e"},{"line":77,"address":[5609987,5611659,5609936,5611156,5610059,5610779,5610258,5611488,5611613,5610608,5610733,5610847,5611727,5610208,5610330,5612036],"length":1,"stats":{"Line":32},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":78,"address":[5610226,5609954],"length":1,"stats":{"Line":7},"fn_name":null},{"line":79,"address":[5610007,5610278],"length":1,"stats":{"Line":7},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":86,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[4568303,4516560,4516648,4568288,4516575,4568376],"length":1,"stats":{"Line":12},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":95,"address":[4568358,4516630],"length":1,"stats":{"Line":12},"fn_name":null},{"line":96,"address":[5612655,5612415],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[5612709,5612469],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":104,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":105,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[4551896,4551808,4551823],"length":1,"stats":{"Line":6},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":110,"address":[4551878],"length":1,"stats":{"Line":6},"fn_name":null},{"line":124,"address":[5022634,5022560],"length":1,"stats":{"Line":2},"fn_name":"init_client"},{"line":125,"address":[5022577],"length":1,"stats":{"Line":3},"fn_name":null},{"line":127,"address":[5022662],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[5022677],"length":1,"stats":{"Line":7},"fn_name":null},{"line":129,"address":[5843222],"length":1,"stats":{"Line":10},"fn_name":null},{"line":132,"address":[5022862],"length":1,"stats":{"Line":1},"fn_name":null},{"line":137,"address":[5023072,5023079],"length":1,"stats":{"Line":9},"fn_name":"should_get_game"},{"line":139,"address":[7072368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[7072399],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[7072456,7072517],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[5795887],"length":1,"stats":{"Line":4},"fn_name":null},{"line":145,"address":[5795986],"length":1,"stats":{"Line":5},"fn_name":null},{"line":147,"address":[7073620,7073802,7073571],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[7074259,7074040,7074349,7073848,7073897,7073875,7073636],"length":1,"stats":{"Line":4},"fn_name":null},{"line":151,"address":[5023383,5023376],"length":1,"stats":{"Line":9},"fn_name":"should_persist_game"},{"line":153,"address":[7075334],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[5781573],"length":1,"stats":{"Line":5},"fn_name":null},{"line":156,"address":[7075351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[5023687,5023680],"length":1,"stats":{"Line":9},"fn_name":"should_purge_games"},{"line":163,"address":[7076318],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[5818727],"length":1,"stats":{"Line":5},"fn_name":null},{"line":166,"address":[7076341],"length":1,"stats":{"Line":1},"fn_name":null},{"line":169,"address":[5818819],"length":1,"stats":{"Line":5},"fn_name":null},{"line":170,"address":[7076927],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[5818866],"length":1,"stats":{"Line":4},"fn_name":null},{"line":176,"address":[5818894],"length":1,"stats":{"Line":5},"fn_name":null},{"line":178,"address":[5818925],"length":1,"stats":{"Line":5},"fn_name":null},{"line":181,"address":[5023991,5023984],"length":1,"stats":{"Line":9},"fn_name":"should_remove_game"},{"line":183,"address":[7080750],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[7080765],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[5856983],"length":1,"stats":{"Line":5},"fn_name":null},{"line":187,"address":[5857052],"length":1,"stats":{"Line":4},"fn_name":null},{"line":188,"address":[7081282,7081364],"length":1,"stats":{"Line":2},"fn_name":null},{"line":191,"address":[7081943,7082009,7081881],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[5857100],"length":1,"stats":{"Line":4},"fn_name":null},{"line":194,"address":[7081971],"length":1,"stats":{"Line":1},"fn_name":null},{"line":197,"address":[7082464,7082542],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[5857151],"length":1,"stats":{"Line":4},"fn_name":null},{"line":200,"address":[7082493,7082590],"length":1,"stats":{"Line":2},"fn_name":null},{"line":203,"address":[7083052,7083077,7083117],"length":1,"stats":{"Line":2},"fn_name":null},{"line":206,"address":[5024295,5024288],"length":1,"stats":{"Line":9},"fn_name":"should_remove_games"},{"line":208,"address":[7084261],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[7084276],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[7084508,7085137,7084411,7084290,7084357],"length":1,"stats":{"Line":4},"fn_name":null},{"line":211,"address":[7084546],"length":1,"stats":{"Line":1},"fn_name":null},{"line":212,"address":[5825467],"length":1,"stats":{"Line":5},"fn_name":null},{"line":213,"address":[7085032,7085099],"length":1,"stats":{"Line":2},"fn_name":null},{"line":216,"address":[5825557],"length":1,"stats":{"Line":5},"fn_name":null},{"line":220,"address":[7085722,7085968,7086067,7085575],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[5825584],"length":1,"stats":{"Line":5},"fn_name":null},{"line":223,"address":[7085681],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[7086478,7086514],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[5825609],"length":1,"stats":{"Line":5},"fn_name":null},{"line":232,"address":[7087352,7087262,7086935,7087058],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[5024592,5024599],"length":1,"stats":{"Line":9},"fn_name":"should_not_get_game"},{"line":237,"address":[7088502],"length":1,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[5847093],"length":1,"stats":{"Line":4},"fn_name":null},{"line":243,"address":[7088934,7088993,7088959],"length":1,"stats":{"Line":2},"fn_name":null},{"line":246,"address":[5024896,5024903],"length":1,"stats":{"Line":9},"fn_name":"should_create_entities_concurrently"},{"line":248,"address":[7090517],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[7090539],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[7090561,7090879,7090668,7091001,7090729],"length":1,"stats":{"Line":4},"fn_name":null},{"line":253,"address":[5760335,5760320,5760534,5760509],"length":1,"stats":{"Line":5},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":254,"address":[5760404],"length":1,"stats":{"Line":6},"fn_name":null},{"line":258,"address":[5800258],"length":1,"stats":{"Line":5},"fn_name":null},{"line":260,"address":[7091744,7092161,7092071,7091867],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[5800310],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":104,"coverable":125},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","database.rs"],"content":"use super::{Command, Persist, ScanFunction};\nuse log::{debug, error, info, warn};\nuse nanoid::nanoid;\nuse rayon::prelude::*;\nuse sled::Db;\nuse std::collections::HashSet;\nuse tokio::sync::{\n    mpsc::{self},\n    oneshot::{self},\n};\n\npub struct Database\u003cT: Persist\u003e {\n    path: String,\n    db: Db,\n    receiver: mpsc::Receiver\u003cCommand\u003cT\u003e\u003e,\n    sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Persist\u003e Database\u003cT\u003e {\n    pub fn init(path: \u0026str) -\u003e Database\u003cT\u003e {\n        let db = sled::open(if cfg!(test) {\n            format!(\".sled/{}/{}\", nanoid!(), \u0026path)\n        } else {\n            format!(\".sled/{}\", \u0026path)\n        })\n        .expect(\"opening database has failed\");\n\n        let (sender, receiver): (mpsc::Sender\u003cCommand\u003cT\u003e\u003e, mpsc::Receiver\u003cCommand\u003cT\u003e\u003e) =\n            mpsc::channel(256);\n\n        let repo = Database {\n            db,\n            path: String::from(path),\n            receiver,\n            sender,\n        };\n\n        repo.purge()\n            .expect(\"Cleanup of existing database has failed\");\n\n        repo\n    }\n\n    pub fn sender(\u0026self) -\u003e mpsc::Sender\u003cCommand\u003cT\u003e\u003e {\n        self.sender.clone()\n    }\n\n    /// A database connection is etablished by creating a database instance, which should should then be started in a separate thread.\n    /// The communication between resources and the database is established with channels. Simply use a client to send messages to the database thread in an easy accesible way.\n    /// Of course it's also possible to send messages through the channel directly without using the client.\n    ///\n    /// Example:\n    /// ```\n    /// use secret_clan::{model::Game, db::{Database, Client}};\n    /// let mut repo: Database\u003cGame\u003e = Database::init(\"test\");\n    /// let sender = repo.sender();\n    /// std::thread::spawn(move || {\n    ///     repo.start_listening();\n    /// });\n    /// let client = Client::new(sender);\n    /// ```\n    pub async fn start_listening(\u0026mut self) {\n        info!(\"Database for \\\"{}\\\" ready\", self.path);\n\n        while let Some(cmd) = self.receiver.recv().await {\n            debug!(\"Received query: {:?}\", cmd);\n\n            match cmd {\n                Command::Get { key, data } =\u003e {\n                    self.send_result(self.get(\u0026key), data.responder);\n                }\n                Command::Persist { value, data } =\u003e {\n                    self.send_result(self.persist(\u0026value), data.responder);\n                }\n                Command::Remove { key, data } =\u003e {\n                    self.send_result(self.remove(\u0026key), data.responder);\n                }\n                Command::RemoveBatch { keys, data } =\u003e {\n                    self.send_result(self.remove_batch(\u0026keys), data.responder);\n                }\n                Command::Count { data } =\u003e {\n                    self.send_result(self.total_count(), data.responder);\n                }\n                Command::Scan {\n                    scan_function,\n                    data,\n                } =\u003e {\n                    self.send_result(Ok(self.scan(scan_function)), data.responder);\n                }\n                Command::Purge { data } =\u003e {\n                    self.send_result(self.purge(), data.responder);\n                }\n            }\n        }\n    }\n\n    fn persist(\u0026self, elem: \u0026T) -\u003e Result\u003cbool, sled::Error\u003e {\n        self.db\n            .insert(elem.id(), elem.clone())\n            .expect(\"Persisting item failed\");\n        self.flush()\n    }\n\n    fn remove(\u0026self, key: \u0026str) -\u003e Result\u003cbool, sled::Error\u003e {\n        match self.db.remove(key).expect(\"Removing item failed\") {\n            Some(_) =\u003e self.flush(),\n            None =\u003e {\n                warn!(\"No item with key \\\"{}\\\" found for removal\", key);\n                Ok(false)\n            }\n        }\n    }\n\n    fn remove_batch(\u0026self, keys: \u0026HashSet\u003cString\u003e) -\u003e Result\u003cbool, sled::Error\u003e {\n        let batch = sled::Batch::default();\n        for key in keys {\n            match self.db.remove(key).expect(\"Removing item failed\") {\n                Some(_) =\u003e {}\n                None =\u003e {\n                    warn!(\"No item with key \\\"{}\\\" found for removal\", key);\n                }\n            }\n        }\n        self.db.apply_batch(batch)?;\n        self.flush()\n    }\n\n    fn get(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cT\u003e, sled::Error\u003e {\n        let success = self.db.get(id);\n        match success {\n            Ok(res) =\u003e Ok(res.and_then(|g| T::try_from(g).ok())),\n            Err(err) =\u003e Err(err),\n        }\n    }\n\n    fn scan(\u0026self, scan_function: ScanFunction\u003cT\u003e) -\u003e HashSet\u003cString\u003e {\n        self.db\n            .iter()\n            .par_bridge()\n            .filter_map(|x| x.ok())\n            .filter_map(|(_, x)| T::try_from(x).ok())\n            .filter_map(|y| {\n                if scan_function(\u0026y) {\n                    Some(String::from(y.id()))\n                } else {\n                    None\n                }\n            })\n            .collect::\u003cHashSet\u003cString\u003e\u003e()\n    }\n\n    fn total_count(\u0026self) -\u003e usize {\n        self.db.len()\n    }\n\n    fn flush(\u0026self) -\u003e Result\u003cbool, sled::Error\u003e {\n        self.db.flush().map(|_| true)\n    }\n\n    fn send_result\u003cR\u003e(\u0026self, data: R, sender: oneshot::Sender\u003cR\u003e) {\n        if sender.send(data).is_err() {\n            error!(\"Sending result to client has failed\");\n        }\n    }\n\n    fn purge(\u0026self) -\u003e Result\u003cbool, sled::Error\u003e {\n        let res = self.db.clear().and_then(|()| self.db.flush()).map(|_| true);\n        info!(\"Purged database \\\"{}\\\"\", self.path);\n\n        res\n    }\n}\n","traces":[{"line":20,"address":[5713248,5713378,5712256,5712386],"length":1,"stats":{"Line":5},"fn_name":"init\u003csecret_clan::model::game::Game\u003e"},{"line":21,"address":[5713275,5713541,5712283,5712549],"length":1,"stats":{"Line":13},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":24,"address":[5712307,5713405,5712413,5713299],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[5713641,5712649],"length":1,"stats":{"Line":4},"fn_name":null},{"line":33,"address":[5713752,5712760],"length":1,"stats":{"Line":6},"fn_name":null},{"line":38,"address":[5714001,5713960,5712968,5713009],"length":1,"stats":{"Line":5},"fn_name":null},{"line":41,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[5714288,5714240],"length":1,"stats":{"Line":2},"fn_name":"sender\u003csecret_clan::model::game::Game\u003e"},{"line":45,"address":[5714300,5714252],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[4529056,4554735,4554720,4529071],"length":1,"stats":{"Line":14},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":63,"address":[5714825,5714692,5715107,5720968,5720857,5720724,5721139,5714936,5720921,5714889],"length":1,"stats":{"Line":16},"fn_name":null},{"line":65,"address":[5721626,5715148,5715259,5721398,5715304,5725563,5721291,5721336,5715366,5721180,5715594,5719531],"length":1,"stats":{"Line":25},"fn_name":null},{"line":66,"address":[5715958,5716182,5721990,5722214,5721752,5715861,5716005,5722037,5721893,5715720],"length":1,"stats":{"Line":17},"fn_name":null},{"line":68,"address":[5719315,5722699,5717044,5716667,5725347,5716356,5722388,5723669,5717340,5723076,5717637,5723372],"length":1,"stats":{"Line":11},"fn_name":null},{"line":69,"address":[5716223,5722390,5716358,5722255],"length":1,"stats":{"Line":9},"fn_name":null},{"line":70,"address":[5716454,5716600,5722486,5722632],"length":1,"stats":{"Line":6},"fn_name":null},{"line":72,"address":[5722704,5716672],"length":1,"stats":{"Line":2},"fn_name":null},{"line":73,"address":[5722896,5716864],"length":1,"stats":{"Line":6},"fn_name":null},{"line":75,"address":[5723081,5717049],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[5723308,5717276,5723177,5717145],"length":1,"stats":{"Line":2},"fn_name":null},{"line":78,"address":[5723377,5717345],"length":1,"stats":{"Line":2},"fn_name":null},{"line":79,"address":[5723489,5717457],"length":1,"stats":{"Line":2},"fn_name":null},{"line":81,"address":[5723674,5717642],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[5717698,5723730],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[5723856,5717824],"length":1,"stats":{"Line":3},"fn_name":null},{"line":86,"address":[5717864,5723896],"length":1,"stats":{"Line":3},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[5718001,5717920,5724033,5723952],"length":1,"stats":{"Line":5},"fn_name":null},{"line":90,"address":[5716263,5722295],"length":1,"stats":{"Line":1},"fn_name":null},{"line":91,"address":[5716319,5722351,5724160,5718128],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[5726496,5726736],"length":1,"stats":{"Line":2},"fn_name":"persist\u003csecret_clan::model::player::Player\u003e"},{"line":98,"address":[5726605,5726522,5726762,5726845],"length":1,"stats":{"Line":12},"fn_name":null},{"line":99,"address":[5726811,5726571],"length":1,"stats":{"Line":2},"fn_name":null},{"line":101,"address":[5726709,5726951],"length":1,"stats":{"Line":2},"fn_name":null},{"line":104,"address":[5726976,5727632,5727045,5727701],"length":1,"stats":{"Line":1},"fn_name":"remove\u003csecret_clan::model::player::Player\u003e"},{"line":105,"address":[5727217,5727873,5727716,5727060,5727660,5727004,5727240,5727896],"length":1,"stats":{"Line":3},"fn_name":null},{"line":106,"address":[5727219,5727143,5727799,5727875],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[5727835,5727901,5727328,5727245,5727984,5727179],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[5729568,5729645,5728365,5728288],"length":1,"stats":{"Line":2},"fn_name":"remove_batch\u003csecret_clan::model::game::Game\u003e"},{"line":115,"address":[5729594,5728314],"length":1,"stats":{"Line":2},"fn_name":null},{"line":116,"address":[5729110,5729809,5728380,5730390,5728529,5729660],"length":1,"stats":{"Line":4},"fn_name":null},{"line":117,"address":[5730029,5728749,5729848,5729089,5728568,5730369],"length":1,"stats":{"Line":2},"fn_name":null},{"line":118,"address":[5728669,5729949],"length":1,"stats":{"Line":2},"fn_name":null},{"line":119,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[5728711,5728756,5729991,5730036,5728839,5730119],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[5728503,5730562,5729783,5729420,5730732,5729115,5730700,5729452,5730395,5729282],"length":1,"stats":{"Line":4},"fn_name":null},{"line":125,"address":[5729258,5730538],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[5730848,5731278,5731312,5731742],"length":1,"stats":{"Line":3},"fn_name":"get\u003csecret_clan::model::player::Player\u003e"},{"line":129,"address":[5731346,5730882],"length":1,"stats":{"Line":3},"fn_name":null},{"line":130,"address":[5731561,5731097],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[5730949,5731413,5731568,5731776,5731104,5731872,5731786,5731882],"length":1,"stats":{"Line":13},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":132,"address":[5731429,5730965],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[5732028,5731968,5732272,5732332],"length":1,"stats":{"Line":3},"fn_name":"scan\u003csecret_clan::model::game::Game\u003e"},{"line":137,"address":[5732383,5732300,5732043,5732173,5732347,5732079,5731996,5732477],"length":1,"stats":{"Line":12},"fn_name":null},{"line":140,"address":[5732576,5732588,5732656,5732668],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":141,"address":[5732994,5732754,5732976,5732736],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":142,"address":[5732469,5732165,5733275,5733216,5733440,5733499],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":143,"address":[5733291,5733452,5733546,5733322,5733515,5733228],"length":1,"stats":{"Line":6},"fn_name":null},{"line":144,"address":[5733324,5733548],"length":1,"stats":{"Line":2},"fn_name":null},{"line":146,"address":[5733315,5733539],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[5733664,5733728],"length":1,"stats":{"Line":1},"fn_name":"total_count\u003csecret_clan::model::player::Player\u003e"},{"line":153,"address":[5733737,5733673],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[5733792,5733888],"length":1,"stats":{"Line":6},"fn_name":"flush\u003csecret_clan::model::player::Player\u003e"},{"line":157,"address":[5733900,5733984,5734025,5734005,5734037,5733804,5733993,5734016],"length":1,"stats":{"Line":12},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":160,"address":[5735441,5736656,5736736,5734048,5735760,5736288,5735027,5735840,5736208,5735392,5734944,5734576,5734496,5737153,5734131,5737104],"length":1,"stats":{"Line":14},"fn_name":"send_result\u003csecret_clan::model::player::Player,core::result::Result\u003ccore::option::Option\u003csecret_clan::model::player::Player\u003e, sled::result::Error\u003e\u003e"},{"line":161,"address":[5737429,5734461,5734591,5737168,5735717,5735783,5735855,5735417,5734967,5736618,5736303,5734146,5734906,5736170,5734071,5737129,5736679,5735357,5736751,5736231,5735456,5737066,5734519,5735042],"length":1,"stats":{"Line":27},"fn_name":null},{"line":162,"address":[5735921,5736915,5736019,5736369,5736817,5736467,5735588,5734657,5737214,5735108,5735206,5734310,5734755,5737300,5734212,5735502],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[5737525,5738032,5737472,5738085],"length":1,"stats":{"Line":6},"fn_name":"purge\u003csecret_clan::model::game::Game\u003e"},{"line":167,"address":[5738100,5738773,5738672,5738793,5738784,5738604,5738752,5737487,5737540,5738592,5738684,5738047,5738761,5738805],"length":1,"stats":{"Line":23},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":168,"address":[5738296,5737779,5738339,5737615,5737736,5738175],"length":1,"stats":{"Line":6},"fn_name":null},{"line":170,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":62,"coverable":74},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","mod.rs"],"content":"mod client;\nmod database;\n\nuse sled::IVec;\nuse std::{\n    clone::Clone,\n    collections::HashSet,\n    convert::TryFrom,\n    fmt::{self, Debug},\n};\nuse tokio::sync::oneshot;\n\npub use self::client::Client;\npub use self::database::Database;\n\npub trait Persist: Into\u003cIVec\u003e + TryFrom\u003cIVec\u003e + Clone + Debug + Send {\n    fn id(\u0026self) -\u003e \u0026str;\n}\n#[derive(Debug, Clone)]\npub struct QueryError {\n    message: String,\n}\n\nimpl QueryError {\n    pub fn new(message: \u0026str) -\u003e Self {\n        QueryError {\n            message: String::from(message),\n        }\n    }\n\n    pub fn from_sled(error: sled::Error) -\u003e Self {\n        QueryError {\n            message: error.to_string(),\n        }\n    }\n}\n\nimpl fmt::Display for QueryError {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter) -\u003e fmt::Result {\n        write!(f, \"invalid first item to double\")\n    }\n}\n\n#[derive(Derivative)]\n#[derivative(Debug)]\npub struct CommandData\u003cR: Debug\u003e {\n    id: String,\n    #[derivative(Debug = \"ignore\")]\n    responder: oneshot::Sender\u003cR\u003e,\n}\n\npub type ScanFunction\u003cT\u003e = Box\u003cdyn Fn(\u0026T) -\u003e bool + Send + Sync\u003e;\n\n#[derive(Derivative)]\n#[derivative(Debug)]\npub enum Command\u003cT: Persist\u003e {\n    Get {\n        key: String,\n        data: CommandData\u003cResult\u003cOption\u003cT\u003e, sled::Error\u003e\u003e,\n    },\n    Scan {\n        #[derivative(Debug = \"ignore\")]\n        scan_function: ScanFunction\u003cT\u003e,\n        data: CommandData\u003cResult\u003cHashSet\u003cString\u003e, sled::Error\u003e\u003e,\n    },\n    Persist {\n        value: T,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Remove {\n        key: String,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Purge {\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    RemoveBatch {\n        keys: HashSet\u003cString\u003e,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Count {\n        data: CommandData\u003cusize\u003e,\n    },\n}\n","traces":[{"line":25,"address":[5840720],"length":1,"stats":{"Line":0},"fn_name":"new"},{"line":27,"address":[5840737],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[5840800,5840841],"length":1,"stats":{"Line":0},"fn_name":"from_sled"},{"line":33,"address":[5840807],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[5840944],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":40,"address":[5840977],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","cleanup_games.rs"],"content":"use crate::{db::Client, model::Game, server::app_context::AppContext};\nuse chrono::{Duration, Utc};\nuse log::{debug, info, warn};\n\npub fn cleanup_games(ctx: \u0026'static AppContext) -\u003e impl Fn() {\n    move || {\n        tokio::task::spawn(async move {\n            execute_cleanup_games(ctx.db().games(), Duration::minutes(5)).await;\n        });\n    }\n}\n\nasync fn execute_cleanup_games(client: \u0026Client\u003cGame\u003e, duration: Duration) -\u003e bool {\n    let inactive_games = client\n        .scan(Box::new(is_inactive_game(duration)))\n        .await\n        .expect(\"Scanning games has failed\");\n\n    let inactive_count = inactive_games.len();\n    if inactive_count == 0 {\n        debug!(\"Removed no inactive games\");\n        false\n    } else {\n        match client.remove_batch(\u0026inactive_games).await {\n            Ok(_) =\u003e {\n                info!(\"Removed {} inactive games\", inactive_count);\n                true\n            }\n            Err(e) =\u003e {\n                warn!(\n                    \"Removing {} inactive games has failed: {:?}\",\n                    inactive_count, e\n                );\n                false\n            }\n        }\n    }\n}\n\n// Game is inactive if no admin is present and last activity happened five minutes ago\nfn is_inactive_game(duration: Duration) -\u003e impl Fn(\u0026Game) -\u003e bool {\n    let threshold = Utc::now().checked_sub_signed(duration).unwrap();\n    move |game: \u0026Game| match game.admin_id() {\n        Some(_) =\u003e false,\n        None =\u003e game.last_action_time().lt(\u0026threshold),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::execute_cleanup_games;\n    use crate::{\n        db::{Client, Database},\n        model::Game,\n    };\n    use chrono::Duration;\n\n    fn init_client() -\u003e Client\u003cGame\u003e {\n        let mut repo = Database::init(\"games\");\n\n        let sender = repo.sender();\n        tokio::task::spawn(async move {\n            repo.start_listening().await;\n        });\n\n        let client = Client::new(sender);\n\n        client\n    }\n\n    #[tokio::test]\n    async fn should_cleanup_games() {\n        let client = init_client();\n        let mut game = Game::new(\"admin\", \"TOKEN\");\n        game.remove_player(\"admin\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_none());\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n\n        let res = execute_cleanup_games(\u0026client, Duration::nanoseconds(1)).await;\n        assert!(res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_none());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_games_with_admin() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"TOKEN\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_some());\n\n        let res = execute_cleanup_games(\u0026client, Duration::nanoseconds(1)).await;\n        assert!(!res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_games_with_recent_action() {\n        let client = init_client();\n        let mut game = Game::new(\"admin\", \"TOKEN\");\n        game.remove_player(\"admin\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_none());\n\n        let res = execute_cleanup_games(\u0026client, Duration::minutes(5)).await;\n        assert!(!res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n    }\n}\n","traces":[{"line":5,"address":[6977360],"length":1,"stats":{"Line":0},"fn_name":"cleanup_games"},{"line":6,"address":[6977369],"length":1,"stats":{"Line":0},"fn_name":null},{"line":7,"address":[5766732,5766624,5766710,5766639],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":8,"address":[5766694],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[5926337,5926304],"length":1,"stats":{"Line":8},"fn_name":"execute_cleanup_games"},{"line":14,"address":[5769327],"length":1,"stats":{"Line":8},"fn_name":null},{"line":15,"address":[6042782],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[6043460,6043523],"length":1,"stats":{"Line":6},"fn_name":null},{"line":20,"address":[6045386,6043534,6043965],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[6043607,6043806,6043740,6043950,6043853],"length":1,"stats":{"Line":8},"fn_name":null},{"line":22,"address":[6043957],"length":1,"stats":{"Line":2},"fn_name":null},{"line":24,"address":[4522645],"length":1,"stats":{"Line":6},"fn_name":null},{"line":25,"address":[4841347],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4841566,4841442,4841646,4841805,4841605],"length":1,"stats":{"Line":4},"fn_name":null},{"line":27,"address":[4841846],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4841364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[4842036,4842066,4841942,4842313,4842225,4841995,4841859,4841396],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[4842062],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[4842354],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[5926384],"length":1,"stats":{"Line":1},"fn_name":"is_inactive_game"},{"line":42,"address":[5926400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[4843255,4843187,4843168,4843281,4843248],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}"},{"line":44,"address":[4843250,4843211],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4843236,4843266],"length":1,"stats":{"Line":2},"fn_name":null},{"line":58,"address":[6238762,6238688],"length":1,"stats":{"Line":1},"fn_name":"init_client"},{"line":59,"address":[6238705],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[6238790],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[6238805],"length":1,"stats":{"Line":9},"fn_name":null},{"line":63,"address":[5808102],"length":1,"stats":{"Line":7},"fn_name":null},{"line":66,"address":[6238990],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[5785813,5785783,5785840,5785536,5785758,5785722,5785689,5785557],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":73,"address":[6256590],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[6256605],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[6256662],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[5785673],"length":1,"stats":{"Line":5},"fn_name":null},{"line":77,"address":[5785742],"length":1,"stats":{"Line":7},"fn_name":null},{"line":84,"address":[5785767],"length":1,"stats":{"Line":5},"fn_name":null},{"line":86,"address":[5785797],"length":1,"stats":{"Line":5},"fn_name":null},{"line":87,"address":[6258735,6258776],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[5785824],"length":1,"stats":{"Line":5},"fn_name":null},{"line":92,"address":[5826247,5826096,5826280,5826313,5826367,5826117,5826340],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":94,"address":[6260574],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[6260589],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5826231],"length":1,"stats":{"Line":5},"fn_name":null},{"line":97,"address":[5826297],"length":1,"stats":{"Line":7},"fn_name":null},{"line":105,"address":[5826324],"length":1,"stats":{"Line":5},"fn_name":null},{"line":106,"address":[6262089,6262132],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5826351],"length":1,"stats":{"Line":5},"fn_name":null},{"line":111,"address":[5854320,5854341,5854564,5854591,5854504,5854537,5854471],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":113,"address":[6263726],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[6263741],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[6263798],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[5854455],"length":1,"stats":{"Line":5},"fn_name":null},{"line":117,"address":[5854521],"length":1,"stats":{"Line":7},"fn_name":null},{"line":125,"address":[5854548],"length":1,"stats":{"Line":5},"fn_name":null},{"line":126,"address":[6265277,6265320],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[5854575],"length":1,"stats":{"Line":5},"fn_name":null}],"covered":49,"coverable":57},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","cleanup_players.rs"],"content":"use crate::{model::Player, server::app_context::AppContext};\nuse chrono::{Duration, Utc};\nuse log::{debug, info, warn};\n\npub fn cleanup_players(ctx: \u0026'static AppContext) -\u003e impl Fn() {\n    move || {\n        tokio::spawn(async move {\n            execute_cleanup_players(ctx, Duration::minutes(1)).await;\n        });\n    }\n}\n\n// Player is active after one minute without an active connection\nfn is_inactive_player(duration: Duration) -\u003e impl Fn(\u0026Player) -\u003e bool {\n    let threshold = Utc::now().checked_sub_signed(duration).unwrap();\n\n    move |player: \u0026Player| player.last_action_time().lt(\u0026threshold)\n}\n\nasync fn execute_cleanup_players(ctx: \u0026AppContext, duration: Duration) -\u003e bool {\n    let inactive_players = ctx\n        .db()\n        .players()\n        .scan(Box::new(is_inactive_player(duration)))\n        .await\n        .expect(\"Scanning players has failed\");\n    let inactive_count = inactive_players.len();\n\n    // remove players from maybe existing game\n    for id in inactive_players.clone() {\n        let player = ctx.db().players().get(\u0026id).await;\n        if let Some(player) = player.expect(\"Reading player has failed\") {\n            let game = ctx.db().games().get(player.game_token()).await;\n            if let Some(mut game) = game.expect(\"Reading game has failed\") {\n                game.remove_player(\u0026id);\n                if ctx.db().games().persist(\u0026game).await.is_err() {\n                    warn!(\"Removing player has failed\");\n                }\n            }\n        }\n    }\n\n    // remove players\n    if inactive_count \u003e 0 {\n        match ctx.db().players().remove_batch(\u0026inactive_players).await {\n            Ok(_) =\u003e {\n                info!(\"Removed {} inactive players\", inactive_count);\n                true\n            }\n            Err(e) =\u003e {\n                warn!(\n                    \"Removing {} inactive players has failed: {:?}\",\n                    inactive_count, e\n                );\n                false\n            }\n        }\n    } else {\n        debug!(\"Removed no inactive players\");\n        false\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::execute_cleanup_players;\n    use crate::{\n        model::{Game, GameState, Player},\n        server::app_context::AppContext,\n    };\n    use chrono::Duration;\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_cleanup_player() {\n        let ctx = init_ctx();\n        let player = Player::new(\"GAME\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Persisting player failed\");\n        let game = Game::new(player.id(), \"GAME\");\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Persisting game failed\");\n\n        let res = execute_cleanup_players(\u0026ctx, Duration::nanoseconds(1)).await;\n        assert!(res);\n\n        assert!(ctx.db().players().get(player.id()).await.unwrap().is_none());\n        assert!(ctx\n            .db()\n            .games()\n            .get(player.game_token())\n            .await\n            .unwrap()\n            .expect(\"Game should still exist\")\n            .admin_id()\n            .is_none());\n        assert_eq!(\n            ctx.db()\n                .games()\n                .get(player.game_token())\n                .await\n                .unwrap()\n                .expect(\"Game should still exist\")\n                .state(),\n            \u0026GameState::Abandoned\n        );\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_player() {\n        let ctx = init_ctx();\n        let player = Player::new(\"GAME\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Persisting player failed\");\n\n        let res = execute_cleanup_players(\u0026ctx, Duration::minutes(1)).await;\n        assert!(!res);\n\n        assert!(ctx.db().players().get(player.id()).await.unwrap().is_some());\n    }\n}\n","traces":[{"line":5,"address":[5704576],"length":1,"stats":{"Line":0},"fn_name":"cleanup_players"},{"line":6,"address":[6128697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":7,"address":[5771312,5771398,5771420,5771327],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":8,"address":[5771382],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[6128720],"length":1,"stats":{"Line":1},"fn_name":"is_inactive_player"},{"line":15,"address":[5704624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[5704788],"length":1,"stats":{"Line":3},"fn_name":null},{"line":20,"address":[4508878,4508761,4508661,4508640,4508958,4509029,4509068,4509267,4509171],"length":1,"stats":{"Line":6},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":21,"address":[4508741],"length":1,"stats":{"Line":10},"fn_name":null},{"line":24,"address":[6445206],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[6445938,6446005],"length":1,"stats":{"Line":4},"fn_name":null},{"line":30,"address":[6446171,6446129,6449643,6446088,6446016,6446199,6446317],"length":1,"stats":{"Line":11},"fn_name":null},{"line":31,"address":[4508858],"length":1,"stats":{"Line":5},"fn_name":null},{"line":32,"address":[6447164,6447467],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4509009],"length":1,"stats":{"Line":5},"fn_name":null},{"line":34,"address":[6448194,6448398],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[6448544],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[4509114],"length":1,"stats":{"Line":5},"fn_name":null},{"line":37,"address":[6449179,6449312,6449352,6449399,6449496],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[6451786,6449656],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4509216],"length":1,"stats":{"Line":6},"fn_name":null},{"line":46,"address":[6450176],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[6450404,6450446,6450487,6450271,6450646],"length":1,"stats":{"Line":4},"fn_name":null},{"line":48,"address":[6450687],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[6450193],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[6451154,6451066,6450907,6450783,6450877,6450700,6450836,6450225],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[6450903],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[6451195],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[6451347,6449663,6451227,6451388,6451485,6451310],"length":1,"stats":{"Line":4},"fn_name":null},{"line":60,"address":[6451492],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6068976],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":74,"address":[6068984],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[5566336,5566304,5566365,5566309,5570779,5570983],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":79,"address":[5566446],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[5566461],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[5862871],"length":1,"stats":{"Line":6},"fn_name":null},{"line":83,"address":[5566592],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[5567043,5567000],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[5567320,5567205,5567101,5567394,5567265,5567129,5570884],"length":1,"stats":{"Line":6},"fn_name":null},{"line":89,"address":[5567183],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[5863013],"length":1,"stats":{"Line":5},"fn_name":null},{"line":94,"address":[5568020,5567991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5568757,5568066,5568842,5568348,5568005,5570926,5568274,5568098,5568179],"length":1,"stats":{"Line":6},"fn_name":null},{"line":97,"address":[5570947,5569602,5568888,5569496,5568827,5568982,5569096,5569001,5569170,5569521,5569471],"length":1,"stats":{"Line":8},"fn_name":null},{"line":100,"address":[5568920],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[5570389,5570689,5570280,5570599,5570242],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[5570220,5570968,5569857,5570264,5569740,5569762,5569587,5569931,5569648],"length":1,"stats":{"Line":8},"fn_name":null},{"line":109,"address":[5569678],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[5572368,5574259,5572400,5572423,5574400,5572373],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":120,"address":[5572504],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[5572519],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[5572847,5572782,5572670,5572730,5574343,5572599,5572553],"length":1,"stats":{"Line":6},"fn_name":null},{"line":124,"address":[5572650],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[5573056,5573099,5573206,5573271,5573121,5574364],"length":1,"stats":{"Line":5},"fn_name":null},{"line":129,"address":[5573430,5573402],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[5574206,5574131,5573568,5573660,5574385,5573418,5573725,5573473,5573502],"length":1,"stats":{"Line":6},"fn_name":null}],"covered":47,"coverable":56},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","mod.rs"],"content":"mod cleanup_games;\nmod cleanup_players;\n\nuse self::cleanup_games::cleanup_games;\nuse self::cleanup_players::cleanup_players;\nuse crate::server::app_context::AppContext;\nuse clokwerk::{Scheduler, TimeUnits};\nuse std::{thread, time::Duration};\n\nconst JOB_INTERVAL: u32 = 60;\n\npub fn init_jobs(ctx: \u0026'static AppContext) {\n    tokio::task::spawn(async move {\n        let mut scheduler = Scheduler::new();\n\n        scheduler\n            .every(JOB_INTERVAL.seconds())\n            .run(cleanup_games(ctx));\n        scheduler\n            .every(JOB_INTERVAL.seconds())\n            .run(cleanup_players(ctx));\n\n        loop {\n            scheduler.run_pending();\n            thread::sleep(Duration::from_millis(100));\n        }\n    });\n}\n","traces":[{"line":12,"address":[6499184],"length":1,"stats":{"Line":0},"fn_name":"init_jobs"},{"line":13,"address":[4895232,4895598,4895249],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":14,"address":[4895287],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[4895396,4895327],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[4895303],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[4895381],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[4895445,4895498],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[4895419],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[4895483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[4895521,4895591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[4895525],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[4895569,4895551],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":12},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","lib.rs"],"content":"use jobs::init_jobs;\nuse server::{app_context::AppContext, run_server};\nuse tokio::runtime::Builder;\n\nmod config;\npub mod db;\npub mod jobs;\npub mod model;\npub mod server;\n\nextern crate chrono;\nextern crate envconfig;\nextern crate log;\n\n#[macro_use]\nextern crate derivative;\n\npub fn run_app() {\n    let mut rt = Builder::new()\n        .threaded_scheduler()\n        .enable_all()\n        .thread_name(\"sc\")\n        .build()\n        .expect(\"Creating runtime failed\");\n\n    rt.block_on(async {\n        let ctx: \u0026'static AppContext = Box::leak(Box::new(AppContext::init()));\n\n        init_jobs(ctx);\n\n        run_server(\u0026ctx).await;\n    });\n}\n","traces":[{"line":18,"address":[4498103,4498080],"length":1,"stats":{"Line":0},"fn_name":"run_app"},{"line":19,"address":[4498179,4498118,4498087],"length":1,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[4498312],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[4805182,4805147,4805041],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[4805185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[4560038],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","model","game.rs"],"content":"use crate::db::Persist;\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sled::IVec;\nuse std::{collections::HashSet, convert::TryFrom};\n\n#[derive(Serialize, Deserialize, Clone, PartialEq, Eq, Debug)]\npub enum GameState {\n    Initialized,\n    Abandoned,\n    Started,\n}\n\n/// This struct defines a game session. Each valid game needs to have an admin who is responsible for defining game settings.\n/// The admin is also a player but currently not added redundantly to player_ids as well as admin_id.\n///\n/// Please note that each method here only mutates the struct state but still needs to be persisted to the database separately.\n///\n/// Example:\n/// ```no_run\n/// use secret_clan::{model::Game, db::{Database, Client}};\n/// let mut repo: Database\u003cGame\u003e = Database::init(\"test\");\n/// let sender = repo.sender();\n/// std::thread::spawn(move || {\n///     repo.start_listening();\n/// });\n/// std::thread::spawn(move || {\n///     async move {\n///         let client = Client::new(sender.clone());\n///         let mut game = Game::new(\"admin\", \"GAME\");\n///         game.start();\n///         let _ = client.persist(\u0026game).await;\n///     }\n/// });\n/// ```\n#[derive(Serialize, Deserialize, Clone, PartialEq, Eq, Debug)]\npub struct Game {\n    token: String,\n    creation_time: DateTime\u003cUtc\u003e,\n    last_action_time: DateTime\u003cUtc\u003e,\n    admin_id: Option\u003cString\u003e,\n    player_ids: HashSet\u003cString\u003e,\n    state: GameState,\n}\n\nimpl Game {\n    pub fn new(admin_id: \u0026str, token: \u0026str) -\u003e Self {\n        Game {\n            token: String::from(token).to_uppercase(),\n            creation_time: Utc::now(),\n            last_action_time: Utc::now(),\n            admin_id: Some(String::from(admin_id)),\n            player_ids: HashSet::new(),\n            state: GameState::Initialized,\n        }\n    }\n\n    pub fn token(\u0026self) -\u003e \u0026str {\n        \u0026self.token\n    }\n\n    pub fn player_ids(\u0026self) -\u003e \u0026HashSet\u003cString\u003e {\n        \u0026self.player_ids\n    }\n\n    pub fn admin_id(\u0026self) -\u003e \u0026Option\u003cString\u003e {\n        \u0026self.admin_id\n    }\n\n    pub fn last_action_time(\u0026self) -\u003e \u0026DateTime\u003cUtc\u003e {\n        \u0026self.last_action_time\n    }\n\n    pub fn state(\u0026self) -\u003e \u0026GameState {\n        \u0026self.state\n    }\n\n    pub fn add_player(\u0026mut self, player_id: \u0026str) {\n        match self.admin_id {\n            Some(_) =\u003e {\n                self.player_ids.insert(String::from(player_id));\n            }\n            None =\u003e self.admin_id = Some(String::from(player_id)),\n        }\n    }\n\n    pub fn remove_player(\u0026mut self, player_id: \u0026str) {\n        if self.player_ids.contains(player_id) {\n            self.player_ids.remove(player_id);\n        } else if self\n            .admin_id\n            .to_owned()\n            .filter(|id| id == player_id)\n            .is_some()\n        {\n            if let Some(next_player_id) = self.player_ids.iter().next().map(String::from) {\n                self.admin_id = Some(String::from(\u0026next_player_id));\n                self.player_ids.remove(\u0026next_player_id);\n            } else {\n                self.admin_id = None;\n                self.state = GameState::Abandoned\n            }\n        } else {\n            // game is already abandoned or requesting user is no admin or player\n        }\n    }\n\n    pub fn start(\u0026mut self) {\n        self.state = GameState::Started;\n    }\n}\n\nimpl Persist for Game {\n    fn id(\u0026self) -\u003e \u0026str {\n        self.token()\n    }\n}\n\nimpl Into\u003cIVec\u003e for Game {\n    fn into(self) -\u003e IVec {\n        IVec::from(bincode::serialize(\u0026self).unwrap())\n    }\n}\n\nimpl TryFrom\u003cIVec\u003e for Game {\n    type Error = bincode::Error;\n    fn try_from(bytes: IVec) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let vec: Vec\u003cu8\u003e = bytes.to_vec();\n\n        bincode::deserialize(\u0026vec)\n    }\n}\n","traces":[{"line":47,"address":[5524288,5524371],"length":1,"stats":{"Line":4},"fn_name":"new"},{"line":49,"address":[5524330,5524391],"length":1,"stats":{"Line":8},"fn_name":null},{"line":50,"address":[5524447],"length":1,"stats":{"Line":4},"fn_name":null},{"line":51,"address":[5524562,5524525],"length":1,"stats":{"Line":10},"fn_name":null},{"line":52,"address":[5524632],"length":1,"stats":{"Line":5},"fn_name":null},{"line":53,"address":[5524671],"length":1,"stats":{"Line":5},"fn_name":null},{"line":58,"address":[5524960],"length":1,"stats":{"Line":1},"fn_name":"token"},{"line":59,"address":[5524969],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[5525008],"length":1,"stats":{"Line":1},"fn_name":"player_ids"},{"line":63,"address":[5525013],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[5525040],"length":1,"stats":{"Line":1},"fn_name":"admin_id"},{"line":67,"address":[5525045],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[5525072],"length":1,"stats":{"Line":1},"fn_name":"last_action_time"},{"line":71,"address":[5525077],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[5525104],"length":1,"stats":{"Line":1},"fn_name":"state"},{"line":75,"address":[5525109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":78,"address":[5525136,5525349],"length":1,"stats":{"Line":1},"fn_name":"add_player"},{"line":79,"address":[5525221,5525273,5525396],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[5525161],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[5525228],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[5525326,5525364,5525199,5525275],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[5525496,5525424],"length":1,"stats":{"Line":1},"fn_name":"remove_player"},{"line":88,"address":[5526002,5525515,5525449,5525578],"length":1,"stats":{"Line":4},"fn_name":null},{"line":89,"address":[5525553],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[5525593,5526272,5525665,5525526],"length":1,"stats":{"Line":4},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[5525583],"length":1,"stats":{"Line":3},"fn_name":null},{"line":96,"address":[5525997,5525681,5525810],"length":1,"stats":{"Line":3},"fn_name":null},{"line":97,"address":[5526160,5525863],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[5526235],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[5526012,5525772],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[5526096],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5526448],"length":1,"stats":{"Line":1},"fn_name":"start"},{"line":109,"address":[5526457],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[5526480],"length":1,"stats":{"Line":1},"fn_name":"id"},{"line":115,"address":[5526489],"length":1,"stats":{"Line":1},"fn_name":null},{"line":120,"address":[5526569,5526528],"length":1,"stats":{"Line":1},"fn_name":"into"},{"line":121,"address":[5526581,5526622,5526535],"length":1,"stats":{"Line":11},"fn_name":null},{"line":127,"address":[5526688,5526756],"length":1,"stats":{"Line":1},"fn_name":"try_from"},{"line":128,"address":[5526700],"length":1,"stats":{"Line":2},"fn_name":null},{"line":130,"address":[5526781],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":39,"coverable":41},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","model","player.rs"],"content":"use crate::db::Persist;\nuse chrono::{DateTime, Utc};\nuse names::Generator;\nuse nanoid::nanoid;\nuse serde::{Deserialize, Serialize};\nuse sled::IVec;\nuse std::hash::Hash;\n\nfn generate_random_name() -\u003e String {\n    Generator::default().next().unwrap()\n}\n\n#[derive(Serialize, Deserialize, Clone, Hash, PartialEq, Eq, Derivative)]\n#[derivative(Debug)]\npub struct Player {\n    id: String,\n    name: String,\n    game_token: String,\n    #[derivative(Debug = \"ignore\")]\n    user_token: String,\n    creation_time: DateTime\u003cUtc\u003e,\n    last_action_time: DateTime\u003cUtc\u003e,\n}\n\nimpl Player {\n    pub fn new(game_token: \u0026str) -\u003e Self {\n        Player {\n            id: nanoid!(),\n            name: generate_random_name(),\n            game_token: String::from(game_token),\n            user_token: String::from(\"\"),\n            creation_time: Utc::now(),\n            last_action_time: Utc::now(),\n        }\n    }\n\n    pub fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    pub fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    pub fn set_name(\u0026mut self, name: \u0026str) {\n        if !name.is_empty() {\n            self.name = String::from(name);\n        }\n    }\n\n    pub fn game_token(\u0026self) -\u003e \u0026str {\n        \u0026self.game_token\n    }\n\n    pub fn update_token(\u0026mut self, new_token: \u0026str) {\n        self.user_token = String::from(new_token);\n    }\n\n    pub fn heartbeat(\u0026mut self) {\n        self.last_action_time = Utc::now();\n    }\n\n    pub fn last_action_time(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.last_action_time\n    }\n}\n\nimpl Persist for Player {\n    fn id(\u0026self) -\u003e \u0026str {\n        self.id()\n    }\n}\n\nimpl Into\u003cIVec\u003e for Player {\n    fn into(self) -\u003e IVec {\n        IVec::from(bincode::serialize(\u0026self).unwrap())\n    }\n}\n\nimpl From\u003cIVec\u003e for Player {\n    fn from(bytes: IVec) -\u003e Player {\n        let vec: Vec\u003cu8\u003e = bytes.to_vec();\n        bincode::deserialize(\u0026vec).unwrap()\n    }\n}\n","traces":[{"line":9,"address":[5926768],"length":1,"stats":{"Line":1},"fn_name":"generate_random_name"},{"line":10,"address":[5190183],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[5190365,5190272],"length":1,"stats":{"Line":1},"fn_name":"new"},{"line":28,"address":[5190312],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[5190385],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[5190407],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[5190427],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[5190505,5190466],"length":1,"stats":{"Line":2},"fn_name":null},{"line":33,"address":[5927149,5927191],"length":1,"stats":{"Line":2},"fn_name":null},{"line":37,"address":[5927520],"length":1,"stats":{"Line":2},"fn_name":"id"},{"line":38,"address":[5927529],"length":1,"stats":{"Line":2},"fn_name":null},{"line":41,"address":[5190976],"length":1,"stats":{"Line":2},"fn_name":"name"},{"line":42,"address":[5190985],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[5191024,5191156],"length":1,"stats":{"Line":1},"fn_name":"set_name"},{"line":46,"address":[5191200,5191048],"length":1,"stats":{"Line":2},"fn_name":null},{"line":47,"address":[5191168,5191133,5191085],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[5191216],"length":1,"stats":{"Line":2},"fn_name":"game_token"},{"line":52,"address":[5191225],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[5927936,5927856],"length":1,"stats":{"Line":1},"fn_name":"update_token"},{"line":56,"address":[5927875,5927948],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[5928000],"length":1,"stats":{"Line":1},"fn_name":"heartbeat"},{"line":60,"address":[5928009],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[5928080],"length":1,"stats":{"Line":1},"fn_name":"last_action_time"},{"line":64,"address":[5928089],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[5928128],"length":1,"stats":{"Line":1},"fn_name":"id"},{"line":70,"address":[5928137],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[5928176,5928217],"length":1,"stats":{"Line":1},"fn_name":"into"},{"line":76,"address":[5928270,5928229,5928183],"length":1,"stats":{"Line":3},"fn_name":null},{"line":81,"address":[5928336,5928407],"length":1,"stats":{"Line":1},"fn_name":"from"},{"line":82,"address":[5928351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[5928435,5928500],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":31,"coverable":31},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","app_context.rs"],"content":"use super::logger::init_logger;\nuse crate::{\n    config::AppConfig,\n    db::{Client, Database},\n    model::{Game, Player},\n};\nuse envconfig::Envconfig;\n\npub struct DbClients {\n    games: Client\u003cGame\u003e,\n    players: Client\u003cPlayer\u003e,\n}\n\nimpl DbClients {\n    pub fn init() -\u003e DbClients {\n        let mut games_repo = Database::init(\"games\");\n        let games_sender = games_repo.sender();\n        tokio::task::spawn(async move {\n            games_repo.start_listening().await;\n        });\n        let mut players_repo = Database::init(\"players\");\n        let players_sender = players_repo.sender();\n        tokio::task::spawn(async move {\n            players_repo.start_listening().await;\n        });\n\n        DbClients {\n            games: Client::new(games_sender),\n            players: Client::new(players_sender),\n        }\n    }\n\n    pub fn games(\u0026self) -\u003e \u0026Client\u003cGame\u003e {\n        \u0026self.games\n    }\n\n    pub fn players(\u0026self) -\u003e \u0026Client\u003cPlayer\u003e {\n        \u0026self.players\n    }\n}\n\npub struct AppContext {\n    db: DbClients,\n    config: AppConfig,\n}\n\nimpl AppContext {\n    pub fn init() -\u003e AppContext {\n        let config = AppConfig::init_from_env().expect(\"Loading server config failed\");\n\n        init_logger(\u0026config);\n\n        let db = DbClients::init();\n\n        AppContext { db, config }\n    }\n\n    pub fn db(\u0026self) -\u003e \u0026DbClients {\n        \u0026self.db\n    }\n\n    pub fn config(\u0026self) -\u003e \u0026AppConfig {\n        \u0026self.config\n    }\n\n    pub fn is_dev(\u0026self) -\u003e bool {\n        cfg!(debug_assertions)\n    }\n}\n","traces":[{"line":15,"address":[6830832,6830923],"length":1,"stats":{"Line":1},"fn_name":"init"},{"line":16,"address":[6978449],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[6830938],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[6978565],"length":1,"stats":{"Line":8},"fn_name":null},{"line":19,"address":[4548566],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[6978750],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[6831202],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[6129767,6129664,6130101,6129687],"length":1,"stats":{"Line":7},"fn_name":"{{closure}}"},{"line":24,"address":[6129755,6129845,6129954,6129889,6129794,6130086],"length":1,"stats":{"Line":9},"fn_name":null},{"line":28,"address":[6979017],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[6831513],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[6979520],"length":1,"stats":{"Line":1},"fn_name":"games"},{"line":34,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[6831984],"length":1,"stats":{"Line":1},"fn_name":"players"},{"line":38,"address":[6831989],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[6832052,6832016],"length":1,"stats":{"Line":1},"fn_name":"init"},{"line":49,"address":[6832026,6832081],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[6832123],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[6832130],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[6832352],"length":1,"stats":{"Line":1},"fn_name":"db"},{"line":59,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[6832368],"length":1,"stats":{"Line":1},"fn_name":"config"},{"line":63,"address":[6832373],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[6832400],"length":1,"stats":{"Line":0},"fn_name":"is_dev"}],"covered":21,"coverable":24},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","auth.rs"],"content":"use super::app_context::AppContext;\nuse crate::model::Player;\nuse hmac::{Hmac, NewMac};\nuse jwt::{AlgorithmType, Error, Header, SignWithKey, Token, VerifyWithKey};\nuse sha2::Sha256;\nuse std::collections::BTreeMap;\nuse std::result::Result;\n\npub fn generate_jwt_token(player: \u0026Player, secret: \u0026str) -\u003e String {\n    let key = init_key(secret);\n    let header = Header {\n        algorithm: AlgorithmType::Hs256,\n        ..Default::default()\n    };\n    let mut claims = BTreeMap::new();\n    claims.insert(String::from(\"sub\"), String::from(player.id()));\n    claims.insert(String::from(\"name\"), String::from(player.name()));\n    claims.insert(String::from(\"game\"), String::from(player.game_token()));\n\n    let jwt_token = Token::new(header, claims).sign_with_key(\u0026key).unwrap();\n\n    String::from(jwt_token.as_str())\n}\n\npub fn extract_verified_token(\n    token_str: \u0026str,\n    secret: \u0026str,\n) -\u003e Result\u003cToken\u003cHeader, BTreeMap\u003cString, String\u003e, jwt::token::Verified\u003e, Error\u003e {\n    let key = init_key(secret);\n    let raw_token: \u0026str = \u0026token_str.replace(\"Bearer \", \"\");\n    let token: Result\u003cToken\u003cHeader, BTreeMap\u003cString, String\u003e, jwt::token::Verified\u003e, Error\u003e =\n        VerifyWithKey::verify_with_key(raw_token, \u0026key);\n\n    token\n}\n\npub fn extract_verified_id(authorization: \u0026str, ctx: \u0026AppContext) -\u003e Option\u003cString\u003e {\n    extract_verified_token(\u0026authorization, \u0026ctx.config().auth_secret)\n        .ok()\n        .and_then(|token| token.claims().get(\"sub\").map(String::from))\n}\n\nfn init_key(secret: \u0026str) -\u003e Hmac\u003cSha256\u003e {\n    Hmac::new_varkey(secret.as_bytes()).unwrap()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{extract_verified_id, extract_verified_token, generate_jwt_token};\n    use crate::{model::Player, server::app_context::AppContext};\n\n    const SECRET: \u0026str = \"super-secret\";\n\n    #[test]\n    fn should_create_token() {\n        let player = Player::new(\"game\");\n        let token = generate_jwt_token(\u0026player, SECRET);\n\n        // payload contains dynamic ID of user, so we can't check the payload for equalness\n        assert!(token.starts_with(\"eyJhbGciOiJIUzI1NiJ9\"));\n    }\n\n    #[test]\n    fn should_verify_token() {\n        let token = extract_verified_token(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX4\", \"super-secret\");\n\n        assert_eq!(token.unwrap().claims().get(\"name\").unwrap(), \"Random Dude\");\n    }\n\n    #[tokio::test]\n    async fn should_extract_verified_id() {\n        let ctx = AppContext::init();\n        let id = extract_verified_id(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX4\", \u0026ctx);\n\n        assert_eq!(id.unwrap(), \"MllJ7oeCY4RGw2M6tIHBZ\");\n    }\n\n    #[tokio::test]\n    async fn should_not_extract_unverified_id() {\n        let ctx = AppContext::init();\n        let id = extract_verified_id(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX3\", \u0026ctx);\n\n        assert!(id.is_none());\n    }\n\n    #[test]\n    fn should_create_and_verify_token() {\n        let player = Player::new(\"game\");\n        let token_str = generate_jwt_token(\u0026player, SECRET);\n        let token = extract_verified_token(\u0026token_str, SECRET);\n        assert!(!token.unwrap().claims().get(\"name\").unwrap().is_empty());\n    }\n\n    #[test]\n    fn should_fail_to_verify_token() {\n        let token = extract_verified_token(\"eyJhbGciOiJIUzI1NiJ9.XYZ.ABC\", \"super-secret\");\n\n        assert!(token.is_err());\n    }\n}\n","traces":[{"line":9,"address":[6077664,6077774],"length":1,"stats":{"Line":2},"fn_name":"generate_jwt_token"},{"line":10,"address":[6077698],"length":1,"stats":{"Line":2},"fn_name":null},{"line":15,"address":[6077892],"length":1,"stats":{"Line":2},"fn_name":null},{"line":16,"address":[4398470,4399289],"length":1,"stats":{"Line":2},"fn_name":null},{"line":17,"address":[4398634,4399325],"length":1,"stats":{"Line":2},"fn_name":null},{"line":18,"address":[6078867,6078266],"length":1,"stats":{"Line":2},"fn_name":null},{"line":20,"address":[6078430],"length":1,"stats":{"Line":2},"fn_name":null},{"line":22,"address":[6078611],"length":1,"stats":{"Line":2},"fn_name":null},{"line":25,"address":[6079107,6079024],"length":1,"stats":{"Line":1},"fn_name":"extract_verified_token"},{"line":29,"address":[6079066],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[6079133],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[6079240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[6079360],"length":1,"stats":{"Line":1},"fn_name":"extract_verified_id"},{"line":38,"address":[6079388],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[5926608,5926615],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":43,"address":[6079552],"length":1,"stats":{"Line":2},"fn_name":"init_key"},{"line":44,"address":[6079645],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[6131824,6131858],"length":1,"stats":{"Line":3},"fn_name":"should_create_token"},{"line":56,"address":[6131838],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[6131873],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[6131942,6131999,6132024,6131913],"length":1,"stats":{"Line":3},"fn_name":null},{"line":64,"address":[6132178,6132128],"length":1,"stats":{"Line":3},"fn_name":"should_verify_token"},{"line":65,"address":[6132149],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[6132200],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[6132855,6132848],"length":1,"stats":{"Line":7},"fn_name":"should_extract_verified_id"},{"line":72,"address":[6843780],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6843787],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[6843906,6843819,6843998,6844343,6844024,6844254],"length":1,"stats":{"Line":4},"fn_name":null},{"line":78,"address":[6133168,6133175],"length":1,"stats":{"Line":7},"fn_name":"should_not_extract_unverified_id"},{"line":80,"address":[6844820],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[6844827],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[6844890,6844861,6844931],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[6133522,6133488],"length":1,"stats":{"Line":3},"fn_name":"should_create_and_verify_token"},{"line":88,"address":[6133502],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[6133537],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[6133577,6133606],"length":1,"stats":{"Line":2},"fn_name":null},{"line":91,"address":[6133913,6133660],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[6134032,6134076],"length":1,"stats":{"Line":3},"fn_name":"should_fail_to_verify_token"},{"line":96,"address":[6134050],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[6134093,6134140],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":40,"coverable":40},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","endpoints","games.rs"],"content":"use crate::{\n    model::{Game, Player},\n    server::{\n        app_context::AppContext,\n        auth::extract_verified_id,\n        auth::generate_jwt_token,\n        reply::{reply_error, reply_error_with_details, reply_success},\n    },\n};\nuse log::debug;\nuse rand::{distributions::Alphanumeric, thread_rng, Rng};\nuse serde::Serialize;\nuse std::{convert::Infallible, iter};\nuse warp::hyper::StatusCode;\n\n// this value determines the findability of a game and is a tradeoff between security and user friendliness\n// 5 tokens mean a chance of finding a random game of 1:60466176.\nconst TOKEN_CHARS_COUNT: usize = 5;\n\npub async fn get_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match extract_verified_id(authorization, ctx) {\n        Some(token) =\u003e match ctx\n            .db()\n            .games()\n            .get(game_token)\n            .await\n            .expect(\"Reading game has failed\")\n        {\n            Some(game) =\u003e {\n                match ctx\n                    .db()\n                    .players()\n                    .get(\u0026token)\n                    .await\n                    .expect(\"Reading player has failed\")\n                    .filter(|player| {\n                        game.player_ids().contains(player.id())\n                            || game.admin_id().is_some()\n                                \u0026\u0026 game.admin_id().as_ref().unwrap() == player.id()\n                    }) {\n                    Some(mut player) =\u003e {\n                        player.heartbeat();\n                        ctx.db()\n                            .players()\n                            .persist(\u0026player)\n                            .await\n                            .expect(\"Persisting heartbeat has failed\");\n                        Ok(warp::reply::with_status(\n                            warp::reply::json(\u0026game),\n                            StatusCode::OK,\n                        ))\n                    }\n                    None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n                }\n            }\n            None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n        },\n        None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n    }\n}\n\npub async fn get_games_count_filter(ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    #[derive(Serialize)]\n    struct GetGamesResponse {\n        total: usize,\n    };\n\n    let total = ctx\n        .db()\n        .games()\n        .total_count()\n        .await\n        .expect(\"Reading games count has failed\");\n\n    Ok(warp::reply::with_status(\n        warp::reply::json(\u0026GetGamesResponse { total }),\n        StatusCode::OK,\n    ))\n}\n\npub async fn create_game_filter(ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    fn generate_game_token() -\u003e String {\n        let mut rng = thread_rng();\n\n        String::from_utf8(\n            iter::repeat(())\n                .map(|()| rng.sample(Alphanumeric).to_ascii_uppercase())\n                .take(TOKEN_CHARS_COUNT)\n                .collect(),\n        )\n        .unwrap()\n    }\n\n    let game_token = generate_game_token();\n    let player = create_new_player(\u0026game_token, ctx).await;\n    let new_game = create_new_game(player.id(), \u0026game_token, ctx).await;\n\n    #[derive(Serialize)]\n    struct CreateGameReponse {\n        game: Game,\n        admin: Player,\n    };\n\n    Ok(warp::reply::with_status(\n        warp::reply::json(\u0026CreateGameReponse {\n            game: new_game,\n            admin: player,\n        }),\n        StatusCode::CREATED,\n    ))\n}\n\npub async fn attend_game_filter(\n    game_token: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e {\n            let player = create_new_player(\u0026game_token, ctx).await;\n\n            game.add_player(player.id());\n            match ctx.db().games().persist(\u0026game).await {\n                Ok(_) =\u003e Ok(warp::reply::with_status(\n                    warp::reply::json(\u0026player),\n                    StatusCode::OK,\n                )),\n                Err(_) =\u003e Ok(reply_error(StatusCode::INTERNAL_SERVER_ERROR)),\n            }\n        }\n        None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n    }\n}\n\npub async fn leave_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e match extract_verified_id(authorization, ctx) {\n            Some(player_id) =\u003e {\n                game.remove_player(\u0026player_id);\n                match ctx.db().games().persist(\u0026game).await {\n                    Ok(_) =\u003e Ok(reply_success(StatusCode::OK)),\n                    Err(_) =\u003e Ok(reply_error_with_details(\n                        StatusCode::INTERNAL_SERVER_ERROR,\n                        \"Writing player has failed\",\n                    )),\n                }\n            }\n            None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n    }\n}\n\npub async fn start_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e match extract_verified_id(authorization, ctx)\n            .filter(|_| game.admin_id().is_some())\n            .filter(|id| id == game.admin_id().as_ref().unwrap())\n        {\n            Some(_) =\u003e {\n                game.start();\n                match ctx.db().games().persist(\u0026game).await {\n                    Ok(_) =\u003e Ok(reply_error(StatusCode::OK)),\n                    Err(_) =\u003e Ok(reply_error(StatusCode::INTERNAL_SERVER_ERROR)),\n                }\n            }\n            None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n    }\n}\n\nasync fn create_new_game(admin_id: \u0026str, token: \u0026str, ctx: \u0026AppContext) -\u003e Game {\n    let new_game = Game::new(admin_id, token);\n    let new_token = new_game.token();\n    ctx.db()\n        .games()\n        .persist(\u0026new_game)\n        .await\n        .expect(\"Creating game failed\");\n    debug!(\"Created game with token {}\", new_token);\n\n    new_game\n}\n\nasync fn create_new_player(game_token: \u0026str, ctx: \u0026AppContext) -\u003e Player {\n    let mut player = Player::new(game_token);\n    let user_token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n    player.update_token(\u0026user_token);\n\n    ctx.db()\n        .players()\n        .persist(\u0026player)\n        .await\n        .expect(\"Creating player failed\");\n    debug!(\"Created player with token {}\", player.id());\n\n    player\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{\n        attend_game_filter, create_game_filter, get_game_filter, leave_game_filter,\n        start_game_filter,\n    };\n    use crate::{\n        model::{Game, GameState, Player},\n        server::{app_context::AppContext, auth::generate_jwt_token},\n    };\n    use warp::{hyper::StatusCode, Reply};\n\n    const GAME_TOKEN: \u0026str = \"ACDEF\";\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_not_get_game_unauthorized() {\n        let ctx = init_ctx();\n\n        let reply = get_game_filter(\"invalid\", \"auth\", \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n    }\n\n    #[tokio::test]\n    async fn should_not_get_unknown_game() {\n        let ctx = init_ctx();\n\n        let token = generate_jwt_token(\u0026Player::new(\"game\"), \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(\"game\", \u0026token, \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_get_game_for_admin() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        ctx.db()\n            .players()\n            .persist(\u0026admin)\n            .await\n            .expect(\"Writing player failed\");\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(admin.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_get_game_for_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(GAME_TOKEN);\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let mut game = Game::new(\"admin\", GAME_TOKEN);\n        game.add_player(player.id());\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_get_game_and_send_heartbeat() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n        let first_time = admin.last_action_time();\n        ctx.db()\n            .players()\n            .persist(\u0026admin)\n            .await\n            .expect(\"Writing admin failed\");\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(admin.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_admin = ctx\n            .db()\n            .players()\n            .get(admin.id())\n            .await\n            .expect(\"Reading admin failed\");\n        assert!(updated_admin.unwrap().last_action_time().gt(\u0026first_time));\n    }\n\n    #[tokio::test]\n    async fn should_create_new_game() {\n        let ctx = init_ctx();\n\n        let reply = create_game_filter(\u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::CREATED);\n    }\n\n    #[tokio::test]\n    async fn should_not_attend_unknown_game() {\n        let ctx = init_ctx();\n\n        let reply = attend_game_filter(\"test\", \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_attend_game() {\n        let ctx = init_ctx();\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(\"admin\", GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = attend_game_filter(GAME_TOKEN, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_leave_game() {\n        let ctx = init_ctx();\n\n        let mut game = Game::new(\"admin\", GAME_TOKEN);\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n        game.add_player(player.id());\n\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n        assert!(game.player_ids().contains(player.id()));\n\n        let reply = leave_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\");\n        assert!(!updated_game.unwrap().player_ids().contains(player.id()));\n    }\n\n    #[tokio::test]\n    async fn should_leave_game_and_select_new_admin() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        let mut game = Game::new(admin.id(), GAME_TOKEN);\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n        game.add_player(player.id());\n\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n        assert_eq!(game.admin_id().as_ref().unwrap(), admin.id());\n\n        let reply = leave_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\")\n            .unwrap();\n        assert!(updated_game.player_ids().is_empty());\n        assert_eq!(updated_game.admin_id().as_ref().unwrap(), player.id());\n    }\n\n    #[tokio::test]\n    async fn should_start_game() {\n        let ctx = init_ctx();\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(player.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = start_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\");\n        assert_eq!(updated_game.unwrap().state(), \u0026GameState::Started);\n    }\n\n    #[tokio::test]\n    async fn should_not_start_game() {\n        let ctx = init_ctx();\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(\"admin\", GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = start_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\");\n        assert_eq!(updated_game.unwrap().state(), \u0026GameState::Initialized);\n    }\n\n    #[tokio::test]\n    async fn should_not_start_unknown_game() {\n        let ctx = init_ctx();\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = start_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n}\n","traces":[{"line":20,"address":[4834672],"length":1,"stats":{"Line":1},"fn_name":"get_game_filter"},{"line":25,"address":[4807664,4807507],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4807869,4807584,4807776,4810478,4807924,4808003,4807674,4808355],"length":1,"stats":{"Line":6},"fn_name":null},{"line":33,"address":[4808295,4808365],"length":1,"stats":{"Line":2},"fn_name":null},{"line":34,"address":[4808712,4809213,4808622,4808782,4808471,4808576,4810499,4809322],"length":1,"stats":{"Line":6},"fn_name":null},{"line":37,"address":[4808552],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[4809191,4806992],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":41,"address":[4807098,4807184,4807012],"length":1,"stats":{"Line":3},"fn_name":null},{"line":42,"address":[4807205,4807149,4807315,4807328,4807060],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":43,"address":[4807168,4807230],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4809264,4809332],"length":1,"stats":{"Line":2},"fn_name":null},{"line":46,"address":[4809458],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4809530,4809771,4809701,4809569,4809649,4810520,4809480],"length":1,"stats":{"Line":6},"fn_name":null},{"line":49,"address":[4809563],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4810049,4810010],"length":1,"stats":{"Line":3},"fn_name":null},{"line":53,"address":[4809977],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4810114,4809295],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[4808328,4810188],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[4807637,4810259],"length":1,"stats":{"Line":2},"fn_name":null},{"line":66,"address":[4586192,4586207,4586280],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":72,"address":[4586262],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[4811874,4811913],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[4811834],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[4812336,4814629,4814563,4812362],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}"},{"line":86,"address":[4834945,4834912],"length":1,"stats":{"Line":1},"fn_name":"generate_game_token"},{"line":87,"address":[4834932],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[4834960,4834984,4835021],"length":1,"stats":{"Line":3},"fn_name":null},{"line":91,"address":[4815040,4815049],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":98,"address":[4812458],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[4812645,4812762,4814593,4812603,4812692,4812484],"length":1,"stats":{"Line":5},"fn_name":null},{"line":100,"address":[4547589],"length":1,"stats":{"Line":6},"fn_name":null},{"line":108,"address":[4814361],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[4814030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[4813792],"length":1,"stats":{"Line":1},"fn_name":null},{"line":111,"address":[4813928],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[4835168],"length":1,"stats":{"Line":1},"fn_name":"attend_game_filter"},{"line":121,"address":[4567133],"length":1,"stats":{"Line":5},"fn_name":null},{"line":124,"address":[4815327],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[4815861,4815931],"length":1,"stats":{"Line":2},"fn_name":null},{"line":129,"address":[4567205],"length":1,"stats":{"Line":4},"fn_name":null},{"line":131,"address":[4816623],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[4567291],"length":1,"stats":{"Line":6},"fn_name":null},{"line":133,"address":[4817234,4817396,4817316],"length":1,"stats":{"Line":3},"fn_name":null},{"line":134,"address":[4817288],"length":1,"stats":{"Line":1},"fn_name":null},{"line":137,"address":[4817251,4817464],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[4817610,4815894],"length":1,"stats":{"Line":2},"fn_name":null},{"line":144,"address":[4835264],"length":1,"stats":{"Line":1},"fn_name":"leave_game_filter"},{"line":149,"address":[4565530],"length":1,"stats":{"Line":8},"fn_name":null},{"line":152,"address":[4818681],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[4819258,4819492,4819188],"length":1,"stats":{"Line":4},"fn_name":null},{"line":157,"address":[4819502,4819411],"length":1,"stats":{"Line":4},"fn_name":null},{"line":158,"address":[4819544],"length":1,"stats":{"Line":2},"fn_name":null},{"line":159,"address":[4565628],"length":1,"stats":{"Line":10},"fn_name":null},{"line":160,"address":[4820113,4820058],"length":1,"stats":{"Line":4},"fn_name":null},{"line":161,"address":[4820075,4820224],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[4819465,4820342],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[4819221,4820413],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[4835376],"length":1,"stats":{"Line":1},"fn_name":"start_game_filter"},{"line":178,"address":[4579066],"length":1,"stats":{"Line":5},"fn_name":null},{"line":181,"address":[4821609],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[4822571,4823337,4822344,4822104,4822441,4822174,4823271],"length":1,"stats":{"Line":6},"fn_name":null},{"line":186,"address":[4821198,4822330,4821184],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":187,"address":[4821248,4821262,4822419],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":189,"address":[4822487],"length":1,"stats":{"Line":1},"fn_name":null},{"line":190,"address":[4822581],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[4579156],"length":1,"stats":{"Line":7},"fn_name":null},{"line":192,"address":[4823030,4823073],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[4823184,4823047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[4822544,4823273],"length":1,"stats":{"Line":2},"fn_name":null},{"line":198,"address":[4822137,4823400],"length":1,"stats":{"Line":2},"fn_name":null},{"line":202,"address":[4577543,4577423,4577408],"length":1,"stats":{"Line":6},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":203,"address":[4824343],"length":1,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[4824413,4824503],"length":1,"stats":{"Line":2},"fn_name":null},{"line":205,"address":[4577500],"length":1,"stats":{"Line":6},"fn_name":null},{"line":207,"address":[4824599],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[4825202,4825001,4825367,4825161,4825127,4825044],"length":1,"stats":{"Line":4},"fn_name":null},{"line":212,"address":[4825416],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[4520154,4520006,4519935,4519920],"length":1,"stats":{"Line":8},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":216,"address":[4826070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":217,"address":[4826131,4826309,4826225],"length":1,"stats":{"Line":3},"fn_name":null},{"line":218,"address":[4826381],"length":1,"stats":{"Line":1},"fn_name":null},{"line":220,"address":[4520067],"length":1,"stats":{"Line":6},"fn_name":null},{"line":222,"address":[4826552],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[4827158,4827393,4827083,4826957,4827000,4827325,4827117],"length":1,"stats":{"Line":7},"fn_name":null},{"line":227,"address":[4827442],"length":1,"stats":{"Line":2},"fn_name":null},{"line":244,"address":[7170400],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":245,"address":[7170408],"length":1,"stats":{"Line":1},"fn_name":null},{"line":248,"address":[5695271,5695221,5695216,5696449,5696353,5695248],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":250,"address":[5695340],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[5695347,5695468,5696434,5695580,5695515],"length":1,"stats":{"Line":3},"fn_name":null},{"line":253,"address":[5695859,5696309,5695898,5695999,5696220],"length":1,"stats":{"Line":2},"fn_name":null},{"line":254,"address":[5695737,5695882,5695820,5695833],"length":1,"stats":{"Line":4},"fn_name":null},{"line":259,"address":[5696848,5696821,5698323,5696816,5696871,5698224],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":261,"address":[5696952],"length":1,"stats":{"Line":1},"fn_name":null},{"line":263,"address":[5696959,5697072,5697040,5697099],"length":1,"stats":{"Line":3},"fn_name":null},{"line":265,"address":[5698308,5697271,5697360,5697313,5697190,5697425],"length":1,"stats":{"Line":5},"fn_name":null},{"line":266,"address":[5697743,5698154,5697704,5698065,5697844],"length":1,"stats":{"Line":2},"fn_name":null},{"line":267,"address":[5697727,5697678,5697582,5697665],"length":1,"stats":{"Line":4},"fn_name":null},{"line":272,"address":[5698864,5698887,5698832,5701513,5701372,5698837],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":274,"address":[5698968],"length":1,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[5698983],"length":1,"stats":{"Line":1},"fn_name":null},{"line":277,"address":[5699017,5699134,5699063,5699249,5699194,5701456,5699323],"length":1,"stats":{"Line":6},"fn_name":null},{"line":279,"address":[5699114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[5699842,5699522,5699550,5699916,5699698,5699721,5701477,5699792],"length":1,"stats":{"Line":7},"fn_name":null},{"line":284,"address":[5699580,5699676],"length":1,"stats":{"Line":2},"fn_name":null},{"line":288,"address":[5700234,5700144],"length":1,"stats":{"Line":2},"fn_name":null},{"line":290,"address":[5700393,5701498,5700482,5700435,5700547,5700282],"length":1,"stats":{"Line":5},"fn_name":null},{"line":291,"address":[5700851,5700789,5701278,5700802,5700968,5700828,5700706,5701189],"length":1,"stats":{"Line":5},"fn_name":null},{"line":294,"address":[5702341,5702368,5702391,5704937,5702336,5705078],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":296,"address":[5702472],"length":1,"stats":{"Line":1},"fn_name":null},{"line":298,"address":[5702487],"length":1,"stats":{"Line":1},"fn_name":null},{"line":299,"address":[5702638,5702753,5702698,5705021,5702567,5702521,5702827],"length":1,"stats":{"Line":6},"fn_name":null},{"line":301,"address":[5702618],"length":1,"stats":{"Line":1},"fn_name":null},{"line":304,"address":[5703026],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[5703171,5703090],"length":1,"stats":{"Line":2},"fn_name":null},{"line":306,"address":[5703481,5705042,5703217,5703352,5703407,5703289],"length":1,"stats":{"Line":5},"fn_name":null},{"line":308,"address":[5703267],"length":1,"stats":{"Line":1},"fn_name":null},{"line":312,"address":[5703728,5703775,5703680],"length":1,"stats":{"Line":3},"fn_name":null},{"line":314,"address":[5704023,5703976,5703823,5703934,5704088,5705063],"length":1,"stats":{"Line":5},"fn_name":null},{"line":315,"address":[5704330,5704343,5704369,5704730,5704509,5704392,5704247,5704819],"length":1,"stats":{"Line":5},"fn_name":null},{"line":318,"address":[5705968,5705936,5705997,5705941,5709718,5709880],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":320,"address":[5706078],"length":1,"stats":{"Line":1},"fn_name":null},{"line":322,"address":[5706093],"length":1,"stats":{"Line":1},"fn_name":null},{"line":323,"address":[5706261,5706193,5706127],"length":1,"stats":{"Line":3},"fn_name":null},{"line":324,"address":[5706309],"length":1,"stats":{"Line":1},"fn_name":null},{"line":325,"address":[5706485,5706532,5706432,5709802,5706650,5706724,5706595],"length":1,"stats":{"Line":6},"fn_name":null},{"line":327,"address":[5706512],"length":1,"stats":{"Line":1},"fn_name":null},{"line":331,"address":[5706951,5707122,5709823,5707099,5707243,5707193,5707317,5706923],"length":1,"stats":{"Line":7},"fn_name":null},{"line":333,"address":[5706981,5707077],"length":1,"stats":{"Line":2},"fn_name":null},{"line":337,"address":[5707809,5707735,5707685,5709844,5707643,5707545],"length":1,"stats":{"Line":5},"fn_name":null},{"line":338,"address":[5708572,5708064,5708248,5707968,5708051,5708093,5708119,5708482],"length":1,"stats":{"Line":5},"fn_name":null},{"line":340,"address":[5709865,5708609,5708811,5708702,5708721,5708876],"length":1,"stats":{"Line":5},"fn_name":null},{"line":343,"address":[5708655],"length":1,"stats":{"Line":1},"fn_name":null},{"line":346,"address":[5709609,5709643,5709441,5709270,5709489,5709467],"length":1,"stats":{"Line":4},"fn_name":null},{"line":349,"address":[5711063,5711008,5712120,5711013,5711040,5712216],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":351,"address":[5711132],"length":1,"stats":{"Line":1},"fn_name":null},{"line":353,"address":[5711347,5712201,5711155,5711282,5711235],"length":1,"stats":{"Line":4},"fn_name":null},{"line":354,"address":[5711649,5711626,5711587,5712076,5711504,5711766,5711600,5711987],"length":1,"stats":{"Line":5},"fn_name":null},{"line":357,"address":[5712631,5713796,5712576,5712608,5712581,5713700],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":359,"address":[5712700],"length":1,"stats":{"Line":1},"fn_name":null},{"line":361,"address":[5712927,5712862,5712815,5712707,5713781],"length":1,"stats":{"Line":4},"fn_name":null},{"line":362,"address":[5713245,5713656,5713567,5713206,5713346],"length":1,"stats":{"Line":2},"fn_name":null},{"line":363,"address":[5713084,5713180,5713229,5713167],"length":1,"stats":{"Line":4},"fn_name":null},{"line":368,"address":[5715968,5715854,5714215,5714192,5714160,5714165],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":370,"address":[5714293],"length":1,"stats":{"Line":1},"fn_name":null},{"line":372,"address":[5714308,5714476,5715932,5714597,5714665,5714456,5714547],"length":1,"stats":{"Line":6},"fn_name":null},{"line":374,"address":[5714379],"length":1,"stats":{"Line":1},"fn_name":null},{"line":378,"address":[5715017,5714880,5714970,5715082,5715953],"length":1,"stats":{"Line":4},"fn_name":null},{"line":379,"address":[5715332,5715358,5715319,5715236,5715810,5715381,5715498,5715720],"length":1,"stats":{"Line":5},"fn_name":null},{"line":382,"address":[5716544,5716512,5719727,5716573,5719868,5716517],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":384,"address":[5716654],"length":1,"stats":{"Line":1},"fn_name":null},{"line":386,"address":[5716669],"length":1,"stats":{"Line":1},"fn_name":null},{"line":387,"address":[5716726],"length":1,"stats":{"Line":1},"fn_name":null},{"line":388,"address":[5716924,5716785,5716856],"length":1,"stats":{"Line":3},"fn_name":null},{"line":389,"address":[5716972],"length":1,"stats":{"Line":1},"fn_name":null},{"line":391,"address":[5719811,5717166,5717229,5717284,5717358,5717096],"length":1,"stats":{"Line":5},"fn_name":null},{"line":393,"address":[5717146],"length":1,"stats":{"Line":1},"fn_name":null},{"line":396,"address":[5717726,5717557,5717655,5717592,5717680],"length":1,"stats":{"Line":4},"fn_name":null},{"line":398,"address":[5717922,5719832,5717996,5717830,5717694,5717872,5717764],"length":1,"stats":{"Line":6},"fn_name":null},{"line":399,"address":[5718251,5718789,5718306,5718435,5718155,5718696,5718238,5718280],"length":1,"stats":{"Line":5},"fn_name":null},{"line":401,"address":[5719063,5718864,5718998,5719853,5718946,5718826],"length":1,"stats":{"Line":5},"fn_name":null},{"line":407,"address":[5719486,5719511,5719583,5719628,5719465,5719294],"length":1,"stats":{"Line":4},"fn_name":null},{"line":410,"address":[5720989,5725443,5720960,5720933,5725302,5720928],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":412,"address":[5721070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":414,"address":[5721085],"length":1,"stats":{"Line":1},"fn_name":null},{"line":415,"address":[5721119,5721180],"length":1,"stats":{"Line":2},"fn_name":null},{"line":416,"address":[5721259],"length":1,"stats":{"Line":1},"fn_name":null},{"line":417,"address":[5721369,5721297,5721437],"length":1,"stats":{"Line":3},"fn_name":null},{"line":418,"address":[5721485],"length":1,"stats":{"Line":1},"fn_name":null},{"line":420,"address":[5721683,5721801,5721611,5725386,5721746,5721875],"length":1,"stats":{"Line":5},"fn_name":null},{"line":422,"address":[5721661],"length":1,"stats":{"Line":1},"fn_name":null},{"line":425,"address":[5722139,5722387,5722790,5722074,5722450,5722103,5722691],"length":1,"stats":{"Line":4},"fn_name":null},{"line":427,"address":[5722407,5723051,5725407,5722885,5722927,5722977,5722819],"length":1,"stats":{"Line":6},"fn_name":null},{"line":428,"address":[5723335,5723210,5723490,5723306,5723361,5723856,5723757,5723293],"length":1,"stats":{"Line":5},"fn_name":null},{"line":430,"address":[5723940,5724080,5725428,5723893,5724154,5724025],"length":1,"stats":{"Line":5},"fn_name":null},{"line":437,"address":[5724502,5724558,5724459,5724529],"length":1,"stats":{"Line":3},"fn_name":null},{"line":438,"address":[5724838,5724593,5725160,5724626,5724543,5724873,5725071],"length":1,"stats":{"Line":4},"fn_name":null},{"line":441,"address":[5726837,5726832,5726864,5730331,5726893,5730190],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":443,"address":[5726974],"length":1,"stats":{"Line":1},"fn_name":null},{"line":444,"address":[5726989],"length":1,"stats":{"Line":1},"fn_name":null},{"line":445,"address":[5727157,5727023,5727089],"length":1,"stats":{"Line":3},"fn_name":null},{"line":447,"address":[5727205,5727616,5727492,5727398,5730274,5727421,5727542],"length":1,"stats":{"Line":6},"fn_name":null},{"line":449,"address":[5727283,5727376],"length":1,"stats":{"Line":2},"fn_name":null},{"line":453,"address":[5727942,5730295,5727844,5728108,5728034,5727984],"length":1,"stats":{"Line":5},"fn_name":null},{"line":454,"address":[5728814,5728547,5728913,5728350,5728363,5728392,5728267,5728418],"length":1,"stats":{"Line":5},"fn_name":null},{"line":456,"address":[5730316,5729211,5729137,5728950,5728997,5729082],"length":1,"stats":{"Line":5},"fn_name":null},{"line":462,"address":[5729649,5730006,5729671,5729457,5729633,5729796,5730096],"length":1,"stats":{"Line":4},"fn_name":null},{"line":465,"address":[5731349,5734801,5731405,5731376,5731344,5734660],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":467,"address":[5731486],"length":1,"stats":{"Line":1},"fn_name":null},{"line":468,"address":[5731501],"length":1,"stats":{"Line":1},"fn_name":null},{"line":469,"address":[5731669,5731535,5731601],"length":1,"stats":{"Line":3},"fn_name":null},{"line":471,"address":[5732020,5734744,5732094,5731970,5731717,5731876,5731899],"length":1,"stats":{"Line":6},"fn_name":null},{"line":473,"address":[5731795],"length":1,"stats":{"Line":1},"fn_name":null},{"line":477,"address":[5732322,5732462,5734765,5732586,5732512,5732420],"length":1,"stats":{"Line":5},"fn_name":null},{"line":478,"address":[5733025,5733292,5732870,5733391,5732912],"length":1,"stats":{"Line":2},"fn_name":null},{"line":479,"address":[5732745,5732841,5732896,5732828],"length":1,"stats":{"Line":4},"fn_name":null},{"line":483,"address":[5734786,5733560,5733689,5733475,5733615,5733428],"length":1,"stats":{"Line":5},"fn_name":null},{"line":489,"address":[5734268,5734121,5734477,5734566,5734105,5733929,5734143],"length":1,"stats":{"Line":4},"fn_name":null},{"line":492,"address":[5737249,5735797,5735824,5735792,5737348,5735847],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":494,"address":[5735928],"length":1,"stats":{"Line":1},"fn_name":null},{"line":495,"address":[5735943],"length":1,"stats":{"Line":1},"fn_name":null},{"line":496,"address":[5735977,5736111,5736043],"length":1,"stats":{"Line":3},"fn_name":null},{"line":498,"address":[5737333,5736424,5736270,5736159,5736312,5736359],"length":1,"stats":{"Line":5},"fn_name":null},{"line":499,"address":[5737155,5736744,5737066,5736845,5736705],"length":1,"stats":{"Line":2},"fn_name":null},{"line":500,"address":[5736666,5736728,5736583,5736679],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":195,"coverable":205},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","endpoints","players.rs"],"content":"use crate::server::{app_context::AppContext, auth::extract_verified_id, reply::reply_error};\nuse serde::{Deserialize, Serialize};\nuse std::convert::Infallible;\nuse warp::hyper::StatusCode;\n\npub async fn get_player_filter(id: \u0026str, ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    #[derive(Serialize)]\n    struct GetPlayerResponse {\n        id: String,\n        name: String,\n    }\n\n    match ctx\n        .db()\n        .players()\n        .get(\u0026id)\n        .await\n        .expect(\"Reading player has failed\")\n    {\n        Some(player) =\u003e Ok(warp::reply::with_status(\n            warp::reply::json(\u0026GetPlayerResponse {\n                id: String::from(player.id()),\n                name: String::from(player.name()),\n            }),\n            StatusCode::OK,\n        )),\n        None =\u003e Ok(reply_error(StatusCode::NOT_FOUND)),\n    }\n}\n\n#[derive(Deserialize)]\npub struct EditPlayerInput {\n    name: String,\n}\n\npub async fn edit_player_filter(\n    id: \u0026str,\n    input: \u0026EditPlayerInput,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match extract_verified_id(authorization, ctx).filter(|token_id| token_id == id) {\n        Some(player_id) =\u003e match ctx\n            .db()\n            .players()\n            .get(\u0026player_id)\n            .await\n            .expect(\"Reading player has failed\")\n        {\n            Some(mut player) =\u003e {\n                player.set_name(\u0026input.name);\n                ctx.db()\n                    .players()\n                    .persist(\u0026player)\n                    .await\n                    .expect(\"editing player failed\");\n                Ok(warp::reply::with_status(\n                    warp::reply::json(\u0026player),\n                    StatusCode::OK,\n                ))\n            }\n            None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_error(StatusCode::UNAUTHORIZED)),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{edit_player_filter, get_player_filter, EditPlayerInput};\n    use crate::{\n        model::Player,\n        server::{app_context::AppContext, auth::generate_jwt_token},\n    };\n    use warp::{hyper::StatusCode, Reply};\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_not_get_unknown_player() {\n        let ctx = init_ctx();\n\n        let reply = get_player_filter(\"unknown\", \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_get_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        let player_id = String::from(player.id());\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n\n        let reply = get_player_filter(\u0026player_id, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_edit_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        let player_id = String::from(player.id());\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = edit_player_filter(\n            \u0026player_id,\n            \u0026EditPlayerInput {\n                name: String::from(\"new name\"),\n            },\n            \u0026token,\n            \u0026ctx,\n        )\n        .await;\n\n        let updated_player = ctx\n            .db()\n            .players()\n            .get(player.id())\n            .await\n            .expect(\"Reading player failed\");\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n        assert_eq!(updated_player.unwrap().name(), \"new name\");\n    }\n\n    #[tokio::test]\n    async fn should_not_edit_other_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = edit_player_filter(\n            \"other\",\n            \u0026EditPlayerInput {\n                name: String::from(\"new name\"),\n            },\n            \u0026token,\n            \u0026ctx,\n        )\n        .await;\n\n        let updated_player = ctx\n            .db()\n            .players()\n            .get(player.id())\n            .await\n            .expect(\"Reading player failed\");\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n        assert_eq!(updated_player.unwrap().name(), player.name());\n    }\n}\n","traces":[{"line":6,"address":[6696314,6697739,6696288,6696452],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}"},{"line":13,"address":[6696504,6696669,6697569,6697100,6697724,6696604,6696415,6696555],"length":1,"stats":{"Line":6},"fn_name":null},{"line":16,"address":[6696483],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[6697498,6697102,6697045],"length":1,"stats":{"Line":3},"fn_name":null},{"line":21,"address":[6697368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[4897014],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4897095],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4897389,4896860],"length":1,"stats":{"Line":2},"fn_name":null},{"line":36,"address":[5908512],"length":1,"stats":{"Line":1},"fn_name":"edit_player_filter"},{"line":42,"address":[4897968,4898211,4897982,4898423],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":43,"address":[4898687,4900352,4898597,4898433,4898551,4899260,4898757,4898371],"length":1,"stats":{"Line":6},"fn_name":null},{"line":46,"address":[4898527],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[6699288,6699355],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[4899396],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4899747,4899679,4900373,4899627,4899547,4899488],"length":1,"stats":{"Line":5},"fn_name":null},{"line":54,"address":[4899541],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4899986,4900025],"length":1,"stats":{"Line":2},"fn_name":null},{"line":58,"address":[4899953],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[4899233,4900090],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[4898396,4900161],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[6026992],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":78,"address":[6027000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[6073412,6072288,6072343,6073508,6072293,6072320],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":83,"address":[6072412],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[6073493,6072574,6072419,6072639,6072527],"length":1,"stats":{"Line":4},"fn_name":null},{"line":87,"address":[6072957,6073058,6073279,6072918,6073368],"length":1,"stats":{"Line":2},"fn_name":null},{"line":88,"address":[6072941,6072796,6072879,6072892],"length":1,"stats":{"Line":4},"fn_name":null},{"line":93,"address":[5763146,5762895,5763055,5763113,5762880],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":95,"address":[6074008],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[6074023],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[6074057,6074118],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[5763039],"length":1,"stats":{"Line":5},"fn_name":null},{"line":101,"address":[6074261],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[5763130],"length":1,"stats":{"Line":6},"fn_name":null},{"line":107,"address":[6075544,6075144,6075061,6075183,6075323,6075633,6075157,6075206],"length":1,"stats":{"Line":5},"fn_name":null},{"line":110,"address":[5864399,5864224,5864608,5864245,5864457,5864735],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":112,"address":[6076614],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[6076655],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[6076689,6076750],"length":1,"stats":{"Line":2},"fn_name":null},{"line":116,"address":[6076973,6080579,6076818,6076913,6077028,6077102],"length":1,"stats":{"Line":5},"fn_name":null},{"line":118,"address":[6076893],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[6077396,6077349,6077301],"length":1,"stats":{"Line":3},"fn_name":null},{"line":123,"address":[5864534],"length":1,"stats":{"Line":5},"fn_name":null},{"line":124,"address":[6077444],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[6077590],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[6077492],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[6077634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[5864555,5864513],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[5864671],"length":1,"stats":{"Line":5},"fn_name":null},{"line":136,"address":[6078255],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[6079098,6079072,6079587,6079043,6079491,6079030,6078913,6079227],"length":1,"stats":{"Line":5},"fn_name":null},{"line":141,"address":[6080208,6079839,6079616,6079817,6080298,6079989],"length":1,"stats":{"Line":3},"fn_name":null},{"line":144,"address":[5858608,5858629,5858792,5859070,5858759,5858943],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":146,"address":[6081830],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[6081871],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[5858743],"length":1,"stats":{"Line":6},"fn_name":null},{"line":151,"address":[6082002],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[6082410,6082458,6082505],"length":1,"stats":{"Line":3},"fn_name":null},{"line":156,"address":[5858869],"length":1,"stats":{"Line":4},"fn_name":null},{"line":158,"address":[6082580],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[6082545],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[6082624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[5858890,5858848],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[5859006],"length":1,"stats":{"Line":5},"fn_name":null},{"line":169,"address":[6083286],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[6084258,6084103,6084145,6084525,6084624],"length":1,"stats":{"Line":2},"fn_name":null},{"line":174,"address":[6084074,6084129,6083944,6084061],"length":1,"stats":{"Line":4},"fn_name":null},{"line":177,"address":[6084653,6085075,6085095,6084879,6085404,6085314,6084857],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":67,"coverable":68},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","logger.rs"],"content":"use crate::config::AppConfig;\nuse flexi_logger::{style, DeferredNow, Level, Logger, Record};\nuse log::info;\nuse std::thread;\n\npub fn custom_format(\n    w: \u0026mut dyn std::io::Write,\n    now: \u0026mut DeferredNow,\n    record: \u0026Record,\n) -\u003e Result\u003c(), std::io::Error\u003e {\n    let level = record.level();\n    write!(\n        w,\n        \"[{}] {} ({})[{}] {}\",\n        now.now().format(\"%Y-%m-%d %H:%M:%S%.3f %:z\"),\n        style(level, level),\n        thread::current().name().unwrap_or(\"-\"),\n        style(level, record.module_path().unwrap_or(\"-\")),\n        style(level, \u0026record.args())\n    )\n}\n\npub fn init_logger(config: \u0026AppConfig) {\n    let log_level = if cfg!(test) {\n        Level::Warn.to_string()\n    } else {\n        config.log_level.to_string()\n    };\n    Logger::with_env_or_str(\u0026log_level)\n        .format(custom_format)\n        .start()\n        .ok();\n\n    info!(\"Initialized logger with level {}\", \u0026log_level);\n}\n","traces":[{"line":6,"address":[7152692,7152592],"length":1,"stats":{"Line":0},"fn_name":"custom_format"},{"line":11,"address":[7152642],"length":1,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[7153207],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[7152715],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[7152766],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[7152801,7152972,7152847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[7153004],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[7153133],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[7154032,7154073],"length":1,"stats":{"Line":1},"fn_name":"init_logger"},{"line":25,"address":[6997398],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[7154047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[7154088,7154159],"length":1,"stats":{"Line":2},"fn_name":null},{"line":34,"address":[7154347,7154226],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":4,"coverable":13},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","mod.rs"],"content":"pub mod app_context;\nmod auth;\nmod endpoints;\nmod logger;\nmod reply;\n\nuse self::{\n    app_context::AppContext,\n    endpoints::{\n        games::{\n            attend_game_filter, create_game_filter, get_game_filter, get_games_count_filter,\n            leave_game_filter, start_game_filter,\n        },\n        players::{edit_player_filter, get_player_filter, EditPlayerInput},\n    },\n    reply::handle_rejection,\n};\nuse log::warn;\nuse std::fs;\nuse warp::Filter;\n\nconst PUBLIC_PATH: \u0026str = \"/var/www/public\";\nconst AUTHORIZATION: \u0026str = \"Authorization\";\n\npub async fn run_server(ctx: \u0026'static AppContext) {\n    let frontend_path = fs::canonicalize(\"../frontend\")\n        .map(|p| {\n            p.into_os_string()\n                .into_string()\n                .unwrap_or_else(|_| \"-\".to_string())\n        })\n        .unwrap_or_else(|_| \"-\".to_string());\n\n    let index_path: String;\n    let static_path: String;\n    if ctx.is_dev() {\n        warn!(\"Delivering development assets from {}\", frontend_path);\n        index_path = format!(\"{}/public/index.html\", frontend_path);\n        static_path = format!(\"{}/dist/\", frontend_path);\n    } else {\n        index_path = format!(\"{}/index.html\", PUBLIC_PATH);\n        static_path = format!(\"{}/static/\", PUBLIC_PATH);\n    }\n\n    let game_route =\n        warp::path(\"games\").and(\n            // GET /api/games\n            warp::get()\n                .and(warp::path::end())\n                .and_then(move || async move { get_games_count_filter(ctx).await })\n                .or(\n                    // PUT /api/games\n                    warp::put().and_then(move || async move { create_game_filter(ctx).await }),\n                )\n                .or(\n                    // POST /api/games/:token/attend\n                    warp::post().and(warp::path!(String / \"attend\")).and_then(\n                        move |game_token: String| async move {\n                            attend_game_filter(\u0026game_token, ctx).await\n                        },\n                    ),\n                )\n                .or(\n                    // POST /api/games/:token/leave\n                    warp::post()\n                        .and(warp::path!(String / \"leave\"))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(\n                            move |game_token: String, authorization: String| async move {\n                                leave_game_filter(\u0026game_token, \u0026authorization, ctx).await\n                            },\n                        ),\n                )\n                .or(\n                    // POST /api/games/:token/start\n                    warp::post()\n                        .and(warp::path!(String / \"start\"))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(\n                            move |game_token: String, authorization: String| async move {\n                                start_game_filter(\u0026game_token, \u0026authorization, ctx).await\n                            },\n                        ),\n                )\n                .or(\n                    // GET /api/games/:token\n                    warp::get()\n                        .and(warp::path!(String))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(move |token: String, authorization: String| async move {\n                            get_game_filter(\u0026token, \u0026authorization, ctx).await\n                        }),\n                ),\n        );\n\n    let player_route = warp::path(\"players\").and(\n        // GET /api/players/:id\n        warp::get()\n            .and(warp::path!(String))\n            .and_then(move |id: String| async move { get_player_filter(\u0026id, ctx).await })\n            .or(\n                // POST /api/players/:id\n                warp::post()\n                    .and(warp::path!(String))\n                    .and(warp::body::json())\n                    .and(warp::header(AUTHORIZATION))\n                    .and_then(\n                        move |id: String, input: EditPlayerInput, authorization: String| async move {\n                            edit_player_filter(\u0026id, \u0026input, \u0026authorization, ctx).await\n                        },\n                    )),\n    );\n    let api_route = warp::path(\"api\").and(game_route.or(player_route));\n\n    let static_route = warp::path(\"static\").and(warp::fs::dir(static_path));\n    let index_route = warp::get().and(warp::path::end().and(warp::fs::file(index_path)));\n\n    let routes = index_route\n        .or(static_route)\n        .or(api_route)\n        .recover(handle_rejection)\n        .with(warp::log(\"server\"));\n\n    warp::serve(routes)\n        .run(([0, 0, 0, 0], ctx.config().port))\n        .await;\n}\n","traces":[{"line":25,"address":[4517683,4517509,4517488],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":27,"address":[4907104],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":28,"address":[4907111],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[4907008,4907015],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":32,"address":[4907223,4907216],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":36,"address":[4916922,4915761,4915726],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[4916154,4916335,4915934,4916107,4916067],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[4916384,4916531],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[4916784,4916637],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[4916935,4915863,4917009],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[4917115,4917265],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[4917548,4918855,4917635,4918551,4918219,4917458,4917519,4917879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[4917492],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[4530432,4530447],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":53,"address":[4572671,4572656],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":57,"address":[4917775,4917762,4917825,4917801,4917743,4917852,4917696],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[4537962,4537887,4538018,4537872],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":59,"address":[4537942],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[4918092,4917927,4918156,4918042],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[4917960,4917938,4917992,4918018,4917979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[4918053],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[4514817,4514943,4514735,4514720],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":70,"address":[4514797],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[4918488,4918424,4918374,4918259],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[4918270,4918324,4918350,4918311,4918292],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[4918385],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[4530961,4531087,4530864,4530879],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":81,"address":[4530941],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[4918678,4918792,4918591,4918728],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[4918641,4918624,4918654,4918602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[4918689],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[4543488,4543711,4543503,4543585],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":91,"address":[4543565],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[4919446,4919100,4918993,4919127],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[4919063,4919046,4919076,4919027],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[4585360,4585375],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":103,"address":[4919154,4919245,4919267,4919383,4919319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[4919167,4919221,4919191,4919208],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[4919256],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[4919280],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[4580616,4580320,4580335,4580420],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":109,"address":[4580397],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[4919822,4919529],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[4919869,4920091,4920036],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[4920310,4920098,4920276,4920175,4920245],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[4920597,4920515,4920365,4920457],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[4920326],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[4920447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[4920546],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[4920642,4921431,4920554,4920501],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[4517621],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[4920802,4920741,4921458,4920944,4920817,4920962,4920931],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":52},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","reply.rs"],"content":"use serde::Serialize;\nuse std::convert::Infallible;\nuse warp::{\n    hyper::StatusCode,\n    reply::{Json, WithStatus},\n    Rejection, Reply,\n};\n\n#[derive(Serialize)]\nstruct ErrorMessage {\n    code: u16,\n    message: String,\n    details: String,\n}\n\n#[derive(Serialize)]\nstruct SuccessMessage {\n    code: u16,\n    message: String,\n}\n\npub fn reply_success(status: StatusCode) -\u003e WithStatus\u003cJson\u003e {\n    warp::reply::with_status(warp::reply::json(\u0026build_success_content(\u0026status)), status)\n}\n\npub fn reply_error(status: StatusCode) -\u003e WithStatus\u003cJson\u003e {\n    warp::reply::with_status(warp::reply::json(\u0026build_error_content(\u0026status, \"\")), status)\n}\n\npub fn reply_error_with_details(status: StatusCode, details: \u0026str) -\u003e WithStatus\u003cJson\u003e {\n    warp::reply::with_status(\n        warp::reply::json(\u0026build_error_content(\u0026status, details)),\n        status,\n    )\n}\n\npub async fn handle_rejection(err: Rejection) -\u003e Result\u003cimpl Reply, Infallible\u003e {\n    if err.is_not_found() {\n        return Ok(reply_error_with_details(\n            StatusCode::NOT_FOUND,\n            \"Path unsupported\",\n        ));\n    } else if err.find::\u003cwarp::reject::MethodNotAllowed\u003e().is_some() {\n        return Ok(reply_error_with_details(\n            StatusCode::METHOD_NOT_ALLOWED,\n            \"Request not supported, check path and sent headers\",\n        ));\n    }\n\n    return Ok(reply_error_with_details(\n        StatusCode::INTERNAL_SERVER_ERROR,\n        \"An internal error has happend, please contact the developers\",\n    ));\n}\n\nfn build_error_content(status: \u0026StatusCode, details: \u0026str) -\u003e ErrorMessage {\n    ErrorMessage {\n        code: status.as_u16(),\n        message: String::from(status.canonical_reason().unwrap_or(\"unknown\")),\n        details: String::from(details),\n    }\n}\n\nfn build_success_content(status: \u0026StatusCode) -\u003e SuccessMessage {\n    SuccessMessage {\n        code: status.as_u16(),\n        message: String::from(status.canonical_reason().unwrap_or(\"unknown\")),\n    }\n}\n","traces":[{"line":22,"address":[4775434,4775392],"length":1,"stats":{"Line":2},"fn_name":"reply_success"},{"line":23,"address":[4907568,4907516],"length":1,"stats":{"Line":4},"fn_name":null},{"line":26,"address":[4907698,4907648],"length":1,"stats":{"Line":1},"fn_name":"reply_error"},{"line":27,"address":[4907720,4907662],"length":1,"stats":{"Line":2},"fn_name":null},{"line":30,"address":[4775766,4775712],"length":1,"stats":{"Line":0},"fn_name":"reply_error_with_details"},{"line":32,"address":[4775737,4775778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[4775888,4775897],"length":1,"stats":{"Line":0},"fn_name":"handle_rejection"},{"line":38,"address":[6173642],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[6173826,6173737],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[6173961,6173923,6173713],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[6174003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[6173967,6174104],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[4775968,4776042],"length":1,"stats":{"Line":1},"fn_name":"build_error_content"},{"line":58,"address":[4776007],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[4776062],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[4776152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4776272],"length":1,"stats":{"Line":2},"fn_name":"build_success_content"},{"line":66,"address":[4776289],"length":1,"stats":{"Line":2},"fn_name":null},{"line":67,"address":[4776317],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":11,"coverable":19}]};
    </script>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, pathToString(file.path)),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('div', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('pre', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>