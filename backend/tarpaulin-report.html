<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
}

.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","bin.rs"],"content":"use secret_clan::run_app;\n\nfn main() {\n    run_app();\n}\n","traces":[{"line":3,"address":[4211120],"length":1,"stats":{"Line":0},"fn_name":"main"},{"line":4,"address":[4211121],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":2},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","client.rs"],"content":"use super::{Command, CommandData, Persist, QueryError};\nuse log::debug;\nuse nanoid::nanoid;\nuse std::{\n    collections::HashSet,\n    fmt::{self, Debug},\n};\nuse tokio::sync::{mpsc, oneshot};\n\npub struct Client\u003cT: Persist\u003e {\n    sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Persist\u003e Client\u003cT\u003e {\n    pub fn new(sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e) -\u003e Self {\n        Client { sender }\n    }\n\n    async fn run_query\u003cR: Debug\u003e(\n        \u0026self,\n        cmd_provider: impl FnOnce(CommandData\u003cR\u003e) -\u003e Command\u003cT\u003e,\n    ) -\u003e Result\u003cR, QueryError\u003e {\n        let (responder, receiver): (oneshot::Sender\u003cR\u003e, oneshot::Receiver\u003cR\u003e) = oneshot::channel();\n        let id = nanoid!();\n        let data = CommandData {\n            responder,\n            id: String::from(\u0026id),\n        };\n        let cmd = cmd_provider(data);\n        let res = self.sender.clone().send(cmd).await;\n        debug!(\"Sent query \\\"{}\\\"\", \u0026id);\n\n        match res {\n            Ok(_) =\u003e match receiver.await {\n                Ok(res) =\u003e {\n                    debug!(\"Received answer for query \\\"{}\\\": {:?}\", \u0026id, res);\n                    Ok(res)\n                }\n                Err(error) =\u003e Err(QueryError::new(\u0026fmt::format(format_args!(\n                    \"Retrieving result for query \\\"{}\\\" has failed: {}\",\n                    id,\n                    error.to_string(),\n                )))),\n            },\n            Err(error) =\u003e Err(QueryError::new(\u0026fmt::format(format_args!(\n                \"Sending query for query \\\"{}\\\" has failed: {}\",\n                id,\n                error.to_string(),\n            )))),\n        }\n    }\n\n    fn map_result\u003cR\u003e(res: Result\u003cR, sled::Error\u003e) -\u003e Result\u003cR, QueryError\u003e {\n        res.map_err(QueryError::from_sled)\n    }\n\n    pub async fn get(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cT\u003e, QueryError\u003e {\n        let key = String::from(id);\n        self.run_query(|data| Command::Get { key, data })\n            .await\n            .and_then(Self::map_result)\n    }\n\n    pub async fn scan(\n        \u0026self,\n        scan_function: Box\u003cdyn Fn(\u0026T) -\u003e bool + Send + Sync\u003e,\n    ) -\u003e Result\u003cHashSet\u003cString\u003e, QueryError\u003e {\n        self.run_query(|data| Command::Scan {\n            scan_function,\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn persist(\u0026self, elem: \u0026T) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Persist {\n            value: elem.clone(),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn remove(\u0026self, key: \u0026str) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Remove {\n            key: String::from(key),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn remove_batch(\u0026self, keys: \u0026HashSet\u003cString\u003e) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::RemoveBatch {\n            keys: keys.clone(),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn purge(\u0026self) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Purge { data })\n            .await\n            .and_then(Self::map_result)\n    }\n\n    pub async fn total_count(\u0026self) -\u003e Result\u003cusize, QueryError\u003e {\n        self.run_query(|data| Command::Count { data }).await\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::Client;\n    use crate::{\n        db::{Database, Persist},\n        model::Game,\n    };\n    use nanoid::nanoid;\n    use std::collections::HashSet;\n\n    fn init_client() -\u003e Client\u003cGame\u003e {\n        let mut repo = Database::init(\"games\");\n\n        let sender = repo.sender();\n        tokio::task::spawn(async move {\n            repo.start_listening().await;\n        });\n\n        let client = Client::new(sender);\n\n        client\n    }\n\n    #[tokio::test]\n    async fn should_get_game() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"token\");\n        let game_id = String::from(game.id());\n\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n\n        let res = client.get(\u0026game_id).await.expect(\"Reading game has failed\");\n\n        assert!(res.is_some());\n        assert_eq!(res.unwrap().id(), game_id);\n    }\n\n    #[tokio::test]\n    async fn should_persist_game() {\n        let client = init_client();\n\n        client\n            .persist(\u0026Game::new(\"admin\", \"token\"))\n            .await\n            .expect(\"Game persist failed\");\n    }\n\n    #[tokio::test]\n    async fn should_purge_games() {\n        let client = init_client();\n\n        client\n            .persist(\u0026Game::new(\"admin\", \"token\"))\n            .await\n            .expect(\"Game persist failed\");\n        client\n            .persist(\u0026Game::new(\"admin\", \"token2\"))\n            .await\n            .expect(\"Game persist failed\");\n\n        assert_eq!(client.total_count().await.unwrap(), 2);\n\n        client.purge().await.expect(\"Perging has failed\");\n\n        assert_eq!(client.total_count().await.unwrap(), 0);\n    }\n\n    #[tokio::test]\n    async fn should_remove_game() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"token\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n\n        let persisted_game = client\n            .get(\u0026game.id())\n            .await\n            .expect(\"Reading game has failed\");\n        assert!(persisted_game.is_some());\n\n        let res = client\n            .remove(game.id())\n            .await\n            .expect(\"Removing game failed\");\n        assert!(res);\n\n        let removed_game = client\n            .get(\u0026game.id())\n            .await\n            .expect(\"Reading game has failed\");\n        assert!(removed_game.is_none());\n    }\n\n    #[tokio::test]\n    async fn should_remove_games() {\n        let client = init_client();\n        let mut ids = HashSet::new();\n        for x in \u0026[\"A\", \"B\", \"C\"] {\n            let g = Game::new(\"admin\", *x);\n            client.persist(\u0026g).await.expect(\"Game persist failed\");\n            ids.insert(String::from(*x));\n        }\n\n        let game_count = client\n            .total_count()\n            .await\n            .expect(\"Reading count has failed\");\n        assert_eq!(game_count, 3);\n\n        let res = client\n            .remove_batch(\u0026ids)\n            .await\n            .expect(\"Removing games failed\");\n        assert!(res);\n\n        let game_count = client\n            .total_count()\n            .await\n            .expect(\"Reading count has failed\");\n        assert_eq!(game_count, 0);\n    }\n\n    #[tokio::test]\n    async fn should_not_get_game() {\n        let client = init_client();\n        let res = client\n            .get(\"unknown\")\n            .await\n            .expect(\"Reading game has failed\");\n\n        assert!(res.is_none());\n    }\n\n    #[tokio::test]\n    async fn should_create_entities_concurrently() {\n        let client = init_client();\n\n        let mut threads = vec![];\n\n        for _ in 0..1000 {\n            threads.push(async {\n                let _ = client.persist(\u0026Game::new(\"admin\", \u0026nanoid!())).await;\n            });\n        }\n\n        futures::future::join_all(threads).await;\n\n        assert_eq!(\n            client\n                .total_count()\n                .await\n                .expect(\"Reading count has failed\"),\n            1000\n        );\n    }\n}\n","traces":[{"line":15,"address":[6073344,6073280],"length":1,"stats":{"Line":9},"fn_name":"new\u003csecret_clan::model::game::Game\u003e"},{"line":19,"address":[6073760,6073568,6073488,6073664,6073920,6074112,6074016,6073840,6073408],"length":1,"stats":{"Line":17},"fn_name":"run_query\u003csecret_clan::model::game::Game,core::result::Result\u003cbool, sled::result::Error\u003e,closure-0\u003e"},{"line":23,"address":[6097745,6074365,6103353,6120921,6086157,6080153,6091945,6109357,6115133],"length":1,"stats":{"Line":17},"fn_name":null},{"line":24,"address":[6092030,6097830,6086250,6103438,6115226,6074458,6080238,6109450,6121006],"length":1,"stats":{"Line":18},"fn_name":null},{"line":27,"address":[6121231,6109675,6092255,6098055,6086475,6115451,6074683,6103663,6080463],"length":1,"stats":{"Line":18},"fn_name":null},{"line":29,"address":[6109915,6109755,6098135,6080735,6092335,6074923,6098287,6121311,6086715,6121499,6074763,6086555,6080543,6092523,6103935,6103743,6115531,6115691],"length":1,"stats":{"Line":37},"fn_name":null},{"line":30,"address":[4821473,4838817,4820353,4782673,4827537,4800673,4789249,4839905,4808609],"length":1,"stats":{"Line":96},"fn_name":null},{"line":31,"address":[6093299,6075699,6099236,6122275,6076106,6104844,6087624,6105118,6099283,6110824,6093432,6093472,6099470,6110864,6116600,6111098,6116874,6104884,6122495,6122682,6116687,6087664,6075832,6122408,6110911,6081918,6122448,6104711,6081644,6093706,6099063,6099196,6087711,6075919,6104931,6110691,6116640,6087491,6116467,6081511,6093519,6075872,6087898,6081731,6081684],"length":1,"stats":{"Line":76},"fn_name":null},{"line":33,"address":[6105320,6113874,6107782,6117076,6119340,6078882,6084582,6093908,6108106,6119650,6111300,6122884,6125154,6102088,6090364,6125478,6113564,6088100,6099672,6082120,6078572,6090674,6076308,6096178,6084906,6096502,6101763],"length":1,"stats":{"Line":22},"fn_name":null},{"line":34,"address":[4789464,4839032,4821688,4808824,4800888,4840120,4820568,4827752,4782888],"length":1,"stats":{"Line":97},"fn_name":null},{"line":35,"address":[6105920,6111766,6082720,6094304,6123280,6076774,6100031,6100098,6076701,6111693,6117469,6123356,6105844,6117542,6088566,6088493,6094380,6082644],"length":1,"stats":{"Line":42},"fn_name":null},{"line":36,"address":[6094635,6112306,6117797,6117844,6088630,6076971,6089203,6106524,6077076,6088868,6095017,6106286,6100338,6111830,6100576,6117739,6082848,6076838,6089106,6100291,6111963,6123420,6100114,6077411,6123658,6123896,6083421,6100247,6088763,6112021,6106181,6106048,6123993,6094444,6094682,6077314,6088821,6083039,6117606,6106239,6083086,6106621,6118179,6123611,6077029,6083324,6112068,6118082,6123553,6094920,6112403,6094577,6100673,6082981],"length":1,"stats":{"Line":84},"fn_name":null},{"line":37,"address":[6100714,6083462,6124034,6089244,6112444,6118220,6095058,6106662,6077452],"length":1,"stats":{"Line":21},"fn_name":null},{"line":39,"address":[6095178,6124561,6118557,6124154,6089669,6100895,6106782,6118340,6095483,6124371,6124294,6095395,6089504,6124459,6077789,6112869,6101168,6077712,6100978,6089581,6106999,6077979,6083989,6083722,6077877,6095318,6107189,6112564,6112971,6112704,6083799,6089364,6118480,6101066,6107087,6077572,6118747,6083887,6089771,6118645,6112781,6106922,6083582,6100755,6095585],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[6111722,6076730,6123312,6094336,6088522,6100054,6117498,6082676,6105876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[6100058,6117502,6105880,6123316,6094340,6111726,6076734,6088526,6082680],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[6089866,6119051,6116955,6076187,6101263,6084381,6101560,6084293,6078471,6107419,6113463,6099551,6111179,6078209,6084481,6095889,6095977,6078371,6084084,6095815,6101662,6107493,6107681,6090075,6095680,6081999,6090001,6113201,6118977,6107581,6107284,6122763,6124791,6096077,6113363,6084219,6113275,6090263,6101398,6078283,6113066,6090163,6105199,6124865,6119239,6124953,6125053,6093787,6124656,6078074,6118842,6101472,6119139,6087979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[6122834,6105270,6076258,6099622,6111250,6082070,6093858,6088050,6117026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[6117030,6105274,6076262,6093862,6082074,6111254,6088054,6099626,6122838],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[6126784,6126544,6126944,6126624,6126704,6126864],"length":1,"stats":{"Line":14},"fn_name":"map_result\u003csecret_clan::model::game::Game,bool\u003e"},{"line":54,"address":[6126951,6126634,6126791,6126711,6126551,6126874],"length":1,"stats":{"Line":16},"fn_name":null},{"line":57,"address":[6127504,6127024,6127154,6127530,6129117,6127738,6128650,6127058,6128205,6127120,6128416,6128442],"length":1,"stats":{"Line":14},"fn_name":"get\u003csecret_clan::model::game::Game\u003e"},{"line":58,"address":[6127649,6128561],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[4846438,4787574],"length":1,"stats":{"Line":18},"fn_name":null},{"line":60,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[6129424,6129328],"length":1,"stats":{"Line":2},"fn_name":"scan\u003csecret_clan::model::game::Game\u003e"},{"line":68,"address":[4827222,4806422],"length":1,"stats":{"Line":15},"fn_name":null},{"line":69,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[6129537,6129649],"length":1,"stats":{"Line":2},"fn_name":null},{"line":72,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[6131562,6131536,6131616,6133146,6133811,6132931,6131642,6133344,6132464,6132240,6132266,6133120],"length":1,"stats":{"Line":35},"fn_name":"persist\u003csecret_clan::model::player::Player\u003e"},{"line":77,"address":[6132090,6131968,6132368,6133373,6131818,6133487,6132916,6131696,6132607,6133796,6131746,6132539,6132018,6133248,6132493,6133419],"length":1,"stats":{"Line":42},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":78,"address":[6131986,6131714],"length":1,"stats":{"Line":7},"fn_name":null},{"line":79,"address":[6131766,6132038],"length":1,"stats":{"Line":7},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":86,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[4831656,4831568,4799424,4799512,4799439,4831583],"length":1,"stats":{"Line":12},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":95,"address":[4831638,4799494],"length":1,"stats":{"Line":12},"fn_name":null},{"line":96,"address":[6134175,6134415],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[6134469,6134229],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":104,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":105,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[4809200,4809215,4809288],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":110,"address":[4809270],"length":1,"stats":{"Line":12},"fn_name":null},{"line":124,"address":[5015600,5015674],"length":1,"stats":{"Line":6},"fn_name":"init_client"},{"line":125,"address":[5015617],"length":1,"stats":{"Line":6},"fn_name":null},{"line":127,"address":[5015702],"length":1,"stats":{"Line":7},"fn_name":null},{"line":128,"address":[5015717],"length":1,"stats":{"Line":12},"fn_name":null},{"line":129,"address":[5827974],"length":1,"stats":{"Line":6},"fn_name":null},{"line":132,"address":[5015902],"length":1,"stats":{"Line":7},"fn_name":null},{"line":137,"address":[5016119,5016112],"length":1,"stats":{"Line":9},"fn_name":"should_get_game"},{"line":139,"address":[6982640],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[6982671],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[6982728,6982789],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[5758527],"length":1,"stats":{"Line":4},"fn_name":null},{"line":145,"address":[5758626],"length":1,"stats":{"Line":5},"fn_name":null},{"line":147,"address":[6983970,6984019,6984201],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[6984439,6984274,6984296,6984035,6984247,6984746,6984657],"length":1,"stats":{"Line":4},"fn_name":null},{"line":151,"address":[5016423,5016416],"length":1,"stats":{"Line":9},"fn_name":"should_persist_game"},{"line":153,"address":[6985734],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[5801493],"length":1,"stats":{"Line":5},"fn_name":null},{"line":156,"address":[6985751],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[5016720,5016727],"length":1,"stats":{"Line":9},"fn_name":"should_purge_games"},{"line":163,"address":[6986718],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[5799767],"length":1,"stats":{"Line":5},"fn_name":null},{"line":166,"address":[6986741],"length":1,"stats":{"Line":1},"fn_name":null},{"line":169,"address":[5799859],"length":1,"stats":{"Line":5},"fn_name":null},{"line":170,"address":[6987327],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[5799906],"length":1,"stats":{"Line":4},"fn_name":null},{"line":176,"address":[5799934],"length":1,"stats":{"Line":5},"fn_name":null},{"line":178,"address":[5799965],"length":1,"stats":{"Line":5},"fn_name":null},{"line":181,"address":[5017024,5017031],"length":1,"stats":{"Line":9},"fn_name":"should_remove_game"},{"line":183,"address":[6991144],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[6991159],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[5775865],"length":1,"stats":{"Line":5},"fn_name":null},{"line":187,"address":[5775934],"length":1,"stats":{"Line":4},"fn_name":null},{"line":188,"address":[6991676,6991758],"length":1,"stats":{"Line":2},"fn_name":null},{"line":191,"address":[6992461,6992405,6992518],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[5775982],"length":1,"stats":{"Line":4},"fn_name":null},{"line":194,"address":[6992489],"length":1,"stats":{"Line":1},"fn_name":null},{"line":197,"address":[6993042,6992964],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[5776033],"length":1,"stats":{"Line":4},"fn_name":null},{"line":200,"address":[6993090,6992993],"length":1,"stats":{"Line":2},"fn_name":null},{"line":203,"address":[6993740,6993715,6993780],"length":1,"stats":{"Line":2},"fn_name":null},{"line":206,"address":[5017328,5017335],"length":1,"stats":{"Line":9},"fn_name":"should_remove_games"},{"line":208,"address":[6994917],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[6994932],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[6994946,6995013,6995164,6995793,6995067],"length":1,"stats":{"Line":4},"fn_name":null},{"line":211,"address":[6995202],"length":1,"stats":{"Line":1},"fn_name":null},{"line":212,"address":[5798089],"length":1,"stats":{"Line":5},"fn_name":null},{"line":213,"address":[6995755,6995688],"length":1,"stats":{"Line":2},"fn_name":null},{"line":216,"address":[5798179],"length":1,"stats":{"Line":5},"fn_name":null},{"line":220,"address":[6996723,6996231,6996378,6996624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[5798206],"length":1,"stats":{"Line":5},"fn_name":null},{"line":223,"address":[6996337],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[6997170,6997134],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[5798231],"length":1,"stats":{"Line":5},"fn_name":null},{"line":232,"address":[6997714,6997918,6998008,6997591],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[5017639,5017632],"length":1,"stats":{"Line":9},"fn_name":"should_not_get_game"},{"line":237,"address":[6999158],"length":1,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[5824949],"length":1,"stats":{"Line":4},"fn_name":null},{"line":243,"address":[6999813,6999754,6999779],"length":1,"stats":{"Line":2},"fn_name":null},{"line":246,"address":[5017943,5017936],"length":1,"stats":{"Line":9},"fn_name":"should_create_entities_concurrently"},{"line":248,"address":[7001333],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[7001355],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[7001817,7001377,7001545,7001695,7001484],"length":1,"stats":{"Line":4},"fn_name":null},{"line":253,"address":[5738600,5738431,5738625,5738416],"length":1,"stats":{"Line":5},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":254,"address":[5738497],"length":1,"stats":{"Line":6},"fn_name":null},{"line":258,"address":[5742050],"length":1,"stats":{"Line":5},"fn_name":null},{"line":260,"address":[7002560,7002887,7002683,7002977],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[5742102],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":104,"coverable":125},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","database.rs"],"content":"use super::{Command, Persist, ScanFunction};\nuse log::{debug, error, info, warn};\nuse nanoid::nanoid;\nuse rayon::prelude::*;\nuse sled::Db;\nuse std::collections::HashSet;\nuse tokio::sync::{\n    mpsc::{self},\n    oneshot::{self},\n};\n\npub struct Database\u003cT: Persist\u003e {\n    path: String,\n    db: Db,\n    receiver: mpsc::Receiver\u003cCommand\u003cT\u003e\u003e,\n    sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Persist\u003e Database\u003cT\u003e {\n    pub fn init(path: \u0026str) -\u003e Database\u003cT\u003e {\n        let db = sled::open(if cfg!(test) {\n            format!(\".sled/{}/{}\", nanoid!(), \u0026path)\n        } else {\n            format!(\".sled/{}\", \u0026path)\n        })\n        .expect(\"opening database has failed\");\n\n        let (sender, receiver): (mpsc::Sender\u003cCommand\u003cT\u003e\u003e, mpsc::Receiver\u003cCommand\u003cT\u003e\u003e) =\n            mpsc::channel(32);\n\n        let repo = Database {\n            db,\n            path: String::from(path),\n            receiver,\n            sender,\n        };\n\n        repo.purge()\n            .expect(\"Cleanup of existing database has failed\");\n\n        repo\n    }\n\n    pub fn sender(\u0026self) -\u003e mpsc::Sender\u003cCommand\u003cT\u003e\u003e {\n        self.sender.clone()\n    }\n\n    /// A database connection is etablished by creating a database instance, which should should then be started in a separate thread.\n    /// The communication between resources and the database is established with channels. Simply use a client to send messages to the database thread in an easy accesible way.\n    /// Of course it's also possible to send messages through the channel directly without using the client.\n    ///\n    /// Example:\n    /// ```\n    /// use secret_clan::{model::Game, db::{Database, Client}};\n    /// let mut repo: Database\u003cGame\u003e = Database::init(\"test\");\n    /// let sender = repo.sender();\n    /// std::thread::spawn(move || {\n    ///     repo.start_listening();\n    /// });\n    /// let client = Client::new(sender);\n    /// ```\n    pub async fn start_listening(\u0026mut self) {\n        info!(\"Database for \\\"{}\\\" ready\", self.path);\n\n        while let Some(cmd) = self.receiver.recv().await {\n            debug!(\"Received query: {:?}\", cmd);\n\n            match cmd {\n                Command::Get { key, data } =\u003e {\n                    self.send_result(self.get(\u0026key), data.responder);\n                }\n                Command::Persist { value, data } =\u003e {\n                    self.send_result(self.persist(\u0026value), data.responder);\n                }\n                Command::Remove { key, data } =\u003e {\n                    self.send_result(self.remove(\u0026key), data.responder);\n                }\n                Command::RemoveBatch { keys, data } =\u003e {\n                    self.send_result(self.remove_batch(\u0026keys), data.responder);\n                }\n                Command::Count { data } =\u003e {\n                    self.send_result(self.total_count(), data.responder);\n                }\n                Command::Scan {\n                    scan_function,\n                    data,\n                } =\u003e {\n                    self.send_result(Ok(self.scan(scan_function)), data.responder);\n                }\n                Command::Purge { data } =\u003e {\n                    self.send_result(self.purge(), data.responder);\n                }\n            }\n        }\n    }\n\n    fn persist(\u0026self, elem: \u0026T) -\u003e Result\u003cbool, sled::Error\u003e {\n        self.db\n            .insert(elem.id(), elem.clone())\n            .expect(\"Persisting item failed\");\n        self.flush()\n    }\n\n    fn remove(\u0026self, key: \u0026str) -\u003e Result\u003cbool, sled::Error\u003e {\n        match self.db.remove(key).expect(\"Removing item failed\") {\n            Some(_) =\u003e self.flush(),\n            None =\u003e {\n                warn!(\"No item with key \\\"{}\\\" found for removal\", key);\n                Ok(false)\n            }\n        }\n    }\n\n    fn remove_batch(\u0026self, keys: \u0026HashSet\u003cString\u003e) -\u003e Result\u003cbool, sled::Error\u003e {\n        let batch = sled::Batch::default();\n        for key in keys {\n            match self.db.remove(key).expect(\"Removing item failed\") {\n                Some(_) =\u003e {}\n                None =\u003e {\n                    warn!(\"No item with key \\\"{}\\\" found for removal\", key);\n                }\n            }\n        }\n        self.db.apply_batch(batch)?;\n        self.flush()\n    }\n\n    fn get(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cT\u003e, sled::Error\u003e {\n        let success = self.db.get(id);\n        match success {\n            Ok(res) =\u003e Ok(res.and_then(|g| T::try_from(g).ok())),\n            Err(err) =\u003e Err(err),\n        }\n    }\n\n    fn scan(\u0026self, scan_function: ScanFunction\u003cT\u003e) -\u003e HashSet\u003cString\u003e {\n        self.db\n            .iter()\n            .par_bridge()\n            .filter_map(|x| x.ok())\n            .filter_map(|(_, x)| T::try_from(x).ok())\n            .filter_map(|y| {\n                if scan_function(\u0026y) {\n                    Some(String::from(y.id()))\n                } else {\n                    None\n                }\n            })\n            .collect::\u003cHashSet\u003cString\u003e\u003e()\n    }\n\n    fn total_count(\u0026self) -\u003e usize {\n        self.db.len()\n    }\n\n    fn flush(\u0026self) -\u003e Result\u003cbool, sled::Error\u003e {\n        self.db.flush().map(|_| true)\n    }\n\n    fn send_result\u003cR\u003e(\u0026self, data: R, sender: oneshot::Sender\u003cR\u003e) {\n        if sender.send(data).is_err() {\n            error!(\"Sending result to client has failed\");\n        }\n    }\n\n    fn purge(\u0026self) -\u003e Result\u003cbool, sled::Error\u003e {\n        let res = self.db.clear().and_then(|()| self.db.flush()).map(|_| true);\n        info!(\"Purged database \\\"{}\\\"\", self.path);\n\n        res\n    }\n}\n","traces":[{"line":20,"address":[6264832,6264962,6265824,6265954],"length":1,"stats":{"Line":8},"fn_name":"init\u003csecret_clan::model::player::Player\u003e"},{"line":21,"address":[6265125,6264859,6266117,6265851],"length":1,"stats":{"Line":18},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":24,"address":[6264989,6265981,6265875,6264883],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[6265225,6266217],"length":1,"stats":{"Line":6},"fn_name":null},{"line":33,"address":[6266328,6265336],"length":1,"stats":{"Line":2},"fn_name":null},{"line":38,"address":[6265585,6266536,6266577,6265544],"length":1,"stats":{"Line":11},"fn_name":null},{"line":41,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[6266816,6266864],"length":1,"stats":{"Line":9},"fn_name":"sender\u003csecret_clan::model::game::Game\u003e"},{"line":45,"address":[6266828,6266876],"length":1,"stats":{"Line":9},"fn_name":null},{"line":62,"address":[4802944,4818080,4818095,4802959],"length":1,"stats":{"Line":13},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":63,"address":[6273300,6273497,6267512,6267683,6273715,6267268,6273544,6273433,6267465,6267401],"length":1,"stats":{"Line":23},"fn_name":null},{"line":65,"address":[6267724,6267835,6268170,6273756,6267880,6273867,6273974,6273912,6278139,6274202,6272107,6267942],"length":1,"stats":{"Line":40},"fn_name":null},{"line":66,"address":[6268296,6274469,6268758,6268437,6274328,6274790,6268534,6274613,6268581,6274566],"length":1,"stats":{"Line":32},"fn_name":null},{"line":68,"address":[6269243,6270213,6274964,6271891,6275275,6276245,6277923,6275948,6268932,6275652,6269620,6269916],"length":1,"stats":{"Line":15},"fn_name":null},{"line":69,"address":[6268799,6268934,6274831,6274966],"length":1,"stats":{"Line":11},"fn_name":null},{"line":70,"address":[6275208,6269176,6275062,6269030],"length":1,"stats":{"Line":6},"fn_name":null},{"line":72,"address":[6275280,6269248],"length":1,"stats":{"Line":7},"fn_name":null},{"line":73,"address":[6269440,6275472],"length":1,"stats":{"Line":7},"fn_name":null},{"line":75,"address":[6269625,6275657],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[6275753,6269721,6269852,6275884],"length":1,"stats":{"Line":2},"fn_name":null},{"line":78,"address":[6269921,6275953],"length":1,"stats":{"Line":2},"fn_name":null},{"line":79,"address":[6276065,6270033],"length":1,"stats":{"Line":2},"fn_name":null},{"line":81,"address":[6276250,6270218],"length":1,"stats":{"Line":2},"fn_name":null},{"line":82,"address":[6276306,6270274],"length":1,"stats":{"Line":2},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[6270400,6276432],"length":1,"stats":{"Line":2},"fn_name":null},{"line":86,"address":[6270440,6276472],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[6276528,6276609,6270577,6270496],"length":1,"stats":{"Line":4},"fn_name":null},{"line":90,"address":[6274871,6268839],"length":1,"stats":{"Line":1},"fn_name":null},{"line":91,"address":[6268895,6274927,6270704,6276736],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[6279312,6279072],"length":1,"stats":{"Line":7},"fn_name":"persist\u003csecret_clan::model::player::Player\u003e"},{"line":98,"address":[6279421,6279338,6279181,6279098],"length":1,"stats":{"Line":14},"fn_name":null},{"line":99,"address":[6279147,6279387],"length":1,"stats":{"Line":7},"fn_name":null},{"line":101,"address":[6279525,6279285],"length":1,"stats":{"Line":7},"fn_name":null},{"line":104,"address":[6280277,6280208,6279552,6279621],"length":1,"stats":{"Line":1},"fn_name":"remove\u003csecret_clan::model::player::Player\u003e"},{"line":105,"address":[6279793,6280449,6280472,6279816,6280292,6279580,6279636,6280236],"length":1,"stats":{"Line":3},"fn_name":null},{"line":106,"address":[6280375,6280451,6279719,6279795],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[6280560,6279904,6279821,6280411,6280477,6279755],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[6282221,6282144,6280864,6280941],"length":1,"stats":{"Line":2},"fn_name":"remove_batch\u003csecret_clan::model::game::Game\u003e"},{"line":115,"address":[6282170,6280890],"length":1,"stats":{"Line":2},"fn_name":null},{"line":116,"address":[6282385,6282236,6281686,6281105,6280956,6282966],"length":1,"stats":{"Line":4},"fn_name":null},{"line":117,"address":[6282424,6281144,6281665,6282945,6281325,6282605],"length":1,"stats":{"Line":2},"fn_name":null},{"line":118,"address":[6281245,6282525],"length":1,"stats":{"Line":2},"fn_name":null},{"line":119,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[6282567,6281332,6281287,6281415,6282612,6282695],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[6282359,6283308,6281858,6281079,6282971,6281691,6282028,6283276,6281996,6283138],"length":1,"stats":{"Line":4},"fn_name":null},{"line":125,"address":[6283114,6281834],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[6283424,6284318,6283888,6283854],"length":1,"stats":{"Line":3},"fn_name":"get\u003csecret_clan::model::player::Player\u003e"},{"line":129,"address":[6283458,6283922],"length":1,"stats":{"Line":3},"fn_name":null},{"line":130,"address":[6283673,6284137],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[6284144,6284458,6284352,6283680,6284362,6284448,6283525,6283989],"length":1,"stats":{"Line":14},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":132,"address":[6283541,6284005],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[6284848,6284544,6284908,6284604],"length":1,"stats":{"Line":2},"fn_name":"scan\u003csecret_clan::model::player::Player\u003e"},{"line":137,"address":[6284959,6284572,6284749,6284619,6284655,6284876,6284923,6285053],"length":1,"stats":{"Line":8},"fn_name":null},{"line":140,"address":[6285152,6285164,6285232,6285244],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":141,"address":[6285570,6285312,6285330,6285552],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":142,"address":[6285045,6284741,6286016,6286075,6285792,6285851],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":143,"address":[6286028,6285898,6285804,6286091,6285867,6286122],"length":1,"stats":{"Line":6},"fn_name":null},{"line":144,"address":[6285900,6286124],"length":1,"stats":{"Line":2},"fn_name":null},{"line":146,"address":[6286115,6285891],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[6286240,6286304],"length":1,"stats":{"Line":2},"fn_name":"total_count\u003csecret_clan::model::player::Player\u003e"},{"line":153,"address":[6286313,6286249],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[6286464,6286368],"length":1,"stats":{"Line":7},"fn_name":"flush\u003csecret_clan::model::player::Player\u003e"},{"line":157,"address":[6286476,6286613,6286592,6286380,6286601,6286581,6286569,6286560],"length":1,"stats":{"Line":21},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":160,"address":[6288784,6286992,6287888,6287968,6288864,6289315,6289680,6287440,6288416,6289232,6289729,6287075,6286673,6287520,6286624,6288336],"length":1,"stats":{"Line":14},"fn_name":"send_result\u003csecret_clan::model::game::Game,usize\u003e"},{"line":161,"address":[6287850,6287015,6286649,6289705,6288879,6289194,6289645,6287535,6286688,6288298,6288746,6289744,6286949,6287090,6290005,6287983,6287911,6289330,6288431,6288807,6287405,6287463,6288359,6289255],"length":1,"stats":{"Line":30},"fn_name":null},{"line":162,"address":[6288147,6289790,6289396,6287156,6287601,6288497,6288945,6286820,6286734,6289043,6289876,6288049,6289494,6287699,6287254,6288595],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[6290048,6290661,6290101,6290608],"length":1,"stats":{"Line":3},"fn_name":"purge\u003csecret_clan::model::game::Game\u003e"},{"line":167,"address":[6291248,6291337,6291168,6291328,6290063,6290623,6291360,6290676,6291180,6291260,6291349,6291381,6290116,6291369],"length":1,"stats":{"Line":28},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":168,"address":[6290751,6290872,6290915,6290312,6290355,6290191],"length":1,"stats":{"Line":27},"fn_name":null},{"line":170,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":62,"coverable":74},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","mod.rs"],"content":"mod client;\nmod database;\n\nuse sled::IVec;\nuse std::{\n    clone::Clone,\n    collections::HashSet,\n    convert::TryFrom,\n    fmt::{self, Debug},\n};\nuse tokio::sync::oneshot;\n\npub use self::client::Client;\npub use self::database::Database;\n\npub trait Persist: Into\u003cIVec\u003e + TryFrom\u003cIVec\u003e + Clone + Debug + Send {\n    fn id(\u0026self) -\u003e \u0026str;\n}\n#[derive(Debug, Clone)]\npub struct QueryError {\n    message: String,\n}\n\nimpl QueryError {\n    pub fn new(message: \u0026str) -\u003e Self {\n        QueryError {\n            message: String::from(message),\n        }\n    }\n\n    pub fn from_sled(error: sled::Error) -\u003e Self {\n        QueryError {\n            message: error.to_string(),\n        }\n    }\n}\n\nimpl fmt::Display for QueryError {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter) -\u003e fmt::Result {\n        write!(f, \"invalid first item to double\")\n    }\n}\n\n#[derive(Derivative)]\n#[derivative(Debug)]\npub struct CommandData\u003cR: Debug\u003e {\n    id: String,\n    #[derivative(Debug = \"ignore\")]\n    responder: oneshot::Sender\u003cR\u003e,\n}\n\npub type ScanFunction\u003cT\u003e = Box\u003cdyn Fn(\u0026T) -\u003e bool + Send + Sync\u003e;\n\n#[derive(Derivative)]\n#[derivative(Debug)]\npub enum Command\u003cT: Persist\u003e {\n    Get {\n        key: String,\n        data: CommandData\u003cResult\u003cOption\u003cT\u003e, sled::Error\u003e\u003e,\n    },\n    Scan {\n        #[derivative(Debug = \"ignore\")]\n        scan_function: ScanFunction\u003cT\u003e,\n        data: CommandData\u003cResult\u003cHashSet\u003cString\u003e, sled::Error\u003e\u003e,\n    },\n    Persist {\n        value: T,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Remove {\n        key: String,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Purge {\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    RemoveBatch {\n        keys: HashSet\u003cString\u003e,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Count {\n        data: CommandData\u003cusize\u003e,\n    },\n}\n","traces":[{"line":25,"address":[5237824],"length":1,"stats":{"Line":0},"fn_name":"new"},{"line":27,"address":[5237841],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[5237945,5237904],"length":1,"stats":{"Line":0},"fn_name":"from_sled"},{"line":33,"address":[5237911],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[5238048],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":40,"address":[5238081],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","cleanup_games.rs"],"content":"use crate::{db::Client, model::Game, server::app_context::AppContext};\nuse chrono::{Duration, Utc};\nuse log::{debug, info, warn};\n\npub fn cleanup_games(ctx: \u0026'static AppContext) -\u003e impl Fn() {\n    move || {\n        tokio::task::spawn(async move {\n            execute_cleanup_games(ctx.db().games(), Duration::minutes(5)).await;\n        });\n    }\n}\n\nasync fn execute_cleanup_games(client: \u0026Client\u003cGame\u003e, duration: Duration) -\u003e bool {\n    let inactive_games = client\n        .scan(Box::new(is_inactive_game(duration)))\n        .await\n        .expect(\"Scanning games has failed\");\n\n    let inactive_count = inactive_games.len();\n    if inactive_count == 0 {\n        debug!(\"Removed no inactive games\");\n        false\n    } else {\n        match client.remove_batch(\u0026inactive_games).await {\n            Ok(_) =\u003e {\n                info!(\"Removed {} inactive games\", inactive_count);\n                true\n            }\n            Err(e) =\u003e {\n                warn!(\n                    \"Removing {} inactive games has failed: {:?}\",\n                    inactive_count, e\n                );\n                false\n            }\n        }\n    }\n}\n\n// Game is inactive if no admin is present and last activity happened five minutes ago\nfn is_inactive_game(duration: Duration) -\u003e impl Fn(\u0026Game) -\u003e bool {\n    let threshold = Utc::now().checked_sub_signed(duration).unwrap();\n    move |game: \u0026Game| match game.admin_id() {\n        Some(_) =\u003e false,\n        None =\u003e game.last_action_time().lt(\u0026threshold),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::execute_cleanup_games;\n    use crate::{\n        db::{Client, Database},\n        model::Game,\n    };\n    use chrono::Duration;\n\n    fn init_client() -\u003e Client\u003cGame\u003e {\n        let mut repo = Database::init(\"games\");\n\n        let sender = repo.sender();\n        tokio::task::spawn(async move {\n            repo.start_listening().await;\n        });\n\n        let client = Client::new(sender);\n\n        client\n    }\n\n    #[tokio::test]\n    async fn should_cleanup_games() {\n        let client = init_client();\n        let mut game = Game::new(\"admin\", \"TOKEN\");\n        game.remove_player(\"admin\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_none());\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n\n        let res = execute_cleanup_games(\u0026client, Duration::nanoseconds(1)).await;\n        assert!(res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_none());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_games_with_admin() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"TOKEN\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_some());\n\n        let res = execute_cleanup_games(\u0026client, Duration::nanoseconds(1)).await;\n        assert!(!res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_games_with_recent_action() {\n        let client = init_client();\n        let mut game = Game::new(\"admin\", \"TOKEN\");\n        game.remove_player(\"admin\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_none());\n\n        let res = execute_cleanup_games(\u0026client, Duration::minutes(5)).await;\n        assert!(!res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n    }\n}\n","traces":[{"line":5,"address":[4739296],"length":1,"stats":{"Line":0},"fn_name":"cleanup_games"},{"line":6,"address":[4739305],"length":1,"stats":{"Line":0},"fn_name":null},{"line":7,"address":[5731660,5731567,5731552,5731638],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":8,"address":[5731622],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[5813553,5813520],"length":1,"stats":{"Line":8},"fn_name":"execute_cleanup_games"},{"line":14,"address":[5791023],"length":1,"stats":{"Line":8},"fn_name":null},{"line":15,"address":[6006302],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[6006980,6007043],"length":1,"stats":{"Line":6},"fn_name":null},{"line":20,"address":[6007054,6008906,6007485],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[6007373,6007470,6007260,6007127,6007326],"length":1,"stats":{"Line":8},"fn_name":null},{"line":22,"address":[6007477],"length":1,"stats":{"Line":2},"fn_name":null},{"line":24,"address":[4772997],"length":1,"stats":{"Line":6},"fn_name":null},{"line":25,"address":[5244867],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[5245086,5245166,5245325,5245125,5244962],"length":1,"stats":{"Line":4},"fn_name":null},{"line":27,"address":[5245366],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[5244884],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[5245833,5245462,5245745,5245556,5244916,5245379,5245586,5245515],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[5245582],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[5245874],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[5813616],"length":1,"stats":{"Line":1},"fn_name":"is_inactive_game"},{"line":42,"address":[5813632],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[5246707,5246775,5246688,5246801,5246768],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}"},{"line":44,"address":[5246731,5246770],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[5246756,5246786],"length":1,"stats":{"Line":2},"fn_name":null},{"line":58,"address":[6331178,6331104],"length":1,"stats":{"Line":1},"fn_name":"init_client"},{"line":59,"address":[6331121],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[6331206],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[5799097,5798960,5798975,5799046],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":63,"address":[5799030],"length":1,"stats":{"Line":7},"fn_name":null},{"line":66,"address":[6331406],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[5768057,5767904,5768090,5768208,5768151,5767925,5768181,5768126],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":73,"address":[6211774],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[6211789],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[6211846],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[5768041],"length":1,"stats":{"Line":5},"fn_name":null},{"line":77,"address":[5768110],"length":1,"stats":{"Line":7},"fn_name":null},{"line":84,"address":[5768135],"length":1,"stats":{"Line":5},"fn_name":null},{"line":86,"address":[5768165],"length":1,"stats":{"Line":5},"fn_name":null},{"line":87,"address":[6214158,6214199],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[5768192],"length":1,"stats":{"Line":5},"fn_name":null},{"line":92,"address":[5815647,5815527,5815376,5815397,5815560,5815593,5815620],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":94,"address":[6216158],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[6216173],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5815511],"length":1,"stats":{"Line":5},"fn_name":null},{"line":97,"address":[5815577],"length":1,"stats":{"Line":7},"fn_name":null},{"line":105,"address":[5815604],"length":1,"stats":{"Line":5},"fn_name":null},{"line":106,"address":[6217822,6217779],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5815631],"length":1,"stats":{"Line":5},"fn_name":null},{"line":111,"address":[5777543,5777392,5777576,5777413,5777636,5777663,5777609],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":113,"address":[6219582],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[6219597],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[6219648],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[5777527],"length":1,"stats":{"Line":5},"fn_name":null},{"line":117,"address":[5777593],"length":1,"stats":{"Line":7},"fn_name":null},{"line":125,"address":[5777620],"length":1,"stats":{"Line":5},"fn_name":null},{"line":126,"address":[6221239,6221282],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[5777647],"length":1,"stats":{"Line":5},"fn_name":null}],"covered":49,"coverable":57},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","cleanup_players.rs"],"content":"use crate::{model::Player, server::app_context::AppContext};\nuse chrono::{Duration, Utc};\nuse log::{debug, info, warn};\n\npub fn cleanup_players(ctx: \u0026'static AppContext) -\u003e impl Fn() {\n    move || {\n        tokio::spawn(async move {\n            execute_cleanup_players(ctx, Duration::minutes(1)).await;\n        });\n    }\n}\n\n// Player is active after one minute without an active connection\nfn is_inactive_player(duration: Duration) -\u003e impl Fn(\u0026Player) -\u003e bool {\n    let threshold = Utc::now().checked_sub_signed(duration).unwrap();\n\n    move |player: \u0026Player| player.last_action_time().lt(\u0026threshold)\n}\n\nasync fn execute_cleanup_players(ctx: \u0026AppContext, duration: Duration) -\u003e bool {\n    let inactive_players = ctx\n        .db()\n        .players()\n        .scan(Box::new(is_inactive_player(duration)))\n        .await\n        .expect(\"Scanning players has failed\");\n    let inactive_count = inactive_players.len();\n\n    // remove players from maybe existing game\n    for id in inactive_players.clone() {\n        let player = ctx.db().players().get(\u0026id).await;\n        if let Some(player) = player.expect(\"Reading player has failed\") {\n            let game = ctx.db().games().get(player.game_token()).await;\n            if let Some(mut game) = game.expect(\"Reading game has failed\") {\n                game.remove_player(\u0026id);\n                if let Err(_) = ctx.db().games().persist(\u0026game).await {\n                    warn!(\"Removing player has failed\");\n                }\n            }\n        }\n    }\n\n    // remove players\n    if inactive_count \u003e 0 {\n        match ctx.db().players().remove_batch(\u0026inactive_players).await {\n            Ok(_) =\u003e {\n                info!(\"Removed {} inactive players\", inactive_count);\n                true\n            }\n            Err(e) =\u003e {\n                warn!(\n                    \"Removing {} inactive players has failed: {:?}\",\n                    inactive_count, e\n                );\n                false\n            }\n        }\n    } else {\n        debug!(\"Removed no inactive players\");\n        false\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::execute_cleanup_players;\n    use crate::{\n        model::{Game, Player},\n        server::app_context::AppContext,\n    };\n    use chrono::Duration;\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_cleanup_player() {\n        let ctx = init_ctx();\n        let player = Player::new(\"GAME\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Persisting player failed\");\n        let game = Game::new(player.id(), \"GAME\");\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Persisting game failed\");\n\n        let res = execute_cleanup_players(\u0026ctx, Duration::nanoseconds(1)).await;\n        assert!(res);\n\n        assert!(ctx.db().players().get(player.id()).await.unwrap().is_none());\n        assert!(ctx\n            .db()\n            .games()\n            .get(player.game_token())\n            .await\n            .unwrap()\n            .expect(\"Game should still exist\")\n            .admin_id()\n            .is_none());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_player() {\n        let ctx = init_ctx();\n        let player = Player::new(\"GAME\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Persisting player failed\");\n\n        let res = execute_cleanup_players(\u0026ctx, Duration::minutes(1)).await;\n        assert!(!res);\n\n        assert!(ctx.db().players().get(player.id()).await.unwrap().is_some());\n    }\n}\n","traces":[{"line":5,"address":[6677584],"length":1,"stats":{"Line":0},"fn_name":"cleanup_players"},{"line":6,"address":[5996848],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":7,"address":[5996231,5996863,5996682,5996354,5996208],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":8,"address":[5996294,5996383,5996524,5996667,5996459],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[4936512],"length":1,"stats":{"Line":1},"fn_name":"is_inactive_player"},{"line":15,"address":[6677632],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[6677796],"length":1,"stats":{"Line":3},"fn_name":null},{"line":20,"address":[4828670,4828750,4829059,4828453,4828553,4828963,4828860,4828432,4828821],"length":1,"stats":{"Line":6},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":21,"address":[4828533],"length":1,"stats":{"Line":7},"fn_name":null},{"line":24,"address":[6775350],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[6776082,6776149],"length":1,"stats":{"Line":4},"fn_name":null},{"line":30,"address":[6776232,6776315,6779964,6776343,6776273,6776461,6776160],"length":1,"stats":{"Line":11},"fn_name":null},{"line":31,"address":[4828650],"length":1,"stats":{"Line":5},"fn_name":null},{"line":32,"address":[6777611,6777308],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4828801],"length":1,"stats":{"Line":5},"fn_name":null},{"line":34,"address":[6778446,6778749],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[6778895],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[4828906],"length":1,"stats":{"Line":5},"fn_name":null},{"line":37,"address":[6779607,6779661,6779474,6779708,6779805],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[6782113,6779977],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4829008],"length":1,"stats":{"Line":6},"fn_name":null},{"line":46,"address":[6780497],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[6780814,6780725,6780973,6780592,6780767],"length":1,"stats":{"Line":4},"fn_name":null},{"line":48,"address":[6781014],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[6780514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[6781204,6780546,6781481,6781110,6781163,6781234,6781027,6781393],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[6781230],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[6781522],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[6779984,6781715,6781674,6781812,6781637,6781554],"length":1,"stats":{"Line":4},"fn_name":null},{"line":60,"address":[6781819],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6981248],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":74,"address":[6981256],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[5802176,5802362,5802471,5802498,5802329,5802523,5802444,5802197,5802421],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":79,"address":[5549086],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[5549101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[5549441,5549252,5549181,5549135,5549312,5549367,5552436],"length":1,"stats":{"Line":6},"fn_name":null},{"line":83,"address":[5549232],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[5549640,5549683],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[5549960,5550034,5552457,5549905,5549741,5549769,5549845],"length":1,"stats":{"Line":6},"fn_name":null},{"line":89,"address":[5549823],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[5550414,5552478,5550246,5550326,5550304,5550494],"length":1,"stats":{"Line":5},"fn_name":null},{"line":94,"address":[5550657,5550631],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5550952,5550887,5550700,5550729,5550645,5550795,5552499,5551358,5551431],"length":1,"stats":{"Line":6},"fn_name":null},{"line":97,"address":[5551474,5551661,5552185,5552277,5552207,5552520,5551419,5551550,5551569,5552163,5551726],"length":1,"stats":{"Line":8},"fn_name":null},{"line":100,"address":[5551503],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5553632,5553605,5553655,5555491,5553600,5555632],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":110,"address":[5553736],"length":1,"stats":{"Line":1},"fn_name":null},{"line":111,"address":[5553751],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[5554014,5554079,5553785,5553902,5553831,5555575,5553962],"length":1,"stats":{"Line":6},"fn_name":null},{"line":114,"address":[5553882],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[5554331,5555596,5554503,5554438,5554288,5554353],"length":1,"stats":{"Line":5},"fn_name":null},{"line":119,"address":[5554662,5554634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[5554957,5554892,5554734,5554705,5555617,5555363,5554800,5555438,5554650],"length":1,"stats":{"Line":6},"fn_name":null}],"covered":44,"coverable":53},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","mod.rs"],"content":"mod cleanup_games;\nmod cleanup_players;\n\nuse self::cleanup_games::cleanup_games;\nuse self::cleanup_players::cleanup_players;\nuse crate::server::app_context::AppContext;\nuse clokwerk::{Scheduler, TimeUnits};\nuse std::{thread, time::Duration};\n\nconst JOB_INTERVAL: u32 = 60;\n\npub fn init_jobs(ctx: \u0026'static AppContext) {\n    tokio::task::spawn(async move {\n        let mut scheduler = Scheduler::new();\n\n        scheduler\n            .every(JOB_INTERVAL.seconds())\n            .run(cleanup_games(ctx));\n        scheduler\n            .every(JOB_INTERVAL.seconds())\n            .run(cleanup_players(ctx));\n\n        loop {\n            scheduler.run_pending();\n            thread::sleep(Duration::from_millis(100));\n        }\n    });\n}\n","traces":[{"line":12,"address":[5833488],"length":1,"stats":{"Line":0},"fn_name":"init_jobs"},{"line":13,"address":[5833497],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[6452151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[6452191,6452260],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[6452167],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[6452245],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[6452362,6452309],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[6452283],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[6452347],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[6452385,6452455],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[6452389],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[6452415,6452433],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":12},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","lib.rs"],"content":"use jobs::init_jobs;\nuse server::{app_context::AppContext, run_server};\nuse tokio::runtime::Builder;\n\nmod config;\npub mod db;\npub mod jobs;\npub mod model;\npub mod server;\n\nextern crate chrono;\nextern crate envconfig;\nextern crate log;\n\n#[macro_use]\nextern crate derivative;\n\npub fn run_app() {\n    let mut rt = Builder::new()\n        .threaded_scheduler()\n        .enable_all()\n        .thread_name(\"sc\")\n        .build()\n        .expect(\"Creating runtime failed\");\n\n    rt.block_on(async {\n        let ctx: \u0026'static AppContext = Box::leak(Box::new(AppContext::init()));\n\n        init_jobs(ctx);\n\n        run_server(\u0026ctx).await;\n    });\n}\n","traces":[{"line":18,"address":[4498215,4498192],"length":1,"stats":{"Line":0},"fn_name":"run_app"},{"line":19,"address":[4498230,4498199,4498291],"length":1,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[4498424],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[6785006,6784971,6784865],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[6785009],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[4793558],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","model","game.rs"],"content":"use crate::db::Persist;\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sled::IVec;\nuse std::{collections::HashSet, convert::TryFrom};\n\n#[derive(Serialize, Deserialize, Clone, PartialEq, Eq, Debug)]\npub struct Game {\n    token: String,\n    creation_time: DateTime\u003cUtc\u003e,\n    last_action_time: DateTime\u003cUtc\u003e,\n    admin_id: Option\u003cString\u003e,\n    player_ids: HashSet\u003cString\u003e,\n}\n\nimpl Game {\n    pub fn new(admin_id: \u0026str, token: \u0026str) -\u003e Self {\n        Game {\n            token: String::from(token).to_uppercase(),\n            creation_time: Utc::now(),\n            last_action_time: Utc::now(),\n            admin_id: Some(String::from(admin_id)),\n            player_ids: HashSet::new(),\n        }\n    }\n\n    pub fn token(\u0026self) -\u003e \u0026str {\n        \u0026self.token\n    }\n\n    pub fn player_ids(\u0026self) -\u003e \u0026HashSet\u003cString\u003e {\n        \u0026self.player_ids\n    }\n\n    pub fn admin_id(\u0026self) -\u003e \u0026Option\u003cString\u003e {\n        \u0026self.admin_id\n    }\n\n    pub fn last_action_time(\u0026self) -\u003e \u0026DateTime\u003cUtc\u003e {\n        \u0026self.last_action_time\n    }\n\n    pub fn add_player(\u0026mut self, player_id: \u0026str) {\n        match self.admin_id {\n            Some(_) =\u003e {\n                self.player_ids.insert(String::from(player_id));\n            }\n            None =\u003e self.admin_id = Some(String::from(player_id)),\n        }\n    }\n\n    pub fn remove_player(\u0026mut self, player_id: \u0026str) {\n        if self.player_ids.contains(player_id) {\n            self.player_ids.remove(player_id);\n        } else if self\n            .admin_id\n            .to_owned()\n            .filter(|id| id == player_id)\n            .is_some()\n        {\n            if let Some(next_player_id) = self.player_ids.iter().next().map(String::from) {\n                self.admin_id = Some(String::from(\u0026next_player_id));\n                self.player_ids.remove(\u0026next_player_id);\n            } else {\n                // abandon game as admin is the last player\n                self.admin_id = None;\n            }\n        } else {\n            // game is already abandoned or requesting user is no admin or player\n        }\n    }\n\n    pub fn start(\u0026mut self) {}\n}\n\nimpl Persist for Game {\n    fn id(\u0026self) -\u003e \u0026str {\n        self.token()\n    }\n}\n\nimpl Into\u003cIVec\u003e for Game {\n    fn into(self) -\u003e IVec {\n        IVec::from(bincode::serialize(\u0026self).unwrap())\n    }\n}\n\nimpl TryFrom\u003cIVec\u003e for Game {\n    type Error = bincode::Error;\n    fn try_from(bytes: IVec) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let vec: Vec\u003cu8\u003e = bytes.to_vec();\n\n        bincode::deserialize(\u0026vec)\n    }\n}\n","traces":[{"line":17,"address":[6891219,6891136],"length":1,"stats":{"Line":5},"fn_name":"new"},{"line":19,"address":[6013447,6013386],"length":1,"stats":{"Line":10},"fn_name":null},{"line":20,"address":[6013503],"length":1,"stats":{"Line":5},"fn_name":null},{"line":21,"address":[6013618,6013581],"length":1,"stats":{"Line":12},"fn_name":null},{"line":22,"address":[6013688],"length":1,"stats":{"Line":6},"fn_name":null},{"line":23,"address":[6013727],"length":1,"stats":{"Line":6},"fn_name":null},{"line":27,"address":[6014000],"length":1,"stats":{"Line":1},"fn_name":"token"},{"line":28,"address":[6014009],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[6014048],"length":1,"stats":{"Line":1},"fn_name":"player_ids"},{"line":32,"address":[6014053],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[6014080],"length":1,"stats":{"Line":1},"fn_name":"admin_id"},{"line":36,"address":[6014085],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[6014112],"length":1,"stats":{"Line":1},"fn_name":"last_action_time"},{"line":40,"address":[6014117],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[6014144,6014357],"length":1,"stats":{"Line":1},"fn_name":"add_player"},{"line":44,"address":[6014229,6014404,6014281],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[6014169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[6014236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[6014372,6014207,6014283,6014334],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[6014432,6014504],"length":1,"stats":{"Line":1},"fn_name":"remove_player"},{"line":53,"address":[6014523,6014457,6014586,6015010],"length":1,"stats":{"Line":4},"fn_name":null},{"line":54,"address":[6014561],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[6014534,6014673,6015262,6014601],"length":1,"stats":{"Line":4},"fn_name":null},{"line":56,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[6014591],"length":1,"stats":{"Line":3},"fn_name":null},{"line":61,"address":[6015005,6014689,6014818],"length":1,"stats":{"Line":3},"fn_name":null},{"line":62,"address":[6015150,6014871],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[6015225],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[6015020,6014780],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6015440,6015445,6015447],"length":1,"stats":{"Line":0},"fn_name":"start"},{"line":77,"address":[6015456],"length":1,"stats":{"Line":1},"fn_name":"id"},{"line":78,"address":[6015465],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[6015504,6015545],"length":1,"stats":{"Line":6},"fn_name":"into"},{"line":84,"address":[6015598,6015511,6015557],"length":1,"stats":{"Line":18},"fn_name":null},{"line":90,"address":[6015664,6015732],"length":1,"stats":{"Line":3},"fn_name":"try_from"},{"line":91,"address":[6015676],"length":1,"stats":{"Line":3},"fn_name":null},{"line":93,"address":[6015757],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":34,"coverable":37},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","model","player.rs"],"content":"use crate::db::Persist;\nuse chrono::{DateTime, Utc};\nuse names::Generator;\nuse nanoid::nanoid;\nuse serde::{Deserialize, Serialize};\nuse sled::IVec;\nuse std::hash::Hash;\n\nfn generate_random_name() -\u003e String {\n    Generator::default().next().unwrap()\n}\n\n#[derive(Serialize, Deserialize, Clone, Hash, PartialEq, Eq, Derivative)]\n#[derivative(Debug)]\npub struct Player {\n    id: String,\n    name: String,\n    game_token: String,\n    #[derivative(Debug = \"ignore\")]\n    user_token: String,\n    creation_time: DateTime\u003cUtc\u003e,\n    last_action_time: DateTime\u003cUtc\u003e,\n}\n\nimpl Player {\n    pub fn new(game_token: \u0026str) -\u003e Self {\n        Player {\n            id: nanoid!(),\n            name: generate_random_name(),\n            game_token: String::from(game_token),\n            user_token: String::from(\"\"),\n            creation_time: Utc::now(),\n            last_action_time: Utc::now(),\n        }\n    }\n\n    pub fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    pub fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    pub fn set_name(\u0026mut self, name: \u0026str) {\n        if !name.is_empty() {\n            self.name = String::from(name);\n        }\n    }\n\n    pub fn game_token(\u0026self) -\u003e \u0026str {\n        \u0026self.game_token\n    }\n\n    pub fn update_token(\u0026mut self, new_token: \u0026str) {\n        self.user_token = String::from(new_token);\n    }\n\n    pub fn heartbeat(\u0026mut self) {\n        self.last_action_time = Utc::now();\n    }\n\n    pub fn last_action_time(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.last_action_time\n    }\n}\n\nimpl Persist for Player {\n    fn id(\u0026self) -\u003e \u0026str {\n        self.id()\n    }\n}\n\nimpl Into\u003cIVec\u003e for Player {\n    fn into(self) -\u003e IVec {\n        IVec::from(bincode::serialize(\u0026self).unwrap())\n    }\n}\n\nimpl From\u003cIVec\u003e for Player {\n    fn from(bytes: IVec) -\u003e Player {\n        let vec: Vec\u003cu8\u003e = bytes.to_vec();\n        bincode::deserialize(\u0026vec).unwrap()\n    }\n}\n","traces":[{"line":9,"address":[4528496],"length":1,"stats":{"Line":1},"fn_name":"generate_random_name"},{"line":10,"address":[5186151],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[5186333,5186240],"length":1,"stats":{"Line":1},"fn_name":"new"},{"line":28,"address":[5186280],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[5186353],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[5186375],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[5186395],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[5186434,5186473],"length":1,"stats":{"Line":2},"fn_name":null},{"line":33,"address":[4528877,4528919],"length":1,"stats":{"Line":2},"fn_name":null},{"line":37,"address":[4529248],"length":1,"stats":{"Line":2},"fn_name":"id"},{"line":38,"address":[4529257],"length":1,"stats":{"Line":2},"fn_name":null},{"line":41,"address":[5186944],"length":1,"stats":{"Line":2},"fn_name":"name"},{"line":42,"address":[5186953],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[5187124,5186992],"length":1,"stats":{"Line":1},"fn_name":"set_name"},{"line":46,"address":[5187168,5187016],"length":1,"stats":{"Line":2},"fn_name":null},{"line":47,"address":[5187053,5187101,5187136],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[5187184],"length":1,"stats":{"Line":2},"fn_name":"game_token"},{"line":52,"address":[5187193],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[4529584,4529664],"length":1,"stats":{"Line":2},"fn_name":"update_token"},{"line":56,"address":[4529676,4529603],"length":1,"stats":{"Line":4},"fn_name":null},{"line":59,"address":[4529728],"length":1,"stats":{"Line":1},"fn_name":"heartbeat"},{"line":60,"address":[4529737],"length":1,"stats":{"Line":2},"fn_name":null},{"line":63,"address":[4529808],"length":1,"stats":{"Line":1},"fn_name":"last_action_time"},{"line":64,"address":[4529817],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[4529856],"length":1,"stats":{"Line":1},"fn_name":"id"},{"line":70,"address":[4529865],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4529945,4529904],"length":1,"stats":{"Line":1},"fn_name":"into"},{"line":76,"address":[4529911,4529957,4529998],"length":1,"stats":{"Line":3},"fn_name":null},{"line":81,"address":[4530064,4530135],"length":1,"stats":{"Line":1},"fn_name":"from"},{"line":82,"address":[4530079],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[4530228,4530163],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":31,"coverable":31},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","app_context.rs"],"content":"use super::logger::init_logger;\nuse crate::{\n    config::AppConfig,\n    db::{Client, Database},\n    model::{Game, Player},\n};\nuse envconfig::Envconfig;\n\npub struct DbClients {\n    games: Client\u003cGame\u003e,\n    players: Client\u003cPlayer\u003e,\n}\n\nimpl DbClients {\n    pub fn init() -\u003e DbClients {\n        let mut games_repo = Database::init(\"games\");\n        let games_sender = games_repo.sender();\n        tokio::task::spawn(async move {\n            games_repo.start_listening().await;\n        });\n        let mut players_repo = Database::init(\"players\");\n        let players_sender = players_repo.sender();\n        tokio::task::spawn(async move {\n            players_repo.start_listening().await;\n        });\n\n        DbClients {\n            games: Client::new(games_sender),\n            players: Client::new(players_sender),\n        }\n    }\n\n    pub fn games(\u0026self) -\u003e \u0026Client\u003cGame\u003e {\n        \u0026self.games\n    }\n\n    pub fn players(\u0026self) -\u003e \u0026Client\u003cPlayer\u003e {\n        \u0026self.players\n    }\n}\n\npub struct AppContext {\n    db: DbClients,\n    config: AppConfig,\n}\n\nimpl AppContext {\n    pub fn init() -\u003e AppContext {\n        let config = AppConfig::init_from_env().expect(\"Loading server config failed\");\n\n        init_logger(\u0026config);\n\n        let db = DbClients::init();\n\n        AppContext { db, config }\n    }\n\n    pub fn db(\u0026self) -\u003e \u0026DbClients {\n        \u0026self.db\n    }\n\n    pub fn config(\u0026self) -\u003e \u0026AppConfig {\n        \u0026self.config\n    }\n\n    pub fn is_dev(\u0026self) -\u003e bool {\n        cfg!(debug_assertions)\n    }\n}\n","traces":[{"line":15,"address":[4522107,4522016],"length":1,"stats":{"Line":1},"fn_name":"init"},{"line":16,"address":[6347729],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[4522122],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[6347845],"length":1,"stats":{"Line":7},"fn_name":null},{"line":19,"address":[5222854,5222906,5223160,5222801,5222950,5223020],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[6348030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[4522386],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[5794598,5794649,5794527,5794512],"length":1,"stats":{"Line":8},"fn_name":"drop_in_place\u003cgenerator-1\u003e"},{"line":24,"address":[5794582],"length":1,"stats":{"Line":6},"fn_name":null},{"line":28,"address":[6348297],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4522697],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[6348800],"length":1,"stats":{"Line":1},"fn_name":"games"},{"line":34,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[4523168],"length":1,"stats":{"Line":1},"fn_name":"players"},{"line":38,"address":[4523173],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[4523200,4523236],"length":1,"stats":{"Line":1},"fn_name":"init"},{"line":49,"address":[4523210,4523265],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[4523307],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[4523314],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[4523536],"length":1,"stats":{"Line":1},"fn_name":"db"},{"line":59,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[4523552],"length":1,"stats":{"Line":1},"fn_name":"config"},{"line":63,"address":[4523557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[4523584],"length":1,"stats":{"Line":0},"fn_name":"is_dev"}],"covered":21,"coverable":24},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","auth.rs"],"content":"use super::app_context::AppContext;\nuse crate::model::Player;\nuse hmac::{Hmac, NewMac};\nuse jwt::{AlgorithmType, Error, Header, SignWithKey, Token, VerifyWithKey};\nuse sha2::Sha256;\nuse std::collections::BTreeMap;\nuse std::result::Result;\n\npub fn generate_jwt_token(player: \u0026Player, secret: \u0026str) -\u003e String {\n    let key = init_key(secret);\n    let header = Header {\n        algorithm: AlgorithmType::Hs256,\n        ..Default::default()\n    };\n    let mut claims = BTreeMap::new();\n    claims.insert(String::from(\"sub\"), String::from(player.id()));\n    claims.insert(String::from(\"name\"), String::from(player.name()));\n    claims.insert(String::from(\"game\"), String::from(player.game_token()));\n\n    let jwt_token = Token::new(header, claims).sign_with_key(\u0026key).unwrap();\n\n    String::from(jwt_token.as_str())\n}\n\npub fn extract_verified_token(\n    token_str: \u0026str,\n    secret: \u0026str,\n) -\u003e Result\u003cToken\u003cHeader, BTreeMap\u003cString, String\u003e, jwt::token::Verified\u003e, Error\u003e {\n    let key = init_key(secret);\n    let raw_token: \u0026str = \u0026token_str.replace(\"Bearer \", \"\");\n    let token: Result\u003cToken\u003cHeader, BTreeMap\u003cString, String\u003e, jwt::token::Verified\u003e, Error\u003e =\n        VerifyWithKey::verify_with_key(raw_token, \u0026key);\n\n    token\n}\n\npub fn extract_verified_id(authorization: \u0026str, ctx: \u0026AppContext) -\u003e Option\u003cString\u003e {\n    extract_verified_token(\u0026authorization, \u0026ctx.config().auth_secret)\n        .ok()\n        .and_then(|token| token.claims().get(\"sub\").map(String::from))\n}\n\nfn init_key(secret: \u0026str) -\u003e Hmac\u003cSha256\u003e {\n    Hmac::new_varkey(secret.as_bytes()).unwrap()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{extract_verified_id, extract_verified_token, generate_jwt_token};\n    use crate::{model::Player, server::app_context::AppContext};\n\n    const SECRET: \u0026str = \"super-secret\";\n\n    #[test]\n    fn should_create_token() {\n        let player = Player::new(\"game\");\n        let token = generate_jwt_token(\u0026player, SECRET);\n\n        // payload contains dynamic ID of user, so we can't check the payload for equalness\n        assert!(token.starts_with(\"eyJhbGciOiJIUzI1NiJ9\"));\n    }\n\n    #[test]\n    fn should_verify_token() {\n        let token = extract_verified_token(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX4\", \"super-secret\");\n\n        assert_eq!(token.unwrap().claims().get(\"name\").unwrap(), \"Random Dude\");\n    }\n\n    #[tokio::test]\n    async fn should_extract_verified_id() {\n        let ctx = AppContext::init();\n        let id = extract_verified_id(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX4\", \u0026ctx);\n\n        assert_eq!(id.unwrap(), \"MllJ7oeCY4RGw2M6tIHBZ\");\n    }\n\n    #[tokio::test]\n    async fn should_not_extract_unverified_id() {\n        let ctx = AppContext::init();\n        let id = extract_verified_id(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX3\", \u0026ctx);\n\n        assert!(id.is_none());\n    }\n\n    #[test]\n    fn should_create_and_verify_token() {\n        let player = Player::new(\"game\");\n        let token_str = generate_jwt_token(\u0026player, SECRET);\n        let token = extract_verified_token(\u0026token_str, SECRET);\n        assert!(!token.unwrap().claims().get(\"name\").unwrap().is_empty());\n    }\n\n    #[test]\n    fn should_fail_to_verify_token() {\n        let token = extract_verified_token(\"eyJhbGciOiJIUzI1NiJ9.XYZ.ABC\", \"super-secret\");\n\n        assert!(token.is_err());\n    }\n}\n","traces":[{"line":9,"address":[6592670,6592560],"length":1,"stats":{"Line":1},"fn_name":"generate_jwt_token"},{"line":10,"address":[6592594],"length":1,"stats":{"Line":1},"fn_name":null},{"line":15,"address":[6592788],"length":1,"stats":{"Line":2},"fn_name":null},{"line":16,"address":[4396246,4397065],"length":1,"stats":{"Line":2},"fn_name":null},{"line":17,"address":[4396410,4397101],"length":1,"stats":{"Line":2},"fn_name":null},{"line":18,"address":[6593763,6593162],"length":1,"stats":{"Line":2},"fn_name":null},{"line":20,"address":[6593326],"length":1,"stats":{"Line":2},"fn_name":null},{"line":22,"address":[6593507],"length":1,"stats":{"Line":2},"fn_name":null},{"line":25,"address":[6594003,6593920],"length":1,"stats":{"Line":1},"fn_name":"extract_verified_token"},{"line":29,"address":[6593962],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[6594029],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[6594136],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[6594256],"length":1,"stats":{"Line":1},"fn_name":"extract_verified_id"},{"line":38,"address":[6594284],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[6677936,6677943],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":43,"address":[6594448],"length":1,"stats":{"Line":2},"fn_name":"init_key"},{"line":44,"address":[6594541],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[6092498,6092464],"length":1,"stats":{"Line":3},"fn_name":"should_create_token"},{"line":56,"address":[6092478],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[6092513],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[6092664,6092639,6092582,6092553],"length":1,"stats":{"Line":3},"fn_name":null},{"line":64,"address":[6092768,6092818],"length":1,"stats":{"Line":3},"fn_name":"should_verify_token"},{"line":65,"address":[6092789],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[6092840],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[6093488,6093495],"length":1,"stats":{"Line":7},"fn_name":"should_extract_verified_id"},{"line":72,"address":[6782116],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6782123],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[6782334,6782155,6782242,6782360,6782679,6782590],"length":1,"stats":{"Line":4},"fn_name":null},{"line":78,"address":[6093808,6093815],"length":1,"stats":{"Line":7},"fn_name":"should_not_extract_unverified_id"},{"line":80,"address":[6783156],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[6783163],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[6783226,6783197,6783267],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[6094162,6094128],"length":1,"stats":{"Line":3},"fn_name":"should_create_and_verify_token"},{"line":88,"address":[6094142],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[6094177],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[6094217,6094246],"length":1,"stats":{"Line":2},"fn_name":null},{"line":91,"address":[6094300,6094553],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[6094716,6094672],"length":1,"stats":{"Line":3},"fn_name":"should_fail_to_verify_token"},{"line":96,"address":[6094690],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[6094780,6094733],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":40,"coverable":40},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","endpoints","games.rs"],"content":"use crate::{\n    model::{Game, Player},\n    server::{\n        app_context::AppContext, auth::extract_verified_id, auth::generate_jwt_token,\n        errors::reply_with_error,\n    },\n};\nuse log::debug;\nuse rand::{distributions::Alphanumeric, thread_rng, Rng};\nuse serde::Serialize;\nuse std::{convert::Infallible, iter};\nuse warp::hyper::StatusCode;\n\n// this value determines the findability of a game and is a tradeoff between security and user friendliness\n// 5 tokens mean a chance of finding a random game of 1:60466176.\nconst TOKEN_CHARS_COUNT: usize = 5;\n\npub async fn get_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match extract_verified_id(authorization, ctx) {\n        Some(token) =\u003e match ctx\n            .db()\n            .games()\n            .get(game_token)\n            .await\n            .expect(\"Reading game has failed\")\n        {\n            Some(game) =\u003e {\n                match ctx\n                    .db()\n                    .players()\n                    .get(\u0026token)\n                    .await\n                    .expect(\"Reading player has failed\")\n                    .filter(|player| {\n                        game.player_ids().contains(player.id())\n                            || game.admin_id().is_some()\n                                \u0026\u0026 game.admin_id().as_ref().unwrap() == player.id()\n                    }) {\n                    Some(mut player) =\u003e {\n                        player.heartbeat();\n                        ctx.db()\n                            .players()\n                            .persist(\u0026player)\n                            .await\n                            .expect(\"Persisting heartbeat has failed\");\n                        Ok(warp::reply::with_status(\n                            warp::reply::json(\u0026game),\n                            StatusCode::OK,\n                        ))\n                    }\n                    None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n                }\n            }\n            None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n        },\n        None =\u003e Ok(reply_with_error(StatusCode::UNAUTHORIZED)),\n    }\n}\n\npub async fn get_games_count_filter(ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    #[derive(Serialize)]\n    struct GetGamesResponse {\n        total: usize,\n    };\n\n    let total = ctx\n        .db()\n        .games()\n        .total_count()\n        .await\n        .expect(\"Reading games count has failed\");\n\n    Ok(warp::reply::with_status(\n        warp::reply::json(\u0026GetGamesResponse { total }),\n        StatusCode::OK,\n    ))\n}\n\npub async fn create_game_filter(ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    fn generate_game_token() -\u003e String {\n        let mut rng = thread_rng();\n\n        String::from_utf8(\n            iter::repeat(())\n                .map(|()| rng.sample(Alphanumeric).to_ascii_uppercase())\n                .take(TOKEN_CHARS_COUNT)\n                .collect(),\n        )\n        .unwrap()\n    }\n\n    let game_token = generate_game_token();\n    let player = create_new_player(\u0026game_token, ctx).await;\n    let new_game = create_new_game(player.id(), \u0026game_token, ctx).await;\n\n    #[derive(Serialize)]\n    struct CreateGameReponse {\n        game: Game,\n        admin: Player,\n    };\n\n    Ok(warp::reply::with_status(\n        warp::reply::json(\u0026CreateGameReponse {\n            game: new_game,\n            admin: player,\n        }),\n        StatusCode::CREATED,\n    ))\n}\n\npub async fn attend_game_filter(\n    game_token: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e {\n            let player = create_new_player(\u0026game_token, ctx).await;\n\n            game.add_player(player.id());\n            match ctx.db().games().persist(\u0026game).await {\n                Ok(_) =\u003e Ok(warp::reply::with_status(\n                    warp::reply::json(\u0026player),\n                    StatusCode::OK,\n                )),\n                Err(_) =\u003e Ok(reply_with_error(StatusCode::INTERNAL_SERVER_ERROR)),\n            }\n        }\n        None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n    }\n}\n\npub async fn leave_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e match extract_verified_id(authorization, ctx) {\n            Some(player_id) =\u003e {\n                game.remove_player(\u0026player_id);\n                match ctx.db().games().persist(\u0026game).await {\n                    Ok(_) =\u003e Ok(reply_with_error(StatusCode::OK)),\n                    Err(_) =\u003e Ok(reply_with_error(StatusCode::INTERNAL_SERVER_ERROR)),\n                }\n            }\n            None =\u003e Ok(reply_with_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n    }\n}\n\nasync fn create_new_game(admin_id: \u0026str, token: \u0026str, ctx: \u0026AppContext) -\u003e Game {\n    let new_game = Game::new(admin_id, token);\n    let new_token = new_game.token();\n    ctx.db()\n        .games()\n        .persist(\u0026new_game)\n        .await\n        .expect(\"Creating game failed\");\n    debug!(\"Created game with token {}\", new_token);\n\n    new_game\n}\n\nasync fn create_new_player(game_token: \u0026str, ctx: \u0026AppContext) -\u003e Player {\n    let mut player = Player::new(game_token);\n    let user_token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n    player.update_token(\u0026user_token);\n\n    ctx.db()\n        .players()\n        .persist(\u0026player)\n        .await\n        .expect(\"Creating player failed\");\n    debug!(\"Created player with token {}\", player.id());\n\n    player\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{attend_game_filter, create_game_filter, get_game_filter, leave_game_filter};\n    use crate::{\n        model::{Game, Player},\n        server::{app_context::AppContext, auth::generate_jwt_token},\n    };\n    use warp::{hyper::StatusCode, Reply};\n\n    const GAME_TOKEN: \u0026str = \"ACDEF\";\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_not_get_game_unauthorized() {\n        let ctx = init_ctx();\n\n        let reply = get_game_filter(\"invalid\", \"auth\", \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n    }\n\n    #[tokio::test]\n    async fn should_not_get_unknown_game() {\n        let ctx = init_ctx();\n\n        let token = generate_jwt_token(\u0026Player::new(\"game\"), \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(\"game\", \u0026token, \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_get_game_for_admin() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        ctx.db()\n            .players()\n            .persist(\u0026admin)\n            .await\n            .expect(\"Writing player failed\");\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(admin.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_get_game_for_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(GAME_TOKEN);\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let mut game = Game::new(\"admin\", GAME_TOKEN);\n        game.add_player(player.id());\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_get_game_and_send_heartbeat() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n        let first_time = admin.last_action_time();\n        ctx.db()\n            .players()\n            .persist(\u0026admin)\n            .await\n            .expect(\"Writing admin failed\");\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(admin.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_admin = ctx\n            .db()\n            .players()\n            .get(admin.id())\n            .await\n            .expect(\"Reading admin failed\");\n        assert!(updated_admin.unwrap().last_action_time().gt(\u0026first_time));\n    }\n\n    #[tokio::test]\n    async fn should_create_new_game() {\n        let ctx = init_ctx();\n\n        let reply = create_game_filter(\u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::CREATED);\n    }\n\n    #[tokio::test]\n    async fn should_not_attend_unknown_game() {\n        let ctx = init_ctx();\n\n        let reply = attend_game_filter(\"test\", \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_attend_game() {\n        let ctx = init_ctx();\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(\"admin\", GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = attend_game_filter(GAME_TOKEN, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_leave_game() {\n        let ctx = init_ctx();\n\n        let mut game = Game::new(\"admin\", GAME_TOKEN);\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n        game.add_player(player.id());\n\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n        assert!(game.player_ids().contains(player.id()));\n\n        let reply = leave_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\");\n        assert!(!updated_game.unwrap().player_ids().contains(player.id()));\n    }\n\n    #[tokio::test]\n    async fn should_leave_game_and_select_new_admin() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        let mut game = Game::new(admin.id(), GAME_TOKEN);\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n        game.add_player(player.id());\n\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n\n        assert_eq!(game.admin_id().as_ref().unwrap(), admin.id());\n\n        let reply = leave_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\")\n            .unwrap();\n        assert!(updated_game.player_ids().is_empty());\n        assert_eq!(updated_game.admin_id().as_ref().unwrap(), player.id());\n    }\n}\n","traces":[{"line":18,"address":[4759792],"length":1,"stats":{"Line":1},"fn_name":"get_game_filter"},{"line":23,"address":[5197139,5197296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[5200227,5197538,5198106,5197306,5197486,5197608,5197216,5197396],"length":1,"stats":{"Line":6},"fn_name":null},{"line":31,"address":[5198116,5198048],"length":1,"stats":{"Line":2},"fn_name":null},{"line":32,"address":[5198463,5199073,5198327,5198964,5198373,5198222,5200248,5198533],"length":1,"stats":{"Line":6},"fn_name":null},{"line":35,"address":[5198303],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[5196624,5198942],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":39,"address":[5196644,5196730,5196816],"length":1,"stats":{"Line":3},"fn_name":null},{"line":40,"address":[5196837,5196947,5196960,5196692,5196781],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":41,"address":[5196800,5196862],"length":1,"stats":{"Line":2},"fn_name":null},{"line":43,"address":[5199015,5199083],"length":1,"stats":{"Line":2},"fn_name":null},{"line":44,"address":[5199209],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4825159],"length":1,"stats":{"Line":10},"fn_name":null},{"line":47,"address":[5199314],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[5199798,5199759],"length":1,"stats":{"Line":3},"fn_name":null},{"line":51,"address":[5199726],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[5199863,5199046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[5198079,5199937],"length":1,"stats":{"Line":2},"fn_name":null},{"line":60,"address":[5197269,5200008],"length":1,"stats":{"Line":2},"fn_name":null},{"line":64,"address":[5201180,5201050,5201024,5201823],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":70,"address":[5201314,5201808,5201135,5201384,5201210],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[5201657,5201618],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[5201578],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[4759968,4759986],"length":1,"stats":{"Line":6},"fn_name":"create_game_filter"},{"line":84,"address":[4760065,4760032],"length":1,"stats":{"Line":1},"fn_name":"generate_game_token"},{"line":85,"address":[4760052],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4760104,4760141,4760080],"length":1,"stats":{"Line":3},"fn_name":null},{"line":89,"address":[4760096],"length":1,"stats":{"Line":3},"fn_name":null},{"line":96,"address":[5202202],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[4810417],"length":1,"stats":{"Line":5},"fn_name":null},{"line":98,"address":[4810501],"length":1,"stats":{"Line":6},"fn_name":null},{"line":106,"address":[5204107],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[5203776],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5203538],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[5203674],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[4760288],"length":1,"stats":{"Line":1},"fn_name":"attend_game_filter"},{"line":119,"address":[4837819],"length":1,"stats":{"Line":5},"fn_name":null},{"line":122,"address":[5205068],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[5205729,5205797],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[4837891],"length":1,"stats":{"Line":4},"fn_name":null},{"line":129,"address":[5206489],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[4837977],"length":1,"stats":{"Line":6},"fn_name":null},{"line":131,"address":[5207180,5207098,5207260],"length":1,"stats":{"Line":3},"fn_name":null},{"line":132,"address":[5207152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[5207115,5207328],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[5205760,5207474],"length":1,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[4760384],"length":1,"stats":{"Line":1},"fn_name":"leave_game_filter"},{"line":147,"address":[4801626],"length":1,"stats":{"Line":5},"fn_name":null},{"line":150,"address":[5208538],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[5209191,5209259,5209493],"length":1,"stats":{"Line":2},"fn_name":null},{"line":155,"address":[5209412,5209503],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[5209545],"length":1,"stats":{"Line":1},"fn_name":null},{"line":157,"address":[4801724],"length":1,"stats":{"Line":6},"fn_name":null},{"line":158,"address":[5210102,5210059],"length":1,"stats":{"Line":2},"fn_name":null},{"line":159,"address":[5210076,5210213],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[5210331,5209466],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[5209222,5210402],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[4760496,4760546],"length":1,"stats":{"Line":6},"fn_name":"create_new_game"},{"line":169,"address":[5211351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":170,"address":[5211421,5211511],"length":1,"stats":{"Line":2},"fn_name":null},{"line":171,"address":[4817932],"length":1,"stats":{"Line":6},"fn_name":null},{"line":173,"address":[5211607],"length":1,"stats":{"Line":1},"fn_name":null},{"line":176,"address":[5212378,5212138,5212213,5212055,5212012,5212172],"length":1,"stats":{"Line":4},"fn_name":null},{"line":178,"address":[5212427],"length":1,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[4760642,4760608],"length":1,"stats":{"Line":8},"fn_name":"create_new_player"},{"line":182,"address":[5213078],"length":1,"stats":{"Line":2},"fn_name":null},{"line":183,"address":[5213233,5213317,5213139],"length":1,"stats":{"Line":6},"fn_name":null},{"line":184,"address":[5213389],"length":1,"stats":{"Line":2},"fn_name":null},{"line":186,"address":[4785155],"length":1,"stats":{"Line":9},"fn_name":null},{"line":188,"address":[5213560],"length":1,"stats":{"Line":2},"fn_name":null},{"line":191,"address":[5214333,5214091,5214401,5214166,5214125,5213965,5214008],"length":1,"stats":{"Line":7},"fn_name":null},{"line":193,"address":[5214450],"length":1,"stats":{"Line":2},"fn_name":null},{"line":207,"address":[7074992],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":208,"address":[7075000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":211,"address":[5674624,5674629,5674656,5674679,5675761,5675857],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":213,"address":[5674748],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[5674988,5675842,5674755,5674876,5674923],"length":1,"stats":{"Line":3},"fn_name":null},{"line":217,"address":[5675717,5675407,5675306,5675267,5675628],"length":1,"stats":{"Line":2},"fn_name":null},{"line":218,"address":[5675241,5675145,5675290,5675228],"length":1,"stats":{"Line":4},"fn_name":null},{"line":223,"address":[5676224,5676229,5676279,5677632,5676256,5677731],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":225,"address":[5676360],"length":1,"stats":{"Line":1},"fn_name":null},{"line":227,"address":[5676367,5676448,5676480,5676507],"length":1,"stats":{"Line":3},"fn_name":null},{"line":229,"address":[5676598,5677716,5676833,5676768,5676679,5676721],"length":1,"stats":{"Line":5},"fn_name":null},{"line":231,"address":[5677112,5677151,5677252,5677473,5677562],"length":1,"stats":{"Line":2},"fn_name":null},{"line":232,"address":[5677073,5676990,5677135,5677086],"length":1,"stats":{"Line":4},"fn_name":null},{"line":237,"address":[5680921,5678272,5678245,5678240,5680780,5678295],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":239,"address":[5678376],"length":1,"stats":{"Line":1},"fn_name":null},{"line":241,"address":[5678391],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[5678542,5680864,5678657,5678471,5678602,5678731,5678425],"length":1,"stats":{"Line":6},"fn_name":null},{"line":244,"address":[5678522],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[5679106,5679200,5679324,5679250,5678958,5680885,5679129,5678930],"length":1,"stats":{"Line":7},"fn_name":null},{"line":249,"address":[5678988,5679084],"length":1,"stats":{"Line":2},"fn_name":null},{"line":253,"address":[5679552,5679642],"length":1,"stats":{"Line":2},"fn_name":null},{"line":255,"address":[5679955,5680906,5679890,5679843,5679801,5679690],"length":1,"stats":{"Line":5},"fn_name":null},{"line":257,"address":[5680197,5680236,5680597,5680210,5680259,5680114,5680376,5680686],"length":1,"stats":{"Line":5},"fn_name":null},{"line":260,"address":[5681744,5681799,5684486,5681776,5684345,5681749],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":262,"address":[5681880],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[5681895],"length":1,"stats":{"Line":1},"fn_name":null},{"line":265,"address":[5682161,5682046,5682106,5682235,5681929,5681975,5684429],"length":1,"stats":{"Line":6},"fn_name":null},{"line":267,"address":[5682026],"length":1,"stats":{"Line":1},"fn_name":null},{"line":270,"address":[5682434],"length":1,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[5682498,5682579],"length":1,"stats":{"Line":2},"fn_name":null},{"line":272,"address":[5682815,5682760,5682697,5682625,5682889,5684450],"length":1,"stats":{"Line":5},"fn_name":null},{"line":274,"address":[5682675],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[5683183,5683088,5683136],"length":1,"stats":{"Line":3},"fn_name":null},{"line":280,"address":[5683342,5683431,5683496,5684471,5683231,5683384],"length":1,"stats":{"Line":5},"fn_name":null},{"line":282,"address":[5684138,5684227,5683800,5683777,5683655,5683738,5683751,5683917],"length":1,"stats":{"Line":5},"fn_name":null},{"line":285,"address":[5685376,5689126,5685344,5685349,5685405,5689288],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":287,"address":[5685486],"length":1,"stats":{"Line":1},"fn_name":null},{"line":289,"address":[5685501],"length":1,"stats":{"Line":1},"fn_name":null},{"line":290,"address":[5685601,5685669,5685535],"length":1,"stats":{"Line":3},"fn_name":null},{"line":291,"address":[5685717],"length":1,"stats":{"Line":1},"fn_name":null},{"line":292,"address":[5685893,5686003,5686058,5685840,5686132,5689210,5685940],"length":1,"stats":{"Line":6},"fn_name":null},{"line":294,"address":[5685920],"length":1,"stats":{"Line":1},"fn_name":null},{"line":298,"address":[5689231,5686530,5686331,5686651,5686507,5686601,5686725,5686359],"length":1,"stats":{"Line":7},"fn_name":null},{"line":300,"address":[5686389,5686485],"length":1,"stats":{"Line":2},"fn_name":null},{"line":304,"address":[5687217,5686953,5689252,5687051,5687093,5687143],"length":1,"stats":{"Line":5},"fn_name":null},{"line":306,"address":[5687980,5687890,5687376,5687472,5687501,5687527,5687656,5687459],"length":1,"stats":{"Line":5},"fn_name":null},{"line":308,"address":[5689273,5688110,5688017,5688129,5688219,5688284],"length":1,"stats":{"Line":5},"fn_name":null},{"line":311,"address":[5688063],"length":1,"stats":{"Line":1},"fn_name":null},{"line":314,"address":[5688849,5689051,5688678,5688875,5688897,5689017],"length":1,"stats":{"Line":4},"fn_name":null},{"line":317,"address":[5691528,5690416,5691624,5690471,5690421,5690448],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":319,"address":[5690540],"length":1,"stats":{"Line":1},"fn_name":null},{"line":321,"address":[5690563,5690690,5690643,5691609,5690755],"length":1,"stats":{"Line":4},"fn_name":null},{"line":323,"address":[5691484,5691034,5691057,5690912,5690995,5691395,5691174,5691008],"length":1,"stats":{"Line":5},"fn_name":null},{"line":326,"address":[5693204,5693108,5692039,5691984,5692016,5691989],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":328,"address":[5692108],"length":1,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[5692223,5692270,5692115,5693189,5692335],"length":1,"stats":{"Line":4},"fn_name":null},{"line":332,"address":[5692614,5692975,5693064,5692754,5692653],"length":1,"stats":{"Line":2},"fn_name":null},{"line":333,"address":[5692588,5692492,5692637,5692575],"length":1,"stats":{"Line":4},"fn_name":null},{"line":338,"address":[5693600,5693623,5693573,5693568,5695262,5695376],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":340,"address":[5693701],"length":1,"stats":{"Line":1},"fn_name":null},{"line":342,"address":[5693884,5695340,5693864,5693955,5693716,5694005,5694073],"length":1,"stats":{"Line":6},"fn_name":null},{"line":344,"address":[5693787],"length":1,"stats":{"Line":1},"fn_name":null},{"line":348,"address":[5694288,5694378,5694490,5695361,5694425],"length":1,"stats":{"Line":4},"fn_name":null},{"line":350,"address":[5694906,5694644,5694766,5694740,5694789,5694727,5695128,5695218],"length":1,"stats":{"Line":5},"fn_name":null},{"line":353,"address":[5695975,5699256,5699397,5695952,5695925,5695920],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":355,"address":[5696056],"length":1,"stats":{"Line":1},"fn_name":null},{"line":357,"address":[5696071],"length":1,"stats":{"Line":1},"fn_name":null},{"line":358,"address":[5696128],"length":1,"stats":{"Line":1},"fn_name":null},{"line":359,"address":[5696258,5696326,5696187],"length":1,"stats":{"Line":3},"fn_name":null},{"line":360,"address":[5696374],"length":1,"stats":{"Line":1},"fn_name":null},{"line":362,"address":[5696760,5699340,5696498,5696568,5696631,5696686],"length":1,"stats":{"Line":5},"fn_name":null},{"line":364,"address":[5696548],"length":1,"stats":{"Line":1},"fn_name":null},{"line":367,"address":[5697082,5697128,5697057,5696959,5696994],"length":1,"stats":{"Line":4},"fn_name":null},{"line":369,"address":[5697274,5697324,5697096,5699361,5697398,5697166,5697232],"length":1,"stats":{"Line":6},"fn_name":null},{"line":370,"address":[5697837,5697682,5697557,5697708,5697653,5697640,5698065,5698155],"length":1,"stats":{"Line":5},"fn_name":null},{"line":372,"address":[5698364,5698192,5698230,5699382,5698312,5698429],"length":1,"stats":{"Line":5},"fn_name":null},{"line":378,"address":[5699112,5698823,5698994,5699015,5699157,5699040],"length":1,"stats":{"Line":4},"fn_name":null},{"line":381,"address":[5700469,5705123,5700496,5700464,5704982,5700525],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":383,"address":[5700606],"length":1,"stats":{"Line":1},"fn_name":null},{"line":385,"address":[5700621],"length":1,"stats":{"Line":1},"fn_name":null},{"line":386,"address":[5700655,5700716],"length":1,"stats":{"Line":2},"fn_name":null},{"line":387,"address":[5700795],"length":1,"stats":{"Line":1},"fn_name":null},{"line":388,"address":[5700973,5700833,5700905],"length":1,"stats":{"Line":3},"fn_name":null},{"line":389,"address":[5701021],"length":1,"stats":{"Line":1},"fn_name":null},{"line":391,"address":[5701147,5701219,5701282,5701337,5705066,5701411],"length":1,"stats":{"Line":5},"fn_name":null},{"line":393,"address":[5701197],"length":1,"stats":{"Line":1},"fn_name":null},{"line":397,"address":[5701675,5701986,5702326,5701610,5701923,5701639,5702227],"length":1,"stats":{"Line":4},"fn_name":null},{"line":399,"address":[5702463,5702587,5705087,5702513,5701943,5702355,5702421],"length":1,"stats":{"Line":6},"fn_name":null},{"line":401,"address":[5702897,5702842,5702746,5702829,5703026,5703392,5702871,5703293],"length":1,"stats":{"Line":5},"fn_name":null},{"line":403,"address":[5703690,5703561,5705108,5703429,5703616,5703476],"length":1,"stats":{"Line":5},"fn_name":null},{"line":410,"address":[5704230,5704131,5704201,5704174],"length":1,"stats":{"Line":3},"fn_name":null},{"line":411,"address":[5704750,5704840,5704551,5704516,5704215,5704265,5704301],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":155,"coverable":164},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","endpoints","players.rs"],"content":"use crate::server::{app_context::AppContext, auth::extract_verified_id, errors::reply_with_error};\nuse serde::{Deserialize, Serialize};\nuse std::convert::Infallible;\nuse warp::hyper::StatusCode;\n\npub async fn get_player_filter(id: \u0026str, ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    #[derive(Serialize)]\n    struct GetPlayerResponse {\n        id: String,\n        name: String,\n    }\n\n    match ctx\n        .db()\n        .players()\n        .get(\u0026id)\n        .await\n        .expect(\"Reading player has failed\")\n    {\n        Some(player) =\u003e Ok(warp::reply::with_status(\n            warp::reply::json(\u0026GetPlayerResponse {\n                id: String::from(player.id()),\n                name: String::from(player.name()),\n            }),\n            StatusCode::OK,\n        )),\n        None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n    }\n}\n\n#[derive(Deserialize)]\npub struct EditPlayerInput {\n    name: String,\n}\n\npub async fn edit_player_filter(\n    id: \u0026str,\n    input: \u0026EditPlayerInput,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match extract_verified_id(authorization, ctx).filter(|token_id| token_id == id) {\n        Some(player_id) =\u003e match ctx\n            .db()\n            .players()\n            .get(\u0026player_id)\n            .await\n            .expect(\"Reading player has failed\")\n        {\n            Some(mut player) =\u003e {\n                player.set_name(\u0026input.name);\n                ctx.db()\n                    .players()\n                    .persist(\u0026player)\n                    .await\n                    .expect(\"editing player failed\");\n                Ok(warp::reply::with_status(\n                    warp::reply::json(\u0026player),\n                    StatusCode::OK,\n                ))\n            }\n            None =\u003e Ok(reply_with_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_with_error(StatusCode::UNAUTHORIZED)),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{edit_player_filter, get_player_filter, EditPlayerInput};\n    use crate::{\n        model::Player,\n        server::{app_context::AppContext, auth::generate_jwt_token},\n    };\n    use warp::{hyper::StatusCode, Reply};\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_not_get_unknown_player() {\n        let ctx = init_ctx();\n\n        let reply = get_player_filter(\"unknown\", \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_get_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        let player_id = String::from(player.id());\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n\n        let reply = get_player_filter(\u0026player_id, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_edit_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        let player_id = String::from(player.id());\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = edit_player_filter(\n            \u0026player_id,\n            \u0026EditPlayerInput {\n                name: String::from(\"new name\"),\n            },\n            \u0026token,\n            \u0026ctx,\n        )\n        .await;\n\n        let updated_player = ctx\n            .db()\n            .players()\n            .get(player.id())\n            .await\n            .expect(\"Reading player failed\");\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n        assert_eq!(updated_player.unwrap().name(), \"new name\");\n    }\n\n    #[tokio::test]\n    async fn should_not_edit_other_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = edit_player_filter(\n            \"other\",\n            \u0026EditPlayerInput {\n                name: String::from(\"new name\"),\n            },\n            \u0026token,\n            \u0026ctx,\n        )\n        .await;\n\n        let updated_player = ctx\n            .db()\n            .players()\n            .get(player.id())\n            .await\n            .expect(\"Reading player failed\");\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n        assert_eq!(updated_player.unwrap().name(), player.name());\n    }\n}\n","traces":[{"line":6,"address":[6639978,6640116,6639952,6641403],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}"},{"line":13,"address":[6640333,6641388,6640219,6641233,6640268,6640079,6640764,6640168],"length":1,"stats":{"Line":7},"fn_name":null},{"line":16,"address":[6640147],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[6640709,6641162,6640766],"length":1,"stats":{"Line":3},"fn_name":null},{"line":21,"address":[6641032],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[5324342],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[5324423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[5324717,5324188],"length":1,"stats":{"Line":2},"fn_name":null},{"line":36,"address":[5815232],"length":1,"stats":{"Line":1},"fn_name":"edit_player_filter"},{"line":42,"address":[5325310,5325751,5325296,5325539],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":43,"address":[5325699,5326015,5325761,5325925,5325879,5327680,5326085,5326588],"length":1,"stats":{"Line":6},"fn_name":null},{"line":46,"address":[5325855],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[6642952,6643019],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[5326724],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[5327075,5327701,5326816,5326875,5326955,5327007],"length":1,"stats":{"Line":5},"fn_name":null},{"line":54,"address":[5326869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[5327314,5327353],"length":1,"stats":{"Line":2},"fn_name":null},{"line":58,"address":[5327281],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[5326561,5327418],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[5325724,5327489],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[4590992],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":78,"address":[4591000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[6034183,6035348,6034128,6034160,6035252,6034133],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":83,"address":[6034252],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[6034414,6034259,6034367,6035333,6034479],"length":1,"stats":{"Line":4},"fn_name":null},{"line":87,"address":[6034758,6034797,6035119,6034898,6035208],"length":1,"stats":{"Line":2},"fn_name":null},{"line":88,"address":[6034719,6034732,6034781,6034636],"length":1,"stats":{"Line":4},"fn_name":null},{"line":93,"address":[5733802,5733711,5733769,5733536,5733551],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":95,"address":[6035848],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[6035863],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[6035897,6035958],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[5733695],"length":1,"stats":{"Line":5},"fn_name":null},{"line":101,"address":[6036101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[5733786],"length":1,"stats":{"Line":6},"fn_name":null},{"line":107,"address":[6036997,6037473,6037046,6037384,6037023,6036901,6036984,6037163],"length":1,"stats":{"Line":5},"fn_name":null},{"line":110,"address":[4591632,4591639],"length":1,"stats":{"Line":9},"fn_name":"should_edit_player"},{"line":112,"address":[6038454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[6038495],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[6038590,6038529],"length":1,"stats":{"Line":2},"fn_name":null},{"line":116,"address":[6038942,6038753,6038658,6042419,6038813,6038868],"length":1,"stats":{"Line":5},"fn_name":null},{"line":118,"address":[6038733],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[6039189,6039141,6039236],"length":1,"stats":{"Line":3},"fn_name":null},{"line":123,"address":[5831046],"length":1,"stats":{"Line":5},"fn_name":null},{"line":124,"address":[6039284],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[6039430],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[6039332],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[6039474],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[5831025,5831067],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[5831183],"length":1,"stats":{"Line":5},"fn_name":null},{"line":136,"address":[6040095],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[6040912,6040753,6040938,6040870,6041067,6041331,6040883,6041427],"length":1,"stats":{"Line":5},"fn_name":null},{"line":141,"address":[6042138,6041679,6042048,6041657,6041829,6041456],"length":1,"stats":{"Line":3},"fn_name":null},{"line":144,"address":[4591943,4591936],"length":1,"stats":{"Line":9},"fn_name":"should_not_edit_other_player"},{"line":146,"address":[6043670],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[6043711],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[5824295],"length":1,"stats":{"Line":6},"fn_name":null},{"line":151,"address":[6043842],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[6044345,6044250,6044298],"length":1,"stats":{"Line":3},"fn_name":null},{"line":156,"address":[5824421],"length":1,"stats":{"Line":4},"fn_name":null},{"line":158,"address":[6044420],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[6044385],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[6044464],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[5824442,5824400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[5824558],"length":1,"stats":{"Line":5},"fn_name":null},{"line":169,"address":[6045126],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[6045943,6045985,6046365,6046098,6046464],"length":1,"stats":{"Line":2},"fn_name":null},{"line":174,"address":[6045914,6045901,6045784,6045969],"length":1,"stats":{"Line":4},"fn_name":null},{"line":177,"address":[6047244,6046493,6047154,6046697,6046935,6046719,6046915],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":67,"coverable":68},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","errors.rs"],"content":"use serde::Serialize;\nuse std::convert::Infallible;\nuse warp::{\n    hyper::StatusCode,\n    reply::{Json, WithStatus},\n    Rejection, Reply,\n};\n\n#[derive(Serialize)]\nstruct ErrorMessage {\n    code: u16,\n    message: String,\n}\n\nfn build_error_content(status: \u0026StatusCode) -\u003e ErrorMessage {\n    ErrorMessage {\n        code: status.as_u16(),\n        message: String::from(status.canonical_reason().unwrap_or(\"unknown\")),\n    }\n}\n\npub fn reply_with_error(status: StatusCode) -\u003e WithStatus\u003cJson\u003e {\n    warp::reply::with_status(warp::reply::json(\u0026build_error_content(\u0026status)), status)\n}\n\npub async fn handle_rejection(err: Rejection) -\u003e Result\u003cimpl Reply, Infallible\u003e {\n    if err.is_not_found() {\n        return Ok(reply_with_error(StatusCode::NOT_FOUND));\n    } else if err.find::\u003cwarp::reject::MethodNotAllowed\u003e().is_some() {\n        return Ok(reply_with_error(StatusCode::METHOD_NOT_ALLOWED));\n    }\n\n    return Ok(reply_with_error(StatusCode::INTERNAL_SERVER_ERROR));\n}\n","traces":[{"line":15,"address":[5111024],"length":1,"stats":{"Line":1},"fn_name":"build_error_content"},{"line":17,"address":[5111041],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[5111069],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[5111200,5111242],"length":1,"stats":{"Line":1},"fn_name":"reply_with_error"},{"line":23,"address":[5111254,5111212],"length":1,"stats":{"Line":2},"fn_name":null},{"line":26,"address":[4790431,4790416],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":27,"address":[5849290],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[5849462,5849385],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[5849559,5849597,5849361],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[5849627],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[5849716,5849603],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":5,"coverable":11},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","logger.rs"],"content":"use crate::config::AppConfig;\nuse flexi_logger::{style, DeferredNow, Level, Logger, Record};\nuse log::info;\nuse std::thread;\n\npub fn custom_format(\n    w: \u0026mut dyn std::io::Write,\n    now: \u0026mut DeferredNow,\n    record: \u0026Record,\n) -\u003e Result\u003c(), std::io::Error\u003e {\n    let level = record.level();\n    write!(\n        w,\n        \"[{}] {} ({})[{}] {}\",\n        now.now().format(\"%Y-%m-%d %H:%M:%S%.3f %:z\"),\n        style(level, level),\n        thread::current().name().unwrap_or(\"-\"),\n        style(level, record.module_path().unwrap_or(\"-\")),\n        style(level, \u0026record.args())\n    )\n}\n\npub fn init_logger(config: \u0026AppConfig) {\n    let log_level = if cfg!(test) {\n        Level::Warn.to_string()\n    } else {\n        config.log_level.to_string()\n    };\n    Logger::with_env_or_str(\u0026log_level)\n        .format(custom_format)\n        .start()\n        .ok();\n\n    info!(\"Initialized logger with level {}\", \u0026log_level);\n}\n","traces":[{"line":6,"address":[6058832,6058932],"length":1,"stats":{"Line":0},"fn_name":"custom_format"},{"line":11,"address":[6058882],"length":1,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[6059447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[6058955],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[6059006],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[6059041,6059087,6059212],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[6059244],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[6059373],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[6060313,6060272],"length":1,"stats":{"Line":1},"fn_name":"init_logger"},{"line":25,"address":[6904070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[6060287],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[6060328,6060399],"length":1,"stats":{"Line":2},"fn_name":null},{"line":34,"address":[6060587,6060466],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":4,"coverable":13},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","mod.rs"],"content":"pub mod app_context;\nmod auth;\nmod endpoints;\nmod errors;\nmod logger;\n\nuse self::{\n    app_context::AppContext,\n    endpoints::{\n        games::{\n            attend_game_filter, create_game_filter, get_game_filter, get_games_count_filter,\n            leave_game_filter,\n        },\n        players::{edit_player_filter, get_player_filter, EditPlayerInput},\n    },\n    errors::handle_rejection,\n};\nuse log::warn;\nuse std::fs;\nuse warp::Filter;\n\nconst PUBLIC_PATH: \u0026str = \"/var/www/public\";\nconst AUTHORIZATION: \u0026str = \"Authorization\";\n\npub async fn run_server(ctx: \u0026'static AppContext) {\n    let frontend_path = fs::canonicalize(\"../frontend\")\n        .map(|p| {\n            p.into_os_string()\n                .into_string()\n                .unwrap_or_else(|_| \"-\".to_string())\n        })\n        .unwrap_or_else(|_| \"-\".to_string());\n\n    let index_path: String;\n    let static_path: String;\n    if ctx.is_dev() {\n        warn!(\"Delivering development assets from {}\", frontend_path);\n        index_path = format!(\"{}/public/index.html\", frontend_path);\n        static_path = format!(\"{}/dist/\", frontend_path);\n    } else {\n        index_path = format!(\"{}/index.html\", PUBLIC_PATH);\n        static_path = format!(\"{}/static/\", PUBLIC_PATH);\n    }\n\n    let game_route =\n        warp::path(\"games\").and(\n            // GET /api/games\n            warp::get()\n                .and(warp::path::end())\n                .and_then(move || async move { get_games_count_filter(ctx).await })\n                .or(\n                    // PUT /api/games\n                    warp::put().and_then(move || async move { create_game_filter(ctx).await }),\n                )\n                .or(\n                    // POST /api/games/attend\n                    warp::post().and(warp::path!(String / \"attend\")).and_then(\n                        move |game_token: String| async move {\n                            attend_game_filter(\u0026game_token, ctx).await\n                        },\n                    ),\n                )\n                .or(\n                    // POST /api/games/leave\n                    warp::post()\n                        .and(warp::path!(String / \"leave\"))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(\n                            move |game_token: String, authorization: String| async move {\n                                leave_game_filter(\u0026game_token, \u0026authorization, ctx).await\n                            },\n                        ),\n                )\n                .or(\n                    // GET /api/games/:token\n                    warp::get()\n                        .and(warp::path!(String))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(move |token: String, authorization: String| async move {\n                            get_game_filter(\u0026token, \u0026authorization, ctx).await\n                        }),\n                ),\n        );\n\n    let player_route = warp::path(\"players\").and(\n        // GET /api/players/:id\n        warp::get()\n            .and(warp::path!(String))\n            .and_then(move |id: String| async move { get_player_filter(\u0026id, ctx).await })\n            .or(\n                // POST /api/players/:id\n                warp::post()\n                    .and(warp::path!(String))\n                    .and(warp::body::json())\n                    .and(warp::header(AUTHORIZATION))\n                    .and_then(\n                        move |id: String, input: EditPlayerInput, authorization: String| async move {\n                            edit_player_filter(\u0026id, \u0026input, \u0026authorization, ctx).await\n                        },\n                    )),\n    );\n    let api_route = warp::path(\"api\").and(game_route.or(player_route));\n\n    let static_route = warp::path(\"static\").and(warp::fs::dir(static_path));\n    let index_route = warp::get().and(warp::path::end().and(warp::fs::file(index_path)));\n\n    let routes = index_route\n        .or(static_route)\n        .or(api_route)\n        .recover(handle_rejection)\n        .with(warp::log(\"server\"));\n\n    warp::serve(routes)\n        .run(([0, 0, 0, 0], ctx.config().port))\n        .await;\n}\n","traces":[{"line":25,"address":[5344720,5344493,5344464,5350208],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":27,"address":[5337296],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":28,"address":[5337303],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[5337200,5337207],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":32,"address":[5337408,5337415],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":36,"address":[5344817,5345978,5344782],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[5344990,5345210,5345163,5345391,5345123],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[5345440,5345587],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[5345693,5345840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[5344919,5345991,5346065],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[5346171,5346321],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[5346573,5346514,5346602,5346689,5346933,5347273,5347577],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[5346548],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[4795856,4795871],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":53,"address":[4835952,4835967],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":57,"address":[5346797,5346906,5346829,5346750,5346855,5346879,5346816],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[4802818,4802672,4802762,4802687],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":59,"address":[4802742],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[5347096,5346981,5347146,5347210],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[5346992,5347072,5347033,5347046,5347014],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[5347107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[4780241,4780144,4780159,4780367],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":70,"address":[4780221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[5347450,5347400,5347514,5347313],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[5347324,5347346,5347376,5347363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[5347411],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[4812256,4812353,4812271,4812479],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":80,"address":[4812333],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[5347822,5348168,5347849,5347715],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[5347749,5347798,5347768,5347785],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[4793647,4793632],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":92,"address":[5348105,5347967,5347989,5347876,5348041],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[5347889,5347930,5347913,5347943],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[5347978],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[5348002],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[4844144,4844159,4844440,4844244],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":98,"address":[4844221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[5348528,5348251],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[5348575,5348797,5348742],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[5349010,5348979,5348804,5348881,5348951],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[5349157,5349297,5349065,5349215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[5349026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[5349147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[5349246],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[5349201,5349254,5349342,5350131],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[4832389],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[5349441,5349644,5349662,5349631,5350158,5349517,5349502],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":47}]};
        var previousData = {"files":[{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","bin.rs"],"content":"use secret_clan::run_app;\n\nfn main() {\n    run_app();\n}\n","traces":[{"line":3,"address":[4211120],"length":1,"stats":{"Line":0},"fn_name":"main"},{"line":4,"address":[4211121],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":2},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","client.rs"],"content":"use super::{Command, CommandData, Persist, QueryError};\nuse log::debug;\nuse nanoid::nanoid;\nuse std::{\n    collections::HashSet,\n    fmt::{self, Debug},\n};\nuse tokio::sync::{mpsc, oneshot};\n\npub struct Client\u003cT: Persist\u003e {\n    sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Persist\u003e Client\u003cT\u003e {\n    pub fn new(sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e) -\u003e Self {\n        Client { sender }\n    }\n\n    async fn run_query\u003cR: Debug\u003e(\n        \u0026self,\n        cmd_provider: impl FnOnce(CommandData\u003cR\u003e) -\u003e Command\u003cT\u003e,\n    ) -\u003e Result\u003cR, QueryError\u003e {\n        let (responder, receiver): (oneshot::Sender\u003cR\u003e, oneshot::Receiver\u003cR\u003e) = oneshot::channel();\n        let id = nanoid!();\n        let data = CommandData {\n            responder,\n            id: String::from(\u0026id),\n        };\n        let cmd = cmd_provider(data);\n        let res = self.sender.clone().send(cmd).await;\n        debug!(\"Sent query \\\"{}\\\"\", \u0026id);\n\n        match res {\n            Ok(_) =\u003e match receiver.await {\n                Ok(res) =\u003e {\n                    debug!(\"Received answer for query \\\"{}\\\": {:?}\", \u0026id, res);\n                    Ok(res)\n                }\n                Err(error) =\u003e Err(QueryError::new(\u0026fmt::format(format_args!(\n                    \"Retrieving result for query \\\"{}\\\" has failed: {}\",\n                    id,\n                    error.to_string(),\n                )))),\n            },\n            Err(error) =\u003e Err(QueryError::new(\u0026fmt::format(format_args!(\n                \"Sending query for query \\\"{}\\\" has failed: {}\",\n                id,\n                error.to_string(),\n            )))),\n        }\n    }\n\n    fn map_result\u003cR\u003e(res: Result\u003cR, sled::Error\u003e) -\u003e Result\u003cR, QueryError\u003e {\n        res.map_err(QueryError::from_sled)\n    }\n\n    pub async fn get(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cT\u003e, QueryError\u003e {\n        let key = String::from(id);\n        self.run_query(|data| Command::Get { key, data })\n            .await\n            .and_then(Self::map_result)\n    }\n\n    pub async fn scan(\n        \u0026self,\n        scan_function: Box\u003cdyn Fn(\u0026T) -\u003e bool + Send + Sync\u003e,\n    ) -\u003e Result\u003cHashSet\u003cString\u003e, QueryError\u003e {\n        self.run_query(|data| Command::Scan {\n            scan_function,\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn persist(\u0026self, elem: \u0026T) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Persist {\n            value: elem.clone(),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn remove(\u0026self, key: \u0026str) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Remove {\n            key: String::from(key),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn remove_batch(\u0026self, keys: \u0026HashSet\u003cString\u003e) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::RemoveBatch {\n            keys: keys.clone(),\n            data,\n        })\n        .await\n        .and_then(Self::map_result)\n    }\n\n    pub async fn purge(\u0026self) -\u003e Result\u003cbool, QueryError\u003e {\n        self.run_query(|data| Command::Purge { data })\n            .await\n            .and_then(Self::map_result)\n    }\n\n    pub async fn total_count(\u0026self) -\u003e Result\u003cusize, QueryError\u003e {\n        self.run_query(|data| Command::Count { data }).await\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::Client;\n    use crate::{\n        db::{Database, Persist},\n        model::Game,\n    };\n    use nanoid::nanoid;\n    use std::collections::HashSet;\n\n    fn init_client() -\u003e Client\u003cGame\u003e {\n        let mut repo = Database::init(\"games\");\n\n        let sender = repo.sender();\n        tokio::task::spawn(async move {\n            repo.start_listening().await;\n        });\n\n        let client = Client::new(sender);\n\n        client\n    }\n\n    #[tokio::test]\n    async fn should_get_game() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"token\");\n        let game_id = String::from(game.id());\n\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n\n        let res = client.get(\u0026game_id).await.expect(\"Reading game has failed\");\n\n        assert!(res.is_some());\n        assert_eq!(res.unwrap().id(), game_id);\n    }\n\n    #[tokio::test]\n    async fn should_persist_game() {\n        let client = init_client();\n\n        client\n            .persist(\u0026Game::new(\"admin\", \"token\"))\n            .await\n            .expect(\"Game persist failed\");\n    }\n\n    #[tokio::test]\n    async fn should_purge_games() {\n        let client = init_client();\n\n        client\n            .persist(\u0026Game::new(\"admin\", \"token\"))\n            .await\n            .expect(\"Game persist failed\");\n        client\n            .persist(\u0026Game::new(\"admin\", \"token2\"))\n            .await\n            .expect(\"Game persist failed\");\n\n        assert_eq!(client.total_count().await.unwrap(), 2);\n\n        client.purge().await.expect(\"Perging has failed\");\n\n        assert_eq!(client.total_count().await.unwrap(), 0);\n    }\n\n    #[tokio::test]\n    async fn should_remove_game() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"token\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n\n        let persisted_game = client\n            .get(\u0026game.id())\n            .await\n            .expect(\"Reading game has failed\");\n        assert!(persisted_game.is_some());\n\n        let res = client\n            .remove(game.id())\n            .await\n            .expect(\"Removing game failed\");\n        assert!(res);\n\n        let removed_game = client\n            .get(\u0026game.id())\n            .await\n            .expect(\"Reading game has failed\");\n        assert!(removed_game.is_none());\n    }\n\n    #[tokio::test]\n    async fn should_remove_games() {\n        let client = init_client();\n        let mut ids = HashSet::new();\n        for x in \u0026[\"A\", \"B\", \"C\"] {\n            let g = Game::new(\"admin\", *x);\n            client.persist(\u0026g).await.expect(\"Game persist failed\");\n            ids.insert(String::from(*x));\n        }\n\n        let game_count = client\n            .total_count()\n            .await\n            .expect(\"Reading count has failed\");\n        assert_eq!(game_count, 3);\n\n        let res = client\n            .remove_batch(\u0026ids)\n            .await\n            .expect(\"Removing games failed\");\n        assert!(res);\n\n        let game_count = client\n            .total_count()\n            .await\n            .expect(\"Reading count has failed\");\n        assert_eq!(game_count, 0);\n    }\n\n    #[tokio::test]\n    async fn should_not_get_game() {\n        let client = init_client();\n        let res = client\n            .get(\"unknown\")\n            .await\n            .expect(\"Reading game has failed\");\n\n        assert!(res.is_none());\n    }\n\n    #[tokio::test]\n    async fn should_create_entities_concurrently() {\n        let client = init_client();\n\n        let mut threads = vec![];\n\n        for _ in 0..1000 {\n            threads.push(async {\n                let _ = client.persist(\u0026Game::new(\"admin\", \u0026nanoid!())).await;\n            });\n        }\n\n        futures::future::join_all(threads).await;\n\n        assert_eq!(\n            client\n                .total_count()\n                .await\n                .expect(\"Reading count has failed\"),\n            1000\n        );\n    }\n}\n","traces":[{"line":15,"address":[6073344,6073280],"length":1,"stats":{"Line":9},"fn_name":"new\u003csecret_clan::model::game::Game\u003e"},{"line":19,"address":[6073488,6073840,6074016,6073568,6073760,6073920,6073408,6074112,6073664],"length":1,"stats":{"Line":16},"fn_name":"run_query\u003csecret_clan::model::game::Game,core::result::Result\u003cbool, sled::result::Error\u003e,closure-0\u003e"},{"line":23,"address":[6097745,6080153,6074365,6086157,6109357,6091945,6120921,6115133,6103353],"length":1,"stats":{"Line":16},"fn_name":null},{"line":24,"address":[6074458,6115226,6086250,6097830,6080238,6092030,6121006,6109450,6103438],"length":1,"stats":{"Line":17},"fn_name":null},{"line":27,"address":[6092255,6080463,6103663,6086475,6109675,6115451,6074683,6121231,6098055],"length":1,"stats":{"Line":17},"fn_name":null},{"line":29,"address":[6074923,6080543,6109755,6092523,6098135,6086715,6103743,6109915,6098287,6115531,6121499,6115691,6080735,6074763,6092335,6086555,6121311,6103935],"length":1,"stats":{"Line":35},"fn_name":null},{"line":30,"address":[4820353,4838817,4827537,4808609,4821473,4800673,4782673,4789249,4839905],"length":1,"stats":{"Line":91},"fn_name":null},{"line":31,"address":[6087664,6104711,6104844,6099236,6116874,6093706,6099196,6104931,6116600,6087711,6075699,6116687,6081731,6111098,6087491,6110824,6093519,6110911,6122495,6087624,6093472,6116467,6110691,6116640,6099283,6093432,6075872,6122275,6075832,6099470,6104884,6105118,6122408,6122448,6081684,6087898,6110864,6099063,6076106,6075919,6093299,6081511,6081644,6081918,6122682],"length":1,"stats":{"Line":72},"fn_name":null},{"line":33,"address":[6078882,6096502,6125154,6096178,6108106,6084582,6078572,6111300,6113874,6122884,6090364,6084906,6090674,6105320,6117076,6076308,6082120,6113564,6101763,6102088,6088100,6119340,6125478,6099672,6093908,6107782,6119650],"length":1,"stats":{"Line":19},"fn_name":null},{"line":34,"address":[4820568,4808824,4839032,4840120,4827752,4782888,4821688,4789464,4800888],"length":1,"stats":{"Line":92},"fn_name":null},{"line":35,"address":[6105844,6082720,6100031,6105920,6094380,6117469,6094304,6111766,6111693,6082644,6076701,6123356,6076774,6088566,6117542,6100098,6123280,6088493],"length":1,"stats":{"Line":38},"fn_name":null},{"line":36,"address":[6094577,6077076,6123611,6076971,6100576,6088821,6077411,6094635,6094682,6106048,6100673,6106621,6094444,6083421,6123658,6106239,6100247,6083039,6094920,6083324,6117844,6112068,6117606,6077314,6106524,6117797,6089106,6082848,6123896,6100338,6100114,6111830,6123553,6111963,6106181,6112021,6082981,6088763,6123420,6118179,6088630,6100291,6089203,6123993,6106286,6076838,6117739,6095017,6112403,6088868,6077029,6083086,6118082,6112306],"length":1,"stats":{"Line":76},"fn_name":null},{"line":37,"address":[6100714,6089244,6077452,6118220,6095058,6124034,6112444,6083462,6106662],"length":1,"stats":{"Line":19},"fn_name":null},{"line":39,"address":[6077712,6100755,6124459,6077979,6095483,6083989,6124294,6118557,6089581,6118645,6089669,6101066,6095318,6083582,6106999,6118747,6112781,6100978,6112869,6089364,6095178,6083799,6089771,6124154,6077789,6083722,6112971,6118480,6095585,6101168,6118340,6100895,6124371,6089504,6106922,6095395,6077572,6107087,6077877,6112704,6106782,6083887,6112564,6124561,6107189],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[6123312,6082676,6117498,6088522,6094336,6100054,6076730,6105876,6111722],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[6123316,6076734,6082680,6105880,6117502,6100058,6088526,6094340,6111726],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[6095680,6119139,6084381,6084293,6124865,6113463,6090263,6090075,6101472,6125053,6124791,6124656,6107681,6099551,6101263,6107493,6087979,6078074,6107419,6095977,6101560,6107284,6113201,6113363,6084084,6111179,6107581,6078283,6124953,6089866,6084219,6119051,6090163,6084481,6078471,6093787,6118842,6116955,6101662,6113275,6095889,6078371,6081999,6105199,6096077,6122763,6095815,6119239,6113066,6118977,6101398,6078209,6090001,6076187],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[6122834,6105270,6093858,6088050,6117026,6082070,6111250,6099622,6076258],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[6111254,6105274,6099626,6117030,6076262,6093862,6122838,6088054,6082074],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[6126544,6126624,6126944,6126864,6126784,6126704],"length":1,"stats":{"Line":15},"fn_name":"map_result\u003csecret_clan::model::game::Game,bool\u003e"},{"line":54,"address":[6126551,6126711,6126874,6126951,6126634,6126791],"length":1,"stats":{"Line":15},"fn_name":null},{"line":57,"address":[6127024,6128416,6127530,6128205,6127504,6128442,6127738,6128650,6127154,6127120,6127058,6129117],"length":1,"stats":{"Line":14},"fn_name":"get\u003csecret_clan::model::game::Game\u003e"},{"line":58,"address":[6128561,6127649],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[4787574,4846438],"length":1,"stats":{"Line":18},"fn_name":null},{"line":60,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[6129424,6129328],"length":1,"stats":{"Line":3},"fn_name":"scan\u003csecret_clan::model::game::Game\u003e"},{"line":68,"address":[4827222,4806422],"length":1,"stats":{"Line":18},"fn_name":null},{"line":69,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[6129649,6129537],"length":1,"stats":{"Line":3},"fn_name":null},{"line":72,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[6132464,6131536,6133811,6131642,6131616,6132240,6133146,6133344,6132931,6133120,6131562,6132266],"length":1,"stats":{"Line":35},"fn_name":"persist\u003csecret_clan::model::player::Player\u003e"},{"line":77,"address":[6132368,6133373,6131746,6131696,6132916,6133487,6133248,6132493,6131968,6132539,6132018,6131818,6133419,6132607,6133796,6132090],"length":1,"stats":{"Line":41},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":78,"address":[6131714,6131986],"length":1,"stats":{"Line":7},"fn_name":null},{"line":79,"address":[6132038,6131766],"length":1,"stats":{"Line":7},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":86,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[4831568,4831583,4799512,4799439,4831656,4799424],"length":1,"stats":{"Line":12},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":95,"address":[4831638,4799494],"length":1,"stats":{"Line":12},"fn_name":null},{"line":96,"address":[6134175,6134415],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[6134229,6134469],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[4809200,4809215,4809288],"length":1,"stats":{"Line":6},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":110,"address":[4809270],"length":1,"stats":{"Line":6},"fn_name":null},{"line":124,"address":[5012144,5012218],"length":1,"stats":{"Line":2},"fn_name":"init_client"},{"line":125,"address":[5012161],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[5012246],"length":1,"stats":{"Line":6},"fn_name":null},{"line":128,"address":[5012261],"length":1,"stats":{"Line":11},"fn_name":null},{"line":129,"address":[5811030],"length":1,"stats":{"Line":6},"fn_name":null},{"line":132,"address":[5012446],"length":1,"stats":{"Line":6},"fn_name":null},{"line":137,"address":[5012663,5012656],"length":1,"stats":{"Line":9},"fn_name":"should_get_game"},{"line":139,"address":[6963312],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[6963343],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[6963461,6963400],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[5742479],"length":1,"stats":{"Line":4},"fn_name":null},{"line":145,"address":[5742578],"length":1,"stats":{"Line":5},"fn_name":null},{"line":147,"address":[6964873,6964691,6964642],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[6964707,6965111,6964919,6964968,6965329,6964946,6965418],"length":1,"stats":{"Line":4},"fn_name":null},{"line":151,"address":[5012960,5012967],"length":1,"stats":{"Line":9},"fn_name":"should_persist_game"},{"line":153,"address":[6966406],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[5784789],"length":1,"stats":{"Line":5},"fn_name":null},{"line":156,"address":[6966423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[5013271,5013264],"length":1,"stats":{"Line":9},"fn_name":"should_remove_game"},{"line":163,"address":[6967384],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[6967399],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[5759817],"length":1,"stats":{"Line":5},"fn_name":null},{"line":167,"address":[5759886],"length":1,"stats":{"Line":4},"fn_name":null},{"line":168,"address":[6967916,6967998],"length":1,"stats":{"Line":2},"fn_name":null},{"line":171,"address":[6968701,6968758,6968645],"length":1,"stats":{"Line":2},"fn_name":null},{"line":173,"address":[5759934],"length":1,"stats":{"Line":4},"fn_name":null},{"line":174,"address":[6968729],"length":1,"stats":{"Line":1},"fn_name":null},{"line":177,"address":[6969204,6969282],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[5759985],"length":1,"stats":{"Line":4},"fn_name":null},{"line":180,"address":[6969233,6969330],"length":1,"stats":{"Line":2},"fn_name":null},{"line":183,"address":[6969980,6969955,6970020],"length":1,"stats":{"Line":2},"fn_name":null},{"line":186,"address":[5013568,5013575],"length":1,"stats":{"Line":9},"fn_name":"should_remove_games"},{"line":188,"address":[6971157],"length":1,"stats":{"Line":1},"fn_name":null},{"line":189,"address":[6971172],"length":1,"stats":{"Line":1},"fn_name":null},{"line":190,"address":[6971186,6971307,6971404,6971253,6972033],"length":1,"stats":{"Line":4},"fn_name":null},{"line":191,"address":[6971442],"length":1,"stats":{"Line":1},"fn_name":null},{"line":192,"address":[5781945],"length":1,"stats":{"Line":5},"fn_name":null},{"line":193,"address":[6971995,6971928],"length":1,"stats":{"Line":2},"fn_name":null},{"line":196,"address":[5782035],"length":1,"stats":{"Line":5},"fn_name":null},{"line":200,"address":[6972471,6972618,6972864,6972963],"length":1,"stats":{"Line":1},"fn_name":null},{"line":202,"address":[5782062],"length":1,"stats":{"Line":5},"fn_name":null},{"line":203,"address":[6972577],"length":1,"stats":{"Line":1},"fn_name":null},{"line":206,"address":[6973374,6973410],"length":1,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[5782087],"length":1,"stats":{"Line":5},"fn_name":null},{"line":212,"address":[6974248,6974158,6973954,6973831],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[5013879,5013872],"length":1,"stats":{"Line":9},"fn_name":"should_not_get_game"},{"line":217,"address":[6975398],"length":1,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[5808005],"length":1,"stats":{"Line":4},"fn_name":null},{"line":223,"address":[6976053,6976019,6975994],"length":1,"stats":{"Line":2},"fn_name":null},{"line":226,"address":[5014176,5014183],"length":1,"stats":{"Line":9},"fn_name":"should_create_entities_concurrently"},{"line":228,"address":[6977573],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[6977595],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[6977785,6978057,6977935,6977724,6977617],"length":1,"stats":{"Line":4},"fn_name":null},{"line":233,"address":[5723056,5723071,5723265,5723240],"length":1,"stats":{"Line":5},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":234,"address":[5723137],"length":1,"stats":{"Line":6},"fn_name":null},{"line":238,"address":[5726690],"length":1,"stats":{"Line":5},"fn_name":null},{"line":240,"address":[6978923,6978800,6979217,6979127],"length":1,"stats":{"Line":1},"fn_name":null},{"line":241,"address":[5726742],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":93,"coverable":116},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","database.rs"],"content":"use super::{Command, Persist, ScanFunction};\nuse log::{debug, error, info, warn};\nuse nanoid::nanoid;\nuse rayon::prelude::*;\nuse sled::Db;\nuse std::collections::HashSet;\nuse tokio::sync::{\n    mpsc::{self},\n    oneshot::{self},\n};\n\npub struct Database\u003cT: Persist\u003e {\n    path: String,\n    db: Db,\n    receiver: mpsc::Receiver\u003cCommand\u003cT\u003e\u003e,\n    sender: mpsc::Sender\u003cCommand\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Persist\u003e Database\u003cT\u003e {\n    pub fn init(path: \u0026str) -\u003e Database\u003cT\u003e {\n        let db = sled::open(if cfg!(test) {\n            format!(\".sled/{}/{}\", nanoid!(), \u0026path)\n        } else {\n            format!(\".sled/{}\", \u0026path)\n        })\n        .expect(\"opening database has failed\");\n\n        let (sender, receiver): (mpsc::Sender\u003cCommand\u003cT\u003e\u003e, mpsc::Receiver\u003cCommand\u003cT\u003e\u003e) =\n            mpsc::channel(32);\n\n        let repo = Database {\n            db,\n            path: String::from(path),\n            receiver,\n            sender,\n        };\n\n        repo.purge()\n            .expect(\"Cleanup of existing database has failed\");\n\n        repo\n    }\n\n    pub fn sender(\u0026self) -\u003e mpsc::Sender\u003cCommand\u003cT\u003e\u003e {\n        self.sender.clone()\n    }\n\n    /// A database connection is etablished by creating a database instance, which should should then be started in a separate thread.\n    /// The communication between resources and the database is established with channels. Simply use a client to send messages to the database thread in an easy accesible way.\n    /// Of course it's also possible to send messages through the channel directly without using the client.\n    ///\n    /// Example:\n    /// ```\n    /// use secret_clan::{model::Game, db::{Database, Client}};\n    /// let mut repo: Database\u003cGame\u003e = Database::init(\"test\");\n    /// let sender = repo.sender();\n    /// std::thread::spawn(move || {\n    ///     repo.start_listening();\n    /// });\n    /// let client = Client::new(sender);\n    /// ```\n    pub async fn start_listening(\u0026mut self) {\n        info!(\"Database for \\\"{}\\\" ready\", self.path);\n\n        while let Some(cmd) = self.receiver.recv().await {\n            debug!(\"Received query: {:?}\", cmd);\n\n            match cmd {\n                Command::Get { key, data } =\u003e {\n                    self.send_result(self.get(\u0026key), data.responder);\n                }\n                Command::Persist { value, data } =\u003e {\n                    self.send_result(self.persist(\u0026value), data.responder);\n                }\n                Command::Remove { key, data } =\u003e {\n                    self.send_result(self.remove(\u0026key), data.responder);\n                }\n                Command::RemoveBatch { keys, data } =\u003e {\n                    self.send_result(self.remove_batch(\u0026keys), data.responder);\n                }\n                Command::Count { data } =\u003e {\n                    self.send_result(self.total_count(), data.responder);\n                }\n                Command::Scan {\n                    scan_function,\n                    data,\n                } =\u003e {\n                    self.send_result(Ok(self.scan(scan_function)), data.responder);\n                }\n                Command::Purge { data } =\u003e {\n                    self.send_result(self.purge(), data.responder);\n                }\n            }\n        }\n    }\n\n    fn persist(\u0026self, elem: \u0026T) -\u003e Result\u003cbool, sled::Error\u003e {\n        self.db\n            .insert(elem.id(), elem.clone())\n            .expect(\"Persisting item failed\");\n        self.flush()\n    }\n\n    fn remove(\u0026self, key: \u0026str) -\u003e Result\u003cbool, sled::Error\u003e {\n        match self.db.remove(key).expect(\"Removing item failed\") {\n            Some(_) =\u003e self.flush(),\n            None =\u003e {\n                warn!(\"No item with key \\\"{}\\\" found for removal\", key);\n                Ok(false)\n            }\n        }\n    }\n\n    fn remove_batch(\u0026self, keys: \u0026HashSet\u003cString\u003e) -\u003e Result\u003cbool, sled::Error\u003e {\n        let batch = sled::Batch::default();\n        for key in keys {\n            match self.db.remove(key).expect(\"Removing item failed\") {\n                Some(_) =\u003e {}\n                None =\u003e {\n                    warn!(\"No item with key \\\"{}\\\" found for removal\", key);\n                }\n            }\n        }\n        self.db.apply_batch(batch)?;\n        self.flush()\n    }\n\n    fn get(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cT\u003e, sled::Error\u003e {\n        let success = self.db.get(id);\n        match success {\n            Ok(res) =\u003e Ok(res.and_then(|g| T::try_from(g).ok())),\n            Err(err) =\u003e Err(err),\n        }\n    }\n\n    fn scan(\u0026self, scan_function: ScanFunction\u003cT\u003e) -\u003e HashSet\u003cString\u003e {\n        self.db\n            .iter()\n            .par_bridge()\n            .filter_map(|x| x.ok())\n            .filter_map(|(_, x)| T::try_from(x).ok())\n            .filter_map(|y| {\n                if scan_function(\u0026y) {\n                    Some(String::from(y.id()))\n                } else {\n                    None\n                }\n            })\n            .collect::\u003cHashSet\u003cString\u003e\u003e()\n    }\n\n    fn total_count(\u0026self) -\u003e usize {\n        self.db.len()\n    }\n\n    fn flush(\u0026self) -\u003e Result\u003cbool, sled::Error\u003e {\n        self.db.flush().map(|_| true)\n    }\n\n    fn send_result\u003cR\u003e(\u0026self, data: R, sender: oneshot::Sender\u003cR\u003e) {\n        if sender.send(data).is_err() {\n            error!(\"Sending result to client has failed\");\n        }\n    }\n\n    fn purge(\u0026self) -\u003e Result\u003cbool, sled::Error\u003e {\n        let res = self.db.clear().and_then(|()| self.db.flush()).map(|_| true);\n        info!(\"Purged database \\\"{}\\\"\", self.path);\n\n        res\n    }\n}\n","traces":[{"line":20,"address":[6264962,6264832,6265824,6265954],"length":1,"stats":{"Line":3},"fn_name":"init\u003csecret_clan::model::player::Player\u003e"},{"line":21,"address":[6264859,6265125,6266117,6265851],"length":1,"stats":{"Line":9},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":24,"address":[6265875,6264883,6265981,6264989],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[6266217,6265225],"length":1,"stats":{"Line":2},"fn_name":null},{"line":33,"address":[6265336,6266328],"length":1,"stats":{"Line":2},"fn_name":null},{"line":38,"address":[6266536,6265585,6265544,6266577],"length":1,"stats":{"Line":12},"fn_name":null},{"line":41,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[6266864,6266816],"length":1,"stats":{"Line":9},"fn_name":"sender\u003csecret_clan::model::game::Game\u003e"},{"line":45,"address":[6266876,6266828],"length":1,"stats":{"Line":9},"fn_name":null},{"line":62,"address":[4818080,4802959,4818095,4802944],"length":1,"stats":{"Line":13},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":63,"address":[6273433,6273715,6267465,6267512,6267401,6267268,6273544,6273300,6273497,6267683],"length":1,"stats":{"Line":20},"fn_name":null},{"line":65,"address":[6267724,6267880,6273867,6274202,6273912,6268170,6267942,6273974,6278139,6267835,6273756,6272107],"length":1,"stats":{"Line":38},"fn_name":null},{"line":66,"address":[6268534,6268437,6274790,6274613,6268758,6274566,6268296,6274328,6268581,6274469],"length":1,"stats":{"Line":32},"fn_name":null},{"line":68,"address":[6269620,6277923,6275275,6271891,6276245,6268932,6270213,6275948,6274964,6275652,6269243,6269916],"length":1,"stats":{"Line":14},"fn_name":null},{"line":69,"address":[6268934,6274966,6268799,6274831],"length":1,"stats":{"Line":11},"fn_name":null},{"line":70,"address":[6269030,6275208,6269176,6275062],"length":1,"stats":{"Line":6},"fn_name":null},{"line":72,"address":[6275280,6269248],"length":1,"stats":{"Line":7},"fn_name":null},{"line":73,"address":[6275472,6269440],"length":1,"stats":{"Line":7},"fn_name":null},{"line":75,"address":[6275657,6269625],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[6269852,6275884,6269721,6275753],"length":1,"stats":{"Line":2},"fn_name":null},{"line":78,"address":[6275953,6269921],"length":1,"stats":{"Line":2},"fn_name":null},{"line":79,"address":[6270033,6276065],"length":1,"stats":{"Line":2},"fn_name":null},{"line":81,"address":[6270218,6276250],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[6270274,6276306],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[6276432,6270400],"length":1,"stats":{"Line":3},"fn_name":null},{"line":86,"address":[6276472,6270440],"length":1,"stats":{"Line":3},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[6270577,6276609,6270496,6276528],"length":1,"stats":{"Line":5},"fn_name":null},{"line":90,"address":[6268839,6274871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[6270704,6268895,6276736,6274927],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[6279072,6279312],"length":1,"stats":{"Line":7},"fn_name":"persist\u003csecret_clan::model::player::Player\u003e"},{"line":98,"address":[6279098,6279421,6279338,6279181],"length":1,"stats":{"Line":14},"fn_name":null},{"line":99,"address":[6279147,6279387],"length":1,"stats":{"Line":7},"fn_name":null},{"line":101,"address":[6279285,6279525],"length":1,"stats":{"Line":7},"fn_name":null},{"line":104,"address":[6279552,6280277,6279621,6280208],"length":1,"stats":{"Line":1},"fn_name":"remove\u003csecret_clan::model::player::Player\u003e"},{"line":105,"address":[6280449,6280472,6280236,6280292,6279636,6279816,6279793,6279580],"length":1,"stats":{"Line":3},"fn_name":null},{"line":106,"address":[6279719,6280451,6279795,6280375],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[6280477,6279904,6280411,6279821,6279755,6280560],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[6282144,6282221,6280864,6280941],"length":1,"stats":{"Line":2},"fn_name":"remove_batch\u003csecret_clan::model::game::Game\u003e"},{"line":115,"address":[6280890,6282170],"length":1,"stats":{"Line":2},"fn_name":null},{"line":116,"address":[6281686,6282385,6281105,6282966,6282236,6280956],"length":1,"stats":{"Line":4},"fn_name":null},{"line":117,"address":[6282945,6282605,6281144,6281325,6282424,6281665],"length":1,"stats":{"Line":2},"fn_name":null},{"line":118,"address":[6281245,6282525],"length":1,"stats":{"Line":2},"fn_name":null},{"line":119,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[6281415,6282612,6282695,6281332,6281287,6282567],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[6282359,6283308,6281858,6282971,6281996,6281079,6281691,6282028,6283276,6283138],"length":1,"stats":{"Line":4},"fn_name":null},{"line":125,"address":[6281834,6283114],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[6284318,6283424,6283888,6283854],"length":1,"stats":{"Line":3},"fn_name":"get\u003csecret_clan::model::player::Player\u003e"},{"line":129,"address":[6283458,6283922],"length":1,"stats":{"Line":3},"fn_name":null},{"line":130,"address":[6283673,6284137],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[6284362,6284352,6284448,6284144,6283525,6284458,6283989,6283680],"length":1,"stats":{"Line":15},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":132,"address":[6283541,6284005],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[6284908,6284544,6284848,6284604],"length":1,"stats":{"Line":3},"fn_name":"scan\u003csecret_clan::model::player::Player\u003e"},{"line":137,"address":[6284749,6284572,6284655,6284923,6284876,6284959,6285053,6284619],"length":1,"stats":{"Line":12},"fn_name":null},{"line":140,"address":[6285152,6285232,6285164,6285244],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":141,"address":[6285330,6285570,6285312,6285552],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":142,"address":[6286016,6285851,6285045,6285792,6286075,6284741],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":143,"address":[6286091,6286122,6286028,6285867,6285898,6285804],"length":1,"stats":{"Line":6},"fn_name":null},{"line":144,"address":[6286124,6285900],"length":1,"stats":{"Line":2},"fn_name":null},{"line":146,"address":[6286115,6285891],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[6286304,6286240],"length":1,"stats":{"Line":1},"fn_name":"total_count\u003csecret_clan::model::player::Player\u003e"},{"line":153,"address":[6286313,6286249],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[6286464,6286368],"length":1,"stats":{"Line":7},"fn_name":"flush\u003csecret_clan::model::player::Player\u003e"},{"line":157,"address":[6286592,6286476,6286380,6286613,6286581,6286601,6286569,6286560],"length":1,"stats":{"Line":21},"fn_name":"{{closure}}\u003csecret_clan::model::game::Game\u003e"},{"line":160,"address":[6286624,6289232,6289680,6287520,6286673,6289315,6288784,6286992,6288864,6287968,6287075,6287888,6289729,6287440,6288416,6288336],"length":1,"stats":{"Line":13},"fn_name":"send_result\u003csecret_clan::model::game::Game,usize\u003e"},{"line":161,"address":[6288746,6287405,6289705,6287535,6287983,6290005,6287850,6289645,6286649,6287090,6288359,6288807,6289194,6289744,6287911,6286949,6287015,6289255,6287463,6286688,6288879,6288298,6288431,6289330],"length":1,"stats":{"Line":28},"fn_name":null},{"line":162,"address":[6288497,6288049,6289790,6289043,6289396,6286734,6289876,6288945,6287699,6288147,6289494,6287601,6287156,6288595,6286820,6287254],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[6290661,6290608,6290048,6290101],"length":1,"stats":{"Line":3},"fn_name":"purge\u003csecret_clan::model::game::Game\u003e"},{"line":167,"address":[6291248,6291168,6291360,6290116,6290063,6290623,6290676,6291337,6291328,6291180,6291349,6291260,6291369,6291381],"length":1,"stats":{"Line":36},"fn_name":"{{closure}}\u003csecret_clan::model::player::Player\u003e"},{"line":168,"address":[6290312,6290355,6290751,6290191,6290915,6290872],"length":1,"stats":{"Line":27},"fn_name":null},{"line":170,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":60,"coverable":74},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","db","mod.rs"],"content":"mod client;\nmod database;\n\nuse sled::IVec;\nuse std::{\n    clone::Clone,\n    collections::HashSet,\n    convert::TryFrom,\n    fmt::{self, Debug},\n};\nuse tokio::sync::oneshot;\n\npub use self::client::Client;\npub use self::database::Database;\n\npub trait Persist: Into\u003cIVec\u003e + TryFrom\u003cIVec\u003e + Clone + Debug + Send {\n    fn id(\u0026self) -\u003e \u0026str;\n}\n#[derive(Debug, Clone)]\npub struct QueryError {\n    message: String,\n}\n\nimpl QueryError {\n    pub fn new(message: \u0026str) -\u003e Self {\n        QueryError {\n            message: String::from(message),\n        }\n    }\n\n    pub fn from_sled(error: sled::Error) -\u003e Self {\n        QueryError {\n            message: error.to_string(),\n        }\n    }\n}\n\nimpl fmt::Display for QueryError {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter) -\u003e fmt::Result {\n        write!(f, \"invalid first item to double\")\n    }\n}\n\n#[derive(Derivative)]\n#[derivative(Debug)]\npub struct CommandData\u003cR: Debug\u003e {\n    id: String,\n    #[derivative(Debug = \"ignore\")]\n    responder: oneshot::Sender\u003cR\u003e,\n}\n\npub type ScanFunction\u003cT\u003e = Box\u003cdyn Fn(\u0026T) -\u003e bool + Send + Sync\u003e;\n\n#[derive(Derivative)]\n#[derivative(Debug)]\npub enum Command\u003cT: Persist\u003e {\n    Get {\n        key: String,\n        data: CommandData\u003cResult\u003cOption\u003cT\u003e, sled::Error\u003e\u003e,\n    },\n    Scan {\n        #[derivative(Debug = \"ignore\")]\n        scan_function: ScanFunction\u003cT\u003e,\n        data: CommandData\u003cResult\u003cHashSet\u003cString\u003e, sled::Error\u003e\u003e,\n    },\n    Persist {\n        value: T,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Remove {\n        key: String,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Purge {\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    RemoveBatch {\n        keys: HashSet\u003cString\u003e,\n        data: CommandData\u003cResult\u003cbool, sled::Error\u003e\u003e,\n    },\n    Count {\n        data: CommandData\u003cusize\u003e,\n    },\n}\n","traces":[{"line":25,"address":[5237824],"length":1,"stats":{"Line":0},"fn_name":"new"},{"line":27,"address":[5237841],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[5237904,5237945],"length":1,"stats":{"Line":0},"fn_name":"from_sled"},{"line":33,"address":[5237911],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[5238048],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":40,"address":[5238081],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","cleanup_games.rs"],"content":"use crate::{db::Client, model::Game, server::app_context::AppContext};\nuse chrono::{Duration, Utc};\nuse log::{debug, info, warn};\n\npub fn cleanup_games(ctx: \u0026'static AppContext) -\u003e impl Fn() {\n    move || {\n        tokio::task::spawn(async move {\n            execute_cleanup_games(ctx.db().games(), Duration::minutes(5)).await;\n        });\n    }\n}\n\nasync fn execute_cleanup_games(client: \u0026Client\u003cGame\u003e, duration: Duration) -\u003e bool {\n    let inactive_games = client\n        .scan(Box::new(is_inactive_game(duration)))\n        .await\n        .expect(\"Scanning games has failed\");\n\n    let inactive_count = inactive_games.len();\n    if inactive_count == 0 {\n        debug!(\"Removed no inactive games\");\n        false\n    } else {\n        match client.remove_batch(\u0026inactive_games).await {\n            Ok(_) =\u003e {\n                info!(\"Removed {} inactive games\", inactive_count);\n                true\n            }\n            Err(e) =\u003e {\n                warn!(\n                    \"Removing {} inactive games has failed: {:?}\",\n                    inactive_count, e\n                );\n                false\n            }\n        }\n    }\n}\n\n// Game is inactive if no admin is present and last activity happened five minutes ago\nfn is_inactive_game(duration: Duration) -\u003e impl Fn(\u0026Game) -\u003e bool {\n    let threshold = Utc::now().checked_sub_signed(duration).unwrap();\n    move |game: \u0026Game| match game.admin_id() {\n        Some(_) =\u003e false,\n        None =\u003e game.last_action_time().lt(\u0026threshold),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::execute_cleanup_games;\n    use crate::{\n        db::{Client, Database},\n        model::Game,\n    };\n    use chrono::Duration;\n\n    fn init_client() -\u003e Client\u003cGame\u003e {\n        let mut repo = Database::init(\"games\");\n\n        let sender = repo.sender();\n        tokio::task::spawn(async move {\n            repo.start_listening().await;\n        });\n\n        let client = Client::new(sender);\n\n        client\n    }\n\n    #[tokio::test]\n    async fn should_cleanup_games() {\n        let client = init_client();\n        let mut game = Game::new(\"admin\", \"TOKEN\");\n        game.remove_player(\"admin\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_none());\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n\n        let res = execute_cleanup_games(\u0026client, Duration::nanoseconds(1)).await;\n        assert!(res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_none());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_games_with_admin() {\n        let client = init_client();\n        let game = Game::new(\"admin\", \"TOKEN\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_some());\n\n        let res = execute_cleanup_games(\u0026client, Duration::nanoseconds(1)).await;\n        assert!(!res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_games_with_recent_action() {\n        let client = init_client();\n        let mut game = Game::new(\"admin\", \"TOKEN\");\n        game.remove_player(\"admin\");\n        client.persist(\u0026game).await.expect(\"Game persist failed\");\n        assert!(client\n            .get(\"TOKEN\")\n            .await\n            .unwrap()\n            .unwrap()\n            .admin_id()\n            .is_none());\n\n        let res = execute_cleanup_games(\u0026client, Duration::minutes(5)).await;\n        assert!(!res);\n\n        assert!(client.get(\"TOKEN\").await.unwrap().is_some());\n    }\n}\n","traces":[{"line":5,"address":[4736288],"length":1,"stats":{"Line":0},"fn_name":"cleanup_games"},{"line":6,"address":[4736297],"length":1,"stats":{"Line":0},"fn_name":null},{"line":7,"address":[5716192,5716278,5716300,5716207],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":8,"address":[5716262],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[5813553,5813520],"length":1,"stats":{"Line":8},"fn_name":"execute_cleanup_games"},{"line":14,"address":[5774879],"length":1,"stats":{"Line":10},"fn_name":null},{"line":15,"address":[5989294],"length":1,"stats":{"Line":2},"fn_name":null},{"line":19,"address":[5989972,5990035],"length":1,"stats":{"Line":6},"fn_name":null},{"line":20,"address":[5990477,5990046,5991898],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[5990318,5990252,5990365,5990462,5990119],"length":1,"stats":{"Line":8},"fn_name":null},{"line":22,"address":[5990469],"length":1,"stats":{"Line":2},"fn_name":null},{"line":24,"address":[4772997],"length":1,"stats":{"Line":6},"fn_name":null},{"line":25,"address":[5244867],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[5245325,5244962,5245086,5245125,5245166],"length":1,"stats":{"Line":4},"fn_name":null},{"line":27,"address":[5245366],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[5244884],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[5245586,5245515,5245745,5245556,5244916,5245462,5245379,5245833],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[5245582],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[5245874],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[5813616],"length":1,"stats":{"Line":2},"fn_name":"is_inactive_game"},{"line":42,"address":[5813632],"length":1,"stats":{"Line":2},"fn_name":null},{"line":43,"address":[5246707,5246768,5246801,5246775,5246688],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}"},{"line":44,"address":[5246731,5246770],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[5246756,5246786],"length":1,"stats":{"Line":2},"fn_name":null},{"line":58,"address":[6314096,6314170],"length":1,"stats":{"Line":2},"fn_name":"init_client"},{"line":59,"address":[6314113],"length":1,"stats":{"Line":2},"fn_name":null},{"line":61,"address":[6314198],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[5782831,5782816,5782902,5782953],"length":1,"stats":{"Line":11},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":63,"address":[5782886],"length":1,"stats":{"Line":12},"fn_name":null},{"line":66,"address":[6314398],"length":1,"stats":{"Line":2},"fn_name":null},{"line":71,"address":[5752078,5752042,5752009,5751877,5751856,5752103,5752160,5752133],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":73,"address":[6194766],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[6194781],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[6194838],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[5751993],"length":1,"stats":{"Line":5},"fn_name":null},{"line":77,"address":[5752062],"length":1,"stats":{"Line":7},"fn_name":null},{"line":84,"address":[5752087],"length":1,"stats":{"Line":5},"fn_name":null},{"line":86,"address":[5752117],"length":1,"stats":{"Line":5},"fn_name":null},{"line":87,"address":[6197191,6197150],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[5752144],"length":1,"stats":{"Line":5},"fn_name":null},{"line":92,"address":[5798648,5798464,5798615,5798735,5798485,5798708,5798681],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":94,"address":[6199150],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[6199165],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5798599],"length":1,"stats":{"Line":5},"fn_name":null},{"line":97,"address":[5798665],"length":1,"stats":{"Line":7},"fn_name":null},{"line":105,"address":[5798692],"length":1,"stats":{"Line":5},"fn_name":null},{"line":106,"address":[6200771,6200814],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5798719],"length":1,"stats":{"Line":5},"fn_name":null},{"line":111,"address":[5761495,5761588,5761615,5761365,5761344,5761528,5761561],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":113,"address":[6202574],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[6202589],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[6202640],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[5761479],"length":1,"stats":{"Line":5},"fn_name":null},{"line":117,"address":[5761545],"length":1,"stats":{"Line":7},"fn_name":null},{"line":125,"address":[5761572],"length":1,"stats":{"Line":5},"fn_name":null},{"line":126,"address":[6204231,6204274],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[5761599],"length":1,"stats":{"Line":5},"fn_name":null}],"covered":49,"coverable":57},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","cleanup_players.rs"],"content":"use crate::{model::Player, server::app_context::AppContext};\nuse chrono::{Duration, Utc};\nuse log::{debug, info, warn};\n\npub fn cleanup_players(ctx: \u0026'static AppContext) -\u003e impl Fn() {\n    move || {\n        tokio::spawn(async move {\n            execute_cleanup_players(ctx, Duration::minutes(1)).await;\n        });\n    }\n}\n\n// Player is active after one minute without an active connection\nfn is_inactive_player(duration: Duration) -\u003e impl Fn(\u0026Player) -\u003e bool {\n    let threshold = Utc::now().checked_sub_signed(duration).unwrap();\n\n    move |player: \u0026Player| player.last_action_time().lt(\u0026threshold)\n}\n\nasync fn execute_cleanup_players(ctx: \u0026AppContext, duration: Duration) -\u003e bool {\n    let inactive_players = ctx\n        .db()\n        .players()\n        .scan(Box::new(is_inactive_player(duration)))\n        .await\n        .expect(\"Scanning players has failed\");\n    let inactive_count = inactive_players.len();\n\n    // remove players from maybe existing game\n    for id in inactive_players.clone() {\n        let player = ctx.db().players().get(\u0026id).await;\n        if let Some(player) = player.expect(\"Reading player has failed\") {\n            let game = ctx.db().games().get(player.game_token()).await;\n            if let Some(mut game) = game.expect(\"Reading game has failed\") {\n                game.remove_player(\u0026id);\n                if let Err(_) = ctx.db().games().persist(\u0026game).await {\n                    warn!(\"Removing player has failed\");\n                }\n            }\n        }\n    }\n\n    // remove players\n    if inactive_count \u003e 0 {\n        match ctx.db().players().remove_batch(\u0026inactive_players).await {\n            Ok(_) =\u003e {\n                info!(\"Removed {} inactive players\", inactive_count);\n                true\n            }\n            Err(e) =\u003e {\n                warn!(\n                    \"Removing {} inactive players has failed: {:?}\",\n                    inactive_count, e\n                );\n                false\n            }\n        }\n    } else {\n        debug!(\"Removed no inactive players\");\n        false\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::execute_cleanup_players;\n    use crate::{\n        model::{Game, Player},\n        server::app_context::AppContext,\n    };\n    use chrono::Duration;\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_cleanup_player() {\n        let ctx = init_ctx();\n        let player = Player::new(\"GAME\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Persisting player failed\");\n        let game = Game::new(player.id(), \"GAME\");\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Persisting game failed\");\n\n        let res = execute_cleanup_players(\u0026ctx, Duration::nanoseconds(1)).await;\n        assert!(res);\n\n        assert!(ctx.db().players().get(player.id()).await.unwrap().is_none());\n        assert!(ctx\n            .db()\n            .games()\n            .get(player.game_token())\n            .await\n            .unwrap()\n            .expect(\"Game should still exist\")\n            .admin_id()\n            .is_none());\n    }\n\n    #[tokio::test]\n    async fn should_not_cleanup_player() {\n        let ctx = init_ctx();\n        let player = Player::new(\"GAME\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Persisting player failed\");\n\n        let res = execute_cleanup_players(\u0026ctx, Duration::minutes(1)).await;\n        assert!(!res);\n\n        assert!(ctx.db().players().get(player.id()).await.unwrap().is_some());\n    }\n}\n","traces":[{"line":5,"address":[6677584],"length":1,"stats":{"Line":0},"fn_name":"cleanup_players"},{"line":6,"address":[5979840],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":7,"address":[5979223,5979674,5979855,5979346,5979200],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":8,"address":[5979516,5979451,5979286,5979659,5979375],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[4933056],"length":1,"stats":{"Line":1},"fn_name":"is_inactive_player"},{"line":15,"address":[6677632],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[6677796],"length":1,"stats":{"Line":3},"fn_name":null},{"line":20,"address":[4829059,4828553,4828432,4828750,4828670,4828860,4828453,4828963,4828821],"length":1,"stats":{"Line":6},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":21,"address":[4828533],"length":1,"stats":{"Line":7},"fn_name":null},{"line":24,"address":[6775350],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[6776149,6776082],"length":1,"stats":{"Line":4},"fn_name":null},{"line":30,"address":[6776232,6776273,6776315,6776160,6779964,6776343,6776461],"length":1,"stats":{"Line":11},"fn_name":null},{"line":31,"address":[4828650],"length":1,"stats":{"Line":5},"fn_name":null},{"line":32,"address":[6777611,6777308],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4828801],"length":1,"stats":{"Line":5},"fn_name":null},{"line":34,"address":[6778446,6778749],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[6778895],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[4828906],"length":1,"stats":{"Line":5},"fn_name":null},{"line":37,"address":[6779474,6779805,6779661,6779708,6779607],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[6779977,6782113],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4829008],"length":1,"stats":{"Line":6},"fn_name":null},{"line":46,"address":[6780497],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[6780592,6780973,6780814,6780767,6780725],"length":1,"stats":{"Line":4},"fn_name":null},{"line":48,"address":[6781014],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[6780514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[6781027,6781204,6781234,6781163,6780546,6781393,6781481,6781110],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[6781230],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[6781522],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[6781554,6779984,6781812,6781715,6781674,6781637],"length":1,"stats":{"Line":4},"fn_name":null},{"line":60,"address":[6781819],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6961920],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":74,"address":[6961928],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[5785658,5785493,5785819,5785625,5785794,5785717,5785767,5785740,5785472],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":79,"address":[5534990],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[5535005],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[5538340,5535039,5535085,5535156,5535216,5535271,5535345],"length":1,"stats":{"Line":6},"fn_name":null},{"line":83,"address":[5535136],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[5535544,5535587],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[5535749,5535645,5535938,5535673,5535809,5538361,5535864],"length":1,"stats":{"Line":6},"fn_name":null},{"line":89,"address":[5535727],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[5538382,5536318,5536398,5536208,5536230,5536150],"length":1,"stats":{"Line":5},"fn_name":null},{"line":94,"address":[5536535,5536561],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5536604,5536633,5538403,5536699,5537335,5536791,5536856,5536549,5537262],"length":1,"stats":{"Line":6},"fn_name":null},{"line":97,"address":[5538089,5537565,5538111,5537630,5537454,5538424,5538067,5537323,5537473,5538181,5537378],"length":1,"stats":{"Line":8},"fn_name":null},{"line":100,"address":[5537407],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5539559,5539509,5541536,5541395,5539536,5539504],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":110,"address":[5539640],"length":1,"stats":{"Line":1},"fn_name":null},{"line":111,"address":[5539655],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[5541479,5539983,5539735,5539918,5539866,5539806,5539689],"length":1,"stats":{"Line":6},"fn_name":null},{"line":114,"address":[5539786],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[5540192,5540235,5540407,5540257,5541500,5540342],"length":1,"stats":{"Line":5},"fn_name":null},{"line":119,"address":[5540538,5540566],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[5540638,5540554,5541267,5540796,5541521,5540861,5540704,5541342,5540609],"length":1,"stats":{"Line":6},"fn_name":null}],"covered":44,"coverable":53},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","jobs","mod.rs"],"content":"mod cleanup_games;\nmod cleanup_players;\n\nuse self::cleanup_games::cleanup_games;\nuse self::cleanup_players::cleanup_players;\nuse crate::server::app_context::AppContext;\nuse clokwerk::{Scheduler, TimeUnits};\nuse std::{thread, time::Duration};\n\nconst JOB_INTERVAL: u32 = 60;\n\npub fn init_jobs(ctx: \u0026'static AppContext) {\n    tokio::task::spawn(async move {\n        let mut scheduler = Scheduler::new();\n\n        scheduler\n            .every(JOB_INTERVAL.seconds())\n            .run(cleanup_games(ctx));\n        scheduler\n            .every(JOB_INTERVAL.seconds())\n            .run(cleanup_players(ctx));\n\n        loop {\n            scheduler.run_pending();\n            thread::sleep(Duration::from_millis(100));\n        }\n    });\n}\n","traces":[{"line":12,"address":[5833488],"length":1,"stats":{"Line":0},"fn_name":"init_jobs"},{"line":13,"address":[5833497],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[6452151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[6452191,6452260],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[6452167],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[6452245],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[6452362,6452309],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[6452283],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[6452347],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[6452385,6452455],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[6452389],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[6452433,6452415],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":12},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","lib.rs"],"content":"use jobs::init_jobs;\nuse server::{app_context::AppContext, run_server};\nuse tokio::runtime::Builder;\n\nmod config;\npub mod db;\npub mod jobs;\npub mod model;\npub mod server;\n\nextern crate chrono;\nextern crate envconfig;\nextern crate log;\n\n#[macro_use]\nextern crate derivative;\n\npub fn run_app() {\n    let mut rt = Builder::new()\n        .threaded_scheduler()\n        .enable_all()\n        .thread_name(\"sc\")\n        .build()\n        .expect(\"Creating runtime failed\");\n\n    rt.block_on(async {\n        let ctx: \u0026'static AppContext = Box::leak(Box::new(AppContext::init()));\n\n        init_jobs(ctx);\n\n        run_server(\u0026ctx).await;\n    });\n}\n","traces":[{"line":18,"address":[4498192,4498215],"length":1,"stats":{"Line":0},"fn_name":"run_app"},{"line":19,"address":[4498230,4498199,4498291],"length":1,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[4498424],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[6785006,6784971,6784865],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[6785009],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[4793558],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","model","game.rs"],"content":"use crate::db::Persist;\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sled::IVec;\nuse std::{collections::HashSet, convert::TryFrom};\n\n#[derive(Serialize, Deserialize, Clone, PartialEq, Eq, Debug)]\npub struct Game {\n    token: String,\n    creation_time: DateTime\u003cUtc\u003e,\n    last_action_time: DateTime\u003cUtc\u003e,\n    admin_id: Option\u003cString\u003e,\n    player_ids: HashSet\u003cString\u003e,\n}\n\nimpl Game {\n    pub fn new(admin_id: \u0026str, token: \u0026str) -\u003e Self {\n        Game {\n            token: String::from(token).to_uppercase(),\n            creation_time: Utc::now(),\n            last_action_time: Utc::now(),\n            admin_id: Some(String::from(admin_id)),\n            player_ids: HashSet::new(),\n        }\n    }\n\n    pub fn token(\u0026self) -\u003e \u0026str {\n        \u0026self.token\n    }\n\n    pub fn player_ids(\u0026self) -\u003e \u0026HashSet\u003cString\u003e {\n        \u0026self.player_ids\n    }\n\n    pub fn admin_id(\u0026self) -\u003e \u0026Option\u003cString\u003e {\n        \u0026self.admin_id\n    }\n\n    pub fn last_action_time(\u0026self) -\u003e \u0026DateTime\u003cUtc\u003e {\n        \u0026self.last_action_time\n    }\n\n    pub fn add_player(\u0026mut self, player_id: \u0026str) {\n        match self.admin_id {\n            Some(_) =\u003e {\n                self.player_ids.insert(String::from(player_id));\n            }\n            None =\u003e self.admin_id = Some(String::from(player_id)),\n        }\n    }\n\n    pub fn remove_player(\u0026mut self, player_id: \u0026str) {\n        if self.player_ids.contains(player_id) {\n            self.player_ids.remove(player_id);\n        } else if self\n            .admin_id\n            .to_owned()\n            .filter(|id| id == player_id)\n            .is_some()\n        {\n            if let Some(next_player_id) = self.player_ids.iter().next().map(String::from) {\n                self.admin_id = Some(String::from(\u0026next_player_id));\n                self.player_ids.remove(\u0026next_player_id);\n            } else {\n                // abandon game as admin is the last player\n                self.admin_id = None;\n            }\n        } else {\n            // game is already abandoned or requesting user is no admin or player\n        }\n    }\n\n    pub fn start(\u0026mut self) {}\n}\n\nimpl Persist for Game {\n    fn id(\u0026self) -\u003e \u0026str {\n        self.token()\n    }\n}\n\nimpl Into\u003cIVec\u003e for Game {\n    fn into(self) -\u003e IVec {\n        IVec::from(bincode::serialize(\u0026self).unwrap())\n    }\n}\n\nimpl TryFrom\u003cIVec\u003e for Game {\n    type Error = bincode::Error;\n    fn try_from(bytes: IVec) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let vec: Vec\u003cu8\u003e = bytes.to_vec();\n\n        bincode::deserialize(\u0026vec)\n    }\n}\n","traces":[{"line":17,"address":[6872288,6872371],"length":1,"stats":{"Line":5},"fn_name":"new"},{"line":19,"address":[6013386,6013447],"length":1,"stats":{"Line":10},"fn_name":null},{"line":20,"address":[6013503],"length":1,"stats":{"Line":5},"fn_name":null},{"line":21,"address":[6013618,6013581],"length":1,"stats":{"Line":12},"fn_name":null},{"line":22,"address":[6013688],"length":1,"stats":{"Line":6},"fn_name":null},{"line":23,"address":[6013727],"length":1,"stats":{"Line":6},"fn_name":null},{"line":27,"address":[6014000],"length":1,"stats":{"Line":1},"fn_name":"token"},{"line":28,"address":[6014009],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[6014048],"length":1,"stats":{"Line":1},"fn_name":"player_ids"},{"line":32,"address":[6014053],"length":1,"stats":{"Line":2},"fn_name":null},{"line":35,"address":[6014080],"length":1,"stats":{"Line":2},"fn_name":"admin_id"},{"line":36,"address":[6014085],"length":1,"stats":{"Line":2},"fn_name":null},{"line":39,"address":[6014112],"length":1,"stats":{"Line":1},"fn_name":"last_action_time"},{"line":40,"address":[6014117],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[6014357,6014144],"length":1,"stats":{"Line":1},"fn_name":"add_player"},{"line":44,"address":[6014229,6014404,6014281],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[6014169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[6014236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[6014283,6014334,6014372,6014207],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[6014432,6014504],"length":1,"stats":{"Line":1},"fn_name":"remove_player"},{"line":53,"address":[6015010,6014523,6014457,6014586],"length":1,"stats":{"Line":4},"fn_name":null},{"line":54,"address":[6014561],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[6015262,6014534,6014601,6014673],"length":1,"stats":{"Line":4},"fn_name":null},{"line":56,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[6014591],"length":1,"stats":{"Line":3},"fn_name":null},{"line":61,"address":[6015005,6014689,6014818],"length":1,"stats":{"Line":3},"fn_name":null},{"line":62,"address":[6014871,6015150],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[6015225],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[6015020,6014780],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6015440,6015447,6015445],"length":1,"stats":{"Line":0},"fn_name":"start"},{"line":77,"address":[6015456],"length":1,"stats":{"Line":1},"fn_name":"id"},{"line":78,"address":[6015465],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[6015545,6015504],"length":1,"stats":{"Line":6},"fn_name":"into"},{"line":84,"address":[6015511,6015557,6015598],"length":1,"stats":{"Line":18},"fn_name":null},{"line":90,"address":[6015732,6015664],"length":1,"stats":{"Line":4},"fn_name":"try_from"},{"line":91,"address":[6015676],"length":1,"stats":{"Line":3},"fn_name":null},{"line":93,"address":[6015757],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":34,"coverable":37},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","model","player.rs"],"content":"use crate::db::Persist;\nuse chrono::{DateTime, Utc};\nuse names::Generator;\nuse nanoid::nanoid;\nuse serde::{Deserialize, Serialize};\nuse sled::IVec;\nuse std::hash::Hash;\n\nfn generate_random_name() -\u003e String {\n    Generator::default().next().unwrap()\n}\n\n#[derive(Serialize, Deserialize, Clone, Hash, PartialEq, Eq, Derivative)]\n#[derivative(Debug)]\npub struct Player {\n    id: String,\n    name: String,\n    game_token: String,\n    #[derivative(Debug = \"ignore\")]\n    user_token: String,\n    creation_time: DateTime\u003cUtc\u003e,\n    last_action_time: DateTime\u003cUtc\u003e,\n}\n\nimpl Player {\n    pub fn new(game_token: \u0026str) -\u003e Self {\n        Player {\n            id: nanoid!(),\n            name: generate_random_name(),\n            game_token: String::from(game_token),\n            user_token: String::from(\"\"),\n            creation_time: Utc::now(),\n            last_action_time: Utc::now(),\n        }\n    }\n\n    pub fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    pub fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    pub fn set_name(\u0026mut self, name: \u0026str) {\n        if !name.is_empty() {\n            self.name = String::from(name);\n        }\n    }\n\n    pub fn game_token(\u0026self) -\u003e \u0026str {\n        \u0026self.game_token\n    }\n\n    pub fn update_token(\u0026mut self, new_token: \u0026str) {\n        self.user_token = String::from(new_token);\n    }\n\n    pub fn heartbeat(\u0026mut self) {\n        self.last_action_time = Utc::now();\n    }\n\n    pub fn last_action_time(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.last_action_time\n    }\n}\n\nimpl Persist for Player {\n    fn id(\u0026self) -\u003e \u0026str {\n        self.id()\n    }\n}\n\nimpl Into\u003cIVec\u003e for Player {\n    fn into(self) -\u003e IVec {\n        IVec::from(bincode::serialize(\u0026self).unwrap())\n    }\n}\n\nimpl From\u003cIVec\u003e for Player {\n    fn from(bytes: IVec) -\u003e Player {\n        let vec: Vec\u003cu8\u003e = bytes.to_vec();\n        bincode::deserialize(\u0026vec).unwrap()\n    }\n}\n","traces":[{"line":9,"address":[4528496],"length":1,"stats":{"Line":2},"fn_name":"generate_random_name"},{"line":10,"address":[5182391],"length":1,"stats":{"Line":2},"fn_name":null},{"line":26,"address":[5182480,5182573],"length":1,"stats":{"Line":2},"fn_name":"new"},{"line":28,"address":[5182520],"length":1,"stats":{"Line":2},"fn_name":null},{"line":29,"address":[5182593],"length":1,"stats":{"Line":2},"fn_name":null},{"line":30,"address":[5182615],"length":1,"stats":{"Line":2},"fn_name":null},{"line":31,"address":[5182635],"length":1,"stats":{"Line":2},"fn_name":null},{"line":32,"address":[5182713,5182674],"length":1,"stats":{"Line":4},"fn_name":null},{"line":33,"address":[4528919,4528877],"length":1,"stats":{"Line":4},"fn_name":null},{"line":37,"address":[4529248],"length":1,"stats":{"Line":2},"fn_name":"id"},{"line":38,"address":[4529257],"length":1,"stats":{"Line":2},"fn_name":null},{"line":41,"address":[5183184],"length":1,"stats":{"Line":2},"fn_name":"name"},{"line":42,"address":[5183193],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[5183364,5183232],"length":1,"stats":{"Line":1},"fn_name":"set_name"},{"line":46,"address":[5183256,5183408],"length":1,"stats":{"Line":2},"fn_name":null},{"line":47,"address":[5183376,5183341,5183293],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[5183424],"length":1,"stats":{"Line":2},"fn_name":"game_token"},{"line":52,"address":[5183433],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[4529584,4529664],"length":1,"stats":{"Line":1},"fn_name":"update_token"},{"line":56,"address":[4529603,4529676],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[4529728],"length":1,"stats":{"Line":1},"fn_name":"heartbeat"},{"line":60,"address":[4529737],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4529808],"length":1,"stats":{"Line":1},"fn_name":"last_action_time"},{"line":64,"address":[4529817],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[4529856],"length":1,"stats":{"Line":1},"fn_name":"id"},{"line":70,"address":[4529865],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4529904,4529945],"length":1,"stats":{"Line":1},"fn_name":"into"},{"line":76,"address":[4529911,4529957,4529998],"length":1,"stats":{"Line":3},"fn_name":null},{"line":81,"address":[4530064,4530135],"length":1,"stats":{"Line":1},"fn_name":"from"},{"line":82,"address":[4530079],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[4530163,4530228],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":31,"coverable":31},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","app_context.rs"],"content":"use super::logger::init_logger;\nuse crate::{\n    config::AppConfig,\n    db::{Client, Database},\n    model::{Game, Player},\n};\nuse envconfig::Envconfig;\n\npub struct DbClients {\n    games: Client\u003cGame\u003e,\n    players: Client\u003cPlayer\u003e,\n}\n\nimpl DbClients {\n    pub fn init() -\u003e DbClients {\n        let mut games_repo = Database::init(\"games\");\n        let games_sender = games_repo.sender();\n        tokio::task::spawn(async move {\n            games_repo.start_listening().await;\n        });\n        let mut players_repo = Database::init(\"players\");\n        let players_sender = players_repo.sender();\n        tokio::task::spawn(async move {\n            players_repo.start_listening().await;\n        });\n\n        DbClients {\n            games: Client::new(games_sender),\n            players: Client::new(players_sender),\n        }\n    }\n\n    pub fn games(\u0026self) -\u003e \u0026Client\u003cGame\u003e {\n        \u0026self.games\n    }\n\n    pub fn players(\u0026self) -\u003e \u0026Client\u003cPlayer\u003e {\n        \u0026self.players\n    }\n}\n\npub struct AppContext {\n    db: DbClients,\n    config: AppConfig,\n}\n\nimpl AppContext {\n    pub fn init() -\u003e AppContext {\n        let config = AppConfig::init_from_env().expect(\"Loading server config failed\");\n\n        init_logger(\u0026config);\n\n        let db = DbClients::init();\n\n        AppContext { db, config }\n    }\n\n    pub fn db(\u0026self) -\u003e \u0026DbClients {\n        \u0026self.db\n    }\n\n    pub fn config(\u0026self) -\u003e \u0026AppConfig {\n        \u0026self.config\n    }\n\n    pub fn is_dev(\u0026self) -\u003e bool {\n        cfg!(debug_assertions)\n    }\n}\n","traces":[{"line":15,"address":[4522107,4522016],"length":1,"stats":{"Line":1},"fn_name":"init"},{"line":16,"address":[6330321],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[4522122],"length":1,"stats":{"Line":2},"fn_name":null},{"line":18,"address":[6330437],"length":1,"stats":{"Line":8},"fn_name":null},{"line":19,"address":[5222906,5223160,5222854,5223020,5222801,5222950],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[6330622],"length":1,"stats":{"Line":2},"fn_name":null},{"line":22,"address":[4522386],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[5778505,5778454,5778383,5778368],"length":1,"stats":{"Line":7},"fn_name":"drop_in_place\u003cgenerator-1\u003e"},{"line":24,"address":[5778438],"length":1,"stats":{"Line":6},"fn_name":null},{"line":28,"address":[6330889],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4522697],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[6331392],"length":1,"stats":{"Line":1},"fn_name":"games"},{"line":34,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[4523168],"length":1,"stats":{"Line":1},"fn_name":"players"},{"line":38,"address":[4523173],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[4523236,4523200],"length":1,"stats":{"Line":1},"fn_name":"init"},{"line":49,"address":[4523265,4523210],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[4523307],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[4523314],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[4523536],"length":1,"stats":{"Line":1},"fn_name":"db"},{"line":59,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[4523552],"length":1,"stats":{"Line":1},"fn_name":"config"},{"line":63,"address":[4523557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[4523584],"length":1,"stats":{"Line":0},"fn_name":"is_dev"}],"covered":21,"coverable":24},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","auth.rs"],"content":"use super::app_context::AppContext;\nuse crate::model::Player;\nuse hmac::{Hmac, NewMac};\nuse jwt::{AlgorithmType, Error, Header, SignWithKey, Token, VerifyWithKey};\nuse sha2::Sha256;\nuse std::collections::BTreeMap;\nuse std::result::Result;\n\npub fn generate_jwt_token(player: \u0026Player, secret: \u0026str) -\u003e String {\n    let key = init_key(secret);\n    let header = Header {\n        algorithm: AlgorithmType::Hs256,\n        ..Default::default()\n    };\n    let mut claims = BTreeMap::new();\n    claims.insert(String::from(\"sub\"), String::from(player.id()));\n    claims.insert(String::from(\"name\"), String::from(player.name()));\n    claims.insert(String::from(\"game\"), String::from(player.game_token()));\n\n    let jwt_token = Token::new(header, claims).sign_with_key(\u0026key).unwrap();\n\n    String::from(jwt_token.as_str())\n}\n\npub fn extract_verified_token(\n    token_str: \u0026str,\n    secret: \u0026str,\n) -\u003e Result\u003cToken\u003cHeader, BTreeMap\u003cString, String\u003e, jwt::token::Verified\u003e, Error\u003e {\n    let key = init_key(secret);\n    let raw_token: \u0026str = \u0026token_str.replace(\"Bearer \", \"\");\n    let token: Result\u003cToken\u003cHeader, BTreeMap\u003cString, String\u003e, jwt::token::Verified\u003e, Error\u003e =\n        VerifyWithKey::verify_with_key(raw_token, \u0026key);\n\n    token\n}\n\npub fn extract_verified_id(authorization: \u0026str, ctx: \u0026AppContext) -\u003e Option\u003cString\u003e {\n    extract_verified_token(\u0026authorization, \u0026ctx.config().auth_secret)\n        .ok()\n        .and_then(|token| token.claims().get(\"sub\").map(String::from))\n}\n\nfn init_key(secret: \u0026str) -\u003e Hmac\u003cSha256\u003e {\n    Hmac::new_varkey(secret.as_bytes()).unwrap()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{extract_verified_id, extract_verified_token, generate_jwt_token};\n    use crate::{model::Player, server::app_context::AppContext};\n\n    const SECRET: \u0026str = \"super-secret\";\n\n    #[test]\n    fn should_create_token() {\n        let player = Player::new(\"game\");\n        let token = generate_jwt_token(\u0026player, SECRET);\n\n        // payload contains dynamic ID of user, so we can't check the payload for equalness\n        assert!(token.starts_with(\"eyJhbGciOiJIUzI1NiJ9\"));\n    }\n\n    #[test]\n    fn should_verify_token() {\n        let token = extract_verified_token(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX4\", \"super-secret\");\n\n        assert_eq!(token.unwrap().claims().get(\"name\").unwrap(), \"Random Dude\");\n    }\n\n    #[tokio::test]\n    async fn should_extract_verified_id() {\n        let ctx = AppContext::init();\n        let id = extract_verified_id(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX4\", \u0026ctx);\n\n        assert_eq!(id.unwrap(), \"MllJ7oeCY4RGw2M6tIHBZ\");\n    }\n\n    #[tokio::test]\n    async fn should_not_extract_unverified_id() {\n        let ctx = AppContext::init();\n        let id = extract_verified_id(\"eyJhbGciOiJIUzI1NiJ9.eyJnYW1lIjoiZ2FtZSIsIm5hbWUiOiJSYW5kb20gRHVkZSIsInN1YiI6Ik1sbEo3b2VDWTRSR3cyTTZ0SUhCWiJ9.LD1Z9u9G9LFUtqweQCikRi0NQs8SVF6Ri9f3weCKCX3\", \u0026ctx);\n\n        assert!(id.is_none());\n    }\n\n    #[test]\n    fn should_create_and_verify_token() {\n        let player = Player::new(\"game\");\n        let token_str = generate_jwt_token(\u0026player, SECRET);\n        let token = extract_verified_token(\u0026token_str, SECRET);\n        assert!(!token.unwrap().claims().get(\"name\").unwrap().is_empty());\n    }\n\n    #[test]\n    fn should_fail_to_verify_token() {\n        let token = extract_verified_token(\"eyJhbGciOiJIUzI1NiJ9.XYZ.ABC\", \"super-secret\");\n\n        assert!(token.is_err());\n    }\n}\n","traces":[{"line":9,"address":[6592670,6592560],"length":1,"stats":{"Line":2},"fn_name":"generate_jwt_token"},{"line":10,"address":[6592594],"length":1,"stats":{"Line":2},"fn_name":null},{"line":15,"address":[6592788],"length":1,"stats":{"Line":2},"fn_name":null},{"line":16,"address":[4395094,4395913],"length":1,"stats":{"Line":2},"fn_name":null},{"line":17,"address":[4395258,4395949],"length":1,"stats":{"Line":2},"fn_name":null},{"line":18,"address":[6593162,6593763],"length":1,"stats":{"Line":2},"fn_name":null},{"line":20,"address":[6593326],"length":1,"stats":{"Line":2},"fn_name":null},{"line":22,"address":[6593507],"length":1,"stats":{"Line":2},"fn_name":null},{"line":25,"address":[6593920,6594003],"length":1,"stats":{"Line":1},"fn_name":"extract_verified_token"},{"line":29,"address":[6593962],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[6594029],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[6594136],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[6594256],"length":1,"stats":{"Line":1},"fn_name":"extract_verified_id"},{"line":38,"address":[6594284],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[6677943,6677936],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":43,"address":[6594448],"length":1,"stats":{"Line":2},"fn_name":"init_key"},{"line":44,"address":[6594541],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[6075490,6075456],"length":1,"stats":{"Line":3},"fn_name":"should_create_token"},{"line":56,"address":[6075470],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[6075505],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[6075631,6075574,6075545,6075656],"length":1,"stats":{"Line":3},"fn_name":null},{"line":64,"address":[6075760,6075810],"length":1,"stats":{"Line":3},"fn_name":"should_verify_token"},{"line":65,"address":[6075781],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[6075832],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[6076487,6076480],"length":1,"stats":{"Line":7},"fn_name":"should_extract_verified_id"},{"line":72,"address":[6763268],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[6763275],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[6763307,6763486,6763831,6763512,6763742,6763394],"length":1,"stats":{"Line":4},"fn_name":null},{"line":78,"address":[6076807,6076800],"length":1,"stats":{"Line":7},"fn_name":"should_not_extract_unverified_id"},{"line":80,"address":[6764308],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[6764315],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[6764349,6764378,6764419],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[6077154,6077120],"length":1,"stats":{"Line":3},"fn_name":"should_create_and_verify_token"},{"line":88,"address":[6077134],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[6077169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[6077209,6077238],"length":1,"stats":{"Line":2},"fn_name":null},{"line":91,"address":[6077292,6077545],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[6077664,6077708],"length":1,"stats":{"Line":3},"fn_name":"should_fail_to_verify_token"},{"line":96,"address":[6077682],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[6077772,6077725],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":40,"coverable":40},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","endpoints","games.rs"],"content":"use crate::{\n    model::{Game, Player},\n    server::{\n        app_context::AppContext, auth::extract_verified_id, auth::generate_jwt_token,\n        errors::reply_with_error,\n    },\n};\nuse log::debug;\nuse rand::{distributions::Alphanumeric, thread_rng, Rng};\nuse serde::Serialize;\nuse std::{convert::Infallible, iter};\nuse warp::hyper::StatusCode;\n\n// this value determines the findability of a game and is a tradeoff between security and user friendliness\n// 5 tokens mean a chance of finding a random game of 1:60466176.\nconst TOKEN_CHARS_COUNT: usize = 5;\n\npub async fn get_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match extract_verified_id(authorization, ctx) {\n        Some(token) =\u003e match ctx\n            .db()\n            .games()\n            .get(game_token)\n            .await\n            .expect(\"Reading game has failed\")\n        {\n            Some(game) =\u003e {\n                match ctx\n                    .db()\n                    .players()\n                    .get(\u0026token)\n                    .await\n                    .expect(\"Reading player has failed\")\n                    .filter(|player| {\n                        game.player_ids().contains(player.id())\n                            || game.admin_id().is_some()\n                                \u0026\u0026 game.admin_id().as_ref().unwrap() == player.id()\n                    }) {\n                    Some(mut player) =\u003e {\n                        player.heartbeat();\n                        ctx.db()\n                            .players()\n                            .persist(\u0026player)\n                            .await\n                            .expect(\"Persisting heartbeat has failed\");\n                        Ok(warp::reply::with_status(\n                            warp::reply::json(\u0026game),\n                            StatusCode::OK,\n                        ))\n                    }\n                    None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n                }\n            }\n            None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n        },\n        None =\u003e Ok(reply_with_error(StatusCode::UNAUTHORIZED)),\n    }\n}\n\npub async fn get_games_count_filter(ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    #[derive(Serialize)]\n    struct GetGamesResponse {\n        total: usize,\n    };\n\n    let total = ctx\n        .db()\n        .games()\n        .total_count()\n        .await\n        .expect(\"Reading games count has failed\");\n\n    Ok(warp::reply::with_status(\n        warp::reply::json(\u0026GetGamesResponse { total }),\n        StatusCode::OK,\n    ))\n}\n\npub async fn create_game_filter(ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    fn generate_game_token() -\u003e String {\n        let mut rng = thread_rng();\n\n        String::from_utf8(\n            iter::repeat(())\n                .map(|()| rng.sample(Alphanumeric).to_ascii_uppercase())\n                .take(TOKEN_CHARS_COUNT)\n                .collect(),\n        )\n        .unwrap()\n    }\n\n    let game_token = generate_game_token();\n    let player = create_new_player(\u0026game_token, ctx).await;\n    let new_game = create_new_game(player.id(), \u0026game_token, ctx).await;\n\n    #[derive(Serialize)]\n    struct CreateGameReponse {\n        game: Game,\n        admin: Player,\n    };\n\n    Ok(warp::reply::with_status(\n        warp::reply::json(\u0026CreateGameReponse {\n            game: new_game,\n            admin: player,\n        }),\n        StatusCode::CREATED,\n    ))\n}\n\npub async fn attend_game_filter(\n    game_token: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e {\n            let player = create_new_player(\u0026game_token, ctx).await;\n\n            game.add_player(player.id());\n            match ctx.db().games().persist(\u0026game).await {\n                Ok(_) =\u003e Ok(warp::reply::with_status(\n                    warp::reply::json(\u0026player),\n                    StatusCode::OK,\n                )),\n                Err(_) =\u003e Ok(reply_with_error(StatusCode::INTERNAL_SERVER_ERROR)),\n            }\n        }\n        None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n    }\n}\n\npub async fn leave_game_filter(\n    game_token: \u0026str,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match ctx\n        .db()\n        .games()\n        .get(\u0026game_token)\n        .await\n        .expect(\"Reading game has failed\")\n    {\n        Some(mut game) =\u003e match extract_verified_id(authorization, ctx) {\n            Some(player_id) =\u003e {\n                game.remove_player(\u0026player_id);\n                match ctx.db().games().persist(\u0026game).await {\n                    Ok(_) =\u003e Ok(reply_with_error(StatusCode::OK)),\n                    Err(_) =\u003e Ok(reply_with_error(StatusCode::INTERNAL_SERVER_ERROR)),\n                }\n            }\n            None =\u003e Ok(reply_with_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n    }\n}\n\nasync fn create_new_game(admin_id: \u0026str, token: \u0026str, ctx: \u0026AppContext) -\u003e Game {\n    let new_game = Game::new(admin_id, token);\n    let new_token = new_game.token();\n    ctx.db()\n        .games()\n        .persist(\u0026new_game)\n        .await\n        .expect(\"Creating game failed\");\n    debug!(\"Created game with token {}\", new_token);\n\n    new_game\n}\n\nasync fn create_new_player(game_token: \u0026str, ctx: \u0026AppContext) -\u003e Player {\n    let mut player = Player::new(game_token);\n    let user_token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n    player.update_token(\u0026user_token);\n\n    ctx.db()\n        .players()\n        .persist(\u0026player)\n        .await\n        .expect(\"Creating player failed\");\n    debug!(\"Created player with token {}\", player.id());\n\n    player\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{attend_game_filter, create_game_filter, get_game_filter, leave_game_filter};\n    use crate::{\n        model::{Game, Player},\n        server::{app_context::AppContext, auth::generate_jwt_token},\n    };\n    use warp::{hyper::StatusCode, Reply};\n\n    const GAME_TOKEN: \u0026str = \"ACDEF\";\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_not_get_game_unauthorized() {\n        let ctx = init_ctx();\n\n        let reply = get_game_filter(\"invalid\", \"auth\", \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n    }\n\n    #[tokio::test]\n    async fn should_not_get_unknown_game() {\n        let ctx = init_ctx();\n\n        let token = generate_jwt_token(\u0026Player::new(\"game\"), \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(\"game\", \u0026token, \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_get_game_for_admin() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        ctx.db()\n            .players()\n            .persist(\u0026admin)\n            .await\n            .expect(\"Writing player failed\");\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(admin.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_get_game_for_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(GAME_TOKEN);\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let mut game = Game::new(\"admin\", GAME_TOKEN);\n        game.add_player(player.id());\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_get_game_and_send_heartbeat() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n        let first_time = admin.last_action_time();\n        ctx.db()\n            .players()\n            .persist(\u0026admin)\n            .await\n            .expect(\"Writing admin failed\");\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(admin.id(), GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = get_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_admin = ctx\n            .db()\n            .players()\n            .get(admin.id())\n            .await\n            .expect(\"Reading admin failed\");\n        assert!(updated_admin.unwrap().last_action_time().gt(\u0026first_time));\n    }\n\n    #[tokio::test]\n    async fn should_create_new_game() {\n        let ctx = init_ctx();\n\n        let reply = create_game_filter(\u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::CREATED);\n    }\n\n    #[tokio::test]\n    async fn should_not_attend_unknown_game() {\n        let ctx = init_ctx();\n\n        let reply = attend_game_filter(\"test\", \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_attend_game() {\n        let ctx = init_ctx();\n\n        ctx.db()\n            .games()\n            .persist(\u0026Game::new(\"admin\", GAME_TOKEN))\n            .await\n            .expect(\"Writing game failed\");\n\n        let reply = attend_game_filter(GAME_TOKEN, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_leave_game() {\n        let ctx = init_ctx();\n\n        let mut game = Game::new(\"admin\", GAME_TOKEN);\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n        game.add_player(player.id());\n\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n        assert!(game.player_ids().contains(player.id()));\n\n        let reply = leave_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\");\n        assert!(!updated_game.unwrap().player_ids().contains(player.id()));\n    }\n\n    #[tokio::test]\n    async fn should_leave_game_and_select_new_admin() {\n        let ctx = init_ctx();\n\n        let admin = Player::new(GAME_TOKEN);\n        let mut game = Game::new(admin.id(), GAME_TOKEN);\n        let player = Player::new(GAME_TOKEN);\n        let token = generate_jwt_token(\u0026admin, \u0026ctx.config().auth_secret);\n        game.add_player(player.id());\n\n        ctx.db()\n            .games()\n            .persist(\u0026game)\n            .await\n            .expect(\"Writing game failed\");\n\n        assert_eq!(game.admin_id().as_ref().unwrap(), admin.id());\n\n        let reply = leave_game_filter(GAME_TOKEN, \u0026token, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n\n        let updated_game = ctx\n            .db()\n            .games()\n            .get(GAME_TOKEN)\n            .await\n            .expect(\"Couldnt find game\")\n            .unwrap();\n        assert!(updated_game.player_ids().is_empty());\n        assert_eq!(updated_game.admin_id().as_ref().unwrap(), player.id());\n    }\n}\n","traces":[{"line":18,"address":[4759792],"length":1,"stats":{"Line":1},"fn_name":"get_game_filter"},{"line":23,"address":[5197139,5197296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[5197538,5197396,5197216,5198106,5200227,5197486,5197608,5197306],"length":1,"stats":{"Line":6},"fn_name":null},{"line":31,"address":[5198048,5198116],"length":1,"stats":{"Line":2},"fn_name":null},{"line":32,"address":[5200248,5198327,5198533,5198222,5198463,5198373,5199073,5198964],"length":1,"stats":{"Line":7},"fn_name":null},{"line":35,"address":[5198303],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[5198942,5196624],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":39,"address":[5196816,5196730,5196644],"length":1,"stats":{"Line":5},"fn_name":null},{"line":40,"address":[5196781,5196947,5196692,5196837,5196960],"length":1,"stats":{"Line":8},"fn_name":"{{closure}}"},{"line":41,"address":[5196862,5196800],"length":1,"stats":{"Line":4},"fn_name":null},{"line":43,"address":[5199083,5199015],"length":1,"stats":{"Line":2},"fn_name":null},{"line":44,"address":[5199209],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4825159],"length":1,"stats":{"Line":8},"fn_name":null},{"line":47,"address":[5199314],"length":1,"stats":{"Line":2},"fn_name":null},{"line":50,"address":[5199798,5199759],"length":1,"stats":{"Line":3},"fn_name":null},{"line":51,"address":[5199726],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[5199046,5199863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[5198079,5199937],"length":1,"stats":{"Line":2},"fn_name":null},{"line":60,"address":[5197269,5200008],"length":1,"stats":{"Line":2},"fn_name":null},{"line":64,"address":[5201823,5201024,5201180,5201050],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":70,"address":[5201808,5201314,5201210,5201135,5201384],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[5201657,5201618],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[5201578],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[4759968,4759986],"length":1,"stats":{"Line":6},"fn_name":"create_game_filter"},{"line":84,"address":[4760032,4760065],"length":1,"stats":{"Line":1},"fn_name":"generate_game_token"},{"line":85,"address":[4760052],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4760104,4760080,4760141],"length":1,"stats":{"Line":3},"fn_name":null},{"line":89,"address":[4760096],"length":1,"stats":{"Line":3},"fn_name":null},{"line":96,"address":[5202202],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[4810417],"length":1,"stats":{"Line":5},"fn_name":null},{"line":98,"address":[4810501],"length":1,"stats":{"Line":6},"fn_name":null},{"line":106,"address":[5204107],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[5203776],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5203538],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[5203674],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[4760288],"length":1,"stats":{"Line":1},"fn_name":"attend_game_filter"},{"line":119,"address":[4837819],"length":1,"stats":{"Line":5},"fn_name":null},{"line":122,"address":[5205068],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[5205729,5205797],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[4837891],"length":1,"stats":{"Line":4},"fn_name":null},{"line":129,"address":[5206489],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[4837977],"length":1,"stats":{"Line":6},"fn_name":null},{"line":131,"address":[5207180,5207098,5207260],"length":1,"stats":{"Line":3},"fn_name":null},{"line":132,"address":[5207152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[5207328,5207115],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[5207474,5205760],"length":1,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[4760384],"length":1,"stats":{"Line":1},"fn_name":"leave_game_filter"},{"line":147,"address":[4801626],"length":1,"stats":{"Line":5},"fn_name":null},{"line":150,"address":[5208538],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[5209259,5209191,5209493],"length":1,"stats":{"Line":2},"fn_name":null},{"line":155,"address":[5209503,5209412],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[5209545],"length":1,"stats":{"Line":1},"fn_name":null},{"line":157,"address":[4801724],"length":1,"stats":{"Line":6},"fn_name":null},{"line":158,"address":[5210102,5210059],"length":1,"stats":{"Line":2},"fn_name":null},{"line":159,"address":[5210076,5210213],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[5210331,5209466],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[5210402,5209222],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[4760496,4760546],"length":1,"stats":{"Line":6},"fn_name":"create_new_game"},{"line":169,"address":[5211351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":170,"address":[5211511,5211421],"length":1,"stats":{"Line":2},"fn_name":null},{"line":171,"address":[4817932],"length":1,"stats":{"Line":6},"fn_name":null},{"line":173,"address":[5211607],"length":1,"stats":{"Line":1},"fn_name":null},{"line":176,"address":[5212213,5212012,5212378,5212138,5212172,5212055],"length":1,"stats":{"Line":4},"fn_name":null},{"line":178,"address":[5212427],"length":1,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[4760642,4760608],"length":1,"stats":{"Line":6},"fn_name":"create_new_player"},{"line":182,"address":[5213078],"length":1,"stats":{"Line":1},"fn_name":null},{"line":183,"address":[5213233,5213317,5213139],"length":1,"stats":{"Line":3},"fn_name":null},{"line":184,"address":[5213389],"length":1,"stats":{"Line":1},"fn_name":null},{"line":186,"address":[4785155],"length":1,"stats":{"Line":5},"fn_name":null},{"line":188,"address":[5213560],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[5214401,5214166,5214125,5213965,5214333,5214008,5214091],"length":1,"stats":{"Line":4},"fn_name":null},{"line":193,"address":[5214450],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[7050576],"length":1,"stats":{"Line":2},"fn_name":"init_ctx"},{"line":208,"address":[7050584],"length":1,"stats":{"Line":2},"fn_name":null},{"line":211,"address":[5660449,5659312,5659317,5659344,5660545,5659367],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":213,"address":[5659436],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[5659676,5660530,5659611,5659564,5659443],"length":1,"stats":{"Line":3},"fn_name":null},{"line":217,"address":[5659955,5660095,5660405,5659994,5660316],"length":1,"stats":{"Line":2},"fn_name":null},{"line":218,"address":[5659916,5659978,5659833,5659929],"length":1,"stats":{"Line":4},"fn_name":null},{"line":223,"address":[5660912,5660944,5660917,5662320,5662419,5660967],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":225,"address":[5661048],"length":1,"stats":{"Line":1},"fn_name":null},{"line":227,"address":[5661055,5661195,5661136,5661168],"length":1,"stats":{"Line":3},"fn_name":null},{"line":229,"address":[5662404,5661521,5661409,5661286,5661456,5661367],"length":1,"stats":{"Line":5},"fn_name":null},{"line":231,"address":[5661839,5661800,5661940,5662161,5662250],"length":1,"stats":{"Line":2},"fn_name":null},{"line":232,"address":[5661774,5661761,5661678,5661823],"length":1,"stats":{"Line":4},"fn_name":null},{"line":237,"address":[5662933,5662960,5665468,5665609,5662928,5662983],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":239,"address":[5663064],"length":1,"stats":{"Line":1},"fn_name":null},{"line":241,"address":[5663079],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[5663113,5665552,5663419,5663290,5663345,5663159,5663230],"length":1,"stats":{"Line":6},"fn_name":null},{"line":244,"address":[5663210],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[5663646,5665573,5663888,5663618,5663794,5663817,5663938,5664012],"length":1,"stats":{"Line":7},"fn_name":null},{"line":249,"address":[5663772,5663676],"length":1,"stats":{"Line":2},"fn_name":null},{"line":253,"address":[5664240,5664330],"length":1,"stats":{"Line":2},"fn_name":null},{"line":255,"address":[5664531,5664378,5664489,5664578,5665594,5664643],"length":1,"stats":{"Line":5},"fn_name":null},{"line":257,"address":[5664885,5665064,5664947,5664898,5665285,5664802,5665374,5664924],"length":1,"stats":{"Line":5},"fn_name":null},{"line":260,"address":[5666487,5669174,5669033,5666432,5666437,5666464],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":262,"address":[5666568],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[5666583],"length":1,"stats":{"Line":1},"fn_name":null},{"line":265,"address":[5666734,5666617,5666794,5666663,5666849,5666923,5669117],"length":1,"stats":{"Line":6},"fn_name":null},{"line":267,"address":[5666714],"length":1,"stats":{"Line":1},"fn_name":null},{"line":270,"address":[5667122],"length":1,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[5667267,5667186],"length":1,"stats":{"Line":2},"fn_name":null},{"line":272,"address":[5669138,5667577,5667503,5667385,5667448,5667313],"length":1,"stats":{"Line":5},"fn_name":null},{"line":274,"address":[5667363],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[5667824,5667776,5667871],"length":1,"stats":{"Line":3},"fn_name":null},{"line":280,"address":[5668030,5669159,5668119,5668184,5668072,5667919],"length":1,"stats":{"Line":5},"fn_name":null},{"line":282,"address":[5668605,5668488,5668826,5668343,5668915,5668426,5668439,5668465],"length":1,"stats":{"Line":5},"fn_name":null},{"line":285,"address":[5670093,5673814,5670032,5673976,5670037,5670064],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":287,"address":[5670174],"length":1,"stats":{"Line":1},"fn_name":null},{"line":289,"address":[5670189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":290,"address":[5670223,5670289,5670357],"length":1,"stats":{"Line":3},"fn_name":null},{"line":291,"address":[5670405],"length":1,"stats":{"Line":1},"fn_name":null},{"line":292,"address":[5670691,5670746,5670820,5670628,5670528,5673898,5670581],"length":1,"stats":{"Line":6},"fn_name":null},{"line":294,"address":[5670608],"length":1,"stats":{"Line":1},"fn_name":null},{"line":298,"address":[5671218,5671195,5671047,5673919,5671019,5671289,5671339,5671413],"length":1,"stats":{"Line":7},"fn_name":null},{"line":300,"address":[5671077,5671173],"length":1,"stats":{"Line":2},"fn_name":null},{"line":304,"address":[5673940,5671781,5671641,5671905,5671739,5671831],"length":1,"stats":{"Line":5},"fn_name":null},{"line":306,"address":[5672160,5672189,5672344,5672578,5672215,5672147,5672668,5672064],"length":1,"stats":{"Line":5},"fn_name":null},{"line":308,"address":[5672817,5672972,5672907,5672705,5672798,5673961],"length":1,"stats":{"Line":5},"fn_name":null},{"line":311,"address":[5672751],"length":1,"stats":{"Line":1},"fn_name":null},{"line":314,"address":[5673366,5673739,5673705,5673563,5673537,5673585],"length":1,"stats":{"Line":4},"fn_name":null},{"line":317,"address":[5675104,5676216,5676312,5675159,5675136,5675109],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":319,"address":[5675228],"length":1,"stats":{"Line":1},"fn_name":null},{"line":321,"address":[5675251,5675331,5675378,5675443,5676297],"length":1,"stats":{"Line":4},"fn_name":null},{"line":323,"address":[5675696,5676083,5675745,5675683,5675722,5675862,5676172,5675600],"length":1,"stats":{"Line":5},"fn_name":null},{"line":326,"address":[5676677,5676727,5676672,5676704,5677796,5677892],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":328,"address":[5676796],"length":1,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[5676958,5677877,5676803,5677023,5676911],"length":1,"stats":{"Line":4},"fn_name":null},{"line":332,"address":[5677663,5677341,5677302,5677752,5677442],"length":1,"stats":{"Line":2},"fn_name":null},{"line":333,"address":[5677325,5677180,5677276,5677263],"length":1,"stats":{"Line":4},"fn_name":null},{"line":338,"address":[5678256,5678311,5678261,5680064,5679950,5678288],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":340,"address":[5678389],"length":1,"stats":{"Line":1},"fn_name":null},{"line":342,"address":[5678761,5680028,5678404,5678643,5678572,5678552,5678693],"length":1,"stats":{"Line":6},"fn_name":null},{"line":344,"address":[5678475],"length":1,"stats":{"Line":1},"fn_name":null},{"line":348,"address":[5678976,5679066,5679113,5680049,5679178],"length":1,"stats":{"Line":4},"fn_name":null},{"line":350,"address":[5679428,5679454,5679415,5679594,5679816,5679332,5679477,5679906],"length":1,"stats":{"Line":5},"fn_name":null},{"line":353,"address":[5680640,5680663,5683944,5680608,5684085,5680613],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":355,"address":[5680744],"length":1,"stats":{"Line":1},"fn_name":null},{"line":357,"address":[5680759],"length":1,"stats":{"Line":1},"fn_name":null},{"line":358,"address":[5680816],"length":1,"stats":{"Line":1},"fn_name":null},{"line":359,"address":[5680875,5680946,5681014],"length":1,"stats":{"Line":3},"fn_name":null},{"line":360,"address":[5681062],"length":1,"stats":{"Line":1},"fn_name":null},{"line":362,"address":[5681319,5681448,5681256,5684028,5681374,5681186],"length":1,"stats":{"Line":5},"fn_name":null},{"line":364,"address":[5681236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":367,"address":[5681770,5681647,5681745,5681682,5681816],"length":1,"stats":{"Line":4},"fn_name":null},{"line":369,"address":[5681920,5681784,5681962,5681854,5682086,5682012,5684049],"length":1,"stats":{"Line":6},"fn_name":null},{"line":370,"address":[5682843,5682525,5682245,5682328,5682341,5682753,5682370,5682396],"length":1,"stats":{"Line":5},"fn_name":null},{"line":372,"address":[5683117,5683052,5682918,5683000,5684070,5682880],"length":1,"stats":{"Line":5},"fn_name":null},{"line":378,"address":[5683511,5683703,5683728,5683800,5683845,5683682],"length":1,"stats":{"Line":4},"fn_name":null},{"line":381,"address":[5685184,5685213,5685157,5685152,5689670,5689811],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":383,"address":[5685294],"length":1,"stats":{"Line":1},"fn_name":null},{"line":385,"address":[5685309],"length":1,"stats":{"Line":1},"fn_name":null},{"line":386,"address":[5685404,5685343],"length":1,"stats":{"Line":2},"fn_name":null},{"line":387,"address":[5685483],"length":1,"stats":{"Line":1},"fn_name":null},{"line":388,"address":[5685661,5685593,5685521],"length":1,"stats":{"Line":3},"fn_name":null},{"line":389,"address":[5685709],"length":1,"stats":{"Line":1},"fn_name":null},{"line":391,"address":[5685835,5686025,5686099,5689754,5685970,5685907],"length":1,"stats":{"Line":5},"fn_name":null},{"line":393,"address":[5685885],"length":1,"stats":{"Line":1},"fn_name":null},{"line":397,"address":[5686327,5686298,5686674,5687014,5686915,5686363,5686611],"length":1,"stats":{"Line":4},"fn_name":null},{"line":399,"address":[5689775,5687109,5687201,5686631,5687275,5687043,5687151],"length":1,"stats":{"Line":6},"fn_name":null},{"line":401,"address":[5687517,5687714,5688080,5687585,5687530,5687434,5687559,5687981],"length":1,"stats":{"Line":5},"fn_name":null},{"line":403,"address":[5688304,5688117,5688164,5688249,5688378,5689796],"length":1,"stats":{"Line":5},"fn_name":null},{"line":410,"address":[5688889,5688862,5688819,5688918],"length":1,"stats":{"Line":3},"fn_name":null},{"line":411,"address":[5688989,5689528,5688953,5689438,5688903,5689204,5689239],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":155,"coverable":164},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","endpoints","players.rs"],"content":"use crate::server::{app_context::AppContext, auth::extract_verified_id, errors::reply_with_error};\nuse serde::{Deserialize, Serialize};\nuse std::convert::Infallible;\nuse warp::hyper::StatusCode;\n\npub async fn get_player_filter(id: \u0026str, ctx: \u0026AppContext) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    #[derive(Serialize)]\n    struct GetPlayerResponse {\n        id: String,\n        name: String,\n    }\n\n    match ctx\n        .db()\n        .players()\n        .get(\u0026id)\n        .await\n        .expect(\"Reading player has failed\")\n    {\n        Some(player) =\u003e Ok(warp::reply::with_status(\n            warp::reply::json(\u0026GetPlayerResponse {\n                id: String::from(player.id()),\n                name: String::from(player.name()),\n            }),\n            StatusCode::OK,\n        )),\n        None =\u003e Ok(reply_with_error(StatusCode::NOT_FOUND)),\n    }\n}\n\n#[derive(Deserialize)]\npub struct EditPlayerInput {\n    name: String,\n}\n\npub async fn edit_player_filter(\n    id: \u0026str,\n    input: \u0026EditPlayerInput,\n    authorization: \u0026str,\n    ctx: \u0026AppContext,\n) -\u003e Result\u003cimpl warp::Reply, Infallible\u003e {\n    match extract_verified_id(authorization, ctx).filter(|token_id| token_id == id) {\n        Some(player_id) =\u003e match ctx\n            .db()\n            .players()\n            .get(\u0026player_id)\n            .await\n            .expect(\"Reading player has failed\")\n        {\n            Some(mut player) =\u003e {\n                player.set_name(\u0026input.name);\n                ctx.db()\n                    .players()\n                    .persist(\u0026player)\n                    .await\n                    .expect(\"editing player failed\");\n                Ok(warp::reply::with_status(\n                    warp::reply::json(\u0026player),\n                    StatusCode::OK,\n                ))\n            }\n            None =\u003e Ok(reply_with_error(StatusCode::UNAUTHORIZED)),\n        },\n        None =\u003e Ok(reply_with_error(StatusCode::UNAUTHORIZED)),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{edit_player_filter, get_player_filter, EditPlayerInput};\n    use crate::{\n        model::Player,\n        server::{app_context::AppContext, auth::generate_jwt_token},\n    };\n    use warp::{hyper::StatusCode, Reply};\n\n    fn init_ctx() -\u003e AppContext {\n        AppContext::init()\n    }\n\n    #[tokio::test]\n    async fn should_not_get_unknown_player() {\n        let ctx = init_ctx();\n\n        let reply = get_player_filter(\"unknown\", \u0026ctx).await;\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::NOT_FOUND\n        );\n    }\n\n    #[tokio::test]\n    async fn should_get_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        let player_id = String::from(player.id());\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n\n        let reply = get_player_filter(\u0026player_id, \u0026ctx).await;\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn should_edit_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        let player_id = String::from(player.id());\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = edit_player_filter(\n            \u0026player_id,\n            \u0026EditPlayerInput {\n                name: String::from(\"new name\"),\n            },\n            \u0026token,\n            \u0026ctx,\n        )\n        .await;\n\n        let updated_player = ctx\n            .db()\n            .players()\n            .get(player.id())\n            .await\n            .expect(\"Reading player failed\");\n\n        assert_eq!(reply.unwrap().into_response().status(), StatusCode::OK);\n        assert_eq!(updated_player.unwrap().name(), \"new name\");\n    }\n\n    #[tokio::test]\n    async fn should_not_edit_other_player() {\n        let ctx = init_ctx();\n\n        let player = Player::new(\"game\");\n        ctx.db()\n            .players()\n            .persist(\u0026player)\n            .await\n            .expect(\"Writing player failed\");\n        let token = generate_jwt_token(\u0026player, \u0026ctx.config().auth_secret);\n\n        let reply = edit_player_filter(\n            \"other\",\n            \u0026EditPlayerInput {\n                name: String::from(\"new name\"),\n            },\n            \u0026token,\n            \u0026ctx,\n        )\n        .await;\n\n        let updated_player = ctx\n            .db()\n            .players()\n            .get(player.id())\n            .await\n            .expect(\"Reading player failed\");\n\n        assert_eq!(\n            reply.unwrap().into_response().status(),\n            StatusCode::UNAUTHORIZED\n        );\n        assert_eq!(updated_player.unwrap().name(), player.name());\n    }\n}\n","traces":[{"line":6,"address":[6621280,6622731,6621306,6621444],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}"},{"line":13,"address":[6621407,6622092,6622716,6621661,6621547,6621596,6621496,6622561],"length":1,"stats":{"Line":6},"fn_name":null},{"line":16,"address":[6621475],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[6622490,6622094,6622037],"length":1,"stats":{"Line":3},"fn_name":null},{"line":21,"address":[6622360],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[5324342],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[5324423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[5324717,5324188],"length":1,"stats":{"Line":2},"fn_name":null},{"line":36,"address":[5815232],"length":1,"stats":{"Line":1},"fn_name":"edit_player_filter"},{"line":42,"address":[5325751,5325296,5325310,5325539],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":43,"address":[5327680,5325879,5326085,5325925,5326588,5326015,5325761,5325699],"length":1,"stats":{"Line":6},"fn_name":null},{"line":46,"address":[5325855],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[6624347,6624280],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[5326724],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[5326816,5326955,5327701,5327007,5326875,5327075],"length":1,"stats":{"Line":5},"fn_name":null},{"line":54,"address":[5326869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[5327314,5327353],"length":1,"stats":{"Line":2},"fn_name":null},{"line":58,"address":[5327281],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[5326561,5327418],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[5325724,5327489],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[4587984],"length":1,"stats":{"Line":1},"fn_name":"init_ctx"},{"line":78,"address":[4587992],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[6018244,6017175,6017125,6017120,6017152,6018340],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}"},{"line":83,"address":[6017244],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[6017251,6017406,6017359,6017471,6018325],"length":1,"stats":{"Line":4},"fn_name":null},{"line":87,"address":[6018200,6017789,6017890,6018111,6017750],"length":1,"stats":{"Line":2},"fn_name":null},{"line":88,"address":[6017773,6017724,6017711,6017628],"length":1,"stats":{"Line":4},"fn_name":null},{"line":93,"address":[5718409,5718351,5718442,5718191,5718176],"length":1,"stats":{"Line":9},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":95,"address":[6018840],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[6018855],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[6018889,6018950],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[5718335],"length":1,"stats":{"Line":5},"fn_name":null},{"line":101,"address":[6019093],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[5718426],"length":1,"stats":{"Line":6},"fn_name":null},{"line":107,"address":[6019989,6020015,6020155,6020038,6019893,6020465,6020376,6019976],"length":1,"stats":{"Line":5},"fn_name":null},{"line":110,"address":[4588631,4588624],"length":1,"stats":{"Line":9},"fn_name":"should_edit_player"},{"line":112,"address":[6021446],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[6021487],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[6021582,6021521],"length":1,"stats":{"Line":2},"fn_name":null},{"line":116,"address":[6021934,6021860,6021805,6021650,6021745,6025411],"length":1,"stats":{"Line":5},"fn_name":null},{"line":118,"address":[6021725],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[6022228,6022181,6022133],"length":1,"stats":{"Line":3},"fn_name":null},{"line":123,"address":[5814070],"length":1,"stats":{"Line":5},"fn_name":null},{"line":124,"address":[6022276],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[6022422],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[6022324],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[6022466],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[5814049,5814091],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[5814207],"length":1,"stats":{"Line":5},"fn_name":null},{"line":136,"address":[6023087],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[6023875,6023745,6023930,6023862,6023904,6024323,6024419,6024059],"length":1,"stats":{"Line":5},"fn_name":null},{"line":141,"address":[6025040,6024448,6024671,6024821,6024649,6025130],"length":1,"stats":{"Line":3},"fn_name":null},{"line":144,"address":[4588935,4588928],"length":1,"stats":{"Line":9},"fn_name":"should_not_edit_other_player"},{"line":146,"address":[6026662],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[6026703],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[5807351],"length":1,"stats":{"Line":6},"fn_name":null},{"line":151,"address":[6026834],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[6027242,6027290,6027337],"length":1,"stats":{"Line":3},"fn_name":null},{"line":156,"address":[5807477],"length":1,"stats":{"Line":4},"fn_name":null},{"line":158,"address":[6027412],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[6027377],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[6027456],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[5807456,5807498],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[5807614],"length":1,"stats":{"Line":5},"fn_name":null},{"line":169,"address":[6028118],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[6029456,6028935,6028977,6029090,6029357],"length":1,"stats":{"Line":2},"fn_name":null},{"line":174,"address":[6028893,6028776,6028906,6028961],"length":1,"stats":{"Line":4},"fn_name":null},{"line":177,"address":[6029689,6030146,6029485,6030236,6029907,6029711,6029927],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":67,"coverable":68},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","errors.rs"],"content":"use serde::Serialize;\nuse std::convert::Infallible;\nuse warp::{\n    hyper::StatusCode,\n    reply::{Json, WithStatus},\n    Rejection, Reply,\n};\n\n#[derive(Serialize)]\nstruct ErrorMessage {\n    code: u16,\n    message: String,\n}\n\nfn build_error_content(status: \u0026StatusCode) -\u003e ErrorMessage {\n    ErrorMessage {\n        code: status.as_u16(),\n        message: String::from(status.canonical_reason().unwrap_or(\"unknown\")),\n    }\n}\n\npub fn reply_with_error(status: StatusCode) -\u003e WithStatus\u003cJson\u003e {\n    warp::reply::with_status(warp::reply::json(\u0026build_error_content(\u0026status)), status)\n}\n\npub async fn handle_rejection(err: Rejection) -\u003e Result\u003cimpl Reply, Infallible\u003e {\n    if err.is_not_found() {\n        return Ok(reply_with_error(StatusCode::NOT_FOUND));\n    } else if err.find::\u003cwarp::reject::MethodNotAllowed\u003e().is_some() {\n        return Ok(reply_with_error(StatusCode::METHOD_NOT_ALLOWED));\n    }\n\n    return Ok(reply_with_error(StatusCode::INTERNAL_SERVER_ERROR));\n}\n","traces":[{"line":15,"address":[5111024],"length":1,"stats":{"Line":1},"fn_name":"build_error_content"},{"line":17,"address":[5111041],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[5111069],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[5111242,5111200],"length":1,"stats":{"Line":1},"fn_name":"reply_with_error"},{"line":23,"address":[5111254,5111212],"length":1,"stats":{"Line":2},"fn_name":null},{"line":26,"address":[4790416,4790431],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":27,"address":[5849290],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[5849385,5849462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[5849361,5849597,5849559],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[5849627],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[5849603,5849716],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":5,"coverable":11},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","logger.rs"],"content":"use crate::config::AppConfig;\nuse flexi_logger::{style, DeferredNow, Level, Logger, Record};\nuse log::info;\nuse std::thread;\n\npub fn custom_format(\n    w: \u0026mut dyn std::io::Write,\n    now: \u0026mut DeferredNow,\n    record: \u0026Record,\n) -\u003e Result\u003c(), std::io::Error\u003e {\n    let level = record.level();\n    write!(\n        w,\n        \"[{}] {} ({})[{}] {}\",\n        now.now().format(\"%Y-%m-%d %H:%M:%S%.3f %:z\"),\n        style(level, level),\n        thread::current().name().unwrap_or(\"-\"),\n        style(level, record.module_path().unwrap_or(\"-\")),\n        style(level, \u0026record.args())\n    )\n}\n\npub fn init_logger(config: \u0026AppConfig) {\n    let log_level = if cfg!(test) {\n        Level::Warn.to_string()\n    } else {\n        config.log_level.to_string()\n    };\n    Logger::with_env_or_str(\u0026log_level)\n        .format(custom_format)\n        .start()\n        .ok();\n\n    info!(\"Initialized logger with level {}\", \u0026log_level);\n}\n","traces":[{"line":6,"address":[6058832,6058932],"length":1,"stats":{"Line":0},"fn_name":"custom_format"},{"line":11,"address":[6058882],"length":1,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[6059447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[6058955],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[6059006],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[6059212,6059087,6059041],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[6059244],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[6059373],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[6060313,6060272],"length":1,"stats":{"Line":1},"fn_name":"init_logger"},{"line":25,"address":[6885222],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[6060287],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[6060328,6060399],"length":1,"stats":{"Line":2},"fn_name":null},{"line":34,"address":[6060466,6060587],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":4,"coverable":13},{"path":["/","home","floric","Dev","Github","rust-tests","webserver","backend","src","server","mod.rs"],"content":"pub mod app_context;\nmod auth;\nmod endpoints;\nmod errors;\nmod logger;\n\nuse self::{\n    app_context::AppContext,\n    endpoints::{\n        games::{\n            attend_game_filter, create_game_filter, get_game_filter, get_games_count_filter,\n            leave_game_filter,\n        },\n        players::{edit_player_filter, get_player_filter, EditPlayerInput},\n    },\n    errors::handle_rejection,\n};\nuse log::warn;\nuse std::fs;\nuse warp::Filter;\n\nconst PUBLIC_PATH: \u0026str = \"/var/www/public\";\nconst AUTHORIZATION: \u0026str = \"Authorization\";\n\npub async fn run_server(ctx: \u0026'static AppContext) {\n    let frontend_path = fs::canonicalize(\"../frontend\")\n        .map(|p| {\n            p.into_os_string()\n                .into_string()\n                .unwrap_or_else(|_| \"-\".to_string())\n        })\n        .unwrap_or_else(|_| \"-\".to_string());\n\n    let index_path: String;\n    let static_path: String;\n    if ctx.is_dev() {\n        warn!(\"Delivering development assets from {}\", frontend_path);\n        index_path = format!(\"{}/public/index.html\", frontend_path);\n        static_path = format!(\"{}/dist/\", frontend_path);\n    } else {\n        index_path = format!(\"{}/index.html\", PUBLIC_PATH);\n        static_path = format!(\"{}/static/\", PUBLIC_PATH);\n    }\n\n    let game_route =\n        warp::path(\"games\").and(\n            // GET /api/games\n            warp::get()\n                .and(warp::path::end())\n                .and_then(move || async move { get_games_count_filter(ctx).await })\n                .or(\n                    // PUT /api/games\n                    warp::put().and_then(move || async move { create_game_filter(ctx).await }),\n                )\n                .or(\n                    // POST /api/games/attend\n                    warp::post().and(warp::path!(String / \"attend\")).and_then(\n                        move |game_token: String| async move {\n                            attend_game_filter(\u0026game_token, ctx).await\n                        },\n                    ),\n                )\n                .or(\n                    // POST /api/games/leave\n                    warp::post()\n                        .and(warp::path!(String / \"leave\"))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(\n                            move |game_token: String, authorization: String| async move {\n                                leave_game_filter(\u0026game_token, \u0026authorization, ctx).await\n                            },\n                        ),\n                )\n                .or(\n                    // GET /api/games/:token\n                    warp::get()\n                        .and(warp::path!(String))\n                        .and(warp::header(AUTHORIZATION))\n                        .and_then(move |token: String, authorization: String| async move {\n                            get_game_filter(\u0026token, \u0026authorization, ctx).await\n                        }),\n                ),\n        );\n\n    let player_route = warp::path(\"players\").and(\n        // GET /api/players/:id\n        warp::get()\n            .and(warp::path!(String))\n            .and_then(move |id: String| async move { get_player_filter(\u0026id, ctx).await })\n            .or(\n                // POST /api/players/:id\n                warp::post()\n                    .and(warp::path!(String))\n                    .and(warp::body::json())\n                    .and(warp::header(AUTHORIZATION))\n                    .and_then(\n                        move |id: String, input: EditPlayerInput, authorization: String| async move {\n                            edit_player_filter(\u0026id, \u0026input, \u0026authorization, ctx).await\n                        },\n                    )),\n    );\n    let api_route = warp::path(\"api\").and(game_route.or(player_route));\n\n    let static_route = warp::path(\"static\").and(warp::fs::dir(static_path));\n    let index_route = warp::get().and(warp::path::end().and(warp::fs::file(index_path)));\n\n    let routes = index_route\n        .or(static_route)\n        .or(api_route)\n        .recover(handle_rejection)\n        .with(warp::log(\"server\"));\n\n    warp::serve(routes)\n        .run(([0, 0, 0, 0], ctx.config().port))\n        .await;\n}\n","traces":[{"line":25,"address":[5344493,5344464,5350208,5344720],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":27,"address":[5337296],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":28,"address":[5337303],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[5337207,5337200],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":32,"address":[5337408,5337415],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":36,"address":[5344817,5345978,5344782],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[5345391,5345123,5345210,5344990,5345163],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[5345440,5345587],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[5345693,5345840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[5345991,5346065,5344919],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[5346321,5346171],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[5346514,5346689,5347273,5347577,5346933,5346602,5346573],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[5346548],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[4795871,4795856],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":53,"address":[4835967,4835952],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":57,"address":[5346816,5346855,5346829,5346797,5346879,5346750,5346906],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[4802687,4802762,4802818,4802672],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":59,"address":[4802742],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[5347146,5346981,5347096,5347210],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[5347033,5347014,5346992,5347046,5347072],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[5347107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[4780159,4780241,4780367,4780144],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":70,"address":[4780221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[5347313,5347450,5347400,5347514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[5347363,5347346,5347324,5347376],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[5347411],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[4812479,4812271,4812256,4812353],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":80,"address":[4812333],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[5348168,5347822,5347715,5347849],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[5347768,5347785,5347798,5347749],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[4793632,4793647],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":92,"address":[5348041,5348105,5347989,5347967,5347876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[5347889,5347930,5347913,5347943],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[5347978],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[5348002],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[4844144,4844440,4844244,4844159],"length":1,"stats":{"Line":0},"fn_name":"drop_in_place\u003cgenerator-0\u003e"},{"line":98,"address":[4844221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[5348251,5348528],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[5348575,5348742,5348797],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[5348881,5348951,5349010,5348804,5348979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[5349065,5349157,5349215,5349297],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[5349026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[5349147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[5349246],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[5349342,5349201,5349254,5350131],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[4832389],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[5349662,5349631,5349644,5350158,5349517,5349502,5349441],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":47}]};
    </script>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, pathToString(file.path)),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('div', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('pre', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>